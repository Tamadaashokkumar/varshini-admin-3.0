This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
API_INTEGRATION_GUIDE.md
app/dashboard/abandoned-carts/page.tsx
app/dashboard/analytics/page.tsx
app/dashboard/carousel/page.tsx
app/dashboard/categories/page.tsx
app/dashboard/chat/page.tsx
app/dashboard/customers/page.tsx
app/dashboard/layout.tsx
app/dashboard/monitor/page.tsx
app/dashboard/orders/page.tsx
app/dashboard/page.tsx
app/dashboard/products/[id]/page.tsx
app/dashboard/products/add/page.tsx
app/dashboard/products/edit/[id]/page.tsx
app/dashboard/products/page.tsx
app/dashboard/settings/page.tsx
app/globals.css
app/layout.tsx
app/login/page.tsx
app/page.tsx
CHANGELOG.md
components/AdminChatComponent.jsx
components/ChatComponent.jsx
components/dashboard/InventoryForecast.tsx
components/dashboard/SalesHeatmap.tsx
components/Header.tsx
components/PageTransition.tsx
components/providers/SocketProvider.tsx
components/Sidebar.tsx
components/StatsCard.tsx
components/ui/Button.tsx
components/ui/Skeleton.tsx
components/ui/Toaster.tsx
lib/api.ts
lib/utils.ts
next.config.js
package.json
postcss.config.js
public/sounds/alert.mp3
public/sounds/notification.mp3
README.md
SETUP_GUIDE.md
tailwind.config.js
tsconfig.json
types/index.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="app/dashboard/monitor/page.tsx">
// "use client";

// import { useEffect, useState, useRef, useMemo } from "react";
// import { io, Socket } from "socket.io-client";
// import Cookies from "js-cookie";
// import { format } from "date-fns";
// import { motion, AnimatePresence } from "framer-motion";
// import {
//   Activity,
//   ShoppingCart,
//   Smartphone,
//   Monitor,
//   MapPin,
//   Battery,
//   MessageCircle,
//   Wifi,
//   History,
//   X,
//   Send,
//   User,
//   Bell,
//   MousePointer2,
//   AlertTriangle,
//   Clock,
//   Radio,
//   ShoppingBag,
//   CreditCard,
//   Zap,
//   Package,
//   Sparkles,
// } from "lucide-react";
// import toast, { Toaster } from "react-hot-toast";

// const SOCKET_URL = (
//   process.env.NEXT_PUBLIC_API_URL || "http://localhost:5000"
// ).replace(/\/api\/?$/, "");

// // ðŸ”Š Audio Objects
// const notificationSound =
//   typeof window !== "undefined"
//     ? new Audio(
//         "https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3",
//       )
//     : null;

// const cartSound =
//   typeof window !== "undefined"
//     ? new Audio(
//         "https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3",
//       )
//     : null;

// export default function LiveMonitor() {
//   const [logs, setLogs] = useState<any[]>([]);
//   const [isConnected, setIsConnected] = useState(false);

//   // ðŸ’¬ Chat Modal States
//   const [isChatOpen, setIsChatOpen] = useState(false);
//   const [targetUserId, setTargetUserId] = useState<string | null>(null);
//   const [targetUserName, setTargetUserName] = useState<string>("");
//   const [messageInput, setMessageInput] = useState("");

//   // ðŸ”¥ Incoming Reply Popup State
//   const [incomingReply, setIncomingReply] = useState<any | null>(null);

//   const socketRef = useRef<Socket | null>(null);

//   useEffect(() => {
//     const token = Cookies.get("accessToken");

//     socketRef.current = io(SOCKET_URL, {
//       auth: { token },
//       path: "/socket.io/",
//       transports: ["websocket"],
//       autoConnect: true,
//     });

//     socketRef.current.on("connect", () => {
//       setIsConnected(true);
//       socketRef.current?.emit("join_room", "admin");
//     });

//     socketRef.current.on("disconnect", () => setIsConnected(false));

//     socketRef.current.on("new_live_activity", (data: any) => {
//       if (data.action === "ADD_TO_CART" && cartSound) {
//         try {
//           cartSound.currentTime = 0;
//           cartSound.play().catch(() => {});
//         } catch (e) {}
//       }
//       setLogs((prev) => [data, ...prev].slice(0, 150));
//     });

//     socketRef.current.on("admin_receive_reply", (data: any) => {
//       try {
//         if (notificationSound) {
//           notificationSound.currentTime = 0;
//           notificationSound.play().catch(() => {});
//         }
//       } catch (e) {}
//       setIncomingReply(data);
//     });

//     return () => {
//       socketRef.current?.disconnect();
//     };
//   }, []);

//   // =================================================================
//   // ðŸ”¥ LOGIC: PERSISTENT CART + PRIORITY STATUS
//   // =================================================================
//   const activeUsers = useMemo(() => {
//     const userGroups = new Map();

//     logs.forEach((log) => {
//       const key = log.userId || log.guestId || log.userName;
//       if (!userGroups.has(key)) {
//         userGroups.set(key, []);
//       }
//       userGroups.get(key).push(log);
//     });

//     const finalDisplayList: any[] = [];

//     userGroups.forEach((userHistory, key) => {
//       let logToShow = userHistory[0]; // Latest Log

//       // ðŸ›’ FIND PERSISTENT CART DATA (Search history for non-empty cart)
//       const logWithCart = userHistory.find(
//         (l: any) => l.meta?.cart?.items?.length > 0,
//       );
//       const persistentCart = logWithCart
//         ? logWithCart.meta.cart
//         : logToShow.meta?.cart || { items: [], total: 0 };

//       // ðŸš¨ PRIORITY STATUS LOGIC
//       const IMPORTANT_ACTIONS = ["ADD_TO_CART", "CHECKOUT_INIT", "BUY_NOW"];
//       const recentImportantLog = userHistory
//         .slice(0, 8)
//         .find((l: any) => IMPORTANT_ACTIONS.includes(l.action));

//       const finalObj = {
//         ...logToShow,
//         statusAction: recentImportantLog
//           ? recentImportantLog.action
//           : logToShow.action,
//         cartData: persistentCart,
//         historyCount: userHistory.length,
//       };

//       finalDisplayList.push(finalObj);
//     });

//     return finalDisplayList;
//   }, [logs]);

//   const openChatModal = (userId: string, userName: string) => {
//     if (!userId) {
//       toast.error("Guest user - Cannot chat");
//       return;
//     }
//     setTargetUserId(userId);
//     setTargetUserName(userName);
//     setIsChatOpen(true);
//     setIncomingReply(null);
//   };

//   const handleSendMessage = () => {
//     if (!messageInput.trim()) return;

//     if (socketRef.current && targetUserId) {
//       socketRef.current.emit("admin_send_message_trigger", {
//         targetUserId: targetUserId,
//         message: messageInput,
//       });
//       toast.success(`Message sent to ${targetUserName}!`);
//       setMessageInput("");
//       setIsChatOpen(false);
//     }
//   };

//   return (
//     // ðŸ”¥ FIX 1: Main Container is now TRANSPARENT (bg-transparent) to show background
//     // If you have a wallpaper on <body>, it will show through.
//     // Added 'backdrop-blur-sm' to give a glass feel to the whole page if needed.
//     <div className="min-h-screen bg-transparent text-gray-200 font-sans selection:bg-cyan-500/30 overflow-x-hidden relative">
//       <Toaster position="top-right" />

//       {/* ðŸŒŒ Background Ambience (Enhanced Glows) */}
//       <div className="fixed inset-0 pointer-events-none -z-10 bg-[#020617]">
//         {" "}
//         {/* Base Dark Layer */}
//         <div className="absolute top-[-10%] left-[-10%] w-[600px] h-[600px] bg-blue-600/20 rounded-full blur-[120px] animate-pulse"></div>
//         <div className="absolute bottom-[-10%] right-[-10%] w-[600px] h-[600px] bg-emerald-600/10 rounded-full blur-[120px] delay-1000"></div>
//         <div className="absolute top-[20%] right-[20%] w-[400px] h-[400px] bg-purple-600/10 rounded-full blur-[100px]"></div>
//         {/* Noise Texture for Realism */}
//         <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 mix-blend-overlay"></div>
//       </div>

//       {/* ðŸš€ Header (Glass Effect) */}
//       <header className="sticky top-0 z-40 bg-black/10 backdrop-blur-xl border-b border-white/5 px-6 py-4 shadow-sm">
//         <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
//           <div className="flex items-center gap-3">
//             <div className="p-2 bg-gradient-to-br from-cyan-500/20 to-blue-600/20 rounded-xl border border-white/10 shadow-[0_0_15px_rgba(6,182,212,0.15)]">
//               <Activity className="text-cyan-400 w-5 h-5 animate-pulse" />
//             </div>
//             <div>
//               <h1 className="text-lg font-black tracking-widest text-white">
//                 LIVE{" "}
//                 <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-emerald-400">
//                   SPY
//                 </span>
//               </h1>
//               <div className="flex items-center gap-2">
//                 <span
//                   className={`w-1.5 h-1.5 rounded-full ${isConnected ? "bg-emerald-500 shadow-[0_0_8px_#10b981]" : "bg-red-500"}`}
//                 ></span>
//                 <span
//                   className={`text-[10px] font-mono uppercase tracking-widest ${isConnected ? "text-emerald-500" : "text-red-500"}`}
//                 >
//                   {isConnected ? "System Online" : "Reconnecting..."}
//                 </span>
//               </div>
//             </div>
//           </div>
//           <div className="flex items-center gap-3 bg-white/5 px-4 py-1.5 rounded-full border border-white/5 backdrop-blur-md">
//             <Radio
//               size={14}
//               className={`text-cyan-400 ${activeUsers.length > 0 ? "animate-pulse" : ""}`}
//             />
//             <span className="text-xs font-medium text-gray-300">
//               Targets:{" "}
//               <span className="text-cyan-400 text-sm font-bold ml-1">
//                 {activeUsers.length}
//               </span>
//             </span>
//           </div>
//         </div>
//       </header>

//       {/* ðŸ“¡ Activity Grid */}
//       <main className="max-w-7xl mx-auto p-6 relative z-10">
//         {activeUsers.length === 0 ? (
//           <motion.div
//             initial={{ opacity: 0, y: 20 }}
//             animate={{ opacity: 1, y: 0 }}
//             className="flex flex-col items-center justify-center h-[60vh] text-gray-500"
//           >
//             <div className="w-24 h-24 bg-white/5 rounded-full flex items-center justify-center mb-6 animate-pulse border border-white/5 shadow-[0_0_30px_rgba(255,255,255,0.05)]">
//               <Wifi size={48} className="text-white/20" />
//             </div>
//             <h2 className="text-2xl font-bold text-gray-400 mb-2 tracking-tight">
//               Radar Empty
//             </h2>
//             <p className="text-sm font-mono text-gray-600 uppercase tracking-widest">
//               Waiting for signals...
//             </p>
//           </motion.div>
//         ) : (
//           <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
//             <AnimatePresence>
//               {activeUsers.map((log) => {
//                 const meta = log.meta || {};
//                 const isTabActive = meta.isTabActive !== false;

//                 const isExitIntent = log.statusAction === "EXIT_INTENT";
//                 const isAddToCart = log.statusAction === "ADD_TO_CART";
//                 const isCheckout = log.statusAction === "CHECKOUT_INIT";

//                 const uniqueKey = log.userId || log.guestId || log.userName;
//                 const cartItems = log.cartData?.items || [];
//                 const cartTotal = log.cartData?.total || 0;

//                 return (
//                   <motion.div
//                     key={uniqueKey}
//                     layout
//                     initial={{ opacity: 0, scale: 0.95 }}
//                     animate={{ opacity: 1, scale: 1 }}
//                     exit={{ opacity: 0, scale: 0.95 }}
//                     transition={{ duration: 0.3 }}
//                     className={`
//                       relative rounded-[1.5rem] overflow-hidden backdrop-blur-md transition-all duration-500 border group
//                       ${/* ðŸ”¥ GLASS EFFECT: Increased transparency (bg-white/5) instead of solid color */ ""}
//                       ${
//                         isExitIntent
//                           ? "bg-red-500/5 border-red-500/30 shadow-[0_0_40px_-10px_rgba(239,68,68,0.2)]"
//                           : isAddToCart
//                             ? "bg-emerald-500/5 border-emerald-500/30 shadow-[0_0_40px_-10px_rgba(16,185,129,0.2)]"
//                             : "bg-white/5 border-white/10 hover:bg-white/10 hover:border-white/20 hover:shadow-2xl"
//                       }
//                     `}
//                   >
//                     {/* Glass Shine */}
//                     <div className="absolute inset-0 bg-gradient-to-br from-white/5 to-transparent pointer-events-none"></div>

//                     <div className="p-5 relative z-10">
//                       {/* ... (User Info, Badges, etc. - Same as before) ... */}
//                       <div className="flex justify-between items-start mb-4">
//                         <div className="flex items-center gap-3">
//                           <div
//                             className={`p-2.5 rounded-xl border backdrop-blur-md ${meta.device === "Mobile" ? "bg-purple-500/10 border-purple-500/20 text-purple-400" : "bg-blue-500/10 border-blue-500/20 text-blue-400"}`}
//                           >
//                             {meta.device === "Mobile" ? (
//                               <Smartphone size={18} />
//                             ) : (
//                               <Monitor size={18} />
//                             )}
//                           </div>
//                           <div>
//                             <h3 className="font-bold text-white text-sm truncate max-w-[120px] flex items-center gap-2">
//                               {log.userName}
//                               {log.userId ? (
//                                 <div className="p-0.5 bg-cyan-500/20 rounded">
//                                   <User size={10} className="text-cyan-400" />
//                                 </div>
//                               ) : (
//                                 <span className="text-[9px] bg-white/10 px-1.5 rounded text-gray-400">
//                                   GUEST
//                                 </span>
//                               )}
//                             </h3>
//                             <div className="flex items-center gap-1.5 text-[10px] text-gray-400 mt-0.5">
//                               <MapPin size={10} className="text-gray-500" />
//                               {meta.location || "Unknown"}
//                             </div>
//                           </div>
//                         </div>

//                         <div
//                           className={`px-2.5 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wider border flex items-center gap-1.5 backdrop-blur-md shadow-sm
//                           ${
//                             isExitIntent
//                               ? "bg-red-500/20 text-red-300 border-red-500/30"
//                               : isAddToCart
//                                 ? "bg-emerald-500/20 text-emerald-300 border-emerald-500/30"
//                                 : isTabActive
//                                   ? "bg-cyan-500/10 text-cyan-300 border-cyan-500/20"
//                                   : "bg-white/5 text-gray-500 border-white/5"
//                           }`}
//                         >
//                           <span
//                             className={`w-1.5 h-1.5 rounded-full ${isExitIntent ? "bg-red-500 animate-ping" : isAddToCart ? "bg-emerald-500 animate-bounce" : isTabActive ? "bg-cyan-500 animate-pulse" : "bg-gray-600"}`}
//                           ></span>
//                           {isExitIntent
//                             ? "LEAVING"
//                             : isAddToCart
//                               ? "BUYING"
//                               : isTabActive
//                                 ? "ONLINE"
//                                 : "IDLE"}
//                         </div>
//                       </div>

//                       {/* Cart List */}
//                       {cartItems.length > 0 && (
//                         <div className="mb-4 bg-black/20 border border-white/5 rounded-xl overflow-hidden shadow-inner backdrop-blur-sm">
//                           <div className="bg-white/5 px-3 py-2 border-b border-white/5 flex justify-between items-center">
//                             <span className="text-[10px] font-bold text-gray-400 uppercase tracking-widest flex items-center gap-1">
//                               <ShoppingBag size={10} /> Active Cart (
//                               {cartItems.length})
//                             </span>
//                             <span className="text-xs font-bold text-emerald-400 bg-emerald-500/10 px-1.5 py-0.5 rounded border border-emerald-500/20">
//                               â‚¹{cartTotal.toLocaleString()}
//                             </span>
//                           </div>
//                           <div className="max-h-[120px] overflow-y-auto p-2 space-y-1.5 custom-scrollbar">
//                             {cartItems.map((item: any, idx: number) => (
//                               <div
//                                 key={idx}
//                                 className="flex items-center gap-3 p-2 bg-white/5 hover:bg-white/10 rounded-lg border border-white/5 transition-colors group/item"
//                               >
//                                 <div className="w-8 h-8 rounded-md bg-white/5 flex-shrink-0 overflow-hidden border border-white/5">
//                                   {item.image ? (
//                                     <img
//                                       src={item.image}
//                                       alt=""
//                                       className="w-full h-full object-cover opacity-80 group-hover/item:opacity-100 transition-opacity"
//                                     />
//                                   ) : (
//                                     <Package className="w-full h-full p-2 text-gray-600" />
//                                   )}
//                                 </div>
//                                 <div className="flex-1 min-w-0">
//                                   <p className="text-xs font-medium text-gray-300 truncate group-hover/item:text-white transition-colors">
//                                     {item.name || "Product Item"}
//                                   </p>
//                                   <div className="flex justify-between items-center mt-0.5">
//                                     <p className="text-[10px] text-gray-500 font-mono">
//                                       Qty: {item.qty || 1}
//                                     </p>
//                                     <p className="text-[10px] font-bold text-gray-400">
//                                       â‚¹{item.price}
//                                     </p>
//                                   </div>
//                                 </div>
//                               </div>
//                             ))}
//                           </div>
//                         </div>
//                       )}

//                       {/* Action Context */}
//                       <div className="bg-white/5 rounded-xl p-3 border border-white/5 mb-3 relative overflow-hidden backdrop-blur-sm">
//                         <div className="flex items-center justify-between mb-2 relative z-10">
//                           <span
//                             className={`text-[10px] font-black uppercase tracking-widest flex items-center gap-1.5 ${isExitIntent ? "text-red-400" : isAddToCart ? "text-emerald-400" : "text-cyan-400"}`}
//                           >
//                             {isExitIntent ? (
//                               <AlertTriangle size={12} />
//                             ) : isAddToCart ? (
//                               <ShoppingCart size={12} />
//                             ) : (
//                               <Zap size={12} />
//                             )}
//                             {log.action.replace("_", " ")}
//                           </span>
//                           <span className="text-[10px] text-gray-600 font-mono">
//                             {log.timestamp
//                               ? format(new Date(log.timestamp), "HH:mm:ss")
//                               : "Now"}
//                           </span>
//                         </div>
//                         <p className="text-xs text-gray-400 font-mono truncate opacity-60 pl-2 border-l border-white/10">
//                           {log.path}
//                         </p>
//                       </div>

//                       {/* Footer */}
//                       <div className="flex items-center justify-between mt-2">
//                         <div className="flex gap-2">
//                           {meta.battery && (
//                             <div className="flex items-center gap-1 text-[9px] text-gray-500 font-mono bg-white/5 px-2 py-1 rounded border border-white/5">
//                               <Battery
//                                 size={9}
//                                 className={
//                                   parseInt(meta.battery) < 20
//                                     ? "text-red-500"
//                                     : "text-emerald-500"
//                                 }
//                               />{" "}
//                               {meta.battery}
//                             </div>
//                           )}
//                         </div>
//                         {log.userId && (
//                           <button
//                             onClick={() =>
//                               openChatModal(log.userId, log.userName)
//                             }
//                             className="text-xs flex items-center gap-1.5 bg-indigo-500/10 hover:bg-indigo-500/30 text-indigo-300 border border-indigo-500/30 px-3 py-1.5 rounded-lg transition-all backdrop-blur-md"
//                           >
//                             <MessageCircle size={12} /> Message
//                           </button>
//                         )}
//                       </div>
//                     </div>
//                   </motion.div>
//                 );
//               })}
//             </AnimatePresence>
//           </div>
//         )}
//       </main>

//       {/* ========================================================== */}
//       {/* ðŸ”” INCOMING REPLY ALERT MODAL (Fixed Blur) */}
//       {/* ========================================================== */}
//       <AnimatePresence>
//         {incomingReply && (
//           // ðŸ”¥ FIX: Ensure this z-index is high (z-[10000]) and uses fixed inset-0
//           <div className="fixed inset-0 z-[10000] flex items-center justify-center p-6">
//             {/* ðŸ”¥ FIX: This backdrop-blur applies to the overlay BEHIND the modal */}
//             <motion.div
//               initial={{ opacity: 0 }}
//               animate={{ opacity: 1 }}
//               exit={{ opacity: 0 }}
//               className="absolute inset-0 bg-black/60 backdrop-blur-lg" // Stronger blur
//               onClick={() => setIncomingReply(null)}
//             />

//             {/* Modal Content */}
//             <motion.div
//               initial={{ opacity: 0, scale: 0.8, y: 50 }}
//               animate={{ opacity: 1, scale: 1, y: 0 }}
//               exit={{ opacity: 0, scale: 0.8, y: 50 }}
//               transition={{ type: "spring", stiffness: 300, damping: 25 }}
//               className="relative w-full max-w-md bg-black/40 backdrop-blur-2xl border border-white/10 rounded-[2rem] shadow-[0_0_50px_-10px_rgba(16,185,129,0.2)] overflow-hidden"
//             >
//               <div className="absolute -top-20 -left-20 w-40 h-40 bg-emerald-500/20 rounded-full blur-[80px]"></div>

//               <div className="p-8 relative z-10">
//                 <div className="flex items-start gap-4 mb-6">
//                   <div className="bg-gradient-to-br from-emerald-500 to-teal-600 p-3 rounded-2xl shadow-lg text-white">
//                     <Sparkles size={24} fill="white" />
//                   </div>
//                   <div>
//                     <h3 className="text-xl font-bold text-white">
//                       New Message
//                     </h3>
//                     <p className="text-sm text-emerald-400 font-medium">
//                       from {incomingReply.userName}
//                     </p>
//                   </div>
//                 </div>

//                 <div className="bg-white/5 border border-white/5 rounded-2xl p-5 mb-6 backdrop-blur-md">
//                   <p className="text-gray-200 text-lg leading-relaxed font-light">
//                     "{incomingReply.message}"
//                   </p>
//                 </div>

//                 <div className="grid grid-cols-2 gap-3">
//                   <button
//                     onClick={() => setIncomingReply(null)}
//                     className="py-3.5 rounded-xl text-sm font-bold text-gray-400 hover:text-white hover:bg-white/5 transition-all border border-transparent hover:border-white/5"
//                   >
//                     Dismiss
//                   </button>
//                   <button
//                     onClick={() =>
//                       openChatModal(
//                         incomingReply.userId,
//                         incomingReply.userName,
//                       )
//                     }
//                     className="py-3.5 rounded-xl text-sm font-bold text-white bg-gradient-to-r from-emerald-600 to-teal-600 hover:shadow-lg hover:shadow-emerald-500/20 transition-all flex items-center justify-center gap-2"
//                   >
//                     <Send size={16} /> Reply Now
//                   </button>
//                 </div>
//               </div>
//             </motion.div>
//           </div>
//         )}
//       </AnimatePresence>

//       {/* ðŸ’¬ Admin Chat Modal (Same Glass Style) */}
//       <AnimatePresence>
//         {isChatOpen && (
//           <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/50 backdrop-blur-md p-4">
//             <motion.div
//               initial={{ opacity: 0, scale: 0.95 }}
//               animate={{ opacity: 1, scale: 1 }}
//               exit={{ opacity: 0, scale: 0.95 }}
//               className="bg-[#0a0a0a]/80 backdrop-blur-2xl border border-white/10 p-0 rounded-3xl w-full max-w-md shadow-2xl overflow-hidden ring-1 ring-white/5"
//             >
//               <div className="flex justify-between items-center p-5 border-b border-white/5">
//                 <h3 className="text-lg font-bold text-white">
//                   Chat with {targetUserName}
//                 </h3>
//                 <button
//                   onClick={() => setIsChatOpen(false)}
//                   className="text-gray-500 hover:text-white"
//                 >
//                   <X size={20} />
//                 </button>
//               </div>
//               <div className="p-5">
//                 <textarea
//                   value={messageInput}
//                   onChange={(e) => setMessageInput(e.target.value)}
//                   placeholder="Type a message..."
//                   className="w-full h-32 bg-black/20 border border-white/10 rounded-xl p-4 text-white focus:border-indigo-500 focus:outline-none transition-all placeholder-gray-600"
//                   autoFocus
//                 />
//               </div>
//               <div className="p-5 pt-0 flex justify-end gap-3">
//                 <button
//                   onClick={() => setIsChatOpen(false)}
//                   className="px-5 py-2.5 text-gray-400 hover:text-white text-sm font-bold"
//                 >
//                   Cancel
//                 </button>
//                 <button
//                   onClick={handleSendMessage}
//                   disabled={!messageInput.trim()}
//                   className="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-bold rounded-xl shadow-lg flex items-center gap-2"
//                 >
//                   <Send size={16} /> Send
//                 </button>
//               </div>
//             </motion.div>
//           </div>
//         )}
//       </AnimatePresence>
//     </div>
//   );
// }

"use client";

import { useEffect, useState, useRef, useMemo } from "react";
import { io, Socket } from "socket.io-client";
import Cookies from "js-cookie";
import { format } from "date-fns";
import { motion, AnimatePresence } from "framer-motion";
import {
  Activity,
  ShoppingCart,
  Smartphone,
  Monitor,
  MapPin,
  Battery,
  MessageCircle,
  Wifi,
  History,
  X,
  Send,
  User,
  Bell,
  MousePointer2,
  AlertTriangle,
  Clock,
  Radio,
  ShoppingBag,
  CreditCard,
  Zap,
  Package,
  Sparkles,
  ChevronRight,
} from "lucide-react";
import toast, { Toaster } from "react-hot-toast";

const SOCKET_URL = (
  process.env.NEXT_PUBLIC_API_URL || "http://localhost:5000"
).replace(/\/api\/?$/, "");

// ðŸ”Š Audio Objects
const notificationSound =
  typeof window !== "undefined"
    ? new Audio(
        "https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3",
      )
    : null;

const cartSound =
  typeof window !== "undefined"
    ? new Audio(
        "https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3",
      )
    : null;

export default function LiveMonitor() {
  const [logs, setLogs] = useState<any[]>([]);
  const [isConnected, setIsConnected] = useState(false);

  // ðŸ’¬ Chat Modal States
  const [isChatOpen, setIsChatOpen] = useState(false);
  const [targetUserId, setTargetUserId] = useState<string | null>(null);
  const [targetUserName, setTargetUserName] = useState<string>("");
  const [messageInput, setMessageInput] = useState("");

  // ðŸ”¥ Incoming Reply Popup State
  const [incomingReply, setIncomingReply] = useState<any | null>(null);

  const socketRef = useRef<Socket | null>(null);

  useEffect(() => {
    const token = Cookies.get("accessToken");

    socketRef.current = io(SOCKET_URL, {
      auth: { token },
      path: "/socket.io/",
      transports: ["websocket"],
      autoConnect: true,
    });

    socketRef.current.on("connect", () => {
      setIsConnected(true);
      socketRef.current?.emit("join_room", "admin");
    });

    socketRef.current.on("disconnect", () => setIsConnected(false));

    socketRef.current.on("new_live_activity", (data: any) => {
      if (data.action === "ADD_TO_CART" && cartSound) {
        try {
          cartSound.currentTime = 0;
          cartSound.play().catch(() => {});
        } catch (e) {}
      }
      setLogs((prev) => [data, ...prev].slice(0, 150));
    });

    socketRef.current.on("admin_receive_reply", (data: any) => {
      try {
        if (notificationSound) {
          notificationSound.currentTime = 0;
          notificationSound.play().catch(() => {});
        }
      } catch (e) {}
      setIncomingReply(data);
    });

    return () => {
      socketRef.current?.disconnect();
    };
  }, []);

  // =================================================================
  // ðŸ”¥ LOGIC: PERSISTENT CART + PRIORITY STATUS
  // =================================================================
  const activeUsers = useMemo(() => {
    const userGroups = new Map();

    logs.forEach((log) => {
      const key = log.userId || log.guestId || log.userName;
      if (!userGroups.has(key)) {
        userGroups.set(key, []);
      }
      userGroups.get(key).push(log);
    });

    const finalDisplayList: any[] = [];

    userGroups.forEach((userHistory, key) => {
      let logToShow = userHistory[0]; // Latest Log

      // ðŸ›’ FIND PERSISTENT CART DATA
      const logWithCart = userHistory.find(
        (l: any) => l.meta?.cart?.items?.length > 0,
      );
      const persistentCart = logWithCart
        ? logWithCart.meta.cart
        : logToShow.meta?.cart || { items: [], total: 0 };

      // ðŸš¨ PRIORITY STATUS LOGIC
      const IMPORTANT_ACTIONS = ["ADD_TO_CART", "CHECKOUT_INIT", "BUY_NOW"];
      const recentImportantLog = userHistory
        .slice(0, 8)
        .find((l: any) => IMPORTANT_ACTIONS.includes(l.action));

      const finalObj = {
        ...logToShow,
        statusAction: recentImportantLog
          ? recentImportantLog.action
          : logToShow.action,
        cartData: persistentCart,
        historyCount: userHistory.length,
      };

      finalDisplayList.push(finalObj);
    });

    return finalDisplayList;
  }, [logs]);

  const openChatModal = (userId: string, userName: string) => {
    if (!userId) {
      toast.error("Guest user - Cannot chat");
      return;
    }
    setTargetUserId(userId);
    setTargetUserName(userName);
    setIsChatOpen(true);
    setIncomingReply(null);
  };

  const handleSendMessage = () => {
    if (!messageInput.trim()) return;

    if (socketRef.current && targetUserId) {
      socketRef.current.emit("admin_send_message_trigger", {
        targetUserId: targetUserId,
        message: messageInput,
      });
      toast.success(`Message sent to ${targetUserName}!`);
      setMessageInput("");
      setIsChatOpen(false);
    }
  };

  return (
    <div className="min-h-screen bg-transparent text-gray-200 font-sans overflow-x-hidden relative selection:bg-cyan-500/30">
      <Toaster position="top-right" />

      {/* ðŸŒŒ Background Ambience (Dark & Moody) */}
      <div className="fixed inset-0 pointer-events-none -z-10 bg-[#020617]">
        <div className="absolute top-[-10%] left-[-10%] w-[600px] h-[600px] bg-indigo-600/10 rounded-full blur-[120px] animate-pulse"></div>
        <div className="absolute bottom-[-10%] right-[-10%] w-[600px] h-[600px] bg-cyan-600/10 rounded-full blur-[120px] delay-1000"></div>
        <div className="absolute top-[30%] left-[40%] w-[400px] h-[400px] bg-violet-600/5 rounded-full blur-[100px]"></div>
        <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-10 mix-blend-overlay"></div>
      </div>

      {/* ðŸš€ Header */}
      <header className="sticky top-0 z-40 bg-[#020617]/50 backdrop-blur-xl border-b border-white/5 px-6 py-4 shadow-lg">
        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
          <div className="flex items-center gap-4">
            <div className="p-2.5 bg-gradient-to-br from-indigo-500/20 to-purple-500/20 rounded-xl border border-white/10 shadow-[0_0_15px_rgba(99,102,241,0.2)]">
              <Activity className="text-indigo-400 w-6 h-6 animate-pulse" />
            </div>
            <div>
              <h1 className="text-xl font-bold tracking-widest text-white">
                LIVE{" "}
                <span className="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400">
                  SPY
                </span>
              </h1>
              <div className="flex items-center gap-2 mt-0.5">
                <div className="flex items-center gap-1.5">
                  <span className={`relative flex h-2 w-2`}>
                    <span
                      className={`animate-ping absolute inline-flex h-full w-full rounded-full opacity-75 ${isConnected ? "bg-emerald-400" : "bg-red-400"}`}
                    ></span>
                    <span
                      className={`relative inline-flex rounded-full h-2 w-2 ${isConnected ? "bg-emerald-500" : "bg-red-500"}`}
                    ></span>
                  </span>
                  <span
                    className={`text-[10px] font-mono uppercase tracking-widest font-semibold ${isConnected ? "text-emerald-400" : "text-red-400"}`}
                  >
                    {isConnected ? "System Online" : "Reconnecting"}
                  </span>
                </div>
              </div>
            </div>
          </div>
          <div className="flex items-center gap-3 bg-white/5 px-5 py-2 rounded-full border border-white/5 backdrop-blur-md shadow-inner">
            <Radio
              size={16}
              className={`text-cyan-400 ${activeUsers.length > 0 ? "animate-pulse" : ""}`}
            />
            <span className="text-sm font-medium text-gray-300">
              Active Targets:{" "}
              <span className="text-white text-lg font-bold ml-1">
                {activeUsers.length}
              </span>
            </span>
          </div>
        </div>
      </header>

      {/* ðŸ“¡ Activity Grid */}
      <main className="max-w-7xl mx-auto p-6 relative z-10">
        {activeUsers.length === 0 ? (
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="flex flex-col items-center justify-center h-[60vh] text-gray-500"
          >
            <div className="w-24 h-24 bg-white/5 rounded-full flex items-center justify-center mb-6 animate-pulse border border-white/5 shadow-[0_0_30px_rgba(255,255,255,0.05)]">
              <Wifi size={48} className="text-white/20" />
            </div>
            <h2 className="text-2xl font-bold text-gray-400 mb-2 tracking-tight">
              Scanning Network...
            </h2>
            <p className="text-sm font-mono text-gray-600 uppercase tracking-widest">
              Waiting for signals
            </p>
          </motion.div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            <AnimatePresence>
              {activeUsers.map((log) => {
                const meta = log.meta || {};
                const isTabActive = meta.isTabActive !== false;

                const isExitIntent = log.statusAction === "EXIT_INTENT";
                const isAddToCart = log.statusAction === "ADD_TO_CART";
                const isCheckout = log.statusAction === "CHECKOUT_INIT";

                const uniqueKey = log.userId || log.guestId || log.userName;
                const cartItems = log.cartData?.items || [];
                const cartTotal = log.cartData?.total || 0;

                // Dynamic Border Color
                const borderColor = isExitIntent
                  ? "border-red-500/50"
                  : isAddToCart
                    ? "border-emerald-500/50"
                    : "border-white/10";
                const shadowColor = isExitIntent
                  ? "shadow-red-900/20"
                  : isAddToCart
                    ? "shadow-emerald-900/20"
                    : "shadow-black/20";

                return (
                  <motion.div
                    key={uniqueKey}
                    layout
                    initial={{ opacity: 0, scale: 0.95, y: 20 }}
                    animate={{ opacity: 1, scale: 1, y: 0 }}
                    exit={{ opacity: 0, scale: 0.95 }}
                    whileHover={{ y: -5, transition: { duration: 0.2 } }}
                    transition={{ type: "spring", stiffness: 300, damping: 30 }}
                    className={`
                      relative rounded-[1.5rem] overflow-hidden backdrop-blur-xl border transition-all duration-300 shadow-xl group
                      bg-gray-900/60 ${borderColor} ${shadowColor}
                    `}
                  >
                    {/* Glowing Top Line */}
                    <div
                      className={`absolute top-0 left-0 right-0 h-[2px] bg-gradient-to-r from-transparent via-white/20 to-transparent opacity-50`}
                    ></div>

                    <div className="p-6 relative z-10">
                      {/* Top Row: User Info & Status */}
                      <div className="flex justify-between items-start mb-5">
                        <div className="flex items-center gap-4">
                          <div
                            className={`p-3 rounded-2xl border backdrop-blur-md shadow-lg ${meta.device === "Mobile" ? "bg-purple-500/20 border-purple-500/30 text-purple-300" : "bg-blue-500/20 border-blue-500/30 text-blue-300"}`}
                          >
                            {meta.device === "Mobile" ? (
                              <Smartphone size={20} />
                            ) : (
                              <Monitor size={20} />
                            )}
                          </div>
                          <div>
                            <h3 className="font-bold text-white text-base truncate max-w-[140px] flex items-center gap-2 tracking-tight">
                              {log.userName}
                              {log.userId ? (
                                <div className="bg-cyan-500/20 p-1 rounded-md border border-cyan-500/30">
                                  <User size={10} className="text-cyan-300" />
                                </div>
                              ) : (
                                <span className="text-[9px] bg-white/10 px-1.5 py-0.5 rounded text-gray-400 border border-white/5 uppercase tracking-wider">
                                  GUEST
                                </span>
                              )}
                            </h3>
                            <div className="flex items-center gap-1.5 text-xs text-gray-400 mt-1 font-medium">
                              <MapPin size={12} className="text-indigo-400" />
                              {meta.location || "Unknown Location"}
                            </div>
                          </div>
                        </div>

                        {/* Status Pill */}
                        <div
                          className={`px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wider border flex items-center gap-2 backdrop-blur-md shadow-lg
                          ${
                            isExitIntent
                              ? "bg-red-500/20 text-red-200 border-red-500/40"
                              : isAddToCart
                                ? "bg-emerald-500/20 text-emerald-200 border-emerald-500/40"
                                : isTabActive
                                  ? "bg-cyan-500/10 text-cyan-200 border-cyan-500/30"
                                  : "bg-white/5 text-gray-400 border-white/10"
                          }`}
                        >
                          <span
                            className={`w-1.5 h-1.5 rounded-full ${isExitIntent ? "bg-red-500 animate-ping" : isAddToCart ? "bg-emerald-500 animate-bounce" : isTabActive ? "bg-cyan-500 animate-pulse" : "bg-gray-500"}`}
                          ></span>
                          {isExitIntent
                            ? "LEAVING"
                            : isAddToCart
                              ? "BUYING"
                              : isTabActive
                                ? "ONLINE"
                                : "IDLE"}
                        </div>
                      </div>

                      {/* ðŸ”¥ðŸ”¥ðŸ”¥ UPDATED CART LIST (High Contrast) ðŸ”¥ðŸ”¥ðŸ”¥ */}
                      {cartItems.length > 0 && (
                        <div className="mb-5 bg-[#020617]/50 border border-white/10 rounded-xl overflow-hidden shadow-inner backdrop-blur-sm ring-1 ring-black/20">
                          {/* Header */}
                          <div className="bg-white/5 px-4 py-2.5 border-b border-white/5 flex justify-between items-center">
                            <span className="text-[10px] font-bold text-gray-400 uppercase tracking-widest flex items-center gap-1.5">
                              <ShoppingBag
                                size={12}
                                className="text-emerald-400"
                              />{" "}
                              Active Cart{" "}
                              <span className="bg-white/10 px-1.5 rounded text-white">
                                {cartItems.length}
                              </span>
                            </span>
                            <span className="text-xs font-bold text-emerald-300 bg-emerald-500/10 px-2 py-0.5 rounded border border-emerald-500/20">
                              â‚¹{cartTotal.toLocaleString()}
                            </span>
                          </div>

                          {/* List */}
                          <div className="max-h-[140px] overflow-y-auto p-2 space-y-1 custom-scrollbar">
                            {cartItems.map((item: any, idx: number) => (
                              <div
                                key={idx}
                                className="flex items-center gap-3 p-2 bg-white/5 hover:bg-white/10 rounded-lg border border-white/5 transition-all group/item"
                              >
                                {/* Image */}
                                <div className="w-10 h-10 rounded-lg bg-gray-800 flex-shrink-0 overflow-hidden border border-white/10 relative">
                                  {item.image ? (
                                    <img
                                      src={item.image}
                                      alt=""
                                      className="w-full h-full object-cover opacity-90 group-hover/item:opacity-100 transition-opacity"
                                    />
                                  ) : (
                                    <Package className="w-full h-full p-2.5 text-gray-600" />
                                  )}
                                </div>
                                {/* Details - Fixed Colors for Visibility */}
                                <div className="flex-1 min-w-0">
                                  <p className="text-sm font-bold text-gray-100 truncate group-hover/item:text-white transition-colors">
                                    {item.name || "Product Item"}
                                  </p>
                                  <div className="flex justify-between items-center mt-0.5">
                                    <p className="text-[11px] text-gray-400 font-mono">
                                      Qty: {item.qty || 1}
                                    </p>
                                    <p className="text-[11px] font-bold text-emerald-400">
                                      â‚¹{item.price}
                                    </p>
                                  </div>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* Current Action (Frosted Box) */}
                      <div className="bg-white/5 rounded-xl p-3 border border-white/5 mb-4 relative overflow-hidden backdrop-blur-sm">
                        <div className="flex items-center justify-between mb-1 relative z-10">
                          <span
                            className={`text-[10px] font-black uppercase tracking-widest flex items-center gap-1.5 ${isExitIntent ? "text-red-400" : isAddToCart ? "text-emerald-400" : "text-cyan-400"}`}
                          >
                            {isExitIntent ? (
                              <AlertTriangle size={12} />
                            ) : isAddToCart ? (
                              <ShoppingCart size={12} />
                            ) : (
                              <Zap size={12} />
                            )}
                            {log.action.replace("_", " ")}
                          </span>
                          <span className="text-[10px] text-gray-500 font-mono flex items-center gap-1">
                            <Clock size={10} />{" "}
                            {log.timestamp
                              ? format(new Date(log.timestamp), "HH:mm:ss")
                              : "Now"}
                          </span>
                        </div>
                        <p className="text-xs text-gray-300 font-mono truncate opacity-80 pl-2 border-l-2 border-white/20">
                          {log.path}
                        </p>
                      </div>

                      {/* Footer Actions */}
                      <div className="flex items-center justify-between">
                        <div className="flex gap-2">
                          {meta.battery && (
                            <div className="flex items-center gap-1.5 text-[10px] text-gray-400 font-mono bg-white/5 px-2.5 py-1 rounded-lg border border-white/5">
                              <Battery
                                size={10}
                                className={
                                  parseInt(meta.battery) < 20
                                    ? "text-red-500"
                                    : "text-emerald-500"
                                }
                              />{" "}
                              {meta.battery}
                            </div>
                          )}
                        </div>
                        {log.userId && (
                          <button
                            onClick={() =>
                              openChatModal(log.userId, log.userName)
                            }
                            className="text-xs font-bold flex items-center gap-1.5 bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-xl shadow-lg shadow-indigo-500/20 transition-all hover:scale-105 active:scale-95 border border-indigo-400/20"
                          >
                            Message <ChevronRight size={12} />
                          </button>
                        )}
                      </div>
                    </div>
                  </motion.div>
                );
              })}
            </AnimatePresence>
          </div>
        )}
      </main>

      {/* ========================================================== */}
      {/* ðŸ”¥ MODERN GLASS POPUP (Fixed Backdrop & Text) */}
      {/* ========================================================== */}
      <AnimatePresence>
        {incomingReply && (
          <div className="fixed inset-0 z-[10000] flex items-center justify-center p-6">
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              className="absolute inset-0 bg-black/80 backdrop-blur-lg" // Darker blur
              onClick={() => setIncomingReply(null)}
            />

            <motion.div
              initial={{ opacity: 0, scale: 0.9, y: 50 }}
              animate={{ opacity: 1, scale: 1, y: 0 }}
              exit={{ opacity: 0, scale: 0.9, y: 50 }}
              transition={{ type: "spring", stiffness: 300, damping: 25 }}
              className="relative w-full max-w-md bg-[#0F172A] border border-white/10 rounded-[2rem] shadow-[0_0_60px_-15px_rgba(16,185,129,0.3)] overflow-hidden"
            >
              {/* Glows */}
              <div className="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-emerald-500 via-teal-400 to-cyan-500"></div>
              <div className="absolute -top-20 -left-20 w-40 h-40 bg-emerald-500/20 rounded-full blur-[80px]"></div>

              <div className="p-8 relative z-10">
                <div className="flex items-center gap-4 mb-6">
                  <div className="bg-gradient-to-br from-emerald-500 to-teal-600 p-3.5 rounded-2xl shadow-lg text-white border border-white/10">
                    <Sparkles size={26} fill="white" />
                  </div>
                  <div>
                    <h3 className="text-xl font-black text-white tracking-tight">
                      New Message
                    </h3>
                    <div className="flex items-center gap-1.5 mt-1">
                      <div className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
                      <p className="text-sm text-emerald-400 font-bold">
                        {incomingReply.userName}
                      </p>
                    </div>
                  </div>
                </div>

                <div className="bg-white/5 border border-white/5 rounded-2xl p-6 mb-6 backdrop-blur-md">
                  <p className="text-white text-lg leading-relaxed font-medium">
                    "{incomingReply.message}"
                  </p>
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={() => setIncomingReply(null)}
                    className="flex-1 py-3.5 rounded-xl text-sm font-bold text-gray-400 hover:text-white hover:bg-white/5 transition-all border border-white/5"
                  >
                    Dismiss
                  </button>
                  <button
                    onClick={() =>
                      openChatModal(
                        incomingReply.userId,
                        incomingReply.userName,
                      )
                    }
                    className="flex-[1.5] py-3.5 rounded-xl text-sm font-bold text-white bg-gradient-to-r from-emerald-600 to-teal-600 hover:shadow-lg hover:shadow-emerald-500/20 transition-all flex items-center justify-center gap-2 border-t border-white/20"
                  >
                    <Send size={16} /> Quick Reply
                  </button>
                </div>
              </div>
            </motion.div>
          </div>
        )}
      </AnimatePresence>

      {/* ðŸ’¬ Admin Chat Modal (Fixed Contrast) */}
      <AnimatePresence>
        {isChatOpen && (
          <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-md p-4">
            <motion.div
              initial={{ opacity: 0, scale: 0.95 }}
              animate={{ opacity: 1, scale: 1 }}
              exit={{ opacity: 0, scale: 0.95 }}
              className="bg-[#0a0a0a] border border-white/10 p-0 rounded-3xl w-full max-w-md shadow-2xl overflow-hidden ring-1 ring-white/10"
            >
              <div className="flex justify-between items-center p-5 border-b border-white/5 bg-white/5">
                <h3 className="text-lg font-bold text-white">
                  Chat with {targetUserName}
                </h3>
                <button
                  onClick={() => setIsChatOpen(false)}
                  className="text-gray-400 hover:text-white transition-colors bg-white/5 p-1.5 rounded-full"
                >
                  <X size={18} />
                </button>
              </div>
              <div className="p-5">
                <textarea
                  value={messageInput}
                  onChange={(e) => setMessageInput(e.target.value)}
                  placeholder="Type a message..."
                  className="w-full h-32 bg-white/5 border border-white/10 rounded-xl p-4 text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 focus:outline-none transition-all placeholder-gray-500 font-medium resize-none"
                  autoFocus
                />
              </div>
              <div className="p-5 pt-0 flex justify-end gap-3">
                <button
                  onClick={() => setIsChatOpen(false)}
                  className="px-5 py-2.5 text-gray-400 hover:text-white text-sm font-bold hover:bg-white/5 rounded-xl transition-all"
                >
                  Cancel
                </button>
                <button
                  onClick={handleSendMessage}
                  disabled={!messageInput.trim()}
                  className="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-bold rounded-xl shadow-lg flex items-center gap-2 transition-all active:scale-95"
                >
                  <Send size={16} /> Send
                </button>
              </div>
            </motion.div>
          </div>
        )}
      </AnimatePresence>
    </div>
  );
}
</file>

<file path=".gitignore">
# Dependencies
/node_modules
/.pnp
.pnp.js

# Testing
/coverage

# Next.js
/.next/
/out/

# Production
/build
/dist   # (optional â€“ future use)

# Misc
.DS_Store
*.pem

# Debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*

# Local env files
.env
.env*.local

# Vercel
.vercel

# TypeScript
*.tsbuildinfo
next-env.d.ts

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# OS
Thumbs.db
</file>

<file path="API_INTEGRATION_GUIDE.md">
# ðŸ”Œ API Integration Guide

## Overview
This document explains how the Hyundai Admin Dashboard integrates with your Node.js backend.

## Authentication Flow

### Admin Login
```typescript
import { AdminAuthService } from '@/lib/api';

// Login
const response = await AdminAuthService.login({
  email: 'admin@hyundaispares.com',
  password: 'Admin@12345'
});

// Store token
localStorage.setItem('token', response.data.data.token);
```

### Token Management
- Tokens are stored in `localStorage`
- Automatically added to all API requests via axios interceptor
- On 401 response, user is redirected to login page

## API Services

### 1. AdminAuthService
```typescript
AdminAuthService.login(credentials)
AdminAuthService.getProfile()
AdminAuthService.updateProfile(data)
AdminAuthService.changePassword(data)
AdminAuthService.logout()
```

### 2. ProductService
```typescript
// Get all products with filters
ProductService.getAll({
  page: 1,
  limit: 20,
  category: 'Brake',
  search: 'brake pad',
  sortBy: 'createdAt',
  order: 'desc'
})

// CRUD operations
ProductService.getById(id)
ProductService.create(formData) // FormData for images
ProductService.update(id, formData)
ProductService.updateStock(id, stock)
ProductService.delete(id)
ProductService.deleteImage(productId, imageId)
ProductService.getLowStock()
```

### 3. OrderService
```typescript
// Get all orders (Admin)
OrderService.getAllOrders({
  page: 1,
  limit: 20,
  status: 'Placed',
  sortBy: 'createdAt',
  order: 'desc'
})

// Order management
OrderService.getById(id)
OrderService.updateStatus(id, {
  orderStatus: 'Packed',
  note: 'Order has been packed'
})

// Invoice download (returns Blob)
const blob = await OrderService.getInvoice(orderId)
// Helper function for download
downloadInvoice(orderId, orderNumber)
```

### 4. PaymentService
```typescript
PaymentService.getAllPayments({ page: 1, limit: 20 })
PaymentService.getByOrderId(orderId)
PaymentService.getPaymentMethods() // Stats
```

### 5. DashboardService
```typescript
// Statistics
DashboardService.getStats()

// Revenue analytics
DashboardService.getMonthlyRevenue({ year: 2024 })
DashboardService.getDailyRevenue({ month: 12, year: 2024 })

// Recent data
DashboardService.getRecentOrders(5)
DashboardService.getLowStockProducts()
DashboardService.getTopSellingProducts(5)

// Analytics
DashboardService.getSalesByCategory()
DashboardService.getCustomerGrowth()
```

## Real-time Features (Socket.io)

### Socket Provider Setup
The dashboard uses a global `SocketProvider` that handles all real-time events:

```typescript
import { useSocket } from '@/components/providers/SocketProvider';

function MyComponent() {
  const { socket, isConnected, joinOrderRoom, leaveOrderRoom } = useSocket();
  
  // Join specific order room for updates
  useEffect(() => {
    if (orderId) {
      joinOrderRoom(orderId);
      return () => leaveOrderRoom(orderId);
    }
  }, [orderId]);
}
```

### Events Listened By Dashboard

#### 1. new_order (Admin Only)
Triggered when a customer places a new order.
```typescript
// Automatically handled by SocketProvider
// Shows animated toast with sound effect
{
  orderNumber: 'ORD20241226001',
  totalAmount: 7078,
  user: { name: 'Customer Name' }
}
```

#### 2. order_status_updated
Triggered when order status changes.
```typescript
{
  orderId: '...',
  orderNumber: 'ORD20241226001',
  orderStatus: 'Packed',
  previousStatus: 'Placed'
}
```

#### 3. payment_success
Triggered when payment is completed.
```typescript
{
  orderNumber: 'ORD20241226001',
  amount: 7078,
  paymentMethod: 'Razorpay'
}
```

#### 4. payment_failed
Triggered when payment fails.
```typescript
{
  orderNumber: 'ORD20241226001',
  reason: 'Payment declined'
}
```

#### 5. low_stock_alert
Triggered when product stock goes below threshold.
```typescript
{
  productId: '...',
  productName: 'Brake Pad Set',
  stock: 3,
  threshold: 10
}
```

### Socket Authentication
The socket connection is automatically authenticated using the JWT token from localStorage:

```typescript
const socketInstance = io('http://localhost:5000', {
  auth: {
    token: localStorage.getItem('token')
  },
  transports: ['websocket']
});
```

## Response Format

### Success Response
```json
{
  "success": true,
  "message": "Operation successful",
  "data": {
    // Response data
  }
}
```

### Error Response
```json
{
  "success": false,
  "message": "Error message",
  "error": "Detailed error"
}
```

## Error Handling

All API calls are wrapped in try-catch blocks:

```typescript
try {
  const response = await ProductService.getAll();
  setProducts(response.data.data || response.data);
} catch (error: any) {
  console.error('API Error:', error);
  toast.error(error.response?.data?.message || 'Operation failed');
  
  // Optional: Fallback to mock data for development
  setProducts(mockData);
}
```

## Invoice Download Implementation

The invoice download uses blob response type:

```typescript
// In api.ts
getInvoice: async (orderId: string): Promise<Blob> => {
  const response = await api.get(`/orders/${orderId}/invoice`, {
    responseType: 'blob',
  });
  return response.data;
}

// Helper function
export const downloadInvoice = async (orderId: string, orderNumber: string) => {
  const blob = await OrderService.getInvoice(orderId);
  const url = window.URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `Invoice_${orderNumber}.pdf`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  window.URL.revokeObjectURL(url);
};
```

## Environment Variables

Required in `.env.local`:

```env
NEXT_PUBLIC_API_URL=http://localhost:5000/api
NEXT_PUBLIC_SOCKET_URL=http://localhost:5000
```

## Testing API Integration

### 1. Check Backend is Running
```bash
curl http://localhost:5000/api/health
```

### 2. Test Admin Login
```bash
curl -X POST http://localhost:5000/api/admin/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@hyundaispares.com","password":"Admin@12345"}'
```

### 3. Test Protected Route
```bash
curl http://localhost:5000/api/dashboard/stats \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 4. Test Socket Connection
Open browser console in dashboard and check for:
```
âœ… Socket connected: <socket-id>
ðŸŽ‰ Connected to server: { userId: '...', role: 'admin' }
```

## Common Issues & Solutions

### Issue: CORS Error
**Solution:** Ensure backend has CORS configured for `http://localhost:3000`

### Issue: 401 Unauthorized
**Solution:** 
- Check token is stored: `localStorage.getItem('token')`
- Verify token format in request headers
- Token may have expired (15 min default)

### Issue: Socket Not Connecting
**Solution:**
- Verify backend Socket.io server is running
- Check NEXT_PUBLIC_SOCKET_URL is correct
- Ensure token is valid for socket authentication

### Issue: Invoice Download Fails
**Solution:**
- Check backend invoice generation is working
- Verify `/orders/:id/invoice` endpoint returns PDF
- Check browser console for blob creation errors

## Development vs Production

### Development
- Uses mock data fallbacks if API fails
- Detailed error logging in console
- CORS typically allows localhost

### Production
- Remove mock data fallbacks
- Configure proper error tracking (Sentry, etc.)
- Set up proper CORS origins
- Use environment-specific API URLs

## API Rate Limiting

Your backend may have rate limiting. Handle it:

```typescript
api.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 429) {
      toast.error('Too many requests. Please wait and try again.');
    }
    return Promise.reject(error);
  }
);
```

## Next Steps

1. âœ… Ensure your backend is running on port 5000
2. âœ… Test admin login with default credentials
3. âœ… Verify Socket.io connection in browser console
4. âœ… Test each API endpoint individually
5. âœ… Check real-time notifications are working
6. âœ… Test invoice download functionality
7. âœ… Monitor network tab for API calls

---

**Need Help?**
- Check browser console for errors
- Verify network tab shows correct API calls
- Ensure backend logs don't show errors
- Test API endpoints with Postman/Thunder Client first
</file>

<file path="app/dashboard/abandoned-carts/page.tsx">
"use client";

import { useEffect, useState } from "react";
import { DashboardService, CartService } from "@/lib/api"; // Ensure CartService is exported in api.ts
import { formatCurrency } from "@/lib/utils";
import { formatDistanceToNow } from "date-fns";
import { Mail, CheckCircle, Clock, AlertTriangle, Loader2 } from "lucide-react";
import { toast } from "sonner";

interface AbandonedCart {
  _id: string;
  user: {
    name: string;
    email: string;
    phone: string;
  };
  items: {
    product: {
      name: string;
      images: { url: string }[];
      price: number;
    };
    quantity: number;
  }[];
  totalAmount: number;
  lastActiveAt: string;
  isReminderSent: boolean;
}

export default function AbandonedCartsPage() {
  const [carts, setCarts] = useState<AbandonedCart[]>([]);
  const [loading, setLoading] = useState(true);
  const [sendingId, setSendingId] = useState<string | null>(null);

  // 1. Fetch Data
  const fetchCarts = async () => {
    try {
      const res = await CartService.getAbandonedCarts();
      setCarts(res.data?.data || []);
    } catch (error) {
      console.error("Error fetching carts:", error);
      toast.error("Failed to load abandoned carts");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchCarts();
  }, []);

  // 2. Handle "Send Mail" Click
  const handleSendMail = async (cartId: string) => {
    setSendingId(cartId);
    try {
      await CartService.sendRecoveryEmail(cartId);
      toast.success("Recovery email sent successfully!");

      // Update UI locally (No need to refresh)
      setCarts((prev) =>
        prev.map((c) =>
          c._id === cartId ? { ...c, isReminderSent: true } : c,
        ),
      );
    } catch (error: any) {
      toast.error(error.response?.data?.message || "Failed to send email");
    } finally {
      setSendingId(null);
    }
  };

  if (loading) {
    return (
      <div className="flex h-96 items-center justify-center">
        <Loader2 className="animate-spin text-blue-500 h-8 w-8" />
      </div>
    );
  }

  return (
    <div className="space-y-6 pb-10">
      {/* Header */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
          <h1 className="text-3xl font-bold text-white tracking-tight">
            Abandoned Carts
          </h1>
          <p className="mt-1 text-gray-400 text-sm">
            Recover lost sales by reminding customers about items left in their
            cart.
          </p>
        </div>
        <div className="px-4 py-2 bg-red-500/10 border border-red-500/20 rounded-xl text-red-400 text-sm font-medium flex items-center gap-2">
          <AlertTriangle className="h-4 w-4" />
          {carts.length} Potential Orders Lost
        </div>
      </div>

      {/* Table Card */}
      <div className="rounded-2xl border border-white/10 bg-white/[0.03] backdrop-blur-md overflow-hidden">
        <div className="overflow-x-auto">
          <table className="w-full text-left border-collapse">
            <thead className="bg-white/5 text-gray-400 text-xs uppercase font-semibold">
              <tr>
                <th className="px-6 py-4">Customer</th>
                <th className="px-6 py-4">Cart Items</th>
                <th className="px-6 py-4">Value</th>
                <th className="px-6 py-4">Inactive Since</th>
                <th className="px-6 py-4 text-right">Action</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-white/5 text-sm text-gray-300">
              {carts.length > 0 ? (
                carts.map((cart) => (
                  <tr key={cart._id} className="hover:bg-white/5 transition">
                    {/* Customer Info */}
                    <td className="px-6 py-4">
                      <p className="font-medium text-white">
                        {cart.user?.name || "Unknown"}
                      </p>
                      <p className="text-xs text-gray-500">
                        {cart.user?.email}
                      </p>
                    </td>

                    {/* Items Preview */}
                    <td className="px-6 py-4">
                      <div className="flex -space-x-2 overflow-hidden">
                        {cart.items.slice(0, 3).map((item, i) => (
                          <img
                            key={i}
                            src={
                              item.product?.images?.[0]?.url ||
                              "/placeholder.png"
                            }
                            alt={item.product?.name}
                            className="inline-block h-8 w-8 rounded-full ring-2 ring-[#0f0f11] object-cover"
                            title={item.product?.name}
                          />
                        ))}
                        {cart.items.length > 3 && (
                          <div className="flex h-8 w-8 items-center justify-center rounded-full bg-gray-800 ring-2 ring-[#0f0f11] text-xs font-medium text-white">
                            +{cart.items.length - 3}
                          </div>
                        )}
                      </div>
                      <p className="text-xs text-gray-500 mt-1">
                        {cart.items.length} items
                      </p>
                    </td>

                    {/* Value */}
                    <td className="px-6 py-4 font-mono text-white">
                      {formatCurrency(cart.totalAmount)}
                    </td>

                    {/* Time */}
                    <td className="px-6 py-4 text-gray-400 flex items-center gap-2">
                      <Clock className="h-3 w-3" />
                      {formatDistanceToNow(new Date(cart.lastActiveAt), {
                        addSuffix: true,
                      })}
                    </td>

                    {/* Action Button */}
                    <td className="px-6 py-4 text-right">
                      {cart.isReminderSent ? (
                        <button
                          disabled
                          className="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-green-500/20 text-green-400 text-xs font-medium cursor-not-allowed opacity-80"
                        >
                          <CheckCircle className="h-3.5 w-3.5" /> Sent
                        </button>
                      ) : (
                        <button
                          onClick={() => handleSendMail(cart._id)}
                          disabled={sendingId === cart._id}
                          className="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-blue-600 hover:bg-blue-500 text-white text-xs font-medium transition-all shadow-lg shadow-blue-900/20 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          {sendingId === cart._id ? (
                            <>
                              <Loader2 className="h-3.5 w-3.5 animate-spin" />{" "}
                              Sending...
                            </>
                          ) : (
                            <>
                              <Mail className="h-3.5 w-3.5" /> Send Reminder
                            </>
                          )}
                        </button>
                      )}
                    </td>
                  </tr>
                ))
              ) : (
                <tr>
                  <td colSpan={5} className="text-center py-12 text-gray-500">
                    <div className="flex flex-col items-center gap-2">
                      <CheckCircle className="h-8 w-8 text-green-500/50" />
                      <p>No abandoned carts found! Good job.</p>
                    </div>
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/dashboard/analytics/page.tsx">
"use client";

import { useEffect, useState } from "react";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
  LineChart,
  Line,
  PieChart,
  Pie,
  Cell,
  AreaChart,
  Area,
} from "recharts";
import {
  DollarSign,
  ShoppingCart,
  Users,
  Clock,
  Download,
  Calendar,
  MapPin,
  CreditCard,
  TrendingUp,
  AlertTriangle,
  PackageX,
  Zap,
} from "lucide-react";
import { formatCurrency } from "@/lib/utils";
import { DashboardService } from "@/lib/api";
import { toast } from "sonner";

// --- Colors for Charts ---
const COLORS = [
  "#3B82F6",
  "#10B981",
  "#F59E0B",
  "#EF4444",
  "#8B5CF6",
  "#EC4899",
];

// --- Types ---
type DateRangeOption = "7days" | "30days" | "thisMonth" | "lastMonth" | "all";
type InventoryTab = "low" | "dead" | "fast";

export default function AnalyticsPage() {
  const [loading, setLoading] = useState(true);

  // State for Data
  const [kpi, setKpi] = useState<any>({});
  const [funnelData, setFunnelData] = useState<any[]>([]);
  const [paymentData, setPaymentData] = useState<any[]>([]);
  const [geoData, setGeoData] = useState<any[]>([]);
  const [inventoryData, setInventoryData] = useState<any>({
    lowStock: [],
    deadStock: [],
    fastMoving: [],
  });
  const [customerGrowth, setCustomerGrowth] = useState<any[]>([]);
  const [salesByCategory, setSalesByCategory] = useState<any[]>([]);

  // Filter States
  const [dateRange, setDateRange] = useState<DateRangeOption>("30days");
  const [activeInvTab, setActiveInvTab] = useState<InventoryTab>("low");

  // --- Helper: Get Date Objects based on selection ---
  const getDateParams = () => {
    const end = new Date();
    const start = new Date();

    switch (dateRange) {
      case "7days":
        start.setDate(end.getDate() - 7);
        break;
      case "30days":
        start.setDate(end.getDate() - 30);
        break;
      case "thisMonth":
        start.setDate(1);
        break;
      case "lastMonth":
        start.setMonth(start.getMonth() - 1);
        start.setDate(1);
        end.setDate(0);
        break;
      case "all":
        return {}; // No filter
    }
    return { startDate: start.toISOString(), endDate: end.toISOString() };
  };

  // --- Fetch Data ---
  useEffect(() => {
    const fetchData = async () => {
      try {
        setLoading(true);
        const dateParams = getDateParams();

        // Parallel API Calls
        const [advancedRes, invRes, growthRes, categoryRes] = await Promise.all(
          [
            DashboardService.getAdvancedAnalytics(dateParams),
            DashboardService.getInventoryHealth(), // Inventory usually doesn't depend on date range filter
            DashboardService.getCustomerGrowth(dateParams),
            DashboardService.getSalesByCategory(dateParams),
          ],
        );

        // 1. Process Advanced Analytics (KPI, Funnel, Geo, Payments)
        const advData = advancedRes.data?.data || {};
        setKpi(advData.kpi || {});
        setFunnelData(advData.funnel || []);
        setGeoData(advData.geo || []);
        setPaymentData(advData.paymentMethods || []);

        // 2. Process Inventory
        const inv = invRes.data?.data || {};
        setInventoryData({
          lowStock: inv.lowStock?.products || [],
          deadStock: inv.deadStock?.products || [],
          fastMoving: inv.fastMoving || [],
        });

        // 3. Process Growth
        const growth = growthRes.data?.data?.data || [];
        setCustomerGrowth(
          growth.map((item: any) => ({
            name: `${item._id.year}-${String(item._id.month).padStart(2, "0")}-${String(item._id.day || 1).padStart(2, "0")}`,
            value: item.newCustomers,
          })),
        );

        // 4. Sales Category
        setSalesByCategory(categoryRes.data?.data?.data || []);
      } catch (error) {
        console.error("Analytics fetch error:", error);
        toast.error("Failed to load analytics data");
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [dateRange]); // Re-run when date filter changes

  // --- Export Handler ---
  const handleExport = async () => {
    try {
      toast.loading("Preparing report...");
      const dateParams = getDateParams();
      const res = await DashboardService.getExportData(dateParams);

      // Convert JSON to CSV logic (Simplified)
      const orders = res.data?.data?.orders || [];
      if (orders.length === 0) {
        toast.dismiss();
        toast.info("No data to export for this period");
        return;
      }

      const headers = [
        "Order ID",
        "Date",
        "Customer",
        "Amount",
        "Status",
        "Payment",
      ];
      const csvContent = [
        headers.join(","),
        ...orders.map((o: any) =>
          [
            o.orderNumber,
            new Date(o.createdAt).toLocaleDateString(),
            o.user?.name || "Guest",
            o.totalAmount,
            o.orderStatus,
            o.paymentMethod,
          ].join(","),
        ),
      ].join("\n");

      const blob = new Blob([csvContent], { type: "text/csv" });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `sales-report-${dateRange}.csv`;
      a.click();
      toast.dismiss();
      toast.success("Report downloaded");
    } catch (e) {
      toast.dismiss();
      toast.error("Export failed");
    }
  };

  if (loading) {
    return (
      <div className="p-8 text-center text-gray-400 animate-pulse">
        Loading Analytics...
      </div>
    );
  }

  return (
    <div className="space-y-6 pb-20 px-2 md:px-0">
      {/* --- HEADER: Title & Filters --- */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 className="text-3xl font-bold text-white">Business Analytics</h1>
          <p className="text-gray-400 mt-1 text-sm">
            Performance metrics and insights
          </p>
        </div>

        <div className="flex flex-wrap items-center gap-3">
          {/* Date Filter Dropdown */}
          <div className="relative">
            <Calendar className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
            <select
              value={dateRange}
              onChange={(e) => setDateRange(e.target.value as DateRangeOption)}
              className="pl-10 pr-4 py-2 bg-white/5 border border-white/10 rounded-xl text-sm text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 appearance-none cursor-pointer hover:bg-white/10 transition-colors"
            >
              <option value="7days" className="bg-gray-900">
                Last 7 Days
              </option>
              <option value="30days" className="bg-gray-900">
                Last 30 Days
              </option>
              <option value="thisMonth" className="bg-gray-900">
                This Month
              </option>
              <option value="lastMonth" className="bg-gray-900">
                Last Month
              </option>
              <option value="all" className="bg-gray-900">
                All Time
              </option>
            </select>
          </div>

          {/* Export Button */}
          <button
            onClick={handleExport}
            className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl text-sm font-medium transition-colors"
          >
            <Download className="h-4 w-4" />
            Export Report
          </button>
        </div>
      </div>

      {/* --- 1. KPI CARDS (AOV & LTV Added) --- */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <KPICard
          title="Total Revenue"
          value={formatCurrency(kpi.totalRevenue || 0)}
          icon={DollarSign}
          trend="+12% vs last period" // Static for now, can be dynamic
          color="text-emerald-400"
          bg="bg-emerald-400/10"
        />
        <KPICard
          title="Total Orders"
          value={kpi.totalOrders || 0}
          icon={ShoppingCart}
          trend="Order Volume"
          color="text-blue-400"
          bg="bg-blue-400/10"
        />
        <KPICard
          title="Avg. Order Value"
          value={formatCurrency(Math.round(kpi.avgOrderValue || 0))}
          icon={TrendingUp}
          trend="Per Transaction"
          color="text-purple-400"
          bg="bg-purple-400/10"
        />
        <KPICard
          title="Customer LTV"
          value={formatCurrency(Math.round(kpi.customerLTV || 0))}
          icon={Users}
          trend="Lifetime Value"
          color="text-amber-400"
          bg="bg-amber-400/10"
        />
      </div>

      {/* --- 2. MAIN CHARTS (Growth & Payments) --- */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Customer Growth Chart */}
        <div className="lg:col-span-2 bg-gray-900/50 border border-white/10 rounded-2xl p-6 backdrop-blur-sm">
          <h3 className="text-lg font-semibold text-white mb-6 flex items-center gap-2">
            <Users className="h-5 w-5 text-blue-400" /> Customer Acquisition
          </h3>
          <div className="h-72">
            <ResponsiveContainer width="100%" height="100%">
              <AreaChart data={customerGrowth}>
                <defs>
                  <linearGradient id="colorGrowth" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="5%" stopColor="#3B82F6" stopOpacity={0.3} />
                    <stop offset="95%" stopColor="#3B82F6" stopOpacity={0} />
                  </linearGradient>
                </defs>
                <CartesianGrid
                  strokeDasharray="3 3"
                  stroke="#374151"
                  vertical={false}
                />
                <XAxis
                  dataKey="name"
                  stroke="#9CA3AF"
                  fontSize={12}
                  tickLine={false}
                  axisLine={false}
                />
                <YAxis
                  stroke="#9CA3AF"
                  fontSize={12}
                  tickLine={false}
                  axisLine={false}
                />
                <Tooltip
                  contentStyle={{
                    backgroundColor: "#111827",
                    borderColor: "#374151",
                    borderRadius: "8px",
                    color: "#fff",
                  }}
                />
                <Area
                  type="monotone"
                  dataKey="value"
                  stroke="#3B82F6"
                  strokeWidth={3}
                  fillOpacity={1}
                  fill="url(#colorGrowth)"
                />
              </AreaChart>
            </ResponsiveContainer>
          </div>
        </div>

        {/* Payment Methods Pie Chart */}
        <div className="bg-gray-900/50 border border-white/10 rounded-2xl p-6 backdrop-blur-sm">
          <h3 className="text-lg font-semibold text-white mb-6 flex items-center gap-2">
            <CreditCard className="h-5 w-5 text-emerald-400" /> Payment Split
          </h3>
          <div className="h-72 relative">
            <ResponsiveContainer width="100%" height="100%">
              <PieChart>
                <Pie
                  data={paymentData}
                  cx="50%"
                  cy="50%"
                  innerRadius={60}
                  outerRadius={100}
                  paddingAngle={5}
                  dataKey="count"
                  nameKey="_id"
                >
                  {paymentData.map((entry, index) => (
                    <Cell
                      key={`cell-${index}`}
                      fill={entry._id === "COD" ? "#F59E0B" : "#10B981"}
                    />
                  ))}
                </Pie>
                <Tooltip
                  formatter={(value: number) => [value, "Orders"]}
                  contentStyle={{
                    backgroundColor: "#111827",
                    borderColor: "#374151",
                    color: "#fff",
                  }}
                />
                <Legend verticalAlign="bottom" height={36} />
              </PieChart>
            </ResponsiveContainer>
            {/* Center Text */}
            <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center pointer-events-none">
              <span className="text-2xl font-bold text-white">
                {kpi.totalOrders}
              </span>
              <p className="text-xs text-gray-400">Total</p>
            </div>
          </div>
        </div>
      </div>

      {/* --- 3. ADVANCED ANALYSIS (Funnel & Geo) --- */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Order Status Funnel */}
        <div className="bg-gray-900/50 border border-white/10 rounded-2xl p-6">
          <h3 className="text-lg font-semibold text-white mb-6">
            Order Status Funnel
          </h3>
          <div className="h-64">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={funnelData}
                layout="vertical"
                margin={{ left: 20 }}
              >
                <CartesianGrid
                  strokeDasharray="3 3"
                  stroke="#374151"
                  horizontal={false}
                />
                <XAxis type="number" stroke="#9CA3AF" hide />
                <YAxis
                  dataKey="_id"
                  type="category"
                  stroke="#9CA3AF"
                  width={80}
                  tick={{ fill: "#E5E7EB" }}
                />
                <Tooltip
                  cursor={{ fill: "rgba(255,255,255,0.05)" }}
                  contentStyle={{
                    backgroundColor: "#111827",
                    borderColor: "#374151",
                    color: "#fff",
                  }}
                />
                <Bar
                  dataKey="count"
                  fill="#8B5CF6"
                  radius={[0, 4, 4, 0]}
                  barSize={20}
                />
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>

        {/* Top Cities (Geo) */}
        <div className="bg-gray-900/50 border border-white/10 rounded-2xl p-6">
          <h3 className="text-lg font-semibold text-white mb-6 flex items-center gap-2">
            <MapPin className="h-5 w-5 text-red-400" /> Top Cities by Sales
          </h3>
          <div className="space-y-4">
            {geoData.map((city, idx) => (
              <div key={idx} className="relative">
                <div className="flex justify-between items-center text-sm mb-1">
                  <span className="text-gray-300 font-medium">
                    {city._id || "Unknown"}
                  </span>
                  <span className="text-white font-bold">
                    {formatCurrency(city.revenue)}
                  </span>
                </div>
                <div className="w-full bg-gray-700 rounded-full h-2">
                  <div
                    className="bg-gradient-to-r from-red-500 to-pink-500 h-2 rounded-full transition-all duration-500"
                    style={{
                      width: `${(city.revenue / kpi.totalRevenue) * 100}%`,
                    }}
                  />
                </div>
              </div>
            ))}
            {geoData.length === 0 && (
              <p className="text-gray-500 text-center py-4">
                No location data available
              </p>
            )}
          </div>
        </div>
      </div>

      {/* --- 4. INVENTORY HEALTH SECTION --- */}
      <div className="bg-gray-900/50 border border-white/10 rounded-2xl p-6 overflow-hidden">
        <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
          <h3 className="text-lg font-semibold text-white">Inventory Health</h3>

          {/* Inventory Tabs */}
          <div className="flex bg-black/40 p-1 rounded-lg w-fit">
            <button
              onClick={() => setActiveInvTab("low")}
              className={`px-4 py-1.5 text-xs font-medium rounded-md transition-all flex items-center gap-2 ${activeInvTab === "low" ? "bg-red-500/20 text-red-400 shadow-sm" : "text-gray-400 hover:text-white"}`}
            >
              <AlertTriangle className="h-3 w-3" /> Low Stock
            </button>
            <button
              onClick={() => setActiveInvTab("dead")}
              className={`px-4 py-1.5 text-xs font-medium rounded-md transition-all flex items-center gap-2 ${activeInvTab === "dead" ? "bg-gray-600/20 text-gray-300 shadow-sm" : "text-gray-400 hover:text-white"}`}
            >
              <PackageX className="h-3 w-3" /> Dead Stock
            </button>
            <button
              onClick={() => setActiveInvTab("fast")}
              className={`px-4 py-1.5 text-xs font-medium rounded-md transition-all flex items-center gap-2 ${activeInvTab === "fast" ? "bg-green-500/20 text-green-400 shadow-sm" : "text-gray-400 hover:text-white"}`}
            >
              <Zap className="h-3 w-3" /> Fast Moving
            </button>
          </div>
        </div>

        <div className="overflow-x-auto">
          <table className="w-full text-left">
            <thead className="bg-white/5 text-gray-400 text-xs uppercase font-semibold">
              <tr>
                <th className="px-6 py-4 rounded-tl-lg">Product</th>
                <th className="px-6 py-4">Stock</th>
                <th className="px-6 py-4">Price</th>
                <th className="px-6 py-4 rounded-tr-lg">Metric</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-white/5 text-sm">
              {/* Logic to choose which array to map based on activeTab */}
              {(activeInvTab === "low"
                ? inventoryData.lowStock
                : activeInvTab === "dead"
                  ? inventoryData.deadStock
                  : inventoryData.fastMoving
              ).map((item: any, idx: number) => (
                <tr
                  key={item._id || idx}
                  className="hover:bg-white/5 transition"
                >
                  <td className="px-6 py-4">
                    <div className="flex items-center gap-3">
                      <div className="h-10 w-10 bg-gray-800 rounded-lg overflow-hidden flex-shrink-0">
                        {item.images?.[0] && (
                          <img
                            src={item.images[0].url}
                            alt=""
                            className="h-full w-full object-cover"
                          />
                        )}
                      </div>
                      <div>
                        <p className="text-white font-medium line-clamp-1">
                          {item.name}
                        </p>
                        <p className="text-xs text-gray-500">
                          {item.partNumber}
                        </p>
                      </div>
                    </div>
                  </td>
                  <td className="px-6 py-4">
                    <span
                      className={`px-2 py-1 rounded-full text-xs font-medium ${item.stock <= 5 ? "bg-red-500/10 text-red-400" : "bg-green-500/10 text-green-400"}`}
                    >
                      {item.stock} Units
                    </span>
                  </td>
                  <td className="px-6 py-4 text-white font-medium">
                    {formatCurrency(item.price)}
                  </td>
                  <td className="px-6 py-4 text-gray-400">
                    {activeInvTab === "fast"
                      ? `${item.totalSales} Sold`
                      : activeInvTab === "dead"
                        ? `Since ${new Date(item.createdAt).toLocaleDateString()}`
                        : "Reorder Now"}
                  </td>
                </tr>
              ))}
              {/* Empty State */}
              {(activeInvTab === "low"
                ? inventoryData.lowStock
                : activeInvTab === "dead"
                  ? inventoryData.deadStock
                  : inventoryData.fastMoving
              ).length === 0 && (
                <tr>
                  <td
                    colSpan={4}
                    className="px-6 py-8 text-center text-gray-500"
                  >
                    Excellent! No items found in this category.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}

// --- Helper Component: KPI Card ---
function KPICard({ title, value, trend, icon: Icon, color, bg }: any) {
  return (
    <div className="bg-gray-900/50 border border-white/10 rounded-2xl p-6 backdrop-blur-sm hover:bg-white/[0.02] transition-colors">
      <div className="flex justify-between items-start">
        <div>
          <p className="text-gray-400 text-sm font-medium">{title}</p>
          <h3 className="text-2xl font-bold text-white mt-2">{value}</h3>
          <p className="text-xs text-gray-500 mt-1">{trend}</p>
        </div>
        <div className={`p-3 rounded-xl ${bg}`}>
          <Icon className={`h-6 w-6 ${color}`} />
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/dashboard/carousel/page.tsx">
// "use client";

// import { useState, useEffect } from "react";
// import {
//   Plus,
//   Trash2,
//   Edit2,
//   Save,
//   X,
//   Eye,
//   EyeOff,
//   LayoutGrid,
//   Loader2,
//   Check,
//   Palette,
//   ExternalLink,
// } from "lucide-react";
// import { toast } from "sonner";
// import axios from "axios";
// import { motion, AnimatePresence } from "framer-motion";

// // --- TYPES (Matches Mongoose Schema) ---
// interface CarouselSlide {
//   _id?: string;
//   title: string;
//   subtitle: string;
//   discount: string;
//   description: string;
//   buttonText: string;
//   link: string;
//   bgClass: string;
//   textClass: string;
//   buttonClass: string;
//   isActive: boolean;
//   order: number;
// }

// // --- ðŸŽ¨ EXPANDED THEME PRESETS (25+ Themes) ---
// const THEME_PRESETS = [
//   // ðŸ”¹ VIBRANT GRADIENTS
//   {
//     name: "Ocean Blue",
//     bg: "bg-gradient-to-br from-blue-600 to-cyan-400",
//     text: "text-white",
//     btn: "bg-white text-blue-600",
//     preview: "from-blue-600 to-cyan-400",
//   },
//   {
//     name: "Sunset Orange",
//     bg: "bg-gradient-to-br from-orange-500 to-red-500",
//     text: "text-white",
//     btn: "bg-white text-orange-600",
//     preview: "from-orange-500 to-red-500",
//   },
//   {
//     name: "Electric Purple",
//     bg: "bg-gradient-to-br from-purple-600 to-blue-600",
//     text: "text-white",
//     btn: "bg-white text-purple-600",
//     preview: "from-purple-600 to-blue-600",
//   },
//   {
//     name: "Neon Lime",
//     bg: "bg-gradient-to-br from-lime-400 to-emerald-600",
//     text: "text-white",
//     btn: "bg-white text-emerald-600",
//     preview: "from-lime-400 to-emerald-600",
//   },
//   {
//     name: "Pink Lemonade",
//     bg: "bg-gradient-to-br from-pink-400 to-orange-400",
//     text: "text-white",
//     btn: "bg-white text-pink-500",
//     preview: "from-pink-400 to-orange-400",
//   },
//   {
//     name: "Cherry Red",
//     bg: "bg-gradient-to-br from-red-600 to-rose-800",
//     text: "text-white",
//     btn: "bg-white text-red-600",
//     preview: "from-red-600 to-rose-800",
//   },
//   {
//     name: "Golden Hour",
//     bg: "bg-gradient-to-br from-amber-400 to-orange-600",
//     text: "text-white",
//     btn: "bg-white text-amber-600",
//     preview: "from-amber-400 to-orange-600",
//   },

//   // ðŸ”¹ DARK & ELEGANT
//   {
//     name: "Midnight Blue",
//     bg: "bg-gradient-to-br from-slate-900 to-slate-700",
//     text: "text-blue-100",
//     btn: "bg-blue-500 text-white",
//     preview: "from-slate-900 to-slate-700",
//   },
//   {
//     name: "Deep Forest",
//     bg: "bg-gradient-to-br from-green-900 to-emerald-800",
//     text: "text-emerald-100",
//     btn: "bg-emerald-500 text-white",
//     preview: "from-green-900 to-emerald-800",
//   },
//   {
//     name: "Royal Purple",
//     bg: "bg-gradient-to-br from-indigo-900 to-purple-900",
//     text: "text-purple-100",
//     btn: "bg-purple-500 text-white",
//     preview: "from-indigo-900 to-purple-900",
//   },
//   {
//     name: "Charcoal Black",
//     bg: "bg-gradient-to-br from-gray-900 to-black",
//     text: "text-gray-100",
//     btn: "bg-white text-black",
//     preview: "from-gray-900 to-black",
//   },
//   {
//     name: "Luxury Gold",
//     bg: "bg-gradient-to-br from-yellow-700 via-yellow-600 to-yellow-800",
//     text: "text-yellow-50",
//     btn: "bg-black text-yellow-500",
//     preview: "from-yellow-700 to-yellow-800",
//   },

//   // ðŸ”¹ PASTEL & SOFT
//   {
//     name: "Soft Sky",
//     bg: "bg-gradient-to-br from-sky-200 to-blue-100",
//     text: "text-blue-800",
//     btn: "bg-blue-600 text-white",
//     preview: "from-sky-200 to-blue-100",
//   },
//   {
//     name: "Lavender Mist",
//     bg: "bg-gradient-to-br from-purple-200 to-fuchsia-100",
//     text: "text-purple-800",
//     btn: "bg-purple-600 text-white",
//     preview: "from-purple-200 to-fuchsia-100",
//   },
//   {
//     name: "Minty Fresh",
//     bg: "bg-gradient-to-br from-emerald-100 to-teal-100",
//     text: "text-teal-800",
//     btn: "bg-teal-600 text-white",
//     preview: "from-emerald-100 to-teal-100",
//   },
//   {
//     name: "Peachy Keen",
//     bg: "bg-gradient-to-br from-orange-100 to-rose-100",
//     text: "text-rose-800",
//     btn: "bg-rose-500 text-white",
//     preview: "from-orange-100 to-rose-100",
//   },

//   // ðŸ”¹ SPECIAL EFFECTS
//   {
//     name: "Cyberpunk",
//     bg: "bg-gradient-to-r from-pink-500 via-red-500 to-yellow-500",
//     text: "text-white",
//     btn: "bg-black text-white",
//     preview: "from-pink-500 via-red-500 to-yellow-500",
//   },
//   {
//     name: "Northern Lights",
//     bg: "bg-gradient-to-r from-teal-400 via-blue-500 to-purple-500",
//     text: "text-white",
//     btn: "bg-white text-indigo-600",
//     preview: "from-teal-400 via-blue-500 to-purple-500",
//   },
//   {
//     name: "Instagram",
//     bg: "bg-gradient-to-bl from-yellow-400 via-pink-500 to-purple-600",
//     text: "text-white",
//     btn: "bg-white text-pink-600",
//     preview: "from-yellow-400 via-pink-500 to-purple-600",
//   },
//   {
//     name: "Steel Grey",
//     bg: "bg-gradient-to-br from-gray-400 to-gray-600",
//     text: "text-white",
//     btn: "bg-gray-800 text-white",
//     preview: "from-gray-400 to-gray-600",
//   },
// ];

// const initialSlide: CarouselSlide = {
//   title: "",
//   subtitle: "",
//   discount: "",
//   description: "",
//   buttonText: "Shop Now",
//   link: "/products",
//   // Default to first theme
//   bgClass: THEME_PRESETS[0].bg,
//   textClass: THEME_PRESETS[0].text,
//   buttonClass: THEME_PRESETS[0].btn,
//   isActive: true,
//   order: 0,
// };

// // --- âœ¨ GLASSMORPHISM STYLES ---
// const pageBackground = "fixed inset-0 bg-[#0a0a0a] -z-20";
// const ambientGlow =
//   "fixed inset-0 bg-[radial-gradient(circle_at_50%_50%,_rgba(76,29,149,0.15),_rgba(0,0,0,0))] -z-10 pointer-events-none";
// const glassCard =
//   "bg-white/5 backdrop-blur-xl border border-white/10 shadow-2xl rounded-2xl overflow-hidden hover:bg-white/10 hover:border-white/20 transition-all duration-300 group";
// const glassModal =
//   "bg-[#121212]/80 backdrop-blur-2xl border border-white/10 shadow-2xl rounded-2xl";
// const glassInput =
//   "w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500/50 focus:bg-white/10 transition-all";
// const glassButton =
//   "flex items-center justify-center gap-2 px-6 py-3 rounded-xl font-medium transition-all active:scale-95 shadow-lg shadow-black/20 hover:shadow-xl";

// export default function AdminCarouselPage() {
//   const [slides, setSlides] = useState<CarouselSlide[]>([]);
//   const [isLoading, setIsLoading] = useState(true);
//   const [isEditing, setIsEditing] = useState(false);
//   const [currentSlide, setCurrentSlide] = useState<CarouselSlide>(initialSlide);
//   const [showModal, setShowModal] = useState(false);

//   const API_URL =
//     process.env.NEXT_PUBLIC_API_URL || "http://localhost:5000/api";

//   // Fetch Slides
//   const fetchSlides = async () => {
//     try {
//       setIsLoading(true);
//       const token = localStorage.getItem("token");
//       const res = await axios.get(`${API_URL}/carousel/admin/all`, {
//         headers: { Authorization: `Bearer ${token}` },
//       });
//       if (res.data.success) setSlides(res.data.data);
//     } catch (error) {
//       toast.error("Failed to load slides");
//     } finally {
//       setIsLoading(false);
//     }
//   };

//   useEffect(() => {
//     fetchSlides();
//   }, []);

//   // Submit Handler
//   const handleSubmit = async (e: React.FormEvent) => {
//     e.preventDefault();
//     const token = localStorage.getItem("token");

//     try {
//       if (isEditing && currentSlide._id) {
//         await axios.put(
//           `${API_URL}/carousel/${currentSlide._id}`,
//           currentSlide,
//           {
//             headers: { Authorization: `Bearer ${token}` },
//           },
//         );
//         toast.success("Updated successfully!");
//       } else {
//         await axios.post(`${API_URL}/carousel`, currentSlide, {
//           headers: { Authorization: `Bearer ${token}` },
//         });
//         toast.success("Created successfully!");
//       }
//       closeModal();
//       fetchSlides();
//     } catch (error) {
//       toast.error("Operation failed");
//     }
//   };

//   // Delete Handler
//   const handleDelete = async (id: string) => {
//     if (!confirm("Are you sure? This action cannot be undone.")) return;
//     try {
//       const token = localStorage.getItem("token");
//       await axios.delete(`${API_URL}/carousel/${id}`, {
//         headers: { Authorization: `Bearer ${token}` },
//       });
//       toast.success("Deleted!");
//       fetchSlides();
//     } catch (error) {
//       toast.error("Failed to delete");
//     }
//   };

//   // Toggle Status
//   const toggleStatus = async (slide: CarouselSlide) => {
//     try {
//       const token = localStorage.getItem("token"); // admin token get getting from local storage
//       await axios.put(
//         `${API_URL}/carousel/${slide._id}`,
//         { ...slide, isActive: !slide.isActive },
//         { headers: { Authorization: `Bearer ${token}` } },
//       );
//       fetchSlides();
//       toast.success(slide.isActive ? "Slide hidden" : "Slide activated");
//     } catch (error) {
//       toast.error("Update failed");
//     }
//   };

//   // Theme Selector
//   const handleThemeSelect = (theme: (typeof THEME_PRESETS)[0]) => {
//     setCurrentSlide({
//       ...currentSlide,
//       bgClass: theme.bg,
//       textClass: theme.text,
//       buttonClass: theme.btn,
//     });
//   };

//   const openModal = (slide?: CarouselSlide) => {
//     if (slide) {
//       setCurrentSlide(slide);
//       setIsEditing(true);
//     } else {
//       setCurrentSlide(initialSlide);
//       setIsEditing(false);
//     }
//     setShowModal(true);
//   };

//   const closeModal = () => {
//     setShowModal(false);
//     setCurrentSlide(initialSlide);
//   };

//   return (
//     <div className="min-h-screen text-gray-100 p-4 md:p-8 font-sans relative overflow-hidden">
//       {/* ðŸŒŒ Background Effects */}
//       <div className={pageBackground}></div>
//       <div className={ambientGlow}></div>
//       {/* Floating Orbs */}
//       <div className="fixed top-[-20%] left-[-10%] w-[600px] h-[600px] bg-blue-600/10 rounded-full blur-[150px] pointer-events-none"></div>
//       <div className="fixed bottom-[-20%] right-[-10%] w-[600px] h-[600px] bg-purple-600/10 rounded-full blur-[150px] pointer-events-none"></div>

//       <div className="relative z-10 max-w-7xl mx-auto">
//         {/* --- HEADER --- */}
//         <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-6 bg-white/5 p-6 rounded-3xl backdrop-blur-xl border border-white/10 shadow-2xl">
//           <div>
//             <h1 className="text-3xl md:text-4xl font-bold bg-gradient-to-r from-white via-gray-200 to-gray-400 bg-clip-text text-transparent">
//               Carousel Manager
//             </h1>
//             <p className="text-gray-400 mt-2 text-sm flex items-center gap-2">
//               <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
//               Manage your homepage banners live
//             </p>
//           </div>
//           <button
//             onClick={() => openModal()}
//             className={`${glassButton} bg-blue-600 hover:bg-blue-500 text-white border border-blue-400/20`}
//           >
//             <Plus size={20} />
//             <span>Add New Slide</span>
//           </button>
//         </div>

//         {/* --- LOADING STATE --- */}
//         {isLoading ? (
//           <div className="flex h-96 items-center justify-center">
//             <div className="flex flex-col items-center gap-4">
//               <Loader2 className="animate-spin text-blue-500 h-10 w-10" />
//               <p className="text-gray-500 text-sm">Loading slides...</p>
//             </div>
//           </div>
//         ) : (
//           /* --- SLIDES GRID --- */
//           <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
//             <AnimatePresence>
//               {slides.map((slide) => (
//                 <motion.div
//                   layout
//                   initial={{ opacity: 0, scale: 0.95 }}
//                   animate={{ opacity: 1, scale: 1 }}
//                   exit={{ opacity: 0, scale: 0.9 }}
//                   key={slide._id}
//                   className={glassCard}
//                 >
//                   {/* Visual Preview */}
//                   <div
//                     className={`h-48 w-full ${slide.bgClass} flex flex-col justify-center px-8 relative overflow-hidden`}
//                   >
//                     {/* Pattern Overlay */}
//                     <div className="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] mix-blend-overlay"></div>

//                     <div className="relative z-10 space-y-2">
//                       <span className="text-[10px] font-bold uppercase tracking-widest bg-black/30 backdrop-blur-md text-white px-2 py-1 rounded-md border border-white/10 inline-block">
//                         {slide.discount}
//                       </span>
//                       <h3
//                         className={`text-2xl font-bold leading-tight line-clamp-1 ${slide.textClass} drop-shadow-lg`}
//                       >
//                         {slide.title}
//                       </h3>
//                       <p
//                         className={`text-xs opacity-90 line-clamp-1 ${slide.textClass} font-medium`}
//                       >
//                         {slide.subtitle}
//                       </p>
//                     </div>

//                     {/* Status Pill */}
//                     <div className="absolute top-4 right-4">
//                       <span
//                         className={`px-3 py-1 text-[10px] font-bold rounded-full border backdrop-blur-xl shadow-lg flex items-center gap-1.5 ${
//                           slide.isActive
//                             ? "bg-green-500/20 text-white border-green-500/30"
//                             : "bg-red-500/20 text-red-200 border-red-500/30"
//                         }`}
//                       >
//                         <span
//                           className={`w-1.5 h-1.5 rounded-full ${slide.isActive ? "bg-green-400 animate-pulse" : "bg-red-400"}`}
//                         ></span>
//                         {slide.isActive ? "ACTIVE" : "HIDDEN"}
//                       </span>
//                     </div>
//                   </div>

//                   {/* Content & Actions */}
//                   <div className="p-5 flex flex-col gap-4 bg-[#121212]/40">
//                     <div className="flex justify-between items-center text-xs text-gray-400 font-medium">
//                       <div className="flex items-center gap-1.5 bg-white/5 px-2.5 py-1.5 rounded-lg border border-white/5">
//                         <LayoutGrid size={14} />
//                         <span>Order: {slide.order}</span>
//                       </div>
//                       {slide.link && (
//                         <a
//                           href={slide.link}
//                           target="_blank"
//                           className="flex items-center gap-1 hover:text-blue-400 transition-colors"
//                         >
//                           Link <ExternalLink size={12} />
//                         </a>
//                       )}
//                     </div>

//                     <div className="flex items-center justify-between pt-4 border-t border-white/5">
//                       <button
//                         onClick={() => toggleStatus(slide)}
//                         className={`p-2.5 rounded-xl transition-all duration-300 ${
//                           slide.isActive
//                             ? "text-gray-400 hover:text-white hover:bg-white/10"
//                             : "text-gray-500 hover:text-gray-300"
//                         }`}
//                         title={slide.isActive ? "Hide Slide" : "Show Slide"}
//                       >
//                         {slide.isActive ? (
//                           <Eye size={18} />
//                         ) : (
//                           <EyeOff size={18} />
//                         )}
//                       </button>

//                       <div className="flex gap-2">
//                         <button
//                           onClick={() => openModal(slide)}
//                           className="p-2.5 text-blue-400 hover:text-white hover:bg-blue-600 rounded-xl transition-all duration-300 shadow-sm"
//                           title="Edit"
//                         >
//                           <Edit2 size={18} />
//                         </button>
//                         <button
//                           onClick={() => handleDelete(slide._id!)}
//                           className="p-2.5 text-red-400 hover:text-white hover:bg-red-600 rounded-xl transition-all duration-300 shadow-sm"
//                           title="Delete"
//                         >
//                           <Trash2 size={18} />
//                         </button>
//                       </div>
//                     </div>
//                   </div>
//                 </motion.div>
//               ))}
//             </AnimatePresence>
//           </div>
//         )}
//       </div>

//       {/* --- MODAL (Overlay) --- */}
//       <AnimatePresence>
//         {showModal && (
//           <motion.div
//             initial={{ opacity: 0 }}
//             animate={{ opacity: 1 }}
//             exit={{ opacity: 0 }}
//             className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-md"
//           >
//             <motion.div
//               initial={{ y: 50, opacity: 0, scale: 0.95 }}
//               animate={{ y: 0, opacity: 1, scale: 1 }}
//               exit={{ y: 50, opacity: 0, scale: 0.95 }}
//               className={`w-full max-w-4xl ${glassModal} flex flex-col max-h-[90vh]`}
//             >
//               {/* Modal Header */}
//               <div className="p-6 border-b border-white/10 flex justify-between items-center bg-white/5 rounded-t-2xl">
//                 <div>
//                   <h2 className="text-xl font-bold text-white flex items-center gap-2">
//                     {isEditing ? (
//                       <Edit2 size={20} className="text-blue-400" />
//                     ) : (
//                       <Plus size={20} className="text-green-400" />
//                     )}
//                     {isEditing ? "Edit Slide" : "Create New Slide"}
//                   </h2>
//                   <p className="text-gray-400 text-xs mt-1 ml-7">
//                     Fill details to update homepage carousel
//                   </p>
//                 </div>
//                 <button
//                   onClick={closeModal}
//                   className="text-gray-400 hover:text-white p-2 hover:bg-white/10 rounded-full transition"
//                 >
//                   <X size={24} />
//                 </button>
//               </div>

//               {/* Scrollable Content */}
//               <div className="overflow-y-auto p-6 md:p-8 custom-scrollbar">
//                 <form onSubmit={handleSubmit} className="space-y-8">
//                   {/* 1. TEXT CONTENT */}
//                   <div className="space-y-5">
//                     <h3 className="text-xs font-bold text-gray-500 uppercase tracking-widest flex items-center gap-2">
//                       <span className="w-8 h-[1px] bg-gray-600"></span>
//                       Content Details
//                     </h3>

//                     <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
//                       <div className="space-y-2">
//                         <label className="text-xs text-gray-300 ml-1 font-medium">
//                           Main Title
//                         </label>
//                         <input
//                           required
//                           type="text"
//                           value={currentSlide.title}
//                           onChange={(e) =>
//                             setCurrentSlide({
//                               ...currentSlide,
//                               title: e.target.value,
//                             })
//                           }
//                           className={glassInput}
//                           placeholder="e.g. Monsoon Sale"
//                         />
//                       </div>
//                       <div className="space-y-2">
//                         <label className="text-xs text-gray-300 ml-1 font-medium">
//                           Subtitle
//                         </label>
//                         <input
//                           required
//                           type="text"
//                           value={currentSlide.subtitle}
//                           onChange={(e) =>
//                             setCurrentSlide({
//                               ...currentSlide,
//                               subtitle: e.target.value,
//                             })
//                           }
//                           className={glassInput}
//                           placeholder="e.g. Up to 50% Off"
//                         />
//                       </div>
//                       <div className="space-y-2">
//                         <label className="text-xs text-gray-300 ml-1 font-medium">
//                           Discount Badge
//                         </label>
//                         <input
//                           required
//                           type="text"
//                           value={currentSlide.discount}
//                           onChange={(e) =>
//                             setCurrentSlide({
//                               ...currentSlide,
//                               discount: e.target.value,
//                             })
//                           }
//                           className={glassInput}
//                           placeholder="e.g. FLAT 20% OFF"
//                         />
//                       </div>
//                       <div className="space-y-2">
//                         <label className="text-xs text-gray-300 ml-1 font-medium">
//                           Button Link
//                         </label>
//                         <input
//                           required
//                           type="text"
//                           value={currentSlide.link}
//                           onChange={(e) =>
//                             setCurrentSlide({
//                               ...currentSlide,
//                               link: e.target.value,
//                             })
//                           }
//                           className={glassInput}
//                           placeholder="/products?category=..."
//                         />
//                       </div>
//                     </div>
//                     <div className="space-y-2">
//                       <label className="text-xs text-gray-300 ml-1 font-medium">
//                         Description
//                       </label>
//                       <input
//                         required
//                         type="text"
//                         value={currentSlide.description}
//                         onChange={(e) =>
//                           setCurrentSlide({
//                             ...currentSlide,
//                             description: e.target.value,
//                           })
//                         }
//                         className={glassInput}
//                         placeholder="Short catchy description..."
//                       />
//                     </div>
//                   </div>

//                   {/* 2. THEME SELECTOR */}
//                   <div className="pt-2">
//                     <div className="flex items-center justify-between mb-4">
//                       <h3 className="text-xs font-bold text-gray-500 uppercase tracking-widest flex items-center gap-2">
//                         <span className="w-8 h-[1px] bg-gray-600"></span>
//                         <Palette size={14} className="text-blue-400" /> Color
//                         Theme
//                       </h3>
//                       <span className="text-[10px] text-gray-400 bg-white/5 px-2 py-1 rounded border border-white/5">
//                         {THEME_PRESETS.length} Styles
//                       </span>
//                     </div>

//                     <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 max-h-60 overflow-y-auto custom-scrollbar p-1">
//                       {THEME_PRESETS.map((theme, idx) => (
//                         <div
//                           key={idx}
//                           onClick={() => handleThemeSelect(theme)}
//                           className={`cursor-pointer rounded-xl p-1 border-2 transition-all relative group ${
//                             currentSlide.bgClass === theme.bg
//                               ? "border-blue-500 bg-white/10 shadow-[0_0_20px_rgba(59,130,246,0.3)] scale-[1.02]"
//                               : "border-transparent hover:border-white/20 hover:bg-white/5"
//                           }`}
//                         >
//                           <div
//                             className={`h-12 rounded-lg bg-gradient-to-br ${theme.preview} flex items-center justify-center shadow-inner relative overflow-hidden`}
//                           >
//                             {currentSlide.bgClass === theme.bg && (
//                               <div className="absolute inset-0 bg-black/20 flex items-center justify-center backdrop-blur-[1px]">
//                                 <div className="bg-white rounded-full p-1 shadow-lg">
//                                   <Check
//                                     size={12}
//                                     className="text-blue-600 stroke-[3]"
//                                   />
//                                 </div>
//                               </div>
//                             )}
//                           </div>
//                           <p
//                             className={`text-[10px] text-center mt-2 font-medium truncate px-1 ${currentSlide.bgClass === theme.bg ? "text-blue-400" : "text-gray-400 group-hover:text-white"}`}
//                           >
//                             {theme.name}
//                           </p>
//                         </div>
//                       ))}
//                     </div>
//                   </div>

//                   {/* 3. SETTINGS */}
//                   <div className="flex flex-col sm:flex-row gap-6 pt-4 border-t border-white/10">
//                     <div className="space-y-2 w-full sm:w-1/3">
//                       <label className="text-xs text-gray-300 ml-1 font-medium">
//                         Sort Order
//                       </label>
//                       <input
//                         type="number"
//                         value={currentSlide.order}
//                         onChange={(e) =>
//                           setCurrentSlide({
//                             ...currentSlide,
//                             order: parseInt(e.target.value),
//                           })
//                         }
//                         className={glassInput}
//                       />
//                     </div>
//                     <div className="space-y-2 w-full sm:w-2/3">
//                       <label className="text-xs text-gray-300 ml-1 font-medium">
//                         Button Text
//                       </label>
//                       <input
//                         type="text"
//                         value={currentSlide.buttonText}
//                         onChange={(e) =>
//                           setCurrentSlide({
//                             ...currentSlide,
//                             buttonText: e.target.value,
//                           })
//                         }
//                         className={glassInput}
//                       />
//                     </div>
//                   </div>
//                 </form>
//               </div>

//               {/* 4. STATUS (Active/Inactive) - à°‡à°¦à°¿ à°®à°¿à°¸à± à°…à°¯à±à°¯à°¿à°‚à°¦à°¿, à°‡à°ªà±à°ªà±à°¡à± à°¯à°¾à°¡à± à°šà±‡à°¶à°¾à°¨à± */}
//               <div className="pt-4 border-t border-white/10">
//                 <label className="flex items-center gap-3 cursor-pointer group">
//                   <div className="relative">
//                     <input
//                       type="checkbox"
//                       checked={currentSlide.isActive}
//                       onChange={(e) =>
//                         setCurrentSlide({
//                           ...currentSlide,
//                           isActive: e.target.checked,
//                         })
//                       }
//                       className="peer sr-only"
//                     />
//                     {/* Custom Toggle Switch UI */}
//                     <div className="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
//                   </div>
//                   <span className="text-sm font-medium text-gray-300 group-hover:text-white transition-colors">
//                     Set Slide as Active
//                   </span>
//                 </label>
//               </div>

//               {/* Modal Footer */}
//               <div className="p-6 border-t border-white/10 bg-white/5 flex justify-end gap-4 rounded-b-2xl">
//                 <button
//                   onClick={closeModal}
//                   className="px-6 py-2.5 rounded-xl text-gray-400 hover:text-white hover:bg-white/10 transition font-medium"
//                 >
//                   Cancel
//                 </button>
//                 <button
//                   onClick={handleSubmit}
//                   className={`${glassButton} bg-blue-600 hover:bg-blue-500 text-white shadow-blue-500/20`}
//                 >
//                   <Save size={18} />
//                   <span>{isEditing ? "Save Changes" : "Create Slide"}</span>
//                 </button>
//               </div>
//             </motion.div>
//           </motion.div>
//         )}
//       </AnimatePresence>
//     </div>
//   );
// }

"use client";

import { useState, useEffect } from "react";
import {
  Plus,
  Trash2,
  Edit2,
  Save,
  X,
  Eye,
  EyeOff,
  LayoutGrid,
  Loader2,
  Check,
  Palette,
  ExternalLink,
  ToggleLeft,
} from "lucide-react";
import { toast } from "sonner";
import axios from "axios";
import { motion, AnimatePresence } from "framer-motion";

// --- TYPES ---
interface CarouselSlide {
  _id?: string;
  title: string;
  subtitle: string;
  discount: string;
  description: string;
  buttonText: string;
  link: string;
  bgClass: string;
  textClass: string;
  buttonClass: string;
  isActive: boolean;
  order: number;
}

// // --- ðŸŽ¨ THEME PRESETS (25+ Themes) ---
// const THEME_PRESETS = [
//   // ðŸ”¹ VIBRANT GRADIENTS
//   {
//     name: "Ocean Blue",
//     bg: "bg-gradient-to-br from-blue-600 to-cyan-400",
//     text: "text-white",
//     btn: "bg-white text-blue-600",
//     preview: "from-blue-600 to-cyan-400",
//   },
//   {
//     name: "Sunset Orange",
//     bg: "bg-gradient-to-br from-orange-500 to-red-500",
//     text: "text-white",
//     btn: "bg-white text-orange-600",
//     preview: "from-orange-500 to-red-500",
//   },
//   {
//     name: "Electric Purple",
//     bg: "bg-gradient-to-br from-purple-600 to-blue-600",
//     text: "text-white",
//     btn: "bg-white text-purple-600",
//     preview: "from-purple-600 to-blue-600",
//   },
//   {
//     name: "Neon Lime",
//     bg: "bg-gradient-to-br from-lime-400 to-emerald-600",
//     text: "text-white",
//     btn: "bg-white text-emerald-600",
//     preview: "from-lime-400 to-emerald-600",
//   },
//   {
//     name: "Pink Lemonade",
//     bg: "bg-gradient-to-br from-pink-400 to-orange-400",
//     text: "text-white",
//     btn: "bg-white text-pink-500",
//     preview: "from-pink-400 to-orange-400",
//   },
//   {
//     name: "Cherry Red",
//     bg: "bg-gradient-to-br from-red-600 to-rose-800",
//     text: "text-white",
//     btn: "bg-white text-red-600",
//     preview: "from-red-600 to-rose-800",
//   },
//   {
//     name: "Golden Hour",
//     bg: "bg-gradient-to-br from-amber-400 to-orange-600",
//     text: "text-white",
//     btn: "bg-white text-amber-600",
//     preview: "from-amber-400 to-orange-600",
//   },

//   // ðŸ”¹ DARK & ELEGANT
//   {
//     name: "Midnight Blue",
//     bg: "bg-gradient-to-br from-slate-900 to-slate-700",
//     text: "text-blue-100",
//     btn: "bg-blue-500 text-white",
//     preview: "from-slate-900 to-slate-700",
//   },
//   {
//     name: "Deep Forest",
//     bg: "bg-gradient-to-br from-green-900 to-emerald-800",
//     text: "text-emerald-100",
//     btn: "bg-emerald-500 text-white",
//     preview: "from-green-900 to-emerald-800",
//   },
//   {
//     name: "Royal Purple",
//     bg: "bg-gradient-to-br from-indigo-900 to-purple-900",
//     text: "text-purple-100",
//     btn: "bg-purple-500 text-white",
//     preview: "from-indigo-900 to-purple-900",
//   },
//   {
//     name: "Charcoal Black",
//     bg: "bg-gradient-to-br from-gray-900 to-black",
//     text: "text-gray-100",
//     btn: "bg-white text-black",
//     preview: "from-gray-900 to-black",
//   },
//   {
//     name: "Luxury Gold",
//     bg: "bg-gradient-to-br from-yellow-700 via-yellow-600 to-yellow-800",
//     text: "text-yellow-50",
//     btn: "bg-black text-yellow-500",
//     preview: "from-yellow-700 to-yellow-800",
//   },

//   // ðŸ”¹ PASTEL & SOFT
//   {
//     name: "Soft Sky",
//     bg: "bg-gradient-to-br from-sky-200 to-blue-100",
//     text: "text-blue-800",
//     btn: "bg-blue-600 text-white",
//     preview: "from-sky-200 to-blue-100",
//   },
//   {
//     name: "Lavender Mist",
//     bg: "bg-gradient-to-br from-purple-200 to-fuchsia-100",
//     text: "text-purple-800",
//     btn: "bg-purple-600 text-white",
//     preview: "from-purple-200 to-fuchsia-100",
//   },
//   {
//     name: "Minty Fresh",
//     bg: "bg-gradient-to-br from-emerald-100 to-teal-100",
//     text: "text-teal-800",
//     btn: "bg-teal-600 text-white",
//     preview: "from-emerald-100 to-teal-100",
//   },
//   {
//     name: "Peachy Keen",
//     bg: "bg-gradient-to-br from-orange-100 to-rose-100",
//     text: "text-rose-800",
//     btn: "bg-rose-500 text-white",
//     preview: "from-orange-100 to-rose-100",
//   },

//   // ðŸ”¹ SPECIAL EFFECTS
//   {
//     name: "Cyberpunk",
//     bg: "bg-gradient-to-r from-pink-500 via-red-500 to-yellow-500",
//     text: "text-white",
//     btn: "bg-black text-white",
//     preview: "from-pink-500 via-red-500 to-yellow-500",
//   },
//   {
//     name: "Northern Lights",
//     bg: "bg-gradient-to-r from-teal-400 via-blue-500 to-purple-500",
//     text: "text-white",
//     btn: "bg-white text-indigo-600",
//     preview: "from-teal-400 via-blue-500 to-purple-500",
//   },
//   {
//     name: "Instagram",
//     bg: "bg-gradient-to-bl from-yellow-400 via-pink-500 to-purple-600",
//     text: "text-white",
//     btn: "bg-white text-pink-600",
//     preview: "from-yellow-400 via-pink-500 to-purple-600",
//   },
//   {
//     name: "Steel Grey",
//     bg: "bg-gradient-to-br from-gray-400 to-gray-600",
//     text: "text-white",
//     btn: "bg-gray-800 text-white",
//     preview: "from-gray-400 to-gray-600",
//   },
// ];

// --- ðŸŽ¨ THEME PRESETS (100+ Themes) ---
const THEME_PRESETS = [
  // ==============================
  // ðŸ”¹ BLUES & CYANS (1-12)
  // ==============================
  {
    name: "Ocean Blue",
    bg: "bg-gradient-to-br from-blue-600 to-cyan-400",
    text: "text-white",
    btn: "bg-white text-blue-600",
    preview: "from-blue-600 to-cyan-400",
  },
  {
    name: "Deep Sea",
    bg: "bg-gradient-to-br from-blue-900 via-blue-800 to-indigo-900",
    text: "text-blue-100",
    btn: "bg-blue-500 text-white",
    preview: "from-blue-900 to-indigo-900",
  },
  {
    name: "Electric Blue",
    bg: "bg-gradient-to-br from-blue-500 to-indigo-600",
    text: "text-white",
    btn: "bg-white text-indigo-600",
    preview: "from-blue-500 to-indigo-600",
  },
  {
    name: "Sky High",
    bg: "bg-gradient-to-b from-sky-400 to-blue-500",
    text: "text-white",
    btn: "bg-white text-sky-600",
    preview: "from-sky-400 to-blue-500",
  },
  {
    name: "Aqua Marine",
    bg: "bg-gradient-to-tr from-cyan-500 to-teal-400",
    text: "text-white",
    btn: "bg-teal-800 text-white",
    preview: "from-cyan-500 to-teal-400",
  },
  {
    name: "Iceberg",
    bg: "bg-gradient-to-br from-cyan-100 to-blue-200",
    text: "text-blue-900",
    btn: "bg-blue-600 text-white",
    preview: "from-cyan-100 to-blue-200",
  },
  {
    name: "Night Sky",
    bg: "bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900",
    text: "text-slate-100",
    btn: "bg-blue-500 text-white",
    preview: "from-slate-900 via-blue-900 to-slate-900",
  },
  {
    name: "Blueberry",
    bg: "bg-gradient-to-br from-blue-700 to-purple-800",
    text: "text-white",
    btn: "bg-white text-purple-700",
    preview: "from-blue-700 to-purple-800",
  },
  {
    name: "Pacific",
    bg: "bg-gradient-to-r from-teal-500 to-blue-600",
    text: "text-white",
    btn: "bg-white text-teal-600",
    preview: "from-teal-500 to-blue-600",
  },
  {
    name: "Baby Blue",
    bg: "bg-gradient-to-br from-blue-200 to-cyan-200",
    text: "text-blue-800",
    btn: "bg-blue-600 text-white",
    preview: "from-blue-200 to-cyan-200",
  },
  {
    name: "Denim",
    bg: "bg-gradient-to-br from-blue-800 to-gray-800",
    text: "text-blue-100",
    btn: "bg-orange-500 text-white",
    preview: "from-blue-800 to-gray-800",
  },
  {
    name: "Frost",
    bg: "bg-gradient-to-tr from-white via-blue-100 to-white",
    text: "text-blue-900",
    btn: "bg-blue-500 text-white",
    preview: "from-white via-blue-100 to-white",
  },

  // ==============================
  // ðŸ”¸ REDS & ORANGES (13-24)
  // ==============================
  {
    name: "Sunset",
    bg: "bg-gradient-to-br from-orange-500 to-red-500",
    text: "text-white",
    btn: "bg-white text-orange-600",
    preview: "from-orange-500 to-red-500",
  },
  {
    name: "Cherry Bomb",
    bg: "bg-gradient-to-br from-red-600 to-rose-800",
    text: "text-white",
    btn: "bg-white text-red-600",
    preview: "from-red-600 to-rose-800",
  },
  {
    name: "Lava Flow",
    bg: "bg-gradient-to-br from-red-500 via-orange-500 to-yellow-500",
    text: "text-white",
    btn: "bg-black text-white",
    preview: "from-red-500 via-orange-500 to-yellow-500",
  },
  {
    name: "Coral Reef",
    bg: "bg-gradient-to-br from-rose-400 to-orange-300",
    text: "text-rose-900",
    btn: "bg-white text-rose-500",
    preview: "from-rose-400 to-orange-300",
  },
  {
    name: "Burnt Sienna",
    bg: "bg-gradient-to-br from-orange-700 to-red-900",
    text: "text-orange-100",
    btn: "bg-orange-400 text-black",
    preview: "from-orange-700 to-red-900",
  },
  {
    name: "Peach",
    bg: "bg-gradient-to-br from-orange-200 to-rose-200",
    text: "text-rose-800",
    btn: "bg-rose-500 text-white",
    preview: "from-orange-200 to-rose-200",
  },
  {
    name: "Ferrari",
    bg: "bg-gradient-to-br from-red-600 to-red-700",
    text: "text-white",
    btn: "bg-black text-white",
    preview: "from-red-600 to-red-700",
  },
  {
    name: "Autumn",
    bg: "bg-gradient-to-br from-orange-600 to-amber-700",
    text: "text-amber-100",
    btn: "bg-white text-orange-800",
    preview: "from-orange-600 to-amber-700",
  },
  {
    name: "Tangerine",
    bg: "bg-gradient-to-r from-orange-400 to-yellow-400",
    text: "text-white",
    btn: "bg-white text-orange-500",
    preview: "from-orange-400 to-yellow-400",
  },
  {
    name: "Brick",
    bg: "bg-gradient-to-br from-red-800 to-stone-800",
    text: "text-stone-100",
    btn: "bg-white text-red-900",
    preview: "from-red-800 to-stone-800",
  },
  {
    name: "Blood Moon",
    bg: "bg-gradient-to-br from-red-900 via-black to-red-900",
    text: "text-red-500",
    btn: "bg-red-600 text-white",
    preview: "from-red-900 via-black to-red-900",
  },
  {
    name: "Salmon",
    bg: "bg-gradient-to-br from-rose-300 to-red-300",
    text: "text-red-900",
    btn: "bg-white text-red-500",
    preview: "from-rose-300 to-red-300",
  },

  // ==============================
  // ðŸŒ¿ GREENS & NATURE (25-36)
  // ==============================
  {
    name: "Forest",
    bg: "bg-gradient-to-br from-green-800 to-emerald-900",
    text: "text-emerald-100",
    btn: "bg-emerald-500 text-white",
    preview: "from-green-800 to-emerald-900",
  },
  {
    name: "Neon Lime",
    bg: "bg-gradient-to-br from-lime-400 to-emerald-600",
    text: "text-white",
    btn: "bg-white text-emerald-600",
    preview: "from-lime-400 to-emerald-600",
  },
  {
    name: "Minty",
    bg: "bg-gradient-to-br from-emerald-100 to-teal-100",
    text: "text-teal-800",
    btn: "bg-teal-600 text-white",
    preview: "from-emerald-100 to-teal-100",
  },
  {
    name: "Olive",
    bg: "bg-gradient-to-br from-lime-800 to-stone-700",
    text: "text-lime-100",
    btn: "bg-lime-500 text-black",
    preview: "from-lime-800 to-stone-700",
  },
  {
    name: "Emerald City",
    bg: "bg-gradient-to-r from-emerald-500 to-teal-500",
    text: "text-white",
    btn: "bg-white text-teal-600",
    preview: "from-emerald-500 to-teal-500",
  },
  {
    name: "Grass",
    bg: "bg-gradient-to-br from-green-400 to-green-600",
    text: "text-white",
    btn: "bg-white text-green-600",
    preview: "from-green-400 to-green-600",
  },
  {
    name: "Sage",
    bg: "bg-gradient-to-br from-stone-300 to-emerald-200",
    text: "text-emerald-900",
    btn: "bg-emerald-700 text-white",
    preview: "from-stone-300 to-emerald-200",
  },
  {
    name: "Jungle",
    bg: "bg-gradient-to-br from-green-900 via-teal-900 to-black",
    text: "text-green-400",
    btn: "bg-green-600 text-black",
    preview: "from-green-900 via-teal-900 to-black",
  },
  {
    name: "Toxic",
    bg: "bg-gradient-to-br from-yellow-300 to-lime-400",
    text: "text-lime-900",
    btn: "bg-black text-lime-400",
    preview: "from-yellow-300 to-lime-400",
  },
  {
    name: "Matcha",
    bg: "bg-gradient-to-br from-green-200 to-stone-200",
    text: "text-green-900",
    btn: "bg-green-700 text-white",
    preview: "from-green-200 to-stone-200",
  },
  {
    name: "Seafoam",
    bg: "bg-gradient-to-tr from-teal-200 to-cyan-100",
    text: "text-teal-900",
    btn: "bg-teal-600 text-white",
    preview: "from-teal-200 to-cyan-100",
  },
  {
    name: "Cactus",
    bg: "bg-gradient-to-br from-emerald-700 to-green-800",
    text: "text-white",
    btn: "bg-orange-400 text-white",
    preview: "from-emerald-700 to-green-800",
  },

  // ==============================
  // ðŸ”® PURPLES & PINKS (37-48)
  // ==============================
  {
    name: "Midnight Purple",
    bg: "bg-gradient-to-br from-purple-900 to-indigo-800",
    text: "text-purple-100",
    btn: "bg-purple-500 text-white",
    preview: "from-purple-900 to-indigo-800",
  },
  {
    name: "Pink Lemonade",
    bg: "bg-gradient-to-br from-pink-400 to-orange-400",
    text: "text-white",
    btn: "bg-white text-pink-500",
    preview: "from-pink-400 to-orange-400",
  },
  {
    name: "Electric Purple",
    bg: "bg-gradient-to-br from-purple-600 to-blue-600",
    text: "text-white",
    btn: "bg-white text-purple-600",
    preview: "from-purple-600 to-blue-600",
  },
  {
    name: "Lavender",
    bg: "bg-gradient-to-br from-purple-200 to-fuchsia-100",
    text: "text-purple-800",
    btn: "bg-purple-600 text-white",
    preview: "from-purple-200 to-fuchsia-100",
  },
  {
    name: "Magenta",
    bg: "bg-gradient-to-br from-fuchsia-600 to-pink-600",
    text: "text-white",
    btn: "bg-white text-fuchsia-600",
    preview: "from-fuchsia-600 to-pink-600",
  },
  {
    name: "Grape",
    bg: "bg-gradient-to-br from-violet-700 to-purple-800",
    text: "text-white",
    btn: "bg-white text-purple-800",
    preview: "from-violet-700 to-purple-800",
  },
  {
    name: "Bubblegum",
    bg: "bg-gradient-to-br from-pink-300 to-rose-300",
    text: "text-pink-900",
    btn: "bg-pink-600 text-white",
    preview: "from-pink-300 to-rose-300",
  },
  {
    name: "Royalty",
    bg: "bg-gradient-to-br from-indigo-900 to-purple-900",
    text: "text-indigo-100",
    btn: "bg-amber-400 text-black",
    preview: "from-indigo-900 to-purple-900",
  },
  {
    name: "Cotton Candy",
    bg: "bg-gradient-to-r from-pink-200 via-purple-200 to-indigo-200",
    text: "text-purple-900",
    btn: "bg-purple-600 text-white",
    preview: "from-pink-200 via-purple-200 to-indigo-200",
  },
  {
    name: "Vaporwave",
    bg: "bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500",
    text: "text-white",
    btn: "bg-cyan-400 text-black",
    preview: "from-indigo-500 via-purple-500 to-pink-500",
  },
  {
    name: "Plum",
    bg: "bg-gradient-to-br from-fuchsia-900 to-slate-900",
    text: "text-fuchsia-100",
    btn: "bg-fuchsia-500 text-white",
    preview: "from-fuchsia-900 to-slate-900",
  },
  {
    name: "Flamingo",
    bg: "bg-gradient-to-br from-pink-500 to-rose-400",
    text: "text-white",
    btn: "bg-white text-rose-500",
    preview: "from-pink-500 to-rose-400",
  },

  // ==============================
  // â˜€ï¸ YELLOWS & GOLDS (49-60)
  // ==============================
  {
    name: "Golden Hour",
    bg: "bg-gradient-to-br from-amber-400 to-orange-600",
    text: "text-white",
    btn: "bg-white text-amber-600",
    preview: "from-amber-400 to-orange-600",
  },
  {
    name: "Luxury Gold",
    bg: "bg-gradient-to-br from-yellow-700 via-yellow-600 to-yellow-800",
    text: "text-yellow-50",
    btn: "bg-black text-yellow-500",
    preview: "from-yellow-700 to-yellow-800",
  },
  {
    name: "Lemon",
    bg: "bg-gradient-to-br from-yellow-300 to-yellow-400",
    text: "text-yellow-900",
    btn: "bg-black text-white",
    preview: "from-yellow-300 to-yellow-400",
  },
  {
    name: "Sunshine",
    bg: "bg-gradient-to-tr from-yellow-200 to-orange-100",
    text: "text-orange-800",
    btn: "bg-orange-500 text-white",
    preview: "from-yellow-200 to-orange-100",
  },
  {
    name: "Bee",
    bg: "bg-gradient-to-br from-yellow-400 to-black",
    text: "text-white",
    btn: "bg-white text-black",
    preview: "from-yellow-400 to-black",
  },
  {
    name: "Mustard",
    bg: "bg-gradient-to-br from-yellow-700 to-orange-800",
    text: "text-yellow-100",
    btn: "bg-yellow-400 text-black",
    preview: "from-yellow-700 to-orange-800",
  },
  {
    name: "Cream",
    bg: "bg-gradient-to-br from-yellow-50 to-orange-50",
    text: "text-orange-900",
    btn: "bg-orange-400 text-white",
    preview: "from-yellow-50 to-orange-50",
  },
  {
    name: "Amber",
    bg: "bg-gradient-to-br from-amber-500 to-amber-700",
    text: "text-white",
    btn: "bg-black text-amber-500",
    preview: "from-amber-500 to-amber-700",
  },
  {
    name: "Sand",
    bg: "bg-gradient-to-br from-stone-200 to-orange-100",
    text: "text-stone-800",
    btn: "bg-stone-600 text-white",
    preview: "from-stone-200 to-orange-100",
  },
  {
    name: "Brass",
    bg: "bg-gradient-to-br from-yellow-600 to-stone-600",
    text: "text-yellow-100",
    btn: "bg-white text-stone-800",
    preview: "from-yellow-600 to-stone-600",
  },
  {
    name: "Neon Yellow",
    bg: "bg-gradient-to-br from-yellow-300 to-lime-300",
    text: "text-black",
    btn: "bg-black text-yellow-300",
    preview: "from-yellow-300 to-lime-300",
  },
  {
    name: "Desert",
    bg: "bg-gradient-to-br from-orange-200 via-yellow-200 to-stone-300",
    text: "text-stone-800",
    btn: "bg-stone-800 text-white",
    preview: "from-orange-200 via-yellow-200 to-stone-300",
  },

  // ==============================
  // ðŸŒ‘ DARK & BLACKS (61-72)
  // ==============================
  {
    name: "Charcoal",
    bg: "bg-gradient-to-br from-gray-900 to-black",
    text: "text-gray-100",
    btn: "bg-white text-black",
    preview: "from-gray-900 to-black",
  },
  {
    name: "Midnight",
    bg: "bg-gradient-to-br from-slate-900 to-slate-800",
    text: "text-slate-100",
    btn: "bg-blue-600 text-white",
    preview: "from-slate-900 to-slate-800",
  },
  {
    name: "Obsidian",
    bg: "bg-gradient-to-br from-zinc-900 to-zinc-950",
    text: "text-zinc-100",
    btn: "bg-zinc-100 text-black",
    preview: "from-zinc-900 to-zinc-950",
  },
  {
    name: "Space",
    bg: "bg-gradient-to-b from-black via-purple-950 to-black",
    text: "text-white",
    btn: "bg-white text-purple-950",
    preview: "from-black via-purple-950 to-black",
  },
  {
    name: "Vampire",
    bg: "bg-gradient-to-br from-gray-900 to-red-900",
    text: "text-red-100",
    btn: "bg-red-600 text-white",
    preview: "from-gray-900 to-red-900",
  },
  {
    name: "Gunmetal",
    bg: "bg-gradient-to-br from-gray-700 to-slate-800",
    text: "text-white",
    btn: "bg-teal-500 text-white",
    preview: "from-gray-700 to-slate-800",
  },
  {
    name: "Dark Moss",
    bg: "bg-gradient-to-br from-stone-900 to-green-900",
    text: "text-green-100",
    btn: "bg-green-600 text-white",
    preview: "from-stone-900 to-green-900",
  },
  {
    name: "Eclipse",
    bg: "bg-gradient-to-br from-gray-900 via-gray-800 to-black",
    text: "text-white",
    btn: "bg-white text-black",
    preview: "from-gray-900 via-gray-800 to-black",
  },
  {
    name: "Abyss",
    bg: "bg-gradient-to-br from-blue-950 to-black",
    text: "text-blue-100",
    btn: "bg-blue-600 text-white",
    preview: "from-blue-950 to-black",
  },
  {
    name: "Carbon",
    bg: "bg-[conic-gradient(at_top_left,_var(--tw-gradient-stops))] from-gray-900 via-gray-800 to-black",
    text: "text-gray-200",
    btn: "bg-orange-600 text-white",
    preview: "from-gray-900 via-gray-800 to-black",
  },
  {
    name: "Luxury Dark",
    bg: "bg-gradient-to-br from-neutral-900 to-stone-900",
    text: "text-amber-100",
    btn: "bg-amber-600 text-white",
    preview: "from-neutral-900 to-stone-900",
  },
  {
    name: "Cyber Dark",
    bg: "bg-gradient-to-br from-gray-900 to-cyan-900",
    text: "text-cyan-100",
    btn: "bg-cyan-500 text-black",
    preview: "from-gray-900 to-cyan-900",
  },

  // ==============================
  // ðŸ³ï¸ LIGHT & WHITES (73-84)
  // ==============================
  {
    name: "Minimal",
    bg: "bg-gradient-to-br from-gray-100 to-white",
    text: "text-gray-900",
    btn: "bg-black text-white",
    preview: "from-gray-100 to-white",
  },
  {
    name: "Paper",
    bg: "bg-gradient-to-br from-stone-100 to-stone-50",
    text: "text-stone-800",
    btn: "bg-stone-800 text-white",
    preview: "from-stone-100 to-stone-50",
  },
  {
    name: "Cloud",
    bg: "bg-gradient-to-br from-blue-50 to-white",
    text: "text-blue-900",
    btn: "bg-blue-600 text-white",
    preview: "from-blue-50 to-white",
  },
  {
    name: "Rose Water",
    bg: "bg-gradient-to-br from-rose-50 to-white",
    text: "text-rose-900",
    btn: "bg-rose-500 text-white",
    preview: "from-rose-50 to-white",
  },
  {
    name: "Pearl",
    bg: "bg-gradient-to-tr from-gray-200 via-white to-gray-200",
    text: "text-gray-800",
    btn: "bg-gray-800 text-white",
    preview: "from-gray-200 via-white to-gray-200",
  },
  {
    name: "Linen",
    bg: "bg-gradient-to-br from-orange-50 to-stone-100",
    text: "text-stone-800",
    btn: "bg-stone-600 text-white",
    preview: "from-orange-50 to-stone-100",
  },
  {
    name: "Winter",
    bg: "bg-gradient-to-br from-slate-100 to-slate-200",
    text: "text-slate-800",
    btn: "bg-slate-600 text-white",
    preview: "from-slate-100 to-slate-200",
  },
  {
    name: "Mint Cream",
    bg: "bg-gradient-to-br from-emerald-50 to-white",
    text: "text-emerald-900",
    btn: "bg-emerald-600 text-white",
    preview: "from-emerald-50 to-white",
  },
  {
    name: "Lavender White",
    bg: "bg-gradient-to-br from-purple-50 to-white",
    text: "text-purple-900",
    btn: "bg-purple-600 text-white",
    preview: "from-purple-50 to-white",
  },
  {
    name: "Clean",
    bg: "bg-white",
    text: "text-gray-900",
    btn: "bg-blue-600 text-white",
    preview: "from-white to-gray-100",
  },
  {
    name: "Ivory",
    bg: "bg-gradient-to-br from-yellow-50 to-stone-50",
    text: "text-stone-800",
    btn: "bg-stone-800 text-white",
    preview: "from-yellow-50 to-stone-50",
  },
  {
    name: "Glass",
    bg: "bg-gradient-to-br from-white to-blue-50 border border-blue-100",
    text: "text-blue-900",
    btn: "bg-blue-500 text-white",
    preview: "from-white to-blue-50",
  },

  // ==============================
  // ðŸŒˆ SPECIAL / MIXED (85-100)
  // ==============================
  {
    name: "Northern Lights",
    bg: "bg-gradient-to-r from-teal-400 via-blue-500 to-purple-500",
    text: "text-white",
    btn: "bg-white text-indigo-600",
    preview: "from-teal-400 via-blue-500 to-purple-500",
  },
  {
    name: "Instagram",
    bg: "bg-gradient-to-bl from-yellow-400 via-pink-500 to-purple-600",
    text: "text-white",
    btn: "bg-white text-pink-600",
    preview: "from-yellow-400 via-pink-500 to-purple-600",
  },
  {
    name: "Cyberpunk",
    bg: "bg-gradient-to-r from-pink-500 via-red-500 to-yellow-500",
    text: "text-white",
    btn: "bg-black text-white",
    preview: "from-pink-500 via-red-500 to-yellow-500",
  },
  {
    name: "Steel Grey",
    bg: "bg-gradient-to-br from-gray-400 to-gray-600",
    text: "text-white",
    btn: "bg-gray-800 text-white",
    preview: "from-gray-400 to-gray-600",
  },
  {
    name: "Rainbow",
    bg: "bg-gradient-to-r from-red-500 via-green-500 to-blue-500",
    text: "text-white",
    btn: "bg-white text-black",
    preview: "from-red-500 via-green-500 to-blue-500",
  },
  {
    name: "Holographic",
    bg: "bg-gradient-to-tr from-pink-300 via-purple-300 to-indigo-400",
    text: "text-white",
    btn: "bg-white/50 backdrop-blur-md text-purple-900",
    preview: "from-pink-300 via-purple-300 to-indigo-400",
  },
  {
    name: "Patriot",
    bg: "bg-gradient-to-br from-blue-900 via-white to-red-700",
    text: "text-slate-900",
    btn: "bg-blue-900 text-white",
    preview: "from-blue-900 via-white to-red-700",
  },
  {
    name: "Tropical",
    bg: "bg-gradient-to-br from-green-400 to-blue-500",
    text: "text-white",
    btn: "bg-yellow-400 text-black",
    preview: "from-green-400 to-blue-500",
  },
  {
    name: "Candy Shop",
    bg: "bg-gradient-to-r from-pink-300 via-purple-300 to-cyan-300",
    text: "text-purple-800",
    btn: "bg-white text-purple-600",
    preview: "from-pink-300 via-purple-300 to-cyan-300",
  },
  {
    name: "Dusk",
    bg: "bg-gradient-to-br from-indigo-800 via-purple-800 to-orange-700",
    text: "text-orange-100",
    btn: "bg-orange-500 text-white",
    preview: "from-indigo-800 via-purple-800 to-orange-700",
  },
  {
    name: "Dawn",
    bg: "bg-gradient-to-br from-indigo-300 via-purple-300 to-orange-300",
    text: "text-indigo-900",
    btn: "bg-indigo-600 text-white",
    preview: "from-indigo-300 via-purple-300 to-orange-300",
  },
  {
    name: "Grey Teal",
    bg: "bg-gradient-to-br from-gray-700 to-teal-700",
    text: "text-white",
    btn: "bg-teal-400 text-black",
    preview: "from-gray-700 to-teal-700",
  },
  {
    name: "Warmth",
    bg: "bg-gradient-to-br from-stone-500 to-orange-400",
    text: "text-white",
    btn: "bg-white text-orange-600",
    preview: "from-stone-500 to-orange-400",
  },
  {
    name: "Cooling",
    bg: "bg-gradient-to-br from-blue-200 to-slate-300",
    text: "text-slate-800",
    btn: "bg-slate-700 text-white",
    preview: "from-blue-200 to-slate-300",
  },
  {
    name: "Matrix",
    bg: "bg-gradient-to-b from-black via-green-900 to-black",
    text: "text-green-400",
    btn: "bg-green-600 text-black",
    preview: "from-black via-green-900 to-black",
  },
  {
    name: "Coffee",
    bg: "bg-gradient-to-br from-stone-800 to-orange-900",
    text: "text-orange-100",
    btn: "bg-orange-700 text-white",
    preview: "from-stone-800 to-orange-900",
  },
];

const initialSlide: CarouselSlide = {
  title: "",
  subtitle: "",
  discount: "",
  description: "",
  buttonText: "Shop Now",
  link: "/products",
  bgClass: THEME_PRESETS[0].bg,
  textClass: THEME_PRESETS[0].text,
  buttonClass: THEME_PRESETS[0].btn,
  isActive: true,
  order: 0,
};

// --- STYLES ---
const pageBackground = "fixed inset-0 bg-[#0a0a0a] -z-20";
const ambientGlow =
  "fixed inset-0 bg-[radial-gradient(circle_at_50%_50%,_rgba(76,29,149,0.15),_rgba(0,0,0,0))] -z-10 pointer-events-none";
const glassCard =
  "bg-white/5 backdrop-blur-xl border border-white/10 shadow-2xl rounded-2xl overflow-hidden hover:bg-white/10 hover:border-white/20 transition-all duration-300 group";
const glassModal =
  "bg-[#121212]/95 backdrop-blur-2xl border border-white/10 shadow-2xl rounded-2xl";
const glassInput =
  "w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500/50 focus:bg-white/10 transition-all text-sm";
const glassButton =
  "flex items-center justify-center gap-2 px-6 py-3 rounded-xl font-medium transition-all active:scale-95 shadow-lg shadow-black/20 hover:shadow-xl";

export default function AdminCarouselPage() {
  const [slides, setSlides] = useState<CarouselSlide[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isEditing, setIsEditing] = useState(false);
  const [currentSlide, setCurrentSlide] = useState<CarouselSlide>(initialSlide);
  const [showModal, setShowModal] = useState(false);

  const API_URL =
    process.env.NEXT_PUBLIC_API_URL || "http://localhost:5000/api";

  const fetchSlides = async () => {
    try {
      setIsLoading(true);
      const token = localStorage.getItem("token");
      const res = await axios.get(`${API_URL}/carousel/admin/all`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      if (res.data.success) setSlides(res.data.data);
    } catch (error) {
      toast.error("Failed to load slides");
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    fetchSlides();
  }, []);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    const token = localStorage.getItem("token");

    try {
      if (isEditing && currentSlide._id) {
        await axios.put(
          `${API_URL}/carousel/${currentSlide._id}`,
          currentSlide,
          {
            headers: { Authorization: `Bearer ${token}` },
          },
        );
        toast.success("Updated successfully!");
      } else {
        await axios.post(`${API_URL}/carousel`, currentSlide, {
          headers: { Authorization: `Bearer ${token}` },
        });
        toast.success("Created successfully!");
      }
      closeModal();
      fetchSlides();
    } catch (error) {
      toast.error("Operation failed");
    }
  };

  const handleDelete = async (id: string) => {
    if (!confirm("Are you sure? This action cannot be undone.")) return;
    try {
      const token = localStorage.getItem("token");
      await axios.delete(`${API_URL}/carousel/${id}`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      toast.success("Deleted!");
      fetchSlides();
    } catch (error) {
      toast.error("Failed to delete");
    }
  };

  const toggleStatus = async (slide: CarouselSlide) => {
    try {
      const token = localStorage.getItem("token");
      await axios.put(
        `${API_URL}/carousel/${slide._id}`,
        { ...slide, isActive: !slide.isActive },
        { headers: { Authorization: `Bearer ${token}` } },
      );
      fetchSlides();
      toast.success(slide.isActive ? "Slide hidden" : "Slide activated");
    } catch (error) {
      toast.error("Update failed");
    }
  };

  const handleThemeSelect = (theme: (typeof THEME_PRESETS)[0]) => {
    setCurrentSlide({
      ...currentSlide,
      bgClass: theme.bg,
      textClass: theme.text,
      buttonClass: theme.btn,
    });
  };

  const openModal = (slide?: CarouselSlide) => {
    if (slide) {
      setCurrentSlide(slide);
      setIsEditing(true);
    } else {
      setCurrentSlide(initialSlide);
      setIsEditing(false);
    }
    setShowModal(true);
  };

  const closeModal = () => {
    setShowModal(false);
    setCurrentSlide(initialSlide);
  };

  return (
    <div className="min-h-screen text-gray-100 p-4 md:p-8 font-sans relative overflow-hidden">
      {/* Background Effects */}
      <div className={pageBackground}></div>
      <div className={ambientGlow}></div>
      <div className="fixed top-[-20%] left-[-10%] w-[600px] h-[600px] bg-blue-600/10 rounded-full blur-[150px] pointer-events-none"></div>
      <div className="fixed bottom-[-20%] right-[-10%] w-[600px] h-[600px] bg-purple-600/10 rounded-full blur-[150px] pointer-events-none"></div>

      <div className="relative z-10 max-w-7xl mx-auto">
        {/* HEADER */}
        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-6 bg-white/5 p-6 rounded-3xl backdrop-blur-xl border border-white/10 shadow-2xl">
          <div>
            <h1 className="text-3xl md:text-4xl font-bold bg-gradient-to-r from-white via-gray-200 to-gray-400 bg-clip-text text-transparent">
              Carousel Manager
            </h1>
            <p className="text-gray-400 mt-2 text-sm flex items-center gap-2">
              <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
              Manage your homepage banners live
            </p>
          </div>
          <button
            onClick={() => openModal()}
            className={`${glassButton} bg-blue-600 hover:bg-blue-500 text-white border border-blue-400/20`}
          >
            <Plus size={20} />
            <span>Add New Slide</span>
          </button>
        </div>

        {/* LOADING */}
        {isLoading ? (
          <div className="flex h-96 items-center justify-center">
            <Loader2 className="animate-spin text-blue-500 h-10 w-10" />
          </div>
        ) : (
          /* SLIDES GRID */
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <AnimatePresence>
              {slides.map((slide) => (
                <motion.div
                  layout
                  initial={{ opacity: 0, scale: 0.95 }}
                  animate={{ opacity: 1, scale: 1 }}
                  exit={{ opacity: 0, scale: 0.9 }}
                  key={slide._id}
                  className={glassCard}
                >
                  {/* Visual Preview */}
                  <div
                    className={`h-48 w-full ${slide.bgClass} flex flex-col justify-center px-8 relative overflow-hidden`}
                  >
                    <div className="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] mix-blend-overlay"></div>
                    <div className="relative z-10 space-y-2">
                      <span className="text-[10px] font-bold uppercase tracking-widest bg-black/30 backdrop-blur-md text-white px-2 py-1 rounded-md border border-white/10 inline-block">
                        {slide.discount}
                      </span>
                      <h3
                        className={`text-2xl font-bold leading-tight line-clamp-1 ${slide.textClass} drop-shadow-lg`}
                      >
                        {slide.title}
                      </h3>
                      <p
                        className={`text-xs opacity-90 line-clamp-1 ${slide.textClass} font-medium`}
                      >
                        {slide.subtitle}
                      </p>
                    </div>
                    {/* Status Pill */}
                    <div className="absolute top-4 right-4">
                      <span
                        className={`px-3 py-1 text-[10px] font-bold rounded-full border backdrop-blur-xl shadow-lg flex items-center gap-1.5 ${
                          slide.isActive
                            ? "bg-green-500/20 text-white border-green-500/30"
                            : "bg-red-500/20 text-red-200 border-red-500/30"
                        }`}
                      >
                        <span
                          className={`w-1.5 h-1.5 rounded-full ${slide.isActive ? "bg-green-400 animate-pulse" : "bg-red-400"}`}
                        ></span>
                        {slide.isActive ? "ACTIVE" : "HIDDEN"}
                      </span>
                    </div>
                  </div>

                  {/* Actions */}
                  <div className="p-5 flex flex-col gap-4 bg-[#121212]/40">
                    <div className="flex justify-between items-center text-xs text-gray-400 font-medium">
                      <div className="flex items-center gap-1.5 bg-white/5 px-2.5 py-1.5 rounded-lg border border-white/5">
                        <LayoutGrid size={14} />
                        <span>Order: {slide.order}</span>
                      </div>
                      {slide.link && (
                        <a
                          href={slide.link}
                          target="_blank"
                          className="flex items-center gap-1 hover:text-blue-400 transition-colors"
                        >
                          Link <ExternalLink size={12} />
                        </a>
                      )}
                    </div>

                    <div className="flex items-center justify-between pt-4 border-t border-white/5">
                      <button
                        onClick={() => toggleStatus(slide)}
                        className={`p-2.5 rounded-xl transition-all duration-300 ${
                          slide.isActive
                            ? "text-gray-400 hover:text-white hover:bg-white/10"
                            : "text-gray-500 hover:text-gray-300"
                        }`}
                        title={slide.isActive ? "Hide Slide" : "Show Slide"}
                      >
                        {slide.isActive ? (
                          <Eye size={18} />
                        ) : (
                          <EyeOff size={18} />
                        )}
                      </button>

                      <div className="flex gap-2">
                        <button
                          onClick={() => openModal(slide)}
                          className="p-2.5 text-blue-400 hover:text-white hover:bg-blue-600 rounded-xl transition-all duration-300 shadow-sm"
                        >
                          <Edit2 size={18} />
                        </button>
                        <button
                          onClick={() => handleDelete(slide._id!)}
                          className="p-2.5 text-red-400 hover:text-white hover:bg-red-600 rounded-xl transition-all duration-300 shadow-sm"
                        >
                          <Trash2 size={18} />
                        </button>
                      </div>
                    </div>
                  </div>
                </motion.div>
              ))}
            </AnimatePresence>
          </div>
        )}
      </div>

      {/* --- MODAL (Overlay) --- */}
      <AnimatePresence>
        {showModal && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-md"
          >
            <motion.div
              initial={{ y: 50, opacity: 0, scale: 0.95 }}
              animate={{ y: 0, opacity: 1, scale: 1 }}
              exit={{ y: 50, opacity: 0, scale: 0.95 }}
              className={`w-full max-w-4xl ${glassModal} flex flex-col max-h-[90vh]`}
            >
              {/* Header */}
              <div className="p-6 border-b border-white/10 flex justify-between items-center bg-white/5 rounded-t-2xl">
                <div>
                  <h2 className="text-xl font-bold text-white flex items-center gap-2">
                    {isEditing ? (
                      <Edit2 size={20} className="text-blue-400" />
                    ) : (
                      <Plus size={20} className="text-green-400" />
                    )}
                    {isEditing ? "Edit Slide" : "Create New Slide"}
                  </h2>
                  <p className="text-gray-400 text-xs mt-1 ml-7">
                    Customize your slide appearance
                  </p>
                </div>
                <button
                  onClick={closeModal}
                  className="text-gray-400 hover:text-white p-2 hover:bg-white/10 rounded-full transition"
                >
                  <X size={24} />
                </button>
              </div>

              {/* Scrollable Form */}
              <div className="overflow-y-auto p-6 md:p-8 custom-scrollbar">
                <form onSubmit={handleSubmit} className="space-y-8">
                  {/* 1. TEXT CONTENT (2 Columns) */}
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="space-y-4">
                      <h3 className="text-xs font-bold text-gray-500 uppercase tracking-widest border-b border-white/10 pb-2">
                        Main Info
                      </h3>
                      <div className="space-y-3">
                        <div>
                          <label className="text-xs text-gray-400 ml-1">
                            Main Title
                          </label>
                          <input
                            required
                            type="text"
                            value={currentSlide.title}
                            onChange={(e) =>
                              setCurrentSlide({
                                ...currentSlide,
                                title: e.target.value,
                              })
                            }
                            className={glassInput}
                            placeholder="e.g. Summer Sale"
                          />
                        </div>
                        <div>
                          <label className="text-xs text-gray-400 ml-1">
                            Subtitle
                          </label>
                          <input
                            required
                            type="text"
                            value={currentSlide.subtitle}
                            onChange={(e) =>
                              setCurrentSlide({
                                ...currentSlide,
                                subtitle: e.target.value,
                              })
                            }
                            className={glassInput}
                            placeholder="e.g. Up to 50% Off"
                          />
                        </div>
                        <div>
                          <label className="text-xs text-gray-400 ml-1">
                            Description
                          </label>
                          <input
                            required
                            type="text"
                            value={currentSlide.description}
                            onChange={(e) =>
                              setCurrentSlide({
                                ...currentSlide,
                                description: e.target.value,
                              })
                            }
                            className={glassInput}
                            placeholder="Brief description..."
                          />
                        </div>
                      </div>
                    </div>

                    <div className="space-y-4">
                      <h3 className="text-xs font-bold text-gray-500 uppercase tracking-widest border-b border-white/10 pb-2">
                        Action Details
                      </h3>
                      <div className="space-y-3">
                        <div>
                          <label className="text-xs text-gray-400 ml-1">
                            Discount Tag
                          </label>
                          <input
                            required
                            type="text"
                            value={currentSlide.discount}
                            onChange={(e) =>
                              setCurrentSlide({
                                ...currentSlide,
                                discount: e.target.value,
                              })
                            }
                            className={glassInput}
                            placeholder="e.g. FLAT 20% OFF"
                          />
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                          <div>
                            <label className="text-xs text-gray-400 ml-1">
                              Button Text
                            </label>
                            <input
                              type="text"
                              value={currentSlide.buttonText}
                              onChange={(e) =>
                                setCurrentSlide({
                                  ...currentSlide,
                                  buttonText: e.target.value,
                                })
                              }
                              className={glassInput}
                              placeholder="Shop Now"
                            />
                          </div>
                          <div>
                            <label className="text-xs text-gray-400 ml-1">
                              Sort Order
                            </label>
                            <input
                              type="number"
                              value={currentSlide.order}
                              onChange={(e) =>
                                setCurrentSlide({
                                  ...currentSlide,
                                  order: parseInt(e.target.value),
                                })
                              }
                              className={glassInput}
                            />
                          </div>
                        </div>
                        <div>
                          <label className="text-xs text-gray-400 ml-1">
                            Link URL
                          </label>
                          <input
                            required
                            type="text"
                            value={currentSlide.link}
                            onChange={(e) =>
                              setCurrentSlide({
                                ...currentSlide,
                                link: e.target.value,
                              })
                            }
                            className={glassInput}
                            placeholder="/products?category=..."
                          />
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* 2. SETTINGS ROW (Active Toggle) */}
                  <div className="flex items-center gap-3 bg-white/5 p-4 rounded-xl border border-white/5">
                    <label className="flex items-center gap-3 cursor-pointer group w-full">
                      <div className="relative">
                        <input
                          type="checkbox"
                          checked={currentSlide.isActive}
                          onChange={(e) =>
                            setCurrentSlide({
                              ...currentSlide,
                              isActive: e.target.checked,
                            })
                          }
                          className="peer sr-only"
                        />
                        <div className="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                      </div>
                      <div className="flex flex-col">
                        <span className="text-sm font-medium text-white group-hover:text-blue-400 transition-colors">
                          Set Slide as Active
                        </span>
                        <span className="text-xs text-gray-500">
                          Enable this to show the slide on the homepage
                          immediately.
                        </span>
                      </div>
                    </label>
                  </div>

                  {/* 3. THEME SELECTOR */}
                  <div>
                    <div className="flex items-center justify-between mb-4">
                      <h3 className="text-xs font-bold text-gray-500 uppercase tracking-widest flex items-center gap-2">
                        <Palette size={14} className="text-blue-400" /> Color
                        Theme
                      </h3>
                      <span className="text-[10px] text-gray-400 bg-white/5 px-2 py-1 rounded border border-white/5">
                        {THEME_PRESETS.length} Styles
                      </span>
                    </div>

                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 max-h-52 overflow-y-auto custom-scrollbar p-1">
                      {THEME_PRESETS.map((theme, idx) => (
                        <div
                          key={idx}
                          onClick={() => handleThemeSelect(theme)}
                          className={`cursor-pointer rounded-xl p-1 border-2 transition-all relative group ${
                            currentSlide.bgClass === theme.bg
                              ? "border-blue-500 bg-white/10 shadow-[0_0_15px_rgba(59,130,246,0.3)] scale-[1.02]"
                              : "border-transparent hover:border-white/20 hover:bg-white/5"
                          }`}
                        >
                          <div
                            className={`h-12 rounded-lg bg-gradient-to-br ${theme.preview} flex items-center justify-center shadow-inner relative overflow-hidden`}
                          >
                            {currentSlide.bgClass === theme.bg && (
                              <div className="absolute inset-0 bg-black/20 flex items-center justify-center backdrop-blur-[1px]">
                                <div className="bg-white rounded-full p-1 shadow-lg">
                                  <Check
                                    size={12}
                                    className="text-blue-600 stroke-[3]"
                                  />
                                </div>
                              </div>
                            )}
                          </div>
                          <p
                            className={`text-[10px] text-center mt-2 font-medium truncate px-1 ${currentSlide.bgClass === theme.bg ? "text-blue-400" : "text-gray-400 group-hover:text-white"}`}
                          >
                            {theme.name}
                          </p>
                        </div>
                      ))}
                    </div>
                  </div>
                </form>
              </div>

              {/* Modal Footer */}
              <div className="p-6 border-t border-white/10 bg-white/5 flex justify-end gap-4 rounded-b-2xl">
                <button
                  onClick={closeModal}
                  className="px-6 py-2.5 rounded-xl text-gray-400 hover:text-white hover:bg-white/10 transition font-medium"
                >
                  Cancel
                </button>
                <button
                  onClick={handleSubmit}
                  className={`${glassButton} bg-blue-600 hover:bg-blue-500 text-white shadow-blue-500/20`}
                >
                  <Save size={18} />
                  <span>{isEditing ? "Save Changes" : "Create Slide"}</span>
                </button>
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}
</file>

<file path="app/dashboard/categories/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { motion } from 'framer-motion';
import { Package, TrendingUp, DollarSign } from 'lucide-react';
import { ProductService } from '@/lib/api';
import { toast } from 'sonner';
import { formatCurrency, cn } from '@/lib/utils';
import type { Product, ProductCategory } from '@/types';
import Link from 'next/link';
import Image from 'next/image';

const CATEGORIES: ProductCategory[] = [
  'Engine',
  'Brake',
  'Electrical',
  'Body',
  'Accessories',
  'Suspension',
  'Transmission',
  'Interior',
  'Exterior',
  'Service Parts',
];

const CATEGORY_ICONS: Record<string, string> = {
  Engine: 'âš™ï¸',
  Brake: 'ðŸ›‘',
  Electrical: 'âš¡',
  Body: 'ðŸš—',
  Accessories: 'ðŸ”§',
  Suspension: 'ðŸŽï¸',
  Transmission: 'âš™ï¸',
  Interior: 'ðŸª‘',
  Exterior: 'âœ¨',
  'Service Parts': 'ðŸ”©',
};

export default function CategoriesPage() {
  const [isLoading, setIsLoading] = useState(true);
  const [selectedCategory, setSelectedCategory] = useState<ProductCategory>('Engine');
  const [products, setProducts] = useState<Product[]>([]);
  const [categoryStats, setCategoryStats] = useState<Record<string, { count: number; revenue: number }>>({});

  useEffect(() => {
    fetchAllProducts();
  }, []);

  useEffect(() => {
    fetchProductsByCategory(selectedCategory);
  }, [selectedCategory]);

  const fetchAllProducts = async () => {
    try {
      // Assuming getAll returns a paginated list, we might need a way to get *all* stats.
      // If your API supports a stats endpoint, that's better. 
      // For now, we'll try to fetch a large number to calculate local stats or rely on what's returned.
      
      const response = await ProductService.getAll({ limit: 1000 }); // Fetch large batch to calculate stats accurately
      const allProducts = response.data.data?.products || response.data.products || response.data || [];
      
      // Calculate stats for each category
      const stats: Record<string, { count: number; revenue: number }> = {};
      
      // Initialize with 0
      CATEGORIES.forEach(cat => {
        stats[cat] = { count: 0, revenue: 0 };
      });

      if (Array.isArray(allProducts)) {
        allProducts.forEach((p: Product) => {
          if (p.category && stats[p.category]) {
            stats[p.category].count += 1;
            // Assuming 'revenue' is calculated from price * totalSales, or just use price for potential value
            // If totalSales exists on product:
            stats[p.category].revenue += (p.price * (p.totalSales || 0));
          }
        });
      }
      
      setCategoryStats(stats);
    } catch (error: any) {
      console.error('Products fetch error:', error);
    }
  };

  const fetchProductsByCategory = async (category: ProductCategory) => {
    try {
      setIsLoading(true);
      // Fetch specific category products
      const response = await ProductService.getByCategory(category);
      const data = response.data.data || response.data;
      
      // Handle different API response structures
      const categoryProducts = Array.isArray(data) ? data : data.products || [];
      setProducts(categoryProducts);
      
    } catch (error: any) {
      console.error('Category products fetch error:', error);
      toast.error(`Failed to fetch ${category} products`);
      setProducts([]);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <motion.div
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.5 }}
      >
        <h1 className="text-3xl font-bold text-white">Categories</h1>
        <p className="mt-1 text-gray-400">
          Browse products by category
        </p>
      </motion.div>

      {/* Category Grid */}
      <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-5">
        {CATEGORIES.map((category, index) => {
          const stats = categoryStats[category] || { count: 0, revenue: 0 };
          const isSelected = selectedCategory === category;

          return (
            <motion.button
              key={category}
              initial={{ opacity: 0, scale: 0.9 }}
              animate={{ opacity: 1, scale: 1 }}
              transition={{ delay: index * 0.05 }}
              whileHover={{ y: -4, scale: 1.02 }}
              whileTap={{ scale: 0.98 }}
              onClick={() => setSelectedCategory(category)}
              className={cn(
                'rounded-2xl border p-6 text-left transition-all',
                isSelected
                  ? 'border-blue-500 bg-gradient-to-br from-blue-500/20 to-cyan-500/10 shadow-lg shadow-blue-500/20'
                  : 'border-white/10 bg-white/[0.02] hover:border-white/20 hover:bg-white/[0.05]'
              )}
            >
              <div className="mb-3 text-4xl">{CATEGORY_ICONS[category]}</div>
              <h3 className="text-lg font-semibold text-white">{category}</h3>
              <div className="mt-3 space-y-1">
                <div className="flex items-center gap-2 text-sm text-gray-400">
                  <Package className="h-3 w-3" />
                  {/* Displaying the updated count */}
                  {stats.count} Products
                </div>
                {stats.revenue > 0 && (
                  <div className="flex items-center gap-2 text-sm text-green-400">
                    <DollarSign className="h-3 w-3" />
                    {formatCurrency(stats.revenue)}
                  </div>
                )}
              </div>
            </motion.button>
          );
        })}
      </div>

      {/* Products List */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.3 }}
        className="rounded-2xl border border-white/10 bg-white/[0.02] p-6 backdrop-blur-sm"
      >
        <div className="mb-6 flex items-center justify-between">
          <div>
            <h2 className="text-xl font-semibold text-white">{selectedCategory} Products</h2>
            <p className="mt-1 text-sm text-gray-400">
              {products.length} {products.length === 1 ? 'product' : 'products'} found
            </p>
          </div>
          <Link href="/dashboard/products/add">
            <motion.button
              whileHover={{ scale: 1.05 }}
              whileTap={{ scale: 0.95 }}
              className="rounded-xl bg-blue-500 px-4 py-2 text-sm font-medium text-white shadow-lg shadow-blue-500/30 transition-colors hover:bg-blue-600"
            >
              Add Product
            </motion.button>
          </Link>
        </div>

        {isLoading ? (
          <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
            {Array.from({ length: 8 }).map((_, i) => (
              <div key={i} className="h-64 animate-pulse rounded-xl bg-white/5" />
            ))}
          </div>
        ) : products.length > 0 ? (
          <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
            {products.map((product, index) => (
              <motion.div
                key={product._id}
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: index * 0.05 }}
                whileHover={{ y: -4 }}
                className="group relative overflow-hidden rounded-xl border border-white/10 bg-white/[0.02] transition-all hover:border-white/20 hover:shadow-lg"
              >
                <Link href={`/dashboard/products/${product._id}`}>
                  <div className="aspect-square overflow-hidden bg-white/5">
                    {product.images && product.images.length > 0 ? (
                      <Image
                        src={product.images[0].url}
                        alt={product.name}
                        width={300}
                        height={300}
                        className="h-full w-full object-cover transition-transform group-hover:scale-110"
                      />
                    ) : (
                      <div className="flex h-full items-center justify-center text-4xl">
                        {CATEGORY_ICONS[product.category]}
                      </div>
                    )}
                  </div>
                  
                  <div className="p-4">
                    <h3 className="font-semibold text-white line-clamp-2">{product.name}</h3>
                    <p className="mt-1 text-xs text-gray-400 font-mono">{product.partNumber}</p>
                    
                    <div className="mt-3 flex items-center justify-between">
                      <div>
                        <p className="text-lg font-bold text-white">
                          {formatCurrency(product.finalPrice)}
                        </p>
                        {product.discountPrice && (
                          <p className="text-xs text-gray-500 line-through">
                            {formatCurrency(product.price)}
                          </p>
                        )}
                      </div>
                      
                      <span className={cn(
                        'text-xs font-medium',
                        product.stockStatus === 'In Stock' ? 'text-green-400' : 
                        product.stockStatus === 'Low Stock' ? 'text-yellow-400' : 
                        'text-red-400'
                      )}>
                        {product.stockStatus}
                      </span>
                    </div>
                  </div>
                </Link>
              </motion.div>
            ))}
          </div>
        ) : (
          <div className="flex flex-col items-center justify-center py-12 text-center">
            <Package className="h-16 w-16 text-gray-600" />
            <p className="mt-4 text-lg font-medium text-gray-400">No products found</p>
            <p className="mt-1 text-sm text-gray-500">
              Add products to this category to see them here
            </p>
          </div>
        )}
      </motion.div>
    </div>
  );
}
</file>

<file path="app/dashboard/chat/page.tsx">
// "use client";

// import { useState, useEffect, useRef } from "react";
// import { motion, AnimatePresence } from "framer-motion";
// import {
//   Search,
//   Send,
//   Paperclip,
//   MoreVertical,
//   Phone,
//   Video,
//   ArrowLeft,
//   Check,
//   CheckCheck,
//   Smile,
//   Mic,
//   Loader2,
//   Lock,
//   X,
//   StopCircle,
// } from "lucide-react";
// import { format } from "date-fns";
// import { io, Socket } from "socket.io-client";
// import { ChatService, AdminAuthService } from "@/lib/api";
// import { toast } from "sonner";

// // --- Types ---
// interface ChatUser {
//   _id: string;
//   name: string;
//   email: string;
//   avatar?: string;
//   roomId: string;
//   lastMessage?: string;
//   lastMessageTime?: string;
//   unreadCount?: number;
//   isOnline?: boolean;
// }

// interface ChatMessage {
//   _id: string;
//   senderId:
//     | { _id: string; name: string; email: string; profilePicture?: string }
//     | string;
//   text: string;
//   createdAt: string;
//   isRead: boolean;
//   messageType: "text" | "image" | "video" | "audio";
//   fileUrl?: string;
//   roomId: string;
//   tempId?: number; // For identifying optimistic messages
// }

// // Quick Replies
// const QUICK_REPLIES = [
//   "Hello! How can I help you?",
//   "Your order has been shipped.",
//   "Please provide your Order ID.",
//   "The item is currently out of stock.",
//   "Thank you for contacting us!",
//   "Price for this bumper is â‚¹2,400.",
// ];

// // Helper: Safe ID Extraction
// const getSafeId = (data: any): string => {
//   if (!data) return "";
//   return typeof data === "object" ? data._id : data;
// };

// const glassPanel =
//   "bg-white/5 backdrop-blur-xl border border-white/10 shadow-xl";
// const glassInput =
//   "bg-black/20 border border-white/10 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500/50 focus:bg-black/30";

// export default function ChatPage() {
//   // --- STATE ---
//   const [adminId, setAdminId] = useState<string>("");
//   const [users, setUsers] = useState<ChatUser[]>([]);
//   const [activeUser, setActiveUser] = useState<ChatUser | null>(null);
//   const [messages, setMessages] = useState<ChatMessage[]>([]);
//   const [inputText, setInputText] = useState("");
//   const [socket, setSocket] = useState<Socket | null>(null);
//   const [isLoading, setIsLoading] = useState(true);
//   const [isUploading, setIsUploading] = useState(false);

//   // Features State
//   const [searchQuery, setSearchQuery] = useState("");
//   const [isSearching, setIsSearching] = useState(false);
//   const [isTyping, setIsTyping] = useState(false);
//   const [showQuickReplies, setShowQuickReplies] = useState(false);
//   const [isRecording, setIsRecording] = useState(false);
//   const [mediaRecorder, setMediaRecorder] = useState<MediaRecorder | null>(
//     null,
//   );
//   const [isDragging, setIsDragging] = useState(false);

//   // File State
//   const [selectedFile, setSelectedFile] = useState<File | null>(null);

//   // Refs
//   const activeUserRef = useRef<ChatUser | null>(null);
//   const adminIdRef = useRef<string>("");
//   const typingTimeoutRef = useRef<NodeJS.Timeout | null>(null);
//   const notificationAudioRef = useRef<HTMLAudioElement | null>(null);
//   const messagesEndRef = useRef<HTMLDivElement>(null);
//   const fileInputRef = useRef<HTMLInputElement>(null);

//   // UI
//   const [isMobileView, setIsMobileView] = useState(false);
//   const [showChatOnMobile, setShowChatOnMobile] = useState(false);

//   // Sync Refs to avoid stale closures in socket listeners
//   useEffect(() => {
//     activeUserRef.current = activeUser;
//   }, [activeUser]);
//   useEffect(() => {
//     adminIdRef.current = adminId;
//   }, [adminId]);

//   // --- 1. INITIAL SETUP ---
//   useEffect(() => {
//     let pollingInterval: NodeJS.Timeout;

//     if (typeof window !== "undefined") {
//       notificationAudioRef.current = new Audio("/alert.mp3");
//     }

//     const initChat = async () => {
//       try {
//         console.log("ðŸš€ Admin Chat Initializing...");

//         // Get Admin Profile
//         const profileRes = await AdminAuthService.getProfile();
//         const rootData = profileRes.data;
//         const adminData =
//           rootData?.data?.data || rootData?.data?.admin || rootData?.data;

//         if (adminData?._id) {
//           setAdminId(adminData._id);
//           adminIdRef.current = adminData._id;
//         }

//         // Load Users List
//         await fetchUserList();

//         // Socket Connection
//         const token =
//           localStorage.getItem("token") ||
//           localStorage.getItem("adminToken") ||
//           "";
//         const socketUrl =
//           process.env.NEXT_PUBLIC_API_URL?.replace("/api", "") ||
//           "http://localhost:5000";

//         const newSocket = io(socketUrl, {
//           withCredentials: true,
//           transports: ["websocket", "polling"],
//           auth: { token },
//           reconnection: true,
//         });

//         // --- SOCKET EVENT LISTENERS ---

//         newSocket.on("connect", () => {
//           console.log("ðŸŸ¢ Admin Socket Connected:", newSocket.id);
//           if (adminData?._id) newSocket.emit("join_room", adminData._id);
//         });

//         newSocket.on("connect", () => {
//           console.log("ðŸŸ¢ Admin Socket Connected:", newSocket.id);
//           if (adminData?._id) newSocket.emit("join_room", adminData._id);

//           // ðŸ‘‡ NEW: à°•à°¨à±†à°•à±à°Ÿà± à°…à°µà±à°µà°—à°¾à°¨à±‡ à°†à°¨à±â€Œà°²à±ˆà°¨à± à°²à°¿à°¸à±à°Ÿà± à°…à°¡à°—à°¾à°²à°¿
//           newSocket.emit("get_online_users");
//         });

//         // ðŸ‘‡ NEW: à°¸à°°à±à°µà°°à± à°¨à±à°‚à°¡à°¿ à°µà°šà±à°šà°¿à°¨ à°†à°¨à±â€Œà°²à±ˆà°¨à± à°²à°¿à°¸à±à°Ÿà±â€Œà°¤à±‹ à°¸à±à°Ÿà±‡à°Ÿà± à°…à°ªà±â€Œà°¡à±‡à°Ÿà± à°šà±‡à°¯à°¾à°²à°¿
//         newSocket.on("online_users_list", (onlineIds: string[]) => {
//           setUsers((prev) =>
//             prev.map((u) => ({
//               ...u,
//               // à°²à°¿à°¸à±à°Ÿà±â€Œà°²à±‹ à°ˆ à°¯à±‚à°œà°°à± ID à°‰à°‚à°Ÿà±‡ Online à°…à°¨à°¿ à°®à°¾à°°à±à°šà±, à°²à±‡à°•à°ªà±‹à°¤à±‡ à°ªà°¾à°¤ à°¸à±à°Ÿà±‡à°Ÿà°¸à± à°²à±‡à°¦à°¾ Offline
//               isOnline: onlineIds.includes(String(u._id)),
//             })),
//           );
//         });

//         // 1. INCOMING MESSAGE
//         newSocket.on("receive_message", (newMsg: ChatMessage) => {
//           handleIncomingMessage(newMsg, newSocket);
//         });

//         // ðŸ”¹ READ RECEIPTS UPDATE
//         newSocket.on("messages_marked_read", ({ roomId }) => {
//           // Only update active room messages
//           if (activeUserRef.current?.roomId === roomId) {
//             setMessages((prev) =>
//               prev.map((msg) =>
//                 getSafeId(msg.senderId) === adminIdRef.current
//                   ? { ...msg, isRead: true }
//                   : msg,
//               ),
//             );
//           }
//         });

//         // 2. ONLINE STATUS UPDATE
//         newSocket.on(
//           "user_status_update",
//           (data: { userId: string; isOnline: boolean }) => {
//             setUsers((prev) =>
//               prev.map((u) =>
//                 String(u._id) === String(data.userId)
//                   ? { ...u, isOnline: data.isOnline }
//                   : u,
//               ),
//             );

//             // If the status update is for the currently active user, update that state too
//             if (activeUserRef.current?._id === data.userId) {
//               setActiveUser((prev) =>
//                 prev ? { ...prev, isOnline: data.isOnline } : null,
//               );
//             }
//           },
//         );

//         // 3. TYPING INDICATOR
//         newSocket.on("display_typing", ({ roomId, userId }) => {
//           // Only show typing for ACTIVE chat
//           if (
//             activeUserRef.current?.roomId === roomId &&
//             userId !== adminIdRef.current
//           ) {
//             setIsTyping(true);
//           }
//         });

//         newSocket.on("hide_typing", ({ roomId }) => {
//           // Hide typing ONLY if same active room
//           if (activeUserRef.current?.roomId === roomId) {
//             setIsTyping(false);
//           }
//         });

//         // ðŸ‘‡ðŸ‘‡ðŸ‘‡ NEW CODE START ðŸ‘‡ðŸ‘‡ðŸ‘‡
//         // 1.5 INITIAL ONLINE STATUS CHECK RESPONSE
//         newSocket.on(
//           "is_user_online_response",
//           (data: { userId: string; isOnline: boolean }) => {
//             // Update Users List
//             setUsers((prev) =>
//               prev.map((u) =>
//                 String(u._id) === String(data.userId)
//                   ? { ...u, isOnline: data.isOnline }
//                   : u,
//               ),
//             );

//             // Update Active Chat Header if same user
//             if (String(activeUserRef.current?._id) === String(data.userId)) {
//               setActiveUser((prev) =>
//                 prev ? { ...prev, isOnline: data.isOnline } : null,
//               );
//             }
//           },
//         );

//         // 4. SENT CONFIRMATION (Update optimistic ID)
//         newSocket.on(
//           "message_sent",
//           (data: { tempId: number; messageId: string }) => {
//             setMessages((prev) =>
//               prev.map((msg) =>
//                 msg.tempId === data.tempId
//                   ? { ...msg, _id: data.messageId, isDelivered: true }
//                   : msg,
//               ),
//             );
//           },
//         );

//         setSocket(newSocket);

//         // Polling Backup to ensure data consistency
//         pollingInterval = setInterval(() => {
//           fetchUserList(true);
//         }, 5000);
//       } catch (error) {
//         console.error("Chat init error:", error);
//       } finally {
//         setIsLoading(false);
//       }
//     };

//     const handleResize = () => setIsMobileView(window.innerWidth < 768);
//     handleResize();
//     window.addEventListener("resize", handleResize);

//     initChat();

//     return () => {
//       window.removeEventListener("resize", handleResize);
//       if (socket) socket.disconnect();
//       clearInterval(pollingInterval);
//     };
//   }, []);

//   // --- API Helpers ---
//   const fetchUserList = async (silent = false) => {
//     try {
//       const roomsRes = await ChatService.getChatRooms();
//       const roomsList = roomsRes.data?.data?.rooms || [];

//       const formattedUsers: ChatUser[] = roomsList.map((room: any) => ({
//         _id: room.otherUser._id,
//         name: room.otherUser.name,
//         email: room.otherUser.email,
//         avatar: room.otherUser.profilePicture,
//         roomId: room.roomId,
//         lastMessage: room.lastMessage,
//         lastMessageTime: room.lastMessageTime,
//         unreadCount: room.unreadCount,
//         // Use online status from API if available, otherwise default to false (socket handles updates)
//         isOnline: room.otherUser.isOnline || false,
//       }));

//       setUsers((prev) => {
//         return formattedUsers.map((newUser) => {
//           // Merge with existing state to preserve real-time online status from socket
//           const existing = prev.find((u) => u._id === newUser._id);
//           return existing
//             ? { ...newUser, isOnline: existing.isOnline }
//             : newUser;
//         });
//       });

//       if (socket) {
//         socket.emit("get_online_users");
//       }
//     } catch (e) {
//       if (!silent) console.error("Failed to fetch users", e);
//     }
//   };

//   // --- 2. Handle User Select ---
//   const handleUserSelect = async (user: ChatUser) => {
//     setActiveUser(user);
//     setIsSearching(false);
//     if (isMobileView) setShowChatOnMobile(true);

//     // Join the specific room
//     socket?.emit("join_room", user.roomId); // Backend expects just roomId string or object? Code says `socket.join(roomToJoin)`
//     // ðŸ‘‡ðŸ‘‡ðŸ‘‡ NEW LINE: Check if this specific user is online ðŸ‘‡ðŸ‘‡ðŸ‘‡
//     socket?.emit("check_online_status", { userId: user._id });
//     // ðŸ‘†ðŸ‘†ðŸ‘†
//     try {
//       const res = await ChatService.getMessages(user.roomId);
//       const history = res.data?.data?.messages || [];

//       // Sort: Oldest first for rendering
//       setMessages(history.reverse());
//       scrollToBottom();

//       // Reset unread locally
//       setUsers((prev) =>
//         prev.map((u) => (u._id === user._id ? { ...u, unreadCount: 0 } : u)),
//       );

//       if (history.length > 0) await ChatService.markAsRead(user.roomId);
//     } catch (error) {
//       console.error("Error fetching messages:", error);
//     }
//   };

//   const scrollToBottom = () => {
//     setTimeout(() => {
//       messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
//     }, 100);
//   };

//   // --- 3. INCOMING MESSAGE LOGIC ---
//   const handleIncomingMessage = (
//     newMsg: ChatMessage,
//     socketInstance: Socket,
//   ) => {
//     const currentActive = activeUserRef.current;
//     const currentAdmin = adminIdRef.current;
//     const senderId = getSafeId(newMsg.senderId);

//     // A. Update Active Chat Window
//     if (currentActive && currentActive.roomId === newMsg.roomId) {
//       setMessages((prev) => {
//         // Prevent Duplicates
//         if (prev.some((m) => m._id === newMsg._id)) return prev;

//         // If sender is ME (Admin), check for tempId match and replace
//         if (senderId === currentAdmin) {
//           return prev.map((m) =>
//             m.tempId && m.text === newMsg.text ? newMsg : m,
//           );
//         }

//         // If sender is USER, play sound & mark read
//         if (senderId !== currentAdmin) {
//           socketInstance.emit("mark_read", {
//             roomId: newMsg.roomId,
//             userId: currentAdmin,
//           });
//           try {
//             notificationAudioRef.current?.play();
//           } catch (e) {}
//         }

//         return [...prev, newMsg];
//       });

//       scrollToBottom();
//       setIsTyping(false);
//     } else {
//       // Notification
//       try {
//         notificationAudioRef.current?.play();
//       } catch (e) {}
//       toast.info(`New message received`);
//     }

//     // B. Update Sidebar List
//     fetchUserList(true);
//   };

//   // --- 4. Send Message (Optimistic UI) ---
//   const handleSendMessage = async (e?: React.FormEvent) => {
//     e?.preventDefault();
//     if ((!inputText.trim() && !selectedFile) || !activeUser || !socket) return;

//     if (selectedFile) {
//       await handleFileUpload();
//       return;
//     }

//     const tempId = Date.now();
//     const payload = {
//       senderId: adminId,
//       receiverId: activeUser._id,
//       text: inputText,
//       roomId: activeUser.roomId,
//       messageType: "text",
//       senderModel: "Admin",
//       receiverModel: "User",
//       tempId: tempId,
//     };

//     const optimisticMsg: ChatMessage = {
//       _id: `temp-${tempId}`,
//       senderId: adminId,
//       text: inputText,
//       createdAt: new Date().toISOString(),
//       isRead: false,
//       messageType: "text",
//       roomId: activeUser.roomId,
//       tempId: tempId,
//     };

//     setMessages((prev) => [...prev, optimisticMsg]);
//     setInputText("");
//     scrollToBottom();
//     setShowQuickReplies(false);

//     socket.emit("stop_typing", { roomId: activeUser.roomId }); // Fixed: Send Object
//     socket.emit("send_message", payload);

//     // Sidebar Update
//     setUsers((prev) =>
//       prev
//         .map((u) =>
//           u._id === activeUser._id
//             ? {
//                 ...u,
//                 lastMessage: payload.text,
//                 lastMessageTime: new Date().toISOString(),
//               }
//             : u,
//         )
//         .sort(
//           (a, b) =>
//             new Date(b.lastMessageTime || 0).getTime() -
//             new Date(a.lastMessageTime || 0).getTime(),
//         ),
//     );
//   };

//   // --- 5. File Upload ---
//   const handleFileUpload = async () => {
//     if (!selectedFile || !activeUser || !socket) return;

//     setIsUploading(true);
//     const formData = new FormData();
//     formData.append("file", selectedFile);

//     try {
//       const res = await ChatService.uploadFile(formData);
//       const { fileUrl, fileType } = res.data.data;

//       // Detect audio manually if needed
//       let finalType = fileType;
//       if (
//         selectedFile.type.startsWith("audio") ||
//         selectedFile.name.endsWith(".webm")
//       ) {
//         finalType = "audio";
//       }

//       const payload = {
//         senderId: adminId,
//         receiverId: activeUser._id,
//         text: "",
//         roomId: activeUser.roomId,
//         messageType: finalType,
//         fileUrl: fileUrl,
//         senderModel: "Admin",
//         receiverModel: "User",
//       };

//       const tempMsg: ChatMessage = {
//         _id: `temp-${Date.now()}`,
//         senderId: adminId,
//         text: "",
//         fileUrl: fileUrl,
//         messageType: finalType as any,
//         createdAt: new Date().toISOString(),
//         isRead: false,
//         roomId: activeUser.roomId,
//       };

//       setMessages((prev) => [...prev, tempMsg]);
//       scrollToBottom();

//       socket.emit("send_message", payload);
//       fetchUserList(true);
//     } catch (error) {
//       console.error("Upload error:", error);
//       toast.error("Failed to upload file");
//     } finally {
//       setIsUploading(false);
//       setSelectedFile(null);
//       if (fileInputRef.current) fileInputRef.current.value = "";
//     }
//   };

//   // --- 6. Voice Recording ---
//   // --- 6. Voice Recording Features (FIXED) ---

//   const streamRef = useRef<MediaStream | null>(null);

//   const startRecording = async () => {
//     try {
//       const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
//       streamRef.current = stream;

//       // Browser Compatibility Check (Safari vs Chrome)
//       let mimeType = "audio/webm";
//       if (MediaRecorder.isTypeSupported("audio/webm;codecs=opus")) {
//         mimeType = "audio/webm;codecs=opus";
//       } else if (MediaRecorder.isTypeSupported("audio/mp4")) {
//         mimeType = "audio/mp4";
//       }

//       const recorder = new MediaRecorder(stream, { mimeType });
//       setMediaRecorder(recorder);
//       const chunks: Blob[] = [];

//       recorder.ondataavailable = (e) => {
//         if (e.data.size > 0) chunks.push(e.data);
//       };

//       recorder.onstop = () => {
//         // Create Blob & File
//         const audioBlob = new Blob(chunks, { type: mimeType });
//         const fileExt = mimeType.includes("mp4") ? "mp4" : "webm";
//         const fileName = `voice_note_${Date.now()}.${fileExt}`;

//         const file = new File([audioBlob], fileName, {
//           type: mimeType,
//         });

//         // ðŸ”¥ FIX 1: Don't set selectedFile for auto-send (avoids preview stuck issue)
//         // setSelectedFile(file); <--- REMOVED THIS LINE

//         // Auto Upload & Send
//         uploadAndSendRecordedFile(file);

//         // Stop Microphone Tracks
//         stream.getTracks().forEach((track) => track.stop());
//       };

//       recorder.start();
//       setIsRecording(true);
//     } catch (err) {
//       console.error(err);
//       toast.error("Microphone access denied");
//     }
//   };

//   const uploadAndSendRecordedFile = async (file: File) => {
//     if (!activeUser || !socket) return;

//     setIsUploading(true);
//     const formData = new FormData();
//     // ðŸ”¥ Make sure your backend accepts field name "file"
//     formData.append("file", file);

//     try {
//       const res = await ChatService.uploadFile(formData);
//       console.log("Audio Upload Response:", res.data);

//       // ðŸ”¥ FIX 2: Safe URL Extraction (Handle different API responses)
//       const responseData = res.data;
//       const fileUrl =
//         responseData?.data?.fileUrl ||
//         responseData?.fileUrl ||
//         responseData?.url ||
//         responseData?.secure_url;

//       if (!fileUrl) {
//         toast.error("Audio upload failed: No URL received");
//         return;
//       }

//       const payload = {
//         senderId: adminId,
//         receiverId: activeUser._id,
//         text: "",
//         roomId: activeUser.roomId,
//         messageType: "audio", // âœ… Correctly set as audio
//         fileUrl: fileUrl,
//         senderModel: "Admin",
//         receiverModel: "User",
//       };

//       const tempMsg: ChatMessage = {
//         _id: `temp-${Date.now()}`,
//         senderId: adminId,
//         text: "",
//         fileUrl: fileUrl,
//         messageType: "audio",
//         createdAt: new Date().toISOString(),
//         isRead: false,
//         roomId: activeUser.roomId,
//       };

//       setMessages((prev) => [...prev, tempMsg]);
//       scrollToBottom();
//       socket.emit("send_message", payload);
//     } catch (e) {
//       console.error(e);
//       toast.error("Failed to send voice note");
//     } finally {
//       setIsUploading(false);
//       setIsRecording(false);
//       setSelectedFile(null); // ðŸ”¥ FIX 3: Ensure file is cleared from state
//     }
//   };

//   const stopRecording = () => {
//     if (mediaRecorder && mediaRecorder.state !== "inactive") {
//       mediaRecorder.stop();
//       setIsRecording(false);
//     }
//   };

//   // --- 7. UI Helpers ---
//   const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
//     const val = e.target.value;
//     setInputText(val);

//     // Quick Reply Trigger
//     if (val === "/") setShowQuickReplies(true);
//     else setShowQuickReplies(false);

//     if (socket && activeUser) {
//       // Send as object to be safe
//       socket.emit("typing", { roomId: activeUser.roomId, userId: adminId });

//       if (typingTimeoutRef.current) clearTimeout(typingTimeoutRef.current);

//       typingTimeoutRef.current = setTimeout(() => {
//         socket.emit("stop_typing", {
//           roomId: activeUser.roomId,
//           userId: adminId,
//         });
//       }, 2000);
//     }
//   };

//   const selectQuickReply = (text: string) => {
//     setInputText(text);
//     setShowQuickReplies(false);
//   };

//   // Drag & Drop
//   const handleDragOver = (e: React.DragEvent) => {
//     e.preventDefault();
//     setIsDragging(true);
//   };
//   const handleDragLeave = () => setIsDragging(false);
//   const handleDrop = (e: React.DragEvent) => {
//     e.preventDefault();
//     setIsDragging(false);
//     const files = e.dataTransfer.files;
//     if (files && files.length > 0) setSelectedFile(files[0]);
//   };

//   const filteredUsers = users.filter((u) =>
//     u.name.toLowerCase().includes(searchQuery.toLowerCase()),
//   );

//   if (isLoading)
//     return (
//       <div className="flex h-96 items-center justify-center">
//         <Loader2 className="animate-spin text-blue-500 h-8 w-8" />
//       </div>
//     );

//   return (
//     <div className="h-[calc(100vh-6rem)] w-full overflow-hidden flex gap-4 custom-scrollbar">
//       {/* --- LEFT SIDEBAR: USERS LIST --- */}
//       <AnimatePresence mode="popLayout">
//         {(!isMobileView || !showChatOnMobile) && (
//           <motion.div
//             initial={{ opacity: 0, x: -20 }}
//             animate={{ opacity: 1, x: 0 }}
//             exit={{ opacity: 0, x: -20 }}
//             className={`flex-1 md:flex-[0.35] lg:flex-[0.3] flex flex-col ${glassPanel} rounded-2xl h-full`}
//           >
//             <div className="p-4 border-b border-white/10 flex justify-between items-center">
//               <h2 className="text-xl font-bold text-white">Chats</h2>
//               <button className="p-2 hover:bg-white/10 rounded-full text-gray-300">
//                 <MoreVertical size={20} />
//               </button>
//             </div>

//             <div className="px-4 py-3">
//               <div
//                 className={`flex items-center gap-2 px-3 py-2 rounded-xl ${glassInput}`}
//               >
//                 <Search size={18} className="text-gray-400" />
//                 <input
//                   type="text"
//                   value={searchQuery}
//                   onChange={(e) => setSearchQuery(e.target.value)}
//                   placeholder="Search users..."
//                   className="bg-transparent border-none outline-none text-sm w-full text-white placeholder-gray-500"
//                 />
//               </div>
//             </div>

//             <div className="flex-1 overflow-y-auto custom-scrollbar">
//               {filteredUsers.map((user) => (
//                 <motion.div
//                   key={user._id}
//                   whileHover={{ backgroundColor: "rgba(255,255,255,0.05)" }}
//                   onClick={() => handleUserSelect(user)}
//                   className={`flex items-center gap-3 p-4 cursor-pointer border-b border-white/5 transition-colors
//                     ${activeUser?._id === user._id ? "bg-white/10 border-l-4 border-l-blue-500" : ""}`}
//                 >
//                   <div className="relative">
//                     <div className="h-12 w-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-lg overflow-hidden">
//                       {user.avatar ? (
//                         <img
//                           src={user.avatar}
//                           className="h-full w-full object-cover"
//                         />
//                       ) : (
//                         user.name.charAt(0).toUpperCase()
//                       )}
//                     </div>
//                     {/* ðŸŸ¢ Online Status Dot */}
//                     {user.isOnline && (
//                       <span className="absolute bottom-0 right-0 h-3 w-3 bg-green-500 border-2 border-[#1a1a1a] rounded-full"></span>
//                     )}
//                   </div>

//                   <div className="flex-1 min-w-0">
//                     <div className="flex justify-between items-center mb-1">
//                       <h3 className="font-semibold text-white truncate">
//                         {user.name}
//                       </h3>
//                       <span className="text-xs text-gray-500">
//                         {user.lastMessageTime
//                           ? format(new Date(user.lastMessageTime), "HH:mm")
//                           : ""}
//                       </span>
//                     </div>
//                     <div className="flex justify-between items-center">
//                       <p className="text-sm text-gray-400 truncate w-[80%]">
//                         {user.lastMessage || "Start conversation"}
//                       </p>
//                       {user.unreadCount && user.unreadCount > 0 ? (
//                         <span className="h-5 w-5 bg-blue-500 rounded-full flex items-center justify-center text-[10px] font-bold text-white">
//                           {user.unreadCount}
//                         </span>
//                       ) : null}
//                     </div>
//                   </div>
//                 </motion.div>
//               ))}
//             </div>
//           </motion.div>
//         )}
//       </AnimatePresence>

//       {/* --- RIGHT SIDE: CHAT WINDOW --- */}
//       <AnimatePresence mode="popLayout">
//         {(!isMobileView || showChatOnMobile) && (
//           <motion.div
//             initial={{ opacity: 0, x: 20 }}
//             animate={{ opacity: 1, x: 0 }}
//             exit={{ opacity: 0, x: 20 }}
//             className={`flex-1 flex flex-col ${glassPanel} rounded-2xl h-full overflow-hidden relative transition-colors ${isDragging ? "bg-blue-500/10 border-blue-500" : ""}`}
//             onDragOver={handleDragOver}
//             onDragLeave={handleDragLeave}
//             onDrop={handleDrop}
//           >
//             {activeUser ? (
//               <>
//                 {/* Header */}
//                 <div className="p-4 border-b border-white/10 flex justify-between items-center bg-white/[0.02]">
//                   <div className="flex items-center gap-3">
//                     {isMobileView && (
//                       <button
//                         onClick={() => setShowChatOnMobile(false)}
//                         className="mr-1 text-gray-300"
//                       >
//                         <ArrowLeft size={22} />
//                       </button>
//                     )}
//                     <div className="h-10 w-10 rounded-full bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center text-white font-bold overflow-hidden">
//                       {activeUser.avatar ? (
//                         <img
//                           src={activeUser.avatar}
//                           className="h-full w-full object-cover"
//                         />
//                       ) : (
//                         activeUser.name.charAt(0).toUpperCase()
//                       )}
//                     </div>
//                     <div>
//                       <h3 className="font-bold text-white">
//                         {activeUser.name}
//                       </h3>
//                       <p className="text-xs text-blue-400">
//                         {isTyping ? (
//                           <span className="text-green-400 animate-pulse">
//                             Typing...
//                           </span>
//                         ) : activeUser.isOnline ? (
//                           "Online"
//                         ) : (
//                           "Offline"
//                         )}
//                       </p>
//                     </div>
//                   </div>
//                   <div className="flex gap-4 text-gray-400">
//                     <Phone
//                       size={20}
//                       className="hover:text-white cursor-pointer"
//                     />
//                     <Video
//                       size={20}
//                       className="hover:text-white cursor-pointer"
//                     />
//                   </div>
//                 </div>

//                 {/* Messages */}
//                 <div className="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-4 custom-scrollbar bg-gradient-to-b from-black/20 to-black/40 relative">
//                   {isDragging && (
//                     <div className="absolute inset-0 bg-blue-500/20 backdrop-blur-sm z-50 flex items-center justify-center border-2 border-dashed border-blue-500 m-4 rounded-xl">
//                       <p className="text-white font-bold text-xl">
//                         Drop files here to upload
//                       </p>
//                     </div>
//                   )}

//                   {messages.map((msg, idx) => {
//                     const senderId = getSafeId(msg.senderId);
//                     const isMe = senderId === adminId;

//                     return (
//                       <motion.div
//                         key={msg._id || idx}
//                         initial={{ opacity: 0, y: 10 }}
//                         animate={{ opacity: 1, y: 0 }}
//                         className={`flex ${isMe ? "justify-end" : "justify-start"}`}
//                       >
//                         <div
//                           className={`max-w-[75%] md:max-w-[60%] px-4 py-2 rounded-2xl relative shadow-md
//                           ${
//                             isMe
//                               ? "bg-blue-600 text-white rounded-tr-none"
//                               : "bg-white/10 backdrop-blur-md text-gray-100 rounded-tl-none border border-white/5"
//                           }`}
//                         >
//                           {/* Media */}
//                           {msg.messageType === "image" && msg.fileUrl && (
//                             <img
//                               src={msg.fileUrl}
//                               alt="attachment"
//                               className="rounded-lg mb-2 max-h-60 object-cover cursor-pointer"
//                               onClick={() => window.open(msg.fileUrl, "_blank")}
//                             />
//                           )}
//                           {msg.messageType === "video" && msg.fileUrl && (
//                             <video
//                               src={msg.fileUrl}
//                               controls
//                               className="rounded-lg mb-2 max-h-60 w-full"
//                             />
//                           )}
//                           {msg.messageType === "audio" && msg.fileUrl && (
//                             <div className="flex items-center gap-2 mb-2 min-w-[220px] bg-black/20 p-2 rounded-lg">
//                               <audio
//                                 controls
//                                 className="w-full h-8"
//                                 preload="metadata"
//                               >
//                                 <source src={msg.fileUrl} type="audio/webm" />
//                                 <source src={msg.fileUrl} type="audio/mp4" />
//                                 <source src={msg.fileUrl} type="audio/mpeg" />
//                                 Your browser does not support the audio element.
//                               </audio>
//                             </div>
//                           )}

//                           {msg.text && (
//                             <p className="text-sm leading-relaxed whitespace-pre-wrap">
//                               {msg.text}
//                             </p>
//                           )}

//                           <div
//                             className={`text-[10px] flex items-center justify-end gap-1 mt-1 ${isMe ? "text-blue-200" : "text-gray-400"}`}
//                           >
//                             {format(new Date(msg.createdAt), "HH:mm")}
//                             {isMe &&
//                               (msg.isRead ? (
//                                 <CheckCheck
//                                   size={14}
//                                   className="text-emerald-400"
//                                 /> // âœ”âœ” GREEN
//                               ) : (
//                                 <Check size={14} className="text-black" /> // âœ” BLACK
//                               ))}
//                           </div>
//                         </div>
//                       </motion.div>
//                     );
//                   })}
//                   <div ref={messagesEndRef} />
//                 </div>

//                 {/* Quick Replies Popup */}
//                 <AnimatePresence>
//                   {showQuickReplies && (
//                     <motion.div
//                       initial={{ opacity: 0, y: 10 }}
//                       animate={{ opacity: 1, y: 0 }}
//                       exit={{ opacity: 0, y: 10 }}
//                       className="absolute bottom-20 left-4 right-4 bg-[#1a1a1a] border border-white/10 rounded-xl p-2 shadow-2xl z-20 flex flex-wrap gap-2"
//                     >
//                       {QUICK_REPLIES.map((reply, i) => (
//                         <button
//                           key={i}
//                           onClick={() => selectQuickReply(reply)}
//                           className="bg-white/5 hover:bg-blue-600 text-sm text-gray-300 hover:text-white px-3 py-1.5 rounded-full transition"
//                         >
//                           {reply}
//                         </button>
//                       ))}
//                     </motion.div>
//                   )}
//                 </AnimatePresence>

//                 {/* File Preview */}
//                 <AnimatePresence>
//                   {selectedFile && (
//                     <motion.div
//                       initial={{ y: 20, opacity: 0 }}
//                       animate={{ y: 0, opacity: 1 }}
//                       exit={{ y: 20, opacity: 0 }}
//                       className="absolute bottom-20 left-4 right-4 p-3 bg-black/80 backdrop-blur-md rounded-xl flex items-center gap-3 border border-white/10 z-30"
//                     >
//                       <Paperclip className="text-white" />
//                       <span className="text-white text-sm truncate flex-1">
//                         {selectedFile.name}
//                       </span>
//                       <button onClick={() => setSelectedFile(null)}>
//                         <X className="text-white hover:text-red-500" />
//                       </button>
//                     </motion.div>
//                   )}
//                 </AnimatePresence>

//                 {/* Input Area */}
//                 <div className="p-3 md:p-4 border-t border-white/10 bg-black/20 backdrop-blur-md">
//                   <form
//                     onSubmit={handleSendMessage}
//                     className="flex items-center gap-3"
//                   >
//                     <button
//                       type="button"
//                       className="text-gray-400 hover:text-white transition"
//                     >
//                       <Smile size={24} />
//                     </button>

//                     <input
//                       type="file"
//                       ref={fileInputRef}
//                       className="hidden"
//                       accept="image/*,video/*,audio/*"
//                       onChange={(e) =>
//                         e.target.files && setSelectedFile(e.target.files[0])
//                       }
//                     />
//                     <button
//                       type="button"
//                       className="text-gray-400 hover:text-white transition"
//                       onClick={() => fileInputRef.current?.click()}
//                     >
//                       <Paperclip size={22} />
//                     </button>

//                     <div className="flex-1 relative">
//                       <input
//                         type="text"
//                         value={inputText}
//                         onChange={handleInputChange}
//                         placeholder={
//                           isRecording
//                             ? "Recording audio..."
//                             : "Type a message... (/ for replies)"
//                         }
//                         className={`w-full py-3 pl-4 pr-10 rounded-xl ${glassInput} ${isRecording ? "text-red-400 placeholder-red-400" : ""}`}
//                         disabled={isRecording || isUploading}
//                       />
//                       {isUploading && (
//                         <div className="absolute right-3 top-1/2 -translate-y-1/2">
//                           <Loader2
//                             size={18}
//                             className="animate-spin text-blue-400"
//                           />
//                         </div>
//                       )}
//                     </div>

//                     {inputText.trim() || selectedFile ? (
//                       <button
//                         type="submit"
//                         disabled={isUploading}
//                         className="h-11 w-11 bg-blue-600 hover:bg-blue-500 rounded-full flex items-center justify-center text-white shadow-lg transition-all transform hover:scale-105"
//                       >
//                         <Send size={20} className="ml-0.5" />
//                       </button>
//                     ) : (
//                       <button
//                         type="button"
//                         onClick={isRecording ? stopRecording : startRecording}
//                         className={`h-11 w-11 rounded-full flex items-center justify-center text-white transition ${isRecording ? "bg-red-600 animate-pulse" : "bg-white/10 hover:bg-white/20"}`}
//                       >
//                         {isRecording ? (
//                           <StopCircle size={20} />
//                         ) : (
//                           <Mic size={20} />
//                         )}
//                       </button>
//                     )}
//                   </form>
//                 </div>
//               </>
//             ) : (
//               <div className="flex-1 flex flex-col items-center justify-center text-center p-8 opacity-50">
//                 <div className="h-24 w-24 bg-white/5 rounded-full flex items-center justify-center mb-4 border border-white/10">
//                   <Send size={40} className="text-blue-400 ml-2" />
//                 </div>
//                 <h2 className="text-2xl font-bold text-white mb-2">
//                   Welcome to Live Chat
//                 </h2>
//                 <p className="text-gray-400 max-w-md">
//                   Select a customer from the left sidebar to start messaging.
//                 </p>
//                 <div className="mt-8 flex gap-2 text-sm text-gray-500">
//                   <div className="flex items-center gap-1">
//                     <Lock size={12} /> End-to-end encrypted
//                   </div>
//                 </div>
//               </div>
//             )}
//           </motion.div>
//         )}
//       </AnimatePresence>
//     </div>
//   );
// }

"use client";

import { useState, useEffect, useRef } from "react";
import { motion, AnimatePresence } from "framer-motion";
import {
  Search,
  Send,
  Paperclip,
  MoreVertical,
  Phone,
  Video,
  ArrowLeft,
  Check,
  CheckCheck,
  Smile,
  Mic,
  Loader2,
  Lock,
  X,
  StopCircle,
  Bot, // ðŸ”¥ NEW: Imported Bot Icon
} from "lucide-react";
import { format } from "date-fns";
import { io, Socket } from "socket.io-client";
import { ChatService, AdminAuthService } from "@/lib/api";
import { toast } from "sonner";

// --- Types ---
interface ChatUser {
  _id: string;
  name: string;
  email: string;
  avatar?: string;
  roomId: string;
  lastMessage?: string;
  lastMessageTime?: string;
  unreadCount?: number;
  isOnline?: boolean;
}

interface ChatMessage {
  _id: string;
  senderId:
    | { _id: string; name: string; email: string; profilePicture?: string }
    | string;
  text: string;
  createdAt: string;
  isRead: boolean;
  messageType: "text" | "image" | "video" | "audio";
  fileUrl?: string;
  roomId: string;
  tempId?: number; // For identifying optimistic messages
}

// Quick Replies
const QUICK_REPLIES = [
  "Hello! How can I help you?",
  "Your order has been shipped.",
  "Please provide your Order ID.",
  "The item is currently out of stock.",
  "Thank you for contacting us!",
  "Price for this bumper is â‚¹2,400.",
];

// Helper: Safe ID Extraction
const getSafeId = (data: any): string => {
  if (!data) return "";
  return typeof data === "object" ? data._id : data;
};

// --- STYLES ---
const glassPanel =
  "bg-white/5 backdrop-blur-xl border border-white/10 shadow-xl";
const glassInput =
  "bg-black/20 border border-white/10 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500/50 focus:bg-black/30 transition-all";

// ðŸ”¥ Stylish Scrollbar Class (Dark Mode Friendly)
const customScrollbar = `
  scrollbar-thin 
  scrollbar-thumb-white/10 
  scrollbar-track-transparent 
  hover:scrollbar-thumb-white/20
  [&::-webkit-scrollbar]:w-1.5
  [&::-webkit-scrollbar-track]:bg-transparent
  [&::-webkit-scrollbar-thumb]:bg-white/10
  [&::-webkit-scrollbar-thumb]:rounded-full
  hover:[&::-webkit-scrollbar-thumb]:bg-white/20
`;

export default function ChatPage() {
  // --- STATE ---
  const [adminId, setAdminId] = useState<string>("");
  const [users, setUsers] = useState<ChatUser[]>([]);
  const [activeUser, setActiveUser] = useState<ChatUser | null>(null);
  const [messages, setMessages] = useState<ChatMessage[]>([]);
  const [inputText, setInputText] = useState("");
  const [socket, setSocket] = useState<Socket | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [isUploading, setIsUploading] = useState(false);

  // Features State
  const [searchQuery, setSearchQuery] = useState("");
  const [isSearching, setIsSearching] = useState(false);
  const [isTyping, setIsTyping] = useState(false);
  const [showQuickReplies, setShowQuickReplies] = useState(false);
  const [isRecording, setIsRecording] = useState(false);
  const [mediaRecorder, setMediaRecorder] = useState<MediaRecorder | null>(
    null,
  );
  const [isDragging, setIsDragging] = useState(false);

  // ðŸ”¥ NEW STATE: AI Auto Reply
  const [isAutoReplyEnabled, setIsAutoReplyEnabled] = useState(false);

  // File State
  const [selectedFile, setSelectedFile] = useState<File | null>(null);

  // Refs
  const activeUserRef = useRef<ChatUser | null>(null);
  const adminIdRef = useRef<string>("");
  const typingTimeoutRef = useRef<NodeJS.Timeout | null>(null);
  const notificationAudioRef = useRef<HTMLAudioElement | null>(null);
  const sentAudioRef = useRef<HTMLAudioElement | null>(null); // ðŸ”¥ NEW: Sent Sound Ref
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  // UI
  const [isMobileView, setIsMobileView] = useState(false);
  const [showChatOnMobile, setShowChatOnMobile] = useState(false);

  // Sync Refs to avoid stale closures in socket listeners
  useEffect(() => {
    activeUserRef.current = activeUser;
  }, [activeUser]);
  useEffect(() => {
    adminIdRef.current = adminId;
  }, [adminId]);

  // --- 1. INITIAL SETUP ---
  useEffect(() => {
    let pollingInterval: NodeJS.Timeout;

    if (typeof window !== "undefined") {
      notificationAudioRef.current = new Audio("/alert.mp3");
      sentAudioRef.current = new Audio("/sent.mp3"); // ðŸ”¥ NEW: Initialize Sent Sound (ensure sent.mp3 exists in public folder)
    }

    const initChat = async () => {
      try {
        console.log("ðŸš€ Admin Chat Initializing...");

        // Get Admin Profile
        const profileRes = await AdminAuthService.getProfile();
        const rootData = profileRes.data;
        const adminData =
          rootData?.data?.data || rootData?.data?.admin || rootData?.data;

        if (adminData?._id) {
          setAdminId(adminData._id);
          adminIdRef.current = adminData._id;
          // ðŸ”¥ NEW: Set AI Status from DB
          setIsAutoReplyEnabled(adminData.isAutoReplyEnabled || false);
        }

        // Load Users List
        await fetchUserList();

        // Socket Connection
        const token =
          localStorage.getItem("token") ||
          localStorage.getItem("adminToken") ||
          "";
        const socketUrl =
          process.env.NEXT_PUBLIC_API_URL?.replace("/api", "") ||
          "http://localhost:5000";

        const newSocket = io(socketUrl, {
          withCredentials: true,
          transports: ["websocket", "polling"],
          auth: { token },
          reconnection: true,
        });

        // --- SOCKET EVENT LISTENERS ---

        newSocket.on("connect", () => {
          console.log("ðŸŸ¢ Admin Socket Connected:", newSocket.id);
          if (adminData?._id) newSocket.emit("join_room", adminData._id);
        });

        newSocket.on("connect", () => {
          console.log("ðŸŸ¢ Admin Socket Connected:", newSocket.id);
          if (adminData?._id) newSocket.emit("join_room", adminData._id);

          // ðŸ‘‡ NEW: à°•à°¨à±†à°•à±à°Ÿà± à°…à°µà±à°µà°—à°¾à°¨à±‡ à°†à°¨à±â€Œà°²à±ˆà°¨à± à°²à°¿à°¸à±à°Ÿà± à°…à°¡à°—à°¾à°²à°¿
          newSocket.emit("get_online_users");
        });

        // ðŸ‘‡ NEW: à°¸à°°à±à°µà°°à± à°¨à±à°‚à°¡à°¿ à°µà°šà±à°šà°¿à°¨ à°†à°¨à±â€Œà°²à±ˆà°¨à± à°²à°¿à°¸à±à°Ÿà±â€Œà°¤à±‹ à°¸à±à°Ÿà±‡à°Ÿà± à°…à°ªà±â€Œà°¡à±‡à°Ÿà± à°šà±‡à°¯à°¾à°²à°¿
        newSocket.on("online_users_list", (onlineIds: string[]) => {
          setUsers((prev) =>
            prev.map((u) => ({
              ...u,
              // à°²à°¿à°¸à±à°Ÿà±â€Œà°²à±‹ à°ˆ à°¯à±‚à°œà°°à± ID à°‰à°‚à°Ÿà±‡ Online à°…à°¨à°¿ à°®à°¾à°°à±à°šà±, à°²à±‡à°•à°ªà±‹à°¤à±‡ à°ªà°¾à°¤ à°¸à±à°Ÿà±‡à°Ÿà°¸à± à°²à±‡à°¦à°¾ Offline
              isOnline: onlineIds.includes(String(u._id)),
            })),
          );
        });

        // 1. INCOMING MESSAGE
        newSocket.on("receive_message", (newMsg: ChatMessage) => {
          handleIncomingMessage(newMsg, newSocket);
        });

        // ðŸ”¹ READ RECEIPTS UPDATE
        newSocket.on("messages_marked_read", ({ roomId }) => {
          // Only update active room messages
          if (activeUserRef.current?.roomId === roomId) {
            setMessages((prev) =>
              prev.map((msg) =>
                getSafeId(msg.senderId) === adminIdRef.current
                  ? { ...msg, isRead: true }
                  : msg,
              ),
            );
          }
        });

        // 2. ONLINE STATUS UPDATE
        newSocket.on(
          "user_status_update",
          (data: { userId: string; isOnline: boolean }) => {
            setUsers((prev) =>
              prev.map((u) =>
                String(u._id) === String(data.userId)
                  ? { ...u, isOnline: data.isOnline }
                  : u,
              ),
            );

            // If the status update is for the currently active user, update that state too
            if (activeUserRef.current?._id === data.userId) {
              setActiveUser((prev) =>
                prev ? { ...prev, isOnline: data.isOnline } : null,
              );
            }
          },
        );

        // 3. TYPING INDICATOR
        newSocket.on("display_typing", ({ roomId, userId }) => {
          // Only show typing for ACTIVE chat
          if (
            activeUserRef.current?.roomId === roomId &&
            userId !== adminIdRef.current
          ) {
            setIsTyping(true);
          }
        });

        newSocket.on("hide_typing", ({ roomId }) => {
          // Hide typing ONLY if same active room
          if (activeUserRef.current?.roomId === roomId) {
            setIsTyping(false);
          }
        });

        // ðŸ‘‡ðŸ‘‡ðŸ‘‡ NEW CODE START ðŸ‘‡ðŸ‘‡ðŸ‘‡
        // 1.5 INITIAL ONLINE STATUS CHECK RESPONSE
        newSocket.on(
          "is_user_online_response",
          (data: { userId: string; isOnline: boolean }) => {
            // Update Users List
            setUsers((prev) =>
              prev.map((u) =>
                String(u._id) === String(data.userId)
                  ? { ...u, isOnline: data.isOnline }
                  : u,
              ),
            );

            // Update Active Chat Header if same user
            if (String(activeUserRef.current?._id) === String(data.userId)) {
              setActiveUser((prev) =>
                prev ? { ...prev, isOnline: data.isOnline } : null,
              );
            }
          },
        );

        // 4. SENT CONFIRMATION (Update optimistic ID)
        newSocket.on(
          "message_sent",
          (data: { tempId: number; messageId: string }) => {
            setMessages((prev) =>
              prev.map((msg) =>
                msg.tempId === data.tempId
                  ? { ...msg, _id: data.messageId, isDelivered: true }
                  : msg,
              ),
            );
          },
        );

        setSocket(newSocket);

        // Polling Backup to ensure data consistency
        pollingInterval = setInterval(() => {
          fetchUserList(true);
        }, 5000);
      } catch (error) {
        console.error("Chat init error:", error);
      } finally {
        setIsLoading(false);
      }
    };

    const handleResize = () => setIsMobileView(window.innerWidth < 768);
    handleResize();
    window.addEventListener("resize", handleResize);

    initChat();

    return () => {
      window.removeEventListener("resize", handleResize);
      if (socket) socket.disconnect();
      clearInterval(pollingInterval);
    };
  }, []);

  // --- API Helpers ---
  const fetchUserList = async (silent = false) => {
    try {
      const roomsRes = await ChatService.getChatRooms();
      const roomsList = roomsRes.data?.data?.rooms || [];

      const formattedUsers: ChatUser[] = roomsList.map((room: any) => ({
        _id: room.otherUser._id,
        name: room.otherUser.name,
        email: room.otherUser.email,
        avatar: room.otherUser.profilePicture,
        roomId: room.roomId,
        lastMessage: room.lastMessage,
        lastMessageTime: room.lastMessageTime,
        unreadCount: room.unreadCount,
        // Use online status from API if available, otherwise default to false (socket handles updates)
        isOnline: room.otherUser.isOnline || false,
      }));

      setUsers((prev) => {
        return formattedUsers.map((newUser) => {
          // Merge with existing state to preserve real-time online status from socket
          const existing = prev.find((u) => u._id === newUser._id);
          return existing
            ? { ...newUser, isOnline: existing.isOnline }
            : newUser;
        });
      });

      if (socket) {
        socket.emit("get_online_users");
      }
    } catch (e) {
      if (!silent) console.error("Failed to fetch users", e);
    }
  };

  // ðŸ”¥ NEW: Toggle AI Auto Reply Function
  const toggleAutoReply = async () => {
    try {
      const token =
        localStorage.getItem("token") || localStorage.getItem("adminToken");
      const newStatus = !isAutoReplyEnabled;

      const response = await fetch(
        `${process.env.NEXT_PUBLIC_API_URL || "http://localhost:5000/api"}/admin/auth/toggle-ai`,
        {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ status: newStatus }),
        },
      );

      const data = await response.json();

      if (data.success) {
        setIsAutoReplyEnabled(newStatus);
        toast.success(`AI Auto-Reply Turned ${newStatus ? "ON ðŸŸ¢" : "OFF ðŸ”´"}`);
      } else {
        toast.error("Failed to update AI status");
      }
    } catch (error) {
      console.error("AI Toggle Error:", error);
      toast.error("Something went wrong");
    }
  };

  // --- 2. Handle User Select ---
  const handleUserSelect = async (user: ChatUser) => {
    setActiveUser(user);
    setIsSearching(false);
    if (isMobileView) setShowChatOnMobile(true);

    // Join the specific room
    socket?.emit("join_room", user.roomId); // Backend expects just roomId string or object? Code says `socket.join(roomToJoin)`
    // ðŸ‘‡ðŸ‘‡ðŸ‘‡ NEW LINE: Check if this specific user is online ðŸ‘‡ðŸ‘‡ðŸ‘‡
    socket?.emit("check_online_status", { userId: user._id });
    // ðŸ‘†ðŸ‘†ðŸ‘†
    try {
      const res = await ChatService.getMessages(user.roomId);
      const history = res.data?.data?.messages || [];

      // Sort: Oldest first for rendering
      setMessages(history.reverse());
      scrollToBottom();

      // Reset unread locally
      setUsers((prev) =>
        prev.map((u) => (u._id === user._id ? { ...u, unreadCount: 0 } : u)),
      );

      if (history.length > 0) await ChatService.markAsRead(user.roomId);
    } catch (error) {
      console.error("Error fetching messages:", error);
    }
  };

  const scrollToBottom = () => {
    setTimeout(() => {
      messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    }, 100);
  };

  // --- 3. INCOMING MESSAGE LOGIC ---
  const handleIncomingMessage = (
    newMsg: ChatMessage,
    socketInstance: Socket,
  ) => {
    const currentActive = activeUserRef.current;
    const currentAdmin = adminIdRef.current;
    const senderId = getSafeId(newMsg.senderId);

    // A. Update Active Chat Window
    if (currentActive && currentActive.roomId === newMsg.roomId) {
      setMessages((prev) => {
        // Prevent Duplicates
        if (prev.some((m) => m._id === newMsg._id)) return prev;

        // If sender is ME (Admin), check for tempId match and replace
        if (senderId === currentAdmin) {
          return prev.map((m) =>
            m.tempId && m.text === newMsg.text ? newMsg : m,
          );
        }

        // If sender is USER, play sound & mark read
        if (senderId !== currentAdmin) {
          socketInstance.emit("mark_read", {
            roomId: newMsg.roomId,
            userId: currentAdmin,
          });
          try {
            notificationAudioRef.current?.play();
          } catch (e) {}
        }

        return [...prev, newMsg];
      });

      scrollToBottom();
      setIsTyping(false);
    } else {
      // Notification
      try {
        notificationAudioRef.current?.play();
      } catch (e) {}
      toast.info(`New message received`);
    }

    // B. Update Sidebar List
    fetchUserList(true);
  };

  // --- 4. Send Message (Optimistic UI) ---
  const handleSendMessage = async (e?: React.FormEvent) => {
    e?.preventDefault();
    if ((!inputText.trim() && !selectedFile) || !activeUser || !socket) return;

    // ðŸ”¥ NEW: Play Sent Sound
    try {
      if (sentAudioRef.current) {
        sentAudioRef.current.currentTime = 0;
        sentAudioRef.current.play();
      }
    } catch (error) {
      console.log("Audio play error", error);
    }

    if (selectedFile) {
      await handleFileUpload();
      return;
    }

    const tempId = Date.now();
    const payload = {
      senderId: adminId,
      receiverId: activeUser._id,
      text: inputText,
      roomId: activeUser.roomId,
      messageType: "text",
      senderModel: "Admin",
      receiverModel: "User",
      tempId: tempId,
    };

    const optimisticMsg: ChatMessage = {
      _id: `temp-${tempId}`,
      senderId: adminId,
      text: inputText,
      createdAt: new Date().toISOString(),
      isRead: false,
      messageType: "text",
      roomId: activeUser.roomId,
      tempId: tempId,
    };

    setMessages((prev) => [...prev, optimisticMsg]);
    setInputText("");
    scrollToBottom();
    setShowQuickReplies(false);

    socket.emit("stop_typing", { roomId: activeUser.roomId }); // Fixed: Send Object
    socket.emit("send_message", payload);

    // Sidebar Update
    setUsers((prev) =>
      prev
        .map((u) =>
          u._id === activeUser._id
            ? {
                ...u,
                lastMessage: payload.text,
                lastMessageTime: new Date().toISOString(),
              }
            : u,
        )
        .sort(
          (a, b) =>
            new Date(b.lastMessageTime || 0).getTime() -
            new Date(a.lastMessageTime || 0).getTime(),
        ),
    );
  };

  // --- 5. File Upload ---
  const handleFileUpload = async () => {
    if (!selectedFile || !activeUser || !socket) return;

    setIsUploading(true);
    const formData = new FormData();
    formData.append("file", selectedFile);

    try {
      const res = await ChatService.uploadFile(formData);
      const { fileUrl, fileType } = res.data.data;

      // Detect audio manually if needed
      let finalType = fileType;
      if (
        selectedFile.type.startsWith("audio") ||
        selectedFile.name.endsWith(".webm")
      ) {
        finalType = "audio";
      }

      const payload = {
        senderId: adminId,
        receiverId: activeUser._id,
        text: "",
        roomId: activeUser.roomId,
        messageType: finalType,
        fileUrl: fileUrl,
        senderModel: "Admin",
        receiverModel: "User",
      };

      const tempMsg: ChatMessage = {
        _id: `temp-${Date.now()}`,
        senderId: adminId,
        text: "",
        fileUrl: fileUrl,
        messageType: finalType as any,
        createdAt: new Date().toISOString(),
        isRead: false,
        roomId: activeUser.roomId,
      };

      setMessages((prev) => [...prev, tempMsg]);
      scrollToBottom();

      socket.emit("send_message", payload);
      fetchUserList(true);
    } catch (error) {
      console.error("Upload error:", error);
      toast.error("Failed to upload file");
    } finally {
      setIsUploading(false);
      setSelectedFile(null);
      if (fileInputRef.current) fileInputRef.current.value = "";
    }
  };

  // --- 6. Voice Recording ---
  // --- 6. Voice Recording Features (FIXED) ---

  const streamRef = useRef<MediaStream | null>(null);

  const startRecording = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      streamRef.current = stream;

      // Browser Compatibility Check (Safari vs Chrome)
      let mimeType = "audio/webm";
      if (MediaRecorder.isTypeSupported("audio/webm;codecs=opus")) {
        mimeType = "audio/webm;codecs=opus";
      } else if (MediaRecorder.isTypeSupported("audio/mp4")) {
        mimeType = "audio/mp4";
      }

      const recorder = new MediaRecorder(stream, { mimeType });
      setMediaRecorder(recorder);
      const chunks: Blob[] = [];

      recorder.ondataavailable = (e) => {
        if (e.data.size > 0) chunks.push(e.data);
      };

      recorder.onstop = () => {
        // Create Blob & File
        const audioBlob = new Blob(chunks, { type: mimeType });
        const fileExt = mimeType.includes("mp4") ? "mp4" : "webm";
        const fileName = `voice_note_${Date.now()}.${fileExt}`;

        const file = new File([audioBlob], fileName, {
          type: mimeType,
        });

        // ðŸ”¥ FIX 1: Don't set selectedFile for auto-send (avoids preview stuck issue)
        // setSelectedFile(file); <--- REMOVED THIS LINE

        // Auto Upload & Send
        uploadAndSendRecordedFile(file);

        // Stop Microphone Tracks
        stream.getTracks().forEach((track) => track.stop());
      };

      recorder.start();
      setIsRecording(true);
    } catch (err) {
      console.error(err);
      toast.error("Microphone access denied");
    }
  };

  const uploadAndSendRecordedFile = async (file: File) => {
    if (!activeUser || !socket) return;

    setIsUploading(true);
    const formData = new FormData();
    // ðŸ”¥ Make sure your backend accepts field name "file"
    formData.append("file", file);

    try {
      const res = await ChatService.uploadFile(formData);
      console.log("Audio Upload Response:", res.data);

      // ðŸ”¥ FIX 2: Safe URL Extraction (Handle different API responses)
      const responseData = res.data;
      const fileUrl =
        responseData?.data?.fileUrl ||
        responseData?.fileUrl ||
        responseData?.url ||
        responseData?.secure_url;

      if (!fileUrl) {
        toast.error("Audio upload failed: No URL received");
        return;
      }

      const payload = {
        senderId: adminId,
        receiverId: activeUser._id,
        text: "",
        roomId: activeUser.roomId,
        messageType: "audio", // âœ… Correctly set as audio
        fileUrl: fileUrl,
        senderModel: "Admin",
        receiverModel: "User",
      };

      const tempMsg: ChatMessage = {
        _id: `temp-${Date.now()}`,
        senderId: adminId,
        text: "",
        fileUrl: fileUrl,
        messageType: "audio",
        createdAt: new Date().toISOString(),
        isRead: false,
        roomId: activeUser.roomId,
      };

      setMessages((prev) => [...prev, tempMsg]);
      scrollToBottom();
      socket.emit("send_message", payload);
    } catch (e) {
      console.error(e);
      toast.error("Failed to send voice note");
    } finally {
      setIsUploading(false);
      setIsRecording(false);
      setSelectedFile(null); // ðŸ”¥ FIX 3: Ensure file is cleared from state
    }
  };

  const stopRecording = () => {
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
      mediaRecorder.stop();
      setIsRecording(false);
    }
  };

  // --- 7. UI Helpers ---
  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const val = e.target.value;
    setInputText(val);

    // Quick Reply Trigger
    if (val === "/") setShowQuickReplies(true);
    else setShowQuickReplies(false);

    if (socket && activeUser) {
      // Send as object to be safe
      socket.emit("typing", { roomId: activeUser.roomId, userId: adminId });

      if (typingTimeoutRef.current) clearTimeout(typingTimeoutRef.current);

      typingTimeoutRef.current = setTimeout(() => {
        socket.emit("stop_typing", {
          roomId: activeUser.roomId,
          userId: adminId,
        });
      }, 2000);
    }
  };

  const selectQuickReply = (text: string) => {
    setInputText(text);
    setShowQuickReplies(false);
  };

  // Drag & Drop
  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault();
    setIsDragging(true);
  };
  const handleDragLeave = () => setIsDragging(false);
  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault();
    setIsDragging(false);
    const files = e.dataTransfer.files;
    if (files && files.length > 0) setSelectedFile(files[0]);
  };

  const filteredUsers = users.filter((u) =>
    u.name.toLowerCase().includes(searchQuery.toLowerCase()),
  );

  if (isLoading)
    return (
      <div className="flex h-[100dvh] items-center justify-center">
        <Loader2 className="animate-spin text-blue-500 h-8 w-8" />
      </div>
    );

  return (
    // ðŸ”¥ UPDATED: Full screen container with proper mobile support (100dvh)
    <div className="h-[calc(100dvh-5rem)] md:h-[calc(100vh-6rem)] w-full overflow-hidden flex flex-col md:flex-row gap-4">
      {/* --- LEFT SIDEBAR: USERS LIST --- */}
      <AnimatePresence mode="popLayout">
        {(!isMobileView || !showChatOnMobile) && (
          <motion.div
            initial={{ opacity: 0, x: -20 }}
            animate={{ opacity: 1, x: 0 }}
            exit={{ opacity: 0, x: -20 }}
            // ðŸ”¥ UPDATED: Full width on mobile, fixed width on desktop
            className={`flex-1 md:flex-none md:w-[350px] lg:w-[400px] flex flex-col ${glassPanel} rounded-2xl h-full`}
          >
            <div className="p-4 border-b border-white/10 flex justify-between items-center">
              <h2 className="text-xl font-bold text-white">Chats</h2>

              {/* ðŸ”¥ NEW: AI Auto Reply Toggle Button */}
              <div className="flex gap-2">
                <button
                  onClick={toggleAutoReply}
                  className={`p-2 rounded-full transition-all ${isAutoReplyEnabled ? "bg-green-500/20 text-green-400 border border-green-500/50" : "bg-white/5 text-gray-400 hover:bg-white/10"}`}
                  title={
                    isAutoReplyEnabled
                      ? "AI Auto-Reply is ON"
                      : "AI Auto-Reply is OFF"
                  }
                >
                  <Bot size={20} />
                </button>
                <button className="p-2 hover:bg-white/10 rounded-full text-gray-300">
                  <MoreVertical size={20} />
                </button>
              </div>
            </div>

            <div className="px-4 py-3">
              <div
                className={`flex items-center gap-2 px-3 py-2 rounded-xl ${glassInput}`}
              >
                <Search size={18} className="text-gray-400" />
                <input
                  type="text"
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  placeholder="Search users..."
                  className="bg-transparent border-none outline-none text-sm w-full text-white placeholder-gray-500"
                />
              </div>
            </div>

            {/* ðŸ”¥ UPDATED: Added custom scrollbar class */}
            <div className={`flex-1 overflow-y-auto ${customScrollbar}`}>
              {filteredUsers.map((user) => (
                <motion.div
                  key={user._id}
                  whileHover={{ backgroundColor: "rgba(255,255,255,0.05)" }}
                  onClick={() => handleUserSelect(user)}
                  className={`flex items-center gap-3 p-4 cursor-pointer border-b border-white/5 transition-colors
                    ${activeUser?._id === user._id ? "bg-white/10 border-l-4 border-l-blue-500" : ""}`}
                >
                  <div className="relative">
                    <div className="h-12 w-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-lg overflow-hidden shrink-0">
                      {user.avatar ? (
                        <img
                          src={user.avatar}
                          className="h-full w-full object-cover"
                        />
                      ) : (
                        user.name.charAt(0).toUpperCase()
                      )}
                    </div>
                    {/* ðŸŸ¢ Online Status Dot */}
                    {user.isOnline && (
                      <span className="absolute bottom-0 right-0 h-3 w-3 bg-green-500 border-2 border-[#1a1a1a] rounded-full"></span>
                    )}
                  </div>

                  <div className="flex-1 min-w-0">
                    <div className="flex justify-between items-center mb-1">
                      <h3 className="font-semibold text-white truncate">
                        {user.name}
                      </h3>
                      <span className="text-xs text-gray-500">
                        {user.lastMessageTime
                          ? format(new Date(user.lastMessageTime), "HH:mm")
                          : ""}
                      </span>
                    </div>
                    <div className="flex justify-between items-center">
                      <p className="text-sm text-gray-400 truncate w-[90%]">
                        {user.lastMessage || "Start conversation"}
                      </p>
                      {user.unreadCount && user.unreadCount > 0 ? (
                        <span className="h-5 w-5 bg-blue-500 rounded-full flex items-center justify-center text-[10px] font-bold text-white shrink-0">
                          {user.unreadCount}
                        </span>
                      ) : null}
                    </div>
                  </div>
                </motion.div>
              ))}
            </div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* --- RIGHT SIDE: CHAT WINDOW --- */}
      <AnimatePresence mode="popLayout">
        {(!isMobileView || showChatOnMobile) && (
          <motion.div
            initial={{ opacity: 0, x: 20 }}
            animate={{ opacity: 1, x: 0 }}
            exit={{ opacity: 0, x: 20 }}
            // ðŸ”¥ UPDATED: Flexible width handling for mobile/desktop
            className={`flex-1 flex flex-col ${glassPanel} rounded-2xl h-full overflow-hidden relative transition-colors ${isDragging ? "bg-blue-500/10 border-blue-500" : ""}`}
            onDragOver={handleDragOver}
            onDragLeave={handleDragLeave}
            onDrop={handleDrop}
          >
            {activeUser ? (
              <>
                {/* Header */}
                <div className="p-4 border-b border-white/10 flex justify-between items-center bg-white/[0.02]">
                  <div className="flex items-center gap-3">
                    {isMobileView && (
                      <button
                        onClick={() => setShowChatOnMobile(false)}
                        className="mr-1 text-gray-300 hover:text-white"
                      >
                        <ArrowLeft size={22} />
                      </button>
                    )}
                    <div className="h-10 w-10 rounded-full bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center text-white font-bold overflow-hidden shrink-0">
                      {activeUser.avatar ? (
                        <img
                          src={activeUser.avatar}
                          className="h-full w-full object-cover"
                        />
                      ) : (
                        activeUser.name.charAt(0).toUpperCase()
                      )}
                    </div>
                    <div>
                      <h3 className="font-bold text-white leading-tight">
                        {activeUser.name}
                      </h3>
                      <p className="text-xs text-blue-400">
                        {isTyping ? (
                          <span className="text-green-400 animate-pulse">
                            Typing...
                          </span>
                        ) : activeUser.isOnline ? (
                          "Online"
                        ) : (
                          "Offline"
                        )}
                      </p>
                    </div>
                  </div>
                  <div className="flex gap-4 text-gray-400">
                    <Phone
                      size={20}
                      className="hover:text-white cursor-pointer"
                    />
                    <Video
                      size={20}
                      className="hover:text-white cursor-pointer"
                    />
                  </div>
                </div>

                {/* Messages */}
                {/* ðŸ”¥ UPDATED: Added custom scrollbar class */}
                <div
                  className={`flex-1 overflow-y-auto p-4 space-y-4 bg-gradient-to-b from-black/20 to-black/40 relative ${customScrollbar}`}
                >
                  {isDragging && (
                    <div className="absolute inset-0 bg-blue-500/20 backdrop-blur-sm z-50 flex items-center justify-center border-2 border-dashed border-blue-500 m-4 rounded-xl">
                      <p className="text-white font-bold text-xl">
                        Drop files here to upload
                      </p>
                    </div>
                  )}

                  {messages.map((msg, idx) => {
                    const senderId = getSafeId(msg.senderId);
                    const isMe = senderId === adminId;

                    return (
                      <motion.div
                        key={msg._id || idx}
                        initial={{ opacity: 0, y: 10 }}
                        animate={{ opacity: 1, y: 0 }}
                        className={`flex ${isMe ? "justify-end" : "justify-start"}`}
                      >
                        <div
                          className={`max-w-[85%] md:max-w-[65%] px-4 py-2 rounded-2xl relative shadow-md
                          ${
                            isMe
                              ? "bg-blue-600 text-white rounded-tr-none"
                              : "bg-white/10 backdrop-blur-md text-gray-100 rounded-tl-none border border-white/5"
                          }`}
                        >
                          {/* Media */}
                          {msg.messageType === "image" && msg.fileUrl && (
                            <img
                              src={msg.fileUrl}
                              alt="attachment"
                              className="rounded-lg mb-2 max-h-60 object-cover cursor-pointer"
                              onClick={() => window.open(msg.fileUrl, "_blank")}
                            />
                          )}
                          {msg.messageType === "video" && msg.fileUrl && (
                            <video
                              src={msg.fileUrl}
                              controls
                              className="rounded-lg mb-2 max-h-60 w-full"
                            />
                          )}
                          {msg.messageType === "audio" && msg.fileUrl && (
                            <div className="flex items-center gap-2 mb-2 min-w-[200px] md:min-w-[220px] bg-black/20 p-2 rounded-lg">
                              <audio
                                controls
                                className="w-full h-8"
                                preload="metadata"
                              >
                                <source src={msg.fileUrl} type="audio/webm" />
                                <source src={msg.fileUrl} type="audio/mp4" />
                                <source src={msg.fileUrl} type="audio/mpeg" />
                                Your browser does not support the audio element.
                              </audio>
                            </div>
                          )}

                          {msg.text && (
                            <p className="text-sm leading-relaxed whitespace-pre-wrap break-words">
                              {msg.text}
                            </p>
                          )}

                          <div
                            className={`text-[10px] flex items-center justify-end gap-1 mt-1 ${isMe ? "text-blue-200" : "text-gray-400"}`}
                          >
                            {format(new Date(msg.createdAt), "HH:mm")}
                            {isMe &&
                              (msg.isRead ? (
                                <CheckCheck
                                  size={14}
                                  className="text-emerald-400"
                                /> // âœ”âœ” GREEN
                              ) : (
                                <Check size={14} className="text-black" /> // âœ” BLACK
                              ))}
                          </div>
                        </div>
                      </motion.div>
                    );
                  })}
                  <div ref={messagesEndRef} />
                </div>

                {/* Quick Replies Popup */}
                <AnimatePresence>
                  {showQuickReplies && (
                    <motion.div
                      initial={{ opacity: 0, y: 10 }}
                      animate={{ opacity: 1, y: 0 }}
                      exit={{ opacity: 0, y: 10 }}
                      className="absolute bottom-20 left-4 right-4 bg-[#1a1a1a] border border-white/10 rounded-xl p-2 shadow-2xl z-20 flex flex-wrap gap-2"
                    >
                      {QUICK_REPLIES.map((reply, i) => (
                        <button
                          key={i}
                          onClick={() => selectQuickReply(reply)}
                          className="bg-white/5 hover:bg-blue-600 text-sm text-gray-300 hover:text-white px-3 py-1.5 rounded-full transition"
                        >
                          {reply}
                        </button>
                      ))}
                    </motion.div>
                  )}
                </AnimatePresence>

                {/* File Preview */}
                <AnimatePresence>
                  {selectedFile && (
                    <motion.div
                      initial={{ y: 20, opacity: 0 }}
                      animate={{ y: 0, opacity: 1 }}
                      exit={{ y: 20, opacity: 0 }}
                      className="absolute bottom-20 left-4 right-4 p-3 bg-black/80 backdrop-blur-md rounded-xl flex items-center gap-3 border border-white/10 z-30"
                    >
                      <Paperclip className="text-white" />
                      <span className="text-white text-sm truncate flex-1">
                        {selectedFile.name}
                      </span>
                      <button onClick={() => setSelectedFile(null)}>
                        <X className="text-white hover:text-red-500" />
                      </button>
                    </motion.div>
                  )}
                </AnimatePresence>

                {/* Input Area */}
                <div className="p-3 md:p-4 border-t border-white/10 bg-black/20 backdrop-blur-md">
                  <form
                    onSubmit={handleSendMessage}
                    className="flex items-center gap-2 md:gap-3"
                  >
                    <button
                      type="button"
                      className="text-gray-400 hover:text-white transition shrink-0"
                    >
                      <Smile size={24} />
                    </button>

                    <input
                      type="file"
                      ref={fileInputRef}
                      className="hidden"
                      accept="image/*,video/*,audio/*"
                      onChange={(e) =>
                        e.target.files && setSelectedFile(e.target.files[0])
                      }
                    />
                    <button
                      type="button"
                      className="text-gray-400 hover:text-white transition shrink-0"
                      onClick={() => fileInputRef.current?.click()}
                    >
                      <Paperclip size={22} />
                    </button>

                    <div className="flex-1 relative">
                      <input
                        type="text"
                        value={inputText}
                        onChange={handleInputChange}
                        placeholder={
                          isRecording
                            ? "Recording..."
                            : isMobileView
                              ? "Message..."
                              : "Type a message... (/ for replies)"
                        }
                        className={`w-full py-3 pl-4 pr-10 rounded-xl ${glassInput} ${isRecording ? "text-red-400 placeholder-red-400" : ""}`}
                        disabled={isRecording || isUploading}
                      />
                      {isUploading && (
                        <div className="absolute right-3 top-1/2 -translate-y-1/2">
                          <Loader2
                            size={18}
                            className="animate-spin text-blue-400"
                          />
                        </div>
                      )}
                    </div>

                    {inputText.trim() || selectedFile ? (
                      <button
                        type="submit"
                        disabled={isUploading}
                        className="h-11 w-11 bg-blue-600 hover:bg-blue-500 rounded-full flex items-center justify-center text-white shadow-lg transition-all transform hover:scale-105 shrink-0"
                      >
                        <Send size={20} className="ml-0.5" />
                      </button>
                    ) : (
                      <button
                        type="button"
                        onClick={isRecording ? stopRecording : startRecording}
                        className={`h-11 w-11 rounded-full flex items-center justify-center text-white transition shrink-0 ${isRecording ? "bg-red-600 animate-pulse" : "bg-white/10 hover:bg-white/20"}`}
                      >
                        {isRecording ? (
                          <StopCircle size={20} />
                        ) : (
                          <Mic size={20} />
                        )}
                      </button>
                    )}
                  </form>
                </div>
              </>
            ) : (
              <div className="flex-1 flex flex-col items-center justify-center text-center p-8 opacity-50">
                <div className="h-24 w-24 bg-white/5 rounded-full flex items-center justify-center mb-4 border border-white/10">
                  <Send size={40} className="text-blue-400 ml-2" />
                </div>
                <h2 className="text-2xl font-bold text-white mb-2">
                  Welcome to Live Chat
                </h2>
                <p className="text-gray-400 max-w-md">
                  Select a customer from the left sidebar to start messaging.
                </p>
                <div className="mt-8 flex gap-2 text-sm text-gray-500">
                  <div className="flex items-center gap-1">
                    <Lock size={12} /> End-to-end encrypted
                  </div>
                </div>
              </div>
            )}
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}
</file>

<file path="app/dashboard/customers/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { motion } from 'framer-motion';
import { Search, Mail, Phone, MapPin, Calendar } from 'lucide-react';
import { TableSkeleton } from '@/components/ui/Skeleton';
import { toast } from 'sonner';
import api from '@/lib/api'; // Ensure this is your configured Axios instance

// --- 1. Define Types based on Backend Response ---
interface Address {
  _id: string;
  addressType: string;
  street: string;
  city: string;
  state: string;
  pincode: string;
  isDefault: boolean;
}

interface User {
  _id: string;
  name: string;
  email: string;
  phone: string;
  role: string;
  isActive: boolean;
  isEmailVerified: boolean;
  addresses: Address[];
  createdAt: string;
  updatedAt: string;
  lastLogin?: string;
}

export default function CustomersPage() {
  const [customers, setCustomers] = useState<User[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState('');

  useEffect(() => {
    fetchCustomers();
  }, []);

  // --- 2. Updated Fetch Logic ---
  const fetchCustomers = async () => {
    try {
      setIsLoading(true);
      
      // Update endpoint if necessary. Based on your previous context it might be '/admin/users'
      const response = await api.get('/admin/auth/users'); 

      // Backend Response Structure: { success: true, message: "...", data: [...] }
      if (response.data && response.data.success) {
        setCustomers(response.data.data);
      } else {
        // Fallback if structure differs slightly
        setCustomers([]); 
        console.warn("Unexpected response format:", response.data);
      }

    } catch (error: any) {
      console.error('Customers fetch error:', error);
      toast.error(error.response?.data?.message || 'Failed to fetch customers');
      setCustomers([]); // Clear data on error
    } finally {
      setIsLoading(false);
    }
  };

  // --- 3. Filter Logic (No changes needed, but ensuring null safety) ---
  const filteredCustomers = customers.filter((customer) =>
    (customer.name || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
    (customer.email || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
    (customer.phone || '').includes(searchQuery)
  );

  if (isLoading) {
    return (
      <div className="space-y-6">
        <div className="flex items-center justify-between">
          <h1 className="text-3xl font-bold text-white">Customers</h1>
        </div>
        <TableSkeleton />
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <motion.div
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.5 }}
        className="flex items-center justify-between"
      >
        <div>
          <h1 className="text-3xl font-bold text-white">Customers</h1>
          <p className="mt-1 text-gray-400">
            Manage your customer database
          </p>
        </div>
      </motion.div>

      {/* Search */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.1, duration: 0.5 }}
      >
        <div className="relative">
          <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400" />
          <input
            type="text"
            placeholder="Search by name, email or phone..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            className="w-full rounded-xl border border-white/10 bg-white/5 py-2.5 pl-10 pr-4 text-sm text-white placeholder-gray-400 backdrop-blur-sm transition-all focus:border-blue-500/30 focus:bg-white/10 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
          />
        </div>
      </motion.div>

      {/* Stats */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.2, duration: 0.5 }}
        className="grid gap-4 sm:grid-cols-3"
      >
        <div className="rounded-xl border border-white/10 bg-white/5 p-4 backdrop-blur-sm">
          <p className="text-sm text-gray-400">Total Customers</p>
          <p className="mt-1 text-2xl font-bold text-white">{customers.length}</p>
        </div>
        <div className="rounded-xl border border-white/10 bg-white/5 p-4 backdrop-blur-sm">
          <p className="text-sm text-gray-400">Verified Emails</p>
          <p className="mt-1 text-2xl font-bold text-green-400">
            {customers.filter(c => c.isEmailVerified).length}
          </p>
        </div>
        <div className="rounded-xl border border-white/10 bg-white/5 p-4 backdrop-blur-sm">
          <p className="text-sm text-gray-400">With Addresses</p>
          <p className="mt-1 text-2xl font-bold text-blue-400">
            {customers.filter(c => c.addresses && c.addresses.length > 0).length}
          </p>
        </div>
      </motion.div>

      {/* Customers Table */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.3, duration: 0.5 }}
        className="overflow-hidden rounded-2xl border border-white/10 bg-white/[0.02] backdrop-blur-sm"
      >
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead>
              <tr className="border-b border-white/10 bg-white/5">
                <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">
                  Customer
                </th>
                <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">
                  Contact
                </th>
                <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">
                  Location
                </th>
                <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">
                  Status
                </th>
                <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">
                  Joined
                </th>
              </tr>
            </thead>
            <tbody className="divide-y divide-white/5">
              {filteredCustomers.map((customer, index) => {
                // Determine display address (Default or First)
                const displayAddress = customer.addresses?.find(a => a.isDefault) || customer.addresses?.[0];

                return (
                  <motion.tr
                    key={customer._id}
                    initial={{ opacity: 0, x: -20 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: 0.05 * index, duration: 0.3 }}
                    whileHover={{ backgroundColor: 'rgba(255, 255, 255, 0.02)' }}
                    className="transition-colors"
                  >
                    <td className="px-6 py-4">
                      <div className="flex items-center gap-3">
                        <div className="flex h-10 w-10 items-center justify-center rounded-full bg-gradient-to-br from-blue-500 to-cyan-500 text-sm font-bold text-white">
                          {customer.name?.charAt(0).toUpperCase() || 'U'}
                        </div>
                        <div>
                          <p className="font-medium text-white">{customer.name || 'Unknown'}</p>
                          <p className="text-xs text-gray-400">ID: {customer._id.slice(-6)}</p>
                        </div>
                      </div>
                    </td>
                    <td className="px-6 py-4">
                      <div className="space-y-1">
                        <div className="flex items-center gap-2 text-sm text-gray-300">
                          <Mail className="h-3 w-3" />
                          {customer.email}
                        </div>
                        <div className="flex items-center gap-2 text-sm text-gray-300">
                          <Phone className="h-3 w-3" />
                          {customer.phone || 'N/A'}
                        </div>
                      </div>
                    </td>
                    <td className="px-6 py-4">
                      {displayAddress ? (
                        <div className="flex items-start gap-2 text-sm text-gray-300">
                          <MapPin className="h-4 w-4 mt-0.5 flex-shrink-0" />
                          <span>
                            {displayAddress.city}, {displayAddress.state}
                          </span>
                        </div>
                      ) : (
                        <span className="text-sm text-gray-500 italic">No address</span>
                      )}
                    </td>
                    <td className="px-6 py-4">
                      <span
                        className={`inline-flex rounded-full px-3 py-1 text-xs font-medium ${
                          customer.isEmailVerified
                            ? 'bg-green-500/10 text-green-400'
                            : 'bg-yellow-500/10 text-yellow-400'
                        }`}
                      >
                        {customer.isEmailVerified ? 'Verified' : 'Pending'}
                      </span>
                    </td>
                    <td className="px-6 py-4">
                      <div className="flex items-center gap-2 text-sm text-gray-400">
                        <Calendar className="h-3 w-3" />
                        {new Date(customer.createdAt).toLocaleDateString('en-IN', {
                          day: '2-digit',
                          month: 'short',
                          year: 'numeric'
                        })}
                      </div>
                    </td>
                  </motion.tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </motion.div>

      {/* No Results */}
      {filteredCustomers.length === 0 && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          className="flex flex-col items-center justify-center py-12 text-center"
        >
          <Search className="h-16 w-16 text-gray-600" />
          <p className="mt-4 text-lg font-medium text-gray-400">No customers found</p>
          <p className="mt-1 text-sm text-gray-500">
            Try adjusting your search criteria
          </p>
        </motion.div>
      )}
    </div>
  );
}
</file>

<file path="app/dashboard/layout.tsx">
// "use client";

// import { useEffect, useState } from "react";
// import { useRouter } from "next/navigation";
// import Sidebar from "@/components/Sidebar";
// import Header from "@/components/Header";
// import PageTransition from "@/components/PageTransition";
// import { SocketProvider } from "@/components/providers/SocketProvider";
// import { motion, AnimatePresence } from "framer-motion";
// import { AdminAuthService } from "@/lib/api";
// import { Menu, X } from "lucide-react"; // Icons for mobile toggle

// export default function DashboardLayout({
//   children,
// }: {
//   children: React.ReactNode;
// }) {
//   const router = useRouter();
//   const [isAuthorized, setIsAuthorized] = useState(false);
//   const [isSidebarOpen, setSidebarOpen] = useState(false); // Mobile Sidebar State

//   // --- SECURITY CHECK ---
//   useEffect(() => {
//     const checkAuth = async () => {
//       try {
//         await AdminAuthService.getProfile();
//         setIsAuthorized(true);
//       } catch (error) {
//         console.error("Auth check failed:", error);
//         router.push("/login");
//       }
//     };

//     checkAuth();
//   }, [router]);

//   if (!isAuthorized) {
//     return (
//       <div className="min-h-screen flex items-center justify-center bg-gray-950 text-white">
//         <div className="flex flex-col items-center gap-4">
//           <div className="h-8 w-8 animate-spin rounded-full border-4 border-blue-500 border-t-transparent"></div>
//           <p className="text-gray-400">Verifying session...</p>
//         </div>
//       </div>
//     );
//   }

//   return (
//     <SocketProvider>
//       <div className="relative min-h-screen bg-gradient-to-br from-gray-950 via-gray-900 to-gray-950 overflow-x-hidden">
//         {/* Animated Background Elements */}
//         <div className="fixed inset-0 overflow-hidden pointer-events-none z-0">
//           <motion.div
//             animate={{ scale: [1, 1.2, 1], rotate: [0, 90, 0] }}
//             transition={{ duration: 20, repeat: Infinity, ease: "linear" }}
//             className="absolute -top-1/2 -right-1/2 h-full w-full rounded-full bg-blue-500/5 blur-3xl"
//           />
//           <motion.div
//             animate={{ scale: [1, 1.1, 1], rotate: [0, -90, 0] }}
//             transition={{ duration: 25, repeat: Infinity, ease: "linear" }}
//             className="absolute -bottom-1/2 -left-1/2 h-full w-full rounded-full bg-cyan-500/5 blur-3xl"
//           />
//         </div>

//         {/* --- MOBILE MENU TOGGLE BUTTON (Visible only on Mobile) --- */}
//         <div className="lg:hidden fixed top-4 left-4 z-50">
//           <button
//             onClick={() => setSidebarOpen(!isSidebarOpen)}
//             className="p-2.5 rounded-xl bg-white/10 backdrop-blur-md border border-white/10 text-white shadow-lg active:scale-95 transition-all"
//           >
//             {isSidebarOpen ? <X size={24} /> : <Menu size={24} />}
//           </button>
//         </div>

//         {/* --- MOBILE OVERLAY (Backdrop) --- */}
//         <AnimatePresence>
//           {isSidebarOpen && (
//             <motion.div
//               initial={{ opacity: 0 }}
//               animate={{ opacity: 1 }}
//               exit={{ opacity: 0 }}
//               onClick={() => setSidebarOpen(false)}
//               className="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 lg:hidden"
//             />
//           )}
//         </AnimatePresence>

//         {/* --- SIDEBAR WRAPPER --- */}
//         {/* lg:translate-x-0 ensures it's always visible on desktop */}
//         <div
//           className={`fixed inset-y-0 left-0 z-50 w-64 transform transition-transform duration-300 ease-in-out lg:translate-x-0
//           ${isSidebarOpen ? "translate-x-0" : "-translate-x-full"}`}
//         >
//           <Sidebar />
//         </div>

//         {/* --- MAIN CONTENT AREA --- */}
//         {/* lg:ml-64 ensures space for sidebar on desktop, ml-0 for mobile */}
//         <div className="relative z-20 flex-1 flex flex-col min-h-screen transition-all duration-300 lg:ml-64">
//           {/* Header Container */}
//           <div className="sticky top-0 z-30">
//             <Header />
//           </div>

//           <main className="flex-1 pt-6 lg:pt-8">
//             <div className="p-4 md:p-6 lg:p-8">
//               <PageTransition>{children}</PageTransition>
//             </div>
//           </main>
//         </div>
//       </div>
//     </SocketProvider>
//   );
// }

"use client";

import { useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import Sidebar from "@/components/Sidebar";
import Header from "@/components/Header";
import PageTransition from "@/components/PageTransition";
import { SocketProvider } from "@/components/providers/SocketProvider";
import { motion, AnimatePresence } from "framer-motion";
import { AdminAuthService } from "@/lib/api";

export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const router = useRouter();
  const [isAuthorized, setIsAuthorized] = useState(false);
  const [isSidebarOpen, setSidebarOpen] = useState(false); // à°‡à°¦à°¿ à°®à°¨ à°¸à±à°µà°¿à°šà± (State)

  // --- SECURITY CHECK ---
  useEffect(() => {
    const checkAuth = async () => {
      try {
        await AdminAuthService.getProfile();
        setIsAuthorized(true);
      } catch (error) {
        console.error("Auth check failed:", error);
        router.push("/login");
      }
    };

    checkAuth();
  }, [router]);

  if (!isAuthorized) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-950 text-white">
        <div className="flex flex-col items-center gap-4">
          <div className="h-8 w-8 animate-spin rounded-full border-4 border-blue-500 border-t-transparent"></div>
          <p className="text-gray-400">Verifying session...</p>
        </div>
      </div>
    );
  }

  return (
    <SocketProvider>
      <div className="relative min-h-screen bg-gradient-to-br from-gray-950 via-gray-900 to-gray-950 overflow-x-hidden">
        {/* Animated Background Elements */}
        <div className="fixed inset-0 overflow-hidden pointer-events-none z-0">
          <motion.div
            animate={{ scale: [1, 1.2, 1], rotate: [0, 90, 0] }}
            transition={{ duration: 20, repeat: Infinity, ease: "linear" }}
            className="absolute -top-1/2 -right-1/2 h-full w-full rounded-full bg-blue-500/5 blur-3xl"
          />
          <motion.div
            animate={{ scale: [1, 1.1, 1], rotate: [0, -90, 0] }}
            transition={{ duration: 25, repeat: Infinity, ease: "linear" }}
            className="absolute -bottom-1/2 -left-1/2 h-full w-full rounded-full bg-cyan-500/5 blur-3xl"
          />
        </div>

        {/* --- à°‡à°•à±à°•à°¡ à°ªà°¾à°¤ à°¬à°Ÿà°¨à± à°•à±‹à°¡à± à°‰à°‚à°¡à±‡à°¦à°¿, à°¦à°¾à°¨à±à°¨à°¿ à°¤à±€à°¸à±‡à°¸à°¾à°®à± --- */}

        {/* --- MOBILE OVERLAY (Backdrop) --- */}
        <AnimatePresence>
          {isSidebarOpen && (
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              onClick={() => setSidebarOpen(false)}
              className="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 lg:hidden"
            />
          )}
        </AnimatePresence>

        {/* --- SIDEBAR WRAPPER --- */}
        <div
          className={`fixed inset-y-0 left-0 z-50 w-64 transform transition-transform duration-300 ease-in-out lg:translate-x-0 
          ${isSidebarOpen ? "translate-x-0" : "-translate-x-full"}`}
        >
          <Sidebar isOpen={isSidebarOpen} setSidebarOpen={setSidebarOpen} />
        </div>

        {/* --- MAIN CONTENT AREA --- */}
        <div className="relative z-20 flex-1 flex flex-col min-h-screen transition-all duration-300 lg:ml-64">
          {/* Header Container */}
          <div className="sticky top-0 z-30">
            {/* --- UPDATE: à°‡à°•à±à°•à°¡ à°®à°¨à°‚ props à°ªà°¾à°¸à± à°šà±‡à°¸à±à°¤à±à°¨à±à°¨à°¾à°‚ --- */}
            <Header
              isSidebarOpen={isSidebarOpen}
              setSidebarOpen={setSidebarOpen}
            />
          </div>

          <main className="flex-1 pt-6 lg:pt-8">
            <div className="p-4 md:p-6 lg:p-8">
              <PageTransition>{children}</PageTransition>
            </div>
          </main>
        </div>
      </div>
    </SocketProvider>
  );
}
</file>

<file path="app/dashboard/orders/page.tsx">
"use client";

import { useEffect, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import {
  Search,
  Download,
  Eye,
  Package,
  PackageCheck,
  Truck,
  CheckCircle,
  XCircle,
  RefreshCcw,
  X,
  MapPin,
  Calendar,
  User as UserIcon,
  CreditCard,
  Clock,
} from "lucide-react";
import { TableSkeleton } from "@/components/ui/Skeleton";
import { OrderService, downloadInvoice } from "@/lib/api";
import { toast } from "sonner";

import { formatCurrency, getOrderStatusColor, cn } from "@/lib/utils";
import { useSocket } from "@/components/providers/SocketProvider";
import Image from "next/image";

// --- Custom Toast Component ---
const NewOrderToast = ({
  data,
  onClose,
}: {
  data: any;
  onClose: () => void;
}) => (
  <div className="relative w-full max-w-md overflow-hidden rounded-2xl border border-blue-500/30 bg-[#0a0a0a]/95 p-0 shadow-2xl backdrop-blur-xl">
    {/* Top Gradient Line */}
    <div className="absolute top-0 left-0 h-1 w-full bg-gradient-to-r from-blue-600 via-cyan-400 to-blue-600" />

    <div className="p-5">
      <div className="flex items-start gap-4">
        {/* Animated Icon Container */}
        <div className="flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-blue-500/20 ring-1 ring-blue-500/40">
          <div className="relative">
            <div className="absolute -inset-1 animate-ping rounded-full bg-blue-500 opacity-50" />
            <PackageCheck className="relative h-6 w-6 text-blue-400" />
          </div>
        </div>

        {/* Content */}
        <div className="flex-1">
          <div className="flex items-center justify-between">
            <h4 className="text-lg font-bold text-white">
              New Order Received!
            </h4>
            <span className="text-xs font-medium text-gray-400">
              {new Date().toLocaleTimeString()}
            </span>
          </div>

          <p className="mt-1 text-sm text-gray-300">
            Order{" "}
            <span className="font-mono text-cyan-400">#{data.orderNumber}</span>
          </p>

          <div className="mt-3 flex items-center justify-between rounded-lg bg-white/5 p-3">
            <div>
              <p className="text-xs text-gray-500">Customer</p>
              <p className="text-sm font-medium text-white">
                {data.customerName || "Guest"}
              </p>
            </div>
            <div className="text-right">
              <p className="text-xs text-gray-500">Amount</p>
              <p className="text-lg font-bold text-green-400">
                {formatCurrency(data.totalAmount)}
              </p>
            </div>
          </div>
        </div>
      </div>

      {/* Buttons */}
      <div className="mt-4 flex gap-3">
        <button
          onClick={onClose}
          className="flex-1 rounded-lg bg-white/10 py-2 text-sm font-medium text-gray-300 transition-colors hover:bg-white/20"
        >
          Dismiss
        </button>
        <button
          onClick={() => {
            onClose();
          }}
          className="flex-1 rounded-lg bg-blue-600 py-2 text-sm font-medium text-white transition-colors hover:bg-blue-700 shadow-lg shadow-blue-500/20"
        >
          View Order
        </button>
      </div>
    </div>
  </div>
);

// --- Types ---
interface ShippingAddress {
  street: string;
  city: string;
  state: string;
  pincode: string;
  phone: string;
}

interface OrderItem {
  _id: string;
  name: string;
  quantity: number;
  price: number;
  image?: string;
  product?: {
    images: string[];
  };
}

interface User {
  name: string;
  email: string;
  phone?: string;
}

interface Order {
  _id: string;
  orderNumber: string;
  user: User;
  items: OrderItem[];
  shippingAddress: ShippingAddress;
  totalAmount: number;
  paymentMethod: "COD" | "Razorpay";
  paymentStatus: "Pending" | "Completed" | "Failed" | "Refunded";
  orderStatus: "Placed" | "Packed" | "Shipped" | "Delivered" | "Cancelled";
  createdAt: string;
}

const ORDER_STATUSES = [
  "Placed",
  "Packed",
  "Shipped",
  "Delivered",
  "Cancelled",
];

const STATUS_ICONS: Record<string, any> = {
  Placed: Package,
  Packed: PackageCheck,
  Shipped: Truck,
  Delivered: CheckCircle,
  Cancelled: XCircle,
};

// --- Components ---

// 1. Order Details Modal Component
const OrderDetailsModal = ({
  order,
  onClose,
  onStatusUpdate,
}: {
  order: Order;
  onClose: () => void;
  onStatusUpdate: (id: string, status: string) => void;
}) => {
  if (!order) return null;

  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      exit={{ opacity: 0 }}
      className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4"
      onClick={onClose}
    >
      <motion.div
        initial={{ scale: 0.95, opacity: 0, y: 20 }}
        animate={{ scale: 1, opacity: 1, y: 0 }}
        exit={{ scale: 0.95, opacity: 0, y: 20 }}
        onClick={(e) => e.stopPropagation()}
        className="w-full max-w-2xl overflow-hidden rounded-2xl bg-[#1e1e1e] border border-white/10 shadow-2xl flex flex-col max-h-[90vh]"
      >
        {/* Modal Header: Responsive Padding (p-4 md:p-6) */}
        <div className="flex items-center justify-between border-b border-white/10 p-4 md:p-6">
          <div>
            <h2 className="text-xl font-semibold text-white">Order Details</h2>
            <p className="text-sm text-cyan-400 font-mono mt-1">
              {order.orderNumber}
            </p>
          </div>
          <button
            onClick={onClose}
            className="rounded-full p-2 text-gray-400 hover:bg-white/10 hover:text-white transition-colors"
          >
            <X className="h-5 w-5" />
          </button>
        </div>

        {/* Modal Content: Responsive Padding */}
        <div className="flex-1 overflow-y-auto p-4 md:p-6 space-y-8">
          {/* Customer & Date Info */}
          <div className="flex flex-col md:flex-row justify-between gap-6">
            <div className="flex gap-3">
              <div className="mt-1 rounded-lg bg-blue-500/10 p-2 h-fit">
                <UserIcon className="h-5 w-5 text-blue-400" />
              </div>
              <div>
                <p className="text-sm text-gray-400">Customer</p>
                <p className="font-medium text-white text-lg">
                  {order.user?.name || "Guest User"}
                </p>
                <p className="text-sm text-gray-400">{order.user?.email}</p>
                {order.shippingAddress?.phone && (
                  <p className="text-sm text-gray-400">
                    {order.shippingAddress.phone}
                  </p>
                )}
              </div>
            </div>

            <div className="flex gap-3">
              <div className="mt-1 rounded-lg bg-purple-500/10 p-2 h-fit">
                <Calendar className="h-5 w-5 text-purple-400" />
              </div>
              <div>
                <p className="text-sm text-gray-400">Order Date</p>
                <p className="font-medium text-white">
                  {new Date(order.createdAt).toLocaleDateString("en-US", {
                    day: "numeric",
                    month: "short",
                    year: "numeric",
                  })}
                </p>
                <p className="text-sm text-gray-500">
                  {new Date(order.createdAt).toLocaleTimeString("en-US", {
                    hour: "2-digit",
                    minute: "2-digit",
                  })}
                </p>
              </div>
            </div>
          </div>

          {/* Items List */}
          <div>
            <p className="text-sm font-medium text-gray-400 mb-3">
              Items ({order.items.length})
            </p>
            <div className="space-y-3">
              {order.items.map((item, idx) => (
                <div
                  key={idx}
                  className="flex items-center gap-4 rounded-xl bg-white/5 p-3 border border-white/5"
                >
                  <div className="h-16 w-16 flex-shrink-0 overflow-hidden rounded-lg bg-white/10">
                    {item.image || item.product?.images?.[0] ? (
                      <img
                        src={item.image || item.product?.images?.[0]}
                        alt={item.name}
                        className="h-full w-full object-cover"
                      />
                    ) : (
                      <div className="flex h-full w-full items-center justify-center">
                        <Package className="h-6 w-6 text-gray-500" />
                      </div>
                    )}
                  </div>
                  <div className="flex-1">
                    <p className="font-medium text-white line-clamp-1">
                      {item.name}
                    </p>
                    <p className="text-sm text-gray-400">
                      Qty: {item.quantity}
                    </p>
                  </div>
                  <div className="text-right">
                    <p className="font-medium text-white">
                      {formatCurrency(item.price * item.quantity)}
                    </p>
                    {item.quantity > 1 && (
                      <p className="text-xs text-gray-500">
                        {formatCurrency(item.price)} each
                      </p>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Address & Payment Info */}
          <div className="grid md:grid-cols-2 gap-6">
            <div className="space-y-2">
              <div className="flex items-center gap-2 text-gray-400">
                <MapPin className="h-4 w-4" />
                <span className="text-sm font-medium">Shipping Address</span>
              </div>
              <div className="rounded-xl bg-white/5 p-4 text-sm text-gray-300 border border-white/5 leading-relaxed">
                <p>{order.shippingAddress?.street}</p>
                <p>
                  {order.shippingAddress?.city}, {order.shippingAddress?.state}
                </p>
                <p>PIN: {order.shippingAddress?.pincode}</p>
              </div>
            </div>

            <div className="space-y-2">
              <div className="flex items-center gap-2 text-gray-400">
                <CreditCard className="h-4 w-4" />
                <span className="text-sm font-medium">Payment Details</span>
              </div>
              <div className="rounded-xl bg-white/5 p-4 border border-white/5 space-y-3">
                <div className="flex justify-between items-center">
                  <span className="text-sm text-gray-400">Method</span>
                  <span
                    className={cn(
                      "text-xs font-medium px-2 py-0.5 rounded-full",
                      order.paymentMethod === "COD"
                        ? "bg-yellow-500/10 text-yellow-400"
                        : "bg-blue-500/10 text-blue-400",
                    )}
                  >
                    {order.paymentMethod}
                  </span>
                </div>
                <div className="flex justify-between items-center">
                  <span className="text-sm text-gray-400">Status</span>
                  <span
                    className={cn(
                      "text-xs font-medium px-2 py-0.5 rounded-full",
                      order.paymentStatus === "Completed"
                        ? "bg-green-500/10 text-green-400"
                        : "bg-gray-500/10 text-gray-400",
                    )}
                  >
                    {order.paymentStatus}
                  </span>
                </div>
              </div>
            </div>
          </div>

          {/* Total Amount */}
          <div className="flex justify-end items-center pt-4 border-t border-white/10">
            <div className="text-right">
              <p className="text-sm text-gray-400">Total Amount</p>
              <p className="text-3xl font-bold text-white mt-1">
                {formatCurrency(order.totalAmount)}
              </p>
            </div>
          </div>

          {/* Update Status Section */}
          <div className="space-y-2 pt-2">
            <label className="text-sm font-medium text-gray-400">
              Update Order Status
            </label>
            <div className="relative">
              <select
                value={order.orderStatus}
                onChange={(e) => onStatusUpdate(order._id, e.target.value)}
                className="w-full appearance-none rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white transition-all hover:bg-white/10 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
              >
                {ORDER_STATUSES.map((status) => (
                  <option
                    key={status}
                    value={status}
                    className="bg-[#1e1e1e] text-white"
                  >
                    {status}
                  </option>
                ))}
              </select>
              <div className="pointer-events-none absolute right-4 top-1/2 -translate-y-1/2 text-gray-400">
                <RefreshCcw className="h-4 w-4" />
              </div>
            </div>
          </div>
        </div>
      </motion.div>
    </motion.div>
  );
};

// --- Main Page Component ---
export default function OrdersPage() {
  const [orders, setOrders] = useState<Order[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState("");
  const [selectedStatus, setSelectedStatus] = useState("All");
  const [selectedOrder, setSelectedOrder] = useState<Order | null>(null);

  const { socket, isConnected } = useSocket();

  const fetchOrders = async () => {
    try {
      setIsLoading(true);
      const response = await OrderService.getAllOrders({ limit: 100, page: 1 });
      const incomingData =
        response.data.data?.orders || response.data.data || response.data || [];
      if (Array.isArray(incomingData)) setOrders(incomingData);
    } catch (error) {
      console.error(error);
      toast.error("Failed to fetch orders");
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    fetchOrders();
  }, []);

  // --- SOCKET LISTENER (Updated) ---
  useEffect(() => {
    if (socket && isConnected) {
      // 1. New Order Received
      socket.on("new_order", (data: any) => {
        // --- Try Playing Sound ---
        const audio = new Audio("/sounds/notification.mp3");
        audio.play().catch((err) => {
          console.warn("Audio blocked by browser:", err);
          toast.error("ðŸ”Š Click explicitly on page to enable sound!");
        });

        // --- Show Beautiful Toast ---
        toast.custom(
          (t) => <NewOrderToast data={data} onClose={() => toast.dismiss(t)} />,
          {
            duration: 5000,
            position: "top-right",
          },
        );

        // --- Refresh Data ---
        fetchOrders();
      });

      // 2. Order Status Updated
      socket.on("order_status_updated", (data: any) => {
        setOrders((prev) =>
          prev.map((order) =>
            order._id === data.orderId
              ? { ...order, orderStatus: data.orderStatus }
              : order,
          ),
        );

        if (selectedOrder && selectedOrder._id === data.orderId) {
          setSelectedOrder((prev) =>
            prev ? { ...prev, orderStatus: data.orderStatus } : null,
          );
        }

        if (data.type === "new_order") fetchOrders();
        toast.info(`Order status updated to ${data.orderStatus}`);
      });

      return () => {
        socket.off("new_order");
        socket.off("order_status_updated");
      };
    }
  }, [socket, isConnected, selectedOrder]);

  const handleStatusUpdate = async (orderId: string, newStatus: string) => {
    setOrders((prev) =>
      prev.map((o) =>
        o._id === orderId ? { ...o, orderStatus: newStatus as any } : o,
      ),
    );
    if (selectedOrder && selectedOrder._id === orderId) {
      setSelectedOrder({ ...selectedOrder, orderStatus: newStatus as any });
    }
    try {
      await OrderService.updateStatus(orderId, {
        orderStatus: newStatus as any,
      });
      toast.success(`Status updated to ${newStatus}`);
    } catch (error) {
      toast.error("Failed to update status");
      fetchOrders();
    }
  };

  // âœ… 2. Component Handler (Only UI Logic)
  const handleDownloadInvoice = async (order: Order) => {
    try {
      toast.loading("Downloading invoice...");

      // à°œà°¸à±à°Ÿà± à°ˆ à°«à°‚à°•à±à°·à°¨à± à°•à°¾à°²à± à°šà±‡à°¸à±à°¤à±‡ à°šà°¾à°²à±, à°®à°¿à°—à°¤à°¾ à°ªà°¨à°¿ à°…à°¦à±‡ à°šà±‚à°¸à±à°•à±à°‚à°Ÿà±à°‚à°¦à°¿
      await downloadInvoice(order._id, order.orderNumber);

      toast.dismiss();
      toast.success("Invoice downloaded successfully");
    } catch (error) {
      console.error("Handler Error:", error);
      toast.dismiss();
      toast.error("Failed to download invoice");
    }
  };

  const filteredOrders = orders.filter((order) => {
    const query = searchQuery.toLowerCase();
    const matchesSearch =
      (order.orderNumber || "").toLowerCase().includes(query) ||
      (order.user?.name || "").toLowerCase().includes(query) ||
      (order.user?.email || "").toLowerCase().includes(query);
    const matchesStatus =
      selectedStatus === "All" || order.orderStatus === selectedStatus;
    return matchesSearch && matchesStatus;
  });

  if (isLoading && orders.length === 0)
    return (
      <div className="space-y-6">
        <h1 className="text-3xl font-bold text-white">Orders</h1>
        <TableSkeleton />
      </div>
    );

  return (
    <div className="space-y-6 relative px-2 md:px-0">
      {" "}
      {/* Added px-2 for mobile edge spacing */}
      <AnimatePresence>
        {selectedOrder && (
          <OrderDetailsModal
            order={selectedOrder}
            onClose={() => setSelectedOrder(null)}
            onStatusUpdate={handleStatusUpdate}
          />
        )}
      </AnimatePresence>
      {/* Header Section */}
      <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
          <h1 className="text-3xl font-bold text-white">Orders Dashboard</h1>
          <p className="mt-1 text-gray-400">Manage orders and view details</p>
        </div>

        <div className="flex items-center gap-3">
          <div
            className={cn(
              "flex items-center gap-2 rounded-lg border border-white/5 px-3 py-1.5 text-sm font-medium transition-colors",
              isConnected
                ? "bg-green-500/10 text-green-400"
                : "bg-red-500/10 text-red-400",
            )}
          >
            <div
              className={cn(
                "h-2 w-2 rounded-full animate-pulse",
                isConnected ? "bg-green-400" : "bg-red-400",
              )}
            />
            {isConnected ? "Live" : "Offline"}
          </div>

          <button
            onClick={fetchOrders}
            className="flex items-center gap-2 rounded-lg border border-white/5 bg-white/5 px-3 py-2 text-sm font-medium text-white transition-colors hover:bg-white/10"
          >
            <RefreshCcw className="h-4 w-4" />
            <span>Refresh</span>
          </button>
        </div>
      </div>
      {/* Filters Section */}
      <div className="flex flex-col sm:flex-row items-center gap-4">
        <div className="relative w-full sm:flex-1">
          <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400" />
          <input
            type="text"
            placeholder="Search Order ID, Name..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            className="w-full rounded-xl border border-white/10 bg-white/5 py-2.5 pl-10 pr-4 text-sm text-white focus:outline-none focus:ring-2 focus:ring-blue-500/20"
          />
        </div>
        <div className="flex w-full sm:w-auto items-center gap-2 overflow-x-auto rounded-xl border border-white/10 bg-white/5 p-1 scrollbar-hide">
          {["All", ...ORDER_STATUSES].map((status) => (
            <button
              key={status}
              onClick={() => setSelectedStatus(status)}
              className={cn(
                "whitespace-nowrap rounded-lg px-4 py-2 text-sm font-medium transition-all",
                selectedStatus === status
                  ? "bg-blue-500 text-white"
                  : "text-gray-400 hover:text-white",
              )}
            >
              {status}
            </button>
          ))}
        </div>
      </div>
      {/* Stats Cards Section - Responsive Grid */}
      <div className="grid grid-cols-2 gap-4 md:grid-cols-3 lg:grid-cols-5">
        {ORDER_STATUSES.map((status) => {
          const count = orders.filter((o) => o.orderStatus === status).length;
          const Icon = STATUS_ICONS[status] || Package;
          const isCancelled = status === "Cancelled";

          return (
            <motion.div
              key={status}
              initial={{ opacity: 0, y: 10 }}
              animate={{ opacity: 1, y: 0 }}
              className="rounded-xl border border-white/10 bg-white/5 backdrop-blur-sm p-4 transition-colors hover:bg-white/10"
            >
              <div className="flex items-center gap-3 mb-2">
                <div
                  className={cn(
                    "p-2 rounded-lg",
                    isCancelled
                      ? "bg-red-500/10 text-red-400"
                      : "bg-blue-500/10 text-blue-400",
                  )}
                >
                  <Icon className="h-5 w-5" />
                </div>
                <span className="text-sm font-medium text-gray-400">
                  {status}
                </span>
              </div>
              <p className="text-2xl font-bold text-white pl-1">{count}</p>
            </motion.div>
          );
        })}
      </div>
      {/* Table Section */}
      <div className="overflow-hidden rounded-2xl border border-white/10 bg-white/[0.02]">
        <div className="overflow-x-auto">
          {/* Added whitespace-nowrap to prevent row breaking on mobile */}
          <table className="w-full whitespace-nowrap">
            <thead>
              <tr className="border-b border-white/10 bg-white/5">
                {/* Responsive Padding: px-4 on mobile, px-6 on desktop */}
                <th className="px-4 md:px-6 py-4 text-left text-xs font-semibold uppercase text-gray-400">
                  Order
                </th>
                <th className="px-4 md:px-6 py-4 text-left text-xs font-semibold uppercase text-gray-400">
                  Date
                </th>
                <th className="px-4 md:px-6 py-4 text-left text-xs font-semibold uppercase text-gray-400">
                  Customer
                </th>
                <th className="px-4 md:px-6 py-4 text-left text-xs font-semibold uppercase text-gray-400">
                  Payment
                </th>
                <th className="px-4 md:px-6 py-4 text-left text-xs font-semibold uppercase text-gray-400">
                  Amount
                </th>
                <th className="px-4 md:px-6 py-4 text-left text-xs font-semibold uppercase text-gray-400">
                  Status
                </th>
                <th className="px-4 md:px-6 py-4 text-left text-xs font-semibold uppercase text-gray-400">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody className="divide-y divide-white/5">
              {filteredOrders.length === 0 ? (
                <tr>
                  <td
                    colSpan={7}
                    className="px-4 md:px-6 py-12 text-center text-gray-500"
                  >
                    No orders found
                  </td>
                </tr>
              ) : (
                filteredOrders.map((order) => {
                  const firstItem = order.items?.[0];
                  const itemImage =
                    firstItem?.image || firstItem?.product?.images?.[0];
                  const totalItems =
                    order.items?.reduce(
                      (acc, item) => acc + item.quantity,
                      0,
                    ) || 0;

                  return (
                    <motion.tr
                      key={order._id}
                      whileHover={{
                        backgroundColor: "rgba(255, 255, 255, 0.02)",
                      }}
                      className="group"
                    >
                      {/* 1. Order ID + Image + Item Count */}
                      <td className="px-4 md:px-6 py-4">
                        <div className="flex items-center gap-3">
                          <div className="relative h-12 w-12 overflow-hidden rounded-lg bg-white/5 border border-white/10 flex-shrink-0">
                            {itemImage ? (
                              <Image
                                src={itemImage}
                                alt="Item"
                                fill
                                className="object-cover transition-transform group-hover:scale-110"
                              />
                            ) : (
                              <div className="flex h-full w-full items-center justify-center text-gray-500">
                                <Package className="h-5 w-5" />
                              </div>
                            )}
                          </div>
                          <div>
                            <code className="rounded bg-white/5 px-2 py-1 text-xs font-mono text-cyan-400">
                              {order.orderNumber}
                            </code>
                            <div className="mt-1">
                              <span className="inline-flex items-center rounded-full border border-white/10 bg-white/5 px-2 py-0.5 text-[10px] font-medium text-gray-300">
                                {totalItems} Item{totalItems !== 1 ? "s" : ""}
                              </span>
                            </div>
                          </div>
                        </div>
                      </td>

                      {/* 2. Order Date Column */}
                      <td className="px-4 md:px-6 py-4">
                        <div className="flex flex-col">
                          <span className="text-sm text-white font-medium">
                            {new Date(order.createdAt).toLocaleDateString()}
                          </span>
                          <span className="text-xs text-gray-500 flex items-center gap-1">
                            <Clock className="h-3 w-3" />
                            {new Date(order.createdAt).toLocaleTimeString([], {
                              hour: "2-digit",
                              minute: "2-digit",
                            })}
                          </span>
                        </div>
                      </td>

                      {/* 3. Customer */}
                      <td className="px-4 md:px-6 py-4">
                        <p className="font-medium text-white">
                          {order.user?.name || "Guest"}
                        </p>
                        <p className="text-xs text-gray-400">
                          {order.user?.email}
                        </p>
                      </td>

                      {/* 4. Payment Column */}
                      <td className="px-4 md:px-6 py-4">
                        <div className="flex flex-col gap-1.5">
                          <span
                            className={cn(
                              "inline-flex w-fit items-center rounded-full px-2 py-0.5 text-[10px] font-medium border",
                              order.paymentMethod === "COD"
                                ? "bg-yellow-500/10 text-yellow-400 border-yellow-500/20"
                                : "bg-blue-500/10 text-blue-400 border-blue-500/20",
                            )}
                          >
                            {order.paymentMethod}
                          </span>
                          <span
                            className={cn(
                              "text-xs font-medium",
                              order.paymentStatus === "Completed"
                                ? "text-green-400"
                                : order.paymentStatus === "Failed"
                                  ? "text-red-400"
                                  : "text-gray-400",
                            )}
                          >
                            {order.paymentStatus}
                          </span>
                        </div>
                      </td>

                      {/* 5. Amount */}
                      <td className="px-4 md:px-6 py-4 font-semibold text-white">
                        {formatCurrency(order.totalAmount)}
                      </td>

                      {/* 6. Status */}
                      <td className="px-4 md:px-6 py-4">
                        <span
                          className={cn(
                            "inline-flex rounded-full px-2 py-1 text-xs font-medium",
                            getOrderStatusColor(order.orderStatus),
                          )}
                        >
                          {order.orderStatus}
                        </span>
                      </td>

                      {/* 7. Actions */}
                      <td className="px-4 md:px-6 py-4">
                        <div className="flex items-center gap-2">
                          <button
                            onClick={() => setSelectedOrder(order)}
                            className="rounded-lg bg-blue-500/10 p-2 text-blue-400 transition-colors hover:bg-blue-500/20"
                            title="View Details"
                          >
                            <Eye className="h-4 w-4" />
                          </button>
                          <button
                            onClick={() => handleDownloadInvoice(order)}
                            className="rounded-lg bg-green-500/10 p-2 text-green-400 transition-colors hover:bg-green-500/20"
                            title="Download Invoice"
                          >
                            <Download className="h-4 w-4" />
                          </button>
                        </div>
                      </td>
                    </motion.tr>
                  );
                })
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/dashboard/products/[id]/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { useParams, useRouter } from 'next/navigation'; // For ID and Navigation
import { motion } from 'framer-motion';
import Link from 'next/link';
import Image from 'next/image';
import {
  ArrowLeft,
  Edit,
  Package,
  CheckCircle2,
  AlertTriangle,
  XCircle,
  Car,
  Tag,
  Layers,
  Calendar,
  Copy,
  Scale,
  Ruler
} from 'lucide-react';
import Button from '@/components/ui/Button';
import { ProductService } from '@/lib/api';
import { Product } from '@/types';
import { formatCurrency, cn } from '@/lib/utils';
import { toast } from 'sonner';

export default function ViewProductPage() {
  const { id } = useParams(); // URL à°¨à±à°‚à°¡à°¿ ID à°¤à±€à°¸à±à°•à±‹à°µà°¡à°¾à°¨à°¿à°•à°¿
  const router = useRouter();
  
  const [product, setProduct] = useState<Product | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [selectedImageIndex, setSelectedImageIndex] = useState(0);

  useEffect(() => {
    if (id) {
      fetchProductDetails();
    }
  }, [id]);

  const fetchProductDetails = async () => {
    try {
      setIsLoading(true);
      const response = await ProductService.getById(id as string);
      const data = response.data.data.product || response.data;
      
      setProduct(data);
    } catch (error: any) {
      console.error('Fetch error:', error);
      toast.error('Failed to load product details');
      router.push('/dashboard/products'); // Error à°µà°¸à±à°¤à±‡ à°µà±†à°¨à°•à±à°•à°¿ à°ªà°‚à°ªà°¿à°‚à°šà±
    } finally {
      setIsLoading(false);
    }
  };

  const copyPartNumber = () => {
    if (product?.partNumber) {
      navigator.clipboard.writeText(product.partNumber);
      toast.success('Part number copied!');
    }
  };

  // --- Loading Skeleton ---
  if (isLoading || !product) {
    return (
      <div className="flex h-[80vh] items-center justify-center">
        <div className="flex flex-col items-center gap-4">
          <div className="h-10 w-10 animate-spin rounded-full border-4 border-blue-500 border-t-transparent"></div>
          <p className="text-gray-400">Loading product details...</p>
        </div>
      </div>
    );
  }

  // --- Helpers ---
  const stockColor = 
    product.stock > (product.lowStockThreshold || 5) ? 'text-green-400 bg-green-500/10 border-green-500/20' :
    product.stock > 0 ? 'text-yellow-400 bg-yellow-500/10 border-yellow-500/20' :
    'text-red-400 bg-red-500/10 border-red-500/20';

  const StockIcon = 
    product.stock > (product.lowStockThreshold || 5) ? CheckCircle2 :
    product.stock > 0 ? AlertTriangle : XCircle;

  return (
    <div className="space-y-8 pb-20">
      
      {/* 1. Header Navigation */}
      <motion.div
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        className="flex items-center justify-between"
      >
        <div className="flex items-center gap-4">
          <Link href="/dashboard/products">
            <button className="rounded-xl bg-white/5 p-2 transition-colors hover:bg-white/10">
              <ArrowLeft className="h-5 w-5 text-white" />
            </button>
          </Link>
          <div>
            <h1 className="text-sm font-medium text-gray-400">Product Details</h1>
            <p className="text-xl font-bold text-white">{product.name}</p>
          </div>
        </div>

        <Link href={`/dashboard/products/edit/${product._id}`}>
          <Button variant="primary" className="flex items-center gap-2">
            <Edit className="h-4 w-4" /> Edit Product
          </Button>
        </Link>
      </motion.div>

      <div className="grid gap-8 lg:grid-cols-12">
        
        {/* 2. Left Column: Image Gallery */}
        <motion.div 
          initial={{ opacity: 0, x: -20 }}
          animate={{ opacity: 1, x: 0 }}
          transition={{ delay: 0.1 }}
          className="lg:col-span-5 space-y-4"
        >
          {/* Main Image */}
          <div className="relative aspect-square w-full overflow-hidden rounded-2xl border border-white/10 bg-white/[0.02]">
            {product.images && product.images.length > 0 ? (
              <Image
                src={product.images[selectedImageIndex].url}
                alt={product.name}
                fill
                className="object-cover"
                priority
              />
            ) : (
              <div className="flex h-full w-full flex-col items-center justify-center text-gray-500">
                <Package className="h-16 w-16 mb-2 opacity-50" />
                <span>No Image Available</span>
              </div>
            )}
            
            {/* Status Badge on Image */}
            <div className={`absolute top-4 left-4 flex items-center gap-1.5 rounded-full border px-3 py-1 text-xs font-semibold backdrop-blur-md ${stockColor}`}>
              <StockIcon className="h-3.5 w-3.5" />
              {product.stockStatus || (product.stock > 0 ? 'In Stock' : 'Out of Stock')}
            </div>
          </div>

          {/* Thumbnails */}
          {product.images && product.images.length > 1 && (
            <div className="flex gap-3 overflow-x-auto pb-2 scrollbar-hide">
              {product.images.map((img, idx) => (
                <button
                  key={idx}
                  onClick={() => setSelectedImageIndex(idx)}
                  className={cn(
                    "relative h-20 w-20 flex-shrink-0 overflow-hidden rounded-lg border transition-all",
                    selectedImageIndex === idx 
                      ? "border-blue-500 ring-2 ring-blue-500/20" 
                      : "border-white/10 hover:border-white/30 opacity-60 hover:opacity-100"
                  )}
                >
                  <Image src={img.url} alt="thumbnail" fill className="object-cover" />
                </button>
              ))}
            </div>
          )}
        </motion.div>

        {/* 3. Right Column: Product Info */}
        <motion.div 
          initial={{ opacity: 0, x: 20 }}
          animate={{ opacity: 1, x: 0 }}
          transition={{ delay: 0.2 }}
          className="lg:col-span-7 space-y-6"
        >
          {/* Key Details Card */}
          <div className="rounded-2xl border border-white/10 bg-white/[0.02] p-6 backdrop-blur-sm">
            <div className="flex flex-wrap items-start justify-between gap-4">
              <div>
                <div 
                  className="group flex cursor-pointer items-center gap-2 rounded-lg bg-white/5 px-3 py-1.5 text-sm font-mono text-cyan-400 transition-colors hover:bg-white/10"
                  onClick={copyPartNumber}
                  title="Click to copy"
                >
                  <span>{product.partNumber}</span>
                  <Copy className="h-3 w-3 opacity-50 group-hover:opacity-100" />
                </div>
                <h2 className="mt-3 text-3xl font-bold text-white">{product.name}</h2>
                <div className="mt-2 flex items-center gap-2 text-sm text-gray-400">
                  <span className="flex items-center gap-1">
                    <Layers className="h-4 w-4" /> {product.category}
                  </span>
                  {product.subcategory && (
                    <>
                      <span>â€¢</span>
                      <span>{product.subcategory}</span>
                    </>
                  )}
                </div>
              </div>

              <div className="text-right">
                <p className="text-3xl font-bold text-white">
                  {formatCurrency(product.finalPrice || product.price)}
                </p>
                {product.discountPrice && product.discountPrice < product.price && (
                  <p className="text-sm text-gray-400 line-through">
                    {formatCurrency(product.price)}
                  </p>
                )}
                <p className="mt-1 text-xs text-gray-500">Excl. taxes</p>
              </div>
            </div>

            <div className="mt-6 h-px w-full bg-white/10" />

            <div className="mt-6 grid grid-cols-2 gap-6 sm:grid-cols-4">
              <div>
                <p className="text-xs text-gray-500">Stock Available</p>
                <p className="mt-1 text-lg font-semibold text-white">{product.stock} units</p>
              </div>
              <div>
                <p className="text-xs text-gray-500">Manufacturer</p>
                <p className="mt-1 text-lg font-semibold text-white">{product.manufacturer || 'N/A'}</p>
              </div>
              <div>
                <p className="text-xs text-gray-500">Warranty</p>
                <p className="mt-1 text-lg font-semibold text-white">{product.warrantyPeriod || 'No'}</p>
              </div>
              <div>
                <p className="text-xs text-gray-500">Total Sales</p>
                <p className="mt-1 text-lg font-semibold text-white">{product.totalSales || 0}</p>
              </div>
            </div>
          </div>

          {/* Description */}
          <div className="rounded-2xl border border-white/10 bg-white/[0.02] p-6 backdrop-blur-sm">
            <h3 className="mb-3 text-lg font-semibold text-white">Description</h3>
            <p className="text-gray-300 leading-relaxed whitespace-pre-wrap">
              {product.description}
            </p>
            
            {/* Tags */}
            {product.tags && product.tags.length > 0 && (
              <div className="mt-6 flex flex-wrap gap-2">
                {product.tags.map((tag, i) => (
                  <span key={i} className="flex items-center gap-1 rounded-full border border-white/10 bg-white/5 px-3 py-1 text-xs text-gray-300">
                    <Tag className="h-3 w-3" /> {tag}
                  </span>
                ))}
              </div>
            )}
          </div>

          {/* Compatible Models */}
          <div className="rounded-2xl border border-white/10 bg-white/[0.02] p-6 backdrop-blur-sm">
            <h3 className="mb-4 flex items-center gap-2 text-lg font-semibold text-white">
              <Car className="h-5 w-5 text-blue-400" /> Compatible Models
            </h3>
            
            {product.compatibleModels && product.compatibleModels.length > 0 ? (
              <div className="grid gap-3 sm:grid-cols-2">
                {product.compatibleModels.map((model, idx) => (
                  <div key={idx} className="flex items-center justify-between rounded-xl bg-white/5 p-3 border border-white/5 hover:border-white/10 transition-colors">
                    <div>
                      <p className="font-semibold text-white">{model.modelName}</p>
                      <p className="text-xs text-gray-400">{model.variant || 'All Variants'}</p>
                    </div>
                    <div className="flex items-center gap-1.5 rounded bg-black/30 px-2 py-1 text-xs text-gray-300">
                      <Calendar className="h-3 w-3" />
                      {model.yearFrom} - {model.yearTo || 'Present'}
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <p className="text-gray-500 italic">No specific models listed.</p>
            )}
          </div>

          {/* Specifications & Dimensions */}
          <div className="grid gap-6 sm:grid-cols-2">
            {/* Specifications Map */}
            {product.specifications && Object.keys(product.specifications).length > 0 && (
              <div className="rounded-2xl border border-white/10 bg-white/[0.02] p-6 backdrop-blur-sm">
                <h3 className="mb-4 text-lg font-semibold text-white">Specifications</h3>
                <div className="space-y-3">
                  {Object.entries(product.specifications).map(([key, value], idx) => (
                    <div key={idx} className="flex justify-between border-b border-white/5 pb-2 last:border-0 last:pb-0">
                      <span className="text-sm text-gray-400">{key}</span>
                      <span className="text-sm font-medium text-white">{value}</span>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Physical Details */}
            <div className="rounded-2xl border border-white/10 bg-white/[0.02] p-6 backdrop-blur-sm h-fit">
              <h3 className="mb-4 text-lg font-semibold text-white">Physical Details</h3>
              <div className="space-y-4">
                <div className="flex items-center gap-3">
                  <div className="rounded-lg bg-purple-500/10 p-2 text-purple-400">
                    <Scale className="h-5 w-5" />
                  </div>
                  <div>
                    <p className="text-xs text-gray-400">Weight</p>
                    <p className="text-sm font-medium text-white">
                      {product.weight ? `${product.weight} kg` : 'N/A'}
                    </p>
                  </div>
                </div>
                
                <div className="flex items-center gap-3">
                  <div className="rounded-lg bg-orange-500/10 p-2 text-orange-400">
                    <Ruler className="h-5 w-5" />
                  </div>
                  <div>
                    <p className="text-xs text-gray-400">Dimensions (L x W x H)</p>
                    <p className="text-sm font-medium text-white">
                      {product.dimensions && (product.dimensions.length || product.dimensions.width) 
                        ? `${product.dimensions.length || '-'} x ${product.dimensions.width || '-'} x ${product.dimensions.height || '-'} ${product.dimensions.unit || 'cm'}`
                        : 'N/A'}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </motion.div>
      </div>
    </div>
  );
}
</file>

<file path="app/dashboard/products/add/page.tsx">
// 'use client';

// import { useState } from 'react';
// import { useRouter } from 'next/navigation';
// import { motion } from 'framer-motion';
// import { ArrowLeft, Upload, X, Plus, Minus } from 'lucide-react';
// import Button from '@/components/ui/Button';
// import { ProductService } from '@/lib/api';
// import { toast } from 'sonner';
// import { ProductCategory, ProductFormData, CompatibleModel } from '@/types';
// import Link from 'next/link';

// const CATEGORIES: ProductCategory[] = [
//   'Engine',
//   'Brake',
//   'Electrical',
//   'Body',
//   'Accessories',
//   'Suspension',
//   'Transmission',
//   'Interior',
//   'Exterior',
//   'Service Parts',
// ];

// const HYUNDAI_MODELS = [
//   'i10', 'i20', 'Venue', 'Verna', 'Creta', 'Alcazar', 'Tucson',
//   'Elantra', 'Kona', 'Ioniq 5', 'Santro', 'Grand i10', 'Aura'
// ];

// export default function AddProductPage() {
//   const router = useRouter();
//   const [isLoading, setIsLoading] = useState(false);
//   const [images, setImages] = useState<File[]>([]);
//   const [imagePreviews, setImagePreviews] = useState<string[]>([]);

//   const [formData, setFormData] = useState<ProductFormData>({
//     name: '',
//     partNumber: '',
//     description: '',
//     category: 'Engine',
//     subcategory: '',
//     price: 0,
//     stock: 0,
//     lowStockThreshold: 10,
//     warrantyPeriod: '1 Year',
//     manufacturer: 'Hyundai Mobis',
//     compatibleModels: [],
//     tags: [],
//   });

//   const [currentModel, setCurrentModel] = useState<CompatibleModel>({
//     modelName: '',
//     yearFrom: new Date().getFullYear(),
//     yearTo: undefined,
//     variant: '',
//   });

//   const handleImageChange = (e: React.ChangeEvent<HTMLInputElement>) => {
//     const files = Array.from(e.target.files || []);
//     if (files.length + images.length > 5) {
//       toast.error('Maximum 5 images allowed');
//       return;
//     }

//     setImages([...images, ...files]);

//     // Create previews
//     files.forEach(file => {
//       const reader = new FileReader();
//       reader.onloadend = () => {
//         setImagePreviews(prev => [...prev, reader.result as string]);
//       };
//       reader.readAsDataURL(file);
//     });
//   };

//   const removeImage = (index: number) => {
//     setImages(images.filter((_, i) => i !== index));
//     setImagePreviews(imagePreviews.filter((_, i) => i !== index));
//   };

//   const addCompatibleModel = () => {
//     if (!currentModel.modelName) {
//       toast.error('Please select a model');
//       return;
//     }

//     setFormData({
//       ...formData,
//       compatibleModels: [...formData.compatibleModels, currentModel],
//     });

//     setCurrentModel({
//       modelName: '',
//       yearFrom: new Date().getFullYear(),
//       yearTo: undefined,
//       variant: '',
//     });
//   };

//   const removeCompatibleModel = (index: number) => {
//     setFormData({
//       ...formData,
//       compatibleModels: formData.compatibleModels.filter((_, i) => i !== index),
//     });
//   };

//   const handleSubmit = async (e: React.FormEvent) => {
//     e.preventDefault();

//     if (images.length === 0) {
//       toast.error('Please upload at least one image');
//       return;
//     }

//     if (formData.compatibleModels.length === 0) {
//       toast.error('Please add at least one compatible model');
//       return;
//     }

//     setIsLoading(true);

//     try {
//       // Create FormData for multipart/form-data
//       const data = new FormData();

//       // Append all form fields
//       data.append('name', formData.name);
//       data.append('partNumber', formData.partNumber);
//       data.append('description', formData.description);
//       data.append('category', formData.category);
//       if (formData.subcategory) data.append('subcategory', formData.subcategory);
//       data.append('price', formData.price.toString());
//       if (formData.discountPrice) data.append('discountPrice', formData.discountPrice.toString());
//       data.append('stock', formData.stock.toString());
//       data.append('lowStockThreshold', (formData.lowStockThreshold || 10).toString());
//       data.append('warrantyPeriod', formData.warrantyPeriod || '1 Year');
//       data.append('manufacturer', formData.manufacturer || 'Hyundai Mobis');

//       // Append compatible models as JSON string
//       data.append('compatibleModels', JSON.stringify(formData.compatibleModels));

//       // Append tags if any
//       if (formData.tags && formData.tags.length > 0) {
//         data.append('tags', JSON.stringify(formData.tags));
//       }

//       // Append images
//       images.forEach((image) => {
//         data.append('images', image);
//       });

//       await ProductService.create(data);

//       toast.success('Product created successfully!');
//       router.push('/dashboard/products');
//     } catch (error: any) {
//       console.error('Create product error:', error);
//       toast.error(error.response?.data?.message || 'Failed to create product');
//     } finally {
//       setIsLoading(false);
//     }
//   };

//   return (
//     <div className="space-y-6">
//       {/* Header */}
//       <motion.div
//         initial={{ opacity: 0, y: -20 }}
//         animate={{ opacity: 1, y: 0 }}
//         className="flex items-center gap-4"
//       >
//         <Link href="/dashboard/products">
//           <motion.button
//             whileHover={{ scale: 1.05 }}
//             whileTap={{ scale: 0.95 }}
//             className="rounded-xl bg-white/5 p-2 backdrop-blur-sm transition-colors hover:bg-white/10"
//           >
//             <ArrowLeft className="h-5 w-5 text-white" />
//           </motion.button>
//         </Link>
//         <div>
//           <h1 className="text-3xl font-bold text-white">Add New Product</h1>
//           <p className="mt-1 text-gray-400">Create a new spare part listing</p>
//         </div>
//       </motion.div>

//       {/* Form */}
//       <motion.form
//         initial={{ opacity: 0, y: 20 }}
//         animate={{ opacity: 1, y: 0 }}
//         transition={{ delay: 0.1 }}
//         onSubmit={handleSubmit}
//         className="rounded-2xl border border-white/10 bg-white/[0.02] p-8 backdrop-blur-sm"
//       >
//         <div className="space-y-8">
//           {/* Basic Information */}
//           <div>
//             <h2 className="mb-4 text-xl font-semibold text-white">Basic Information</h2>
//             <div className="grid gap-6 md:grid-cols-2">
//               <div>
//                 <label className="mb-2 block text-sm font-medium text-gray-300">
//                   Product Name *
//                 </label>
//                 <input
//                   type="text"
//                   required
//                   value={formData.name}
//                   onChange={(e) => setFormData({ ...formData, name: e.target.value })}
//                   className="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white placeholder-gray-400 backdrop-blur-sm transition-all focus:border-blue-500/50 focus:bg-white/10 focus:outline-none"
//                   placeholder="e.g., Front Brake Pad Set"
//                 />
//               </div>

//               <div>
//                 <label className="mb-2 block text-sm font-medium text-gray-300">
//                   Part Number *
//                 </label>
//                 <input
//                   type="text"
//                   required
//                   value={formData.partNumber}
//                   onChange={(e) => setFormData({ ...formData, partNumber: e.target.value.toUpperCase() })}
//                   className="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white placeholder-gray-400 backdrop-blur-sm transition-all focus:border-blue-500/50 focus:bg-white/10 focus:outline-none"
//                   placeholder="e.g., 58101-C9A70"
//                 />
//               </div>

//               <div className="md:col-span-2">
//                 <label className="mb-2 block text-sm font-medium text-gray-300">
//                   Description *
//                 </label>
//                 <textarea
//                   required
//                   rows={4}
//                   value={formData.description}
//                   onChange={(e) => setFormData({ ...formData, description: e.target.value })}
//                   className="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white placeholder-gray-400 backdrop-blur-sm transition-all focus:border-blue-500/50 focus:bg-white/10 focus:outline-none"
//                   placeholder="Detailed product description..."
//                 />
//               </div>

//               <div>
//                 <label className="mb-2 block text-sm font-medium text-gray-300">
//                   Category *
//                 </label>
//                 <select
//                   required
//                   value={formData.category}
//                   onChange={(e) => setFormData({ ...formData, category: e.target.value as ProductCategory })}
//                   className="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white backdrop-blur-sm transition-all focus:border-blue-500/50 focus:bg-white/10 focus:outline-none"
//                 >
//                   {CATEGORIES.map((cat) => (
//                     <option key={cat} value={cat}>{cat}</option>
//                   ))}
//                 </select>
//               </div>

//               <div>
//                 <label className="mb-2 block text-sm font-medium text-gray-300">
//                   Subcategory
//                 </label>
//                 <input
//                   type="text"
//                   value={formData.subcategory}
//                   onChange={(e) => setFormData({ ...formData, subcategory: e.target.value })}
//                   className="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white placeholder-gray-400 backdrop-blur-sm transition-all focus:border-blue-500/50 focus:bg-white/10 focus:outline-none"
//                   placeholder="e.g., Brake Pads"
//                 />
//               </div>
//             </div>
//           </div>

//           {/* Pricing & Stock */}
//           <div>
//             <h2 className="mb-4 text-xl font-semibold text-white">Pricing & Stock</h2>
//             <div className="grid gap-6 md:grid-cols-4">
//               <div>
//                 <label className="mb-2 block text-sm font-medium text-gray-300">
//                   Price (â‚¹) *
//                 </label>
//                 <input
//                   type="number"
//                   required
//                   min="0"
//                   value={formData.price}
//                   onChange={(e) => setFormData({ ...formData, price: parseFloat(e.target.value) })}
//                   className="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white backdrop-blur-sm transition-all focus:border-blue-500/50 focus:bg-white/10 focus:outline-none"
//                 />
//               </div>

//               <div>
//                 <label className="mb-2 block text-sm font-medium text-gray-300">
//                   Discount Price (â‚¹)
//                 </label>
//                 <input
//                   type="number"
//                   min="0"
//                   value={formData.discountPrice || ''}
//                   onChange={(e) => setFormData({ ...formData, discountPrice: e.target.value ? parseFloat(e.target.value) : undefined })}
//                   className="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white backdrop-blur-sm transition-all focus:border-blue-500/50 focus:bg-white/10 focus:outline-none"
//                 />
//               </div>

//               <div>
//                 <label className="mb-2 block text-sm font-medium text-gray-300">
//                   Stock Quantity *
//                 </label>
//                 <input
//                   type="number"
//                   required
//                   min="0"
//                   value={formData.stock}
//                   onChange={(e) => setFormData({ ...formData, stock: parseInt(e.target.value) })}
//                   className="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white backdrop-blur-sm transition-all focus:border-blue-500/50 focus:bg-white/10 focus:outline-none"
//                 />
//               </div>

//               <div>
//                 <label className="mb-2 block text-sm font-medium text-gray-300">
//                   Low Stock Alert
//                 </label>
//                 <input
//                   type="number"
//                   min="0"
//                   value={formData.lowStockThreshold}
//                   onChange={(e) => setFormData({ ...formData, lowStockThreshold: parseInt(e.target.value) })}
//                   className="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white backdrop-blur-sm transition-all focus:border-blue-500/50 focus:bg-white/10 focus:outline-none"
//                 />
//               </div>
//             </div>
//           </div>

//           {/* Compatible Models */}
//           <div>
//             <h2 className="mb-4 text-xl font-semibold text-white">Compatible Models</h2>

//             <div className="mb-4 grid gap-4 md:grid-cols-5">
//               <div className="md:col-span-2">
//                 <label className="mb-2 block text-sm font-medium text-gray-300">
//                   Model *
//                 </label>
//                 <select
//                   value={currentModel.modelName}
//                   onChange={(e) => setCurrentModel({ ...currentModel, modelName: e.target.value })}
//                   className="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white backdrop-blur-sm transition-all focus:border-blue-500/50 focus:bg-white/10 focus:outline-none"
//                 >
//                   <option value="">Select Model</option>
//                   {HYUNDAI_MODELS.map((model) => (
//                     <option key={model} value={model}>{model}</option>
//                   ))}
//                 </select>
//               </div>

//               <div>
//                 <label className="mb-2 block text-sm font-medium text-gray-300">
//                   Year From *
//                 </label>
//                 <input
//                   type="number"
//                   value={currentModel.yearFrom}
//                   onChange={(e) => setCurrentModel({ ...currentModel, yearFrom: parseInt(e.target.value) })}
//                   className="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white backdrop-blur-sm transition-all focus:border-blue-500/50 focus:bg-white/10 focus:outline-none"
//                   min="2000"
//                   max={new Date().getFullYear() + 1}
//                 />
//               </div>

//               <div>
//                 <label className="mb-2 block text-sm font-medium text-gray-300">
//                   Year To
//                 </label>
//                 <input
//                   type="number"
//                   value={currentModel.yearTo || ''}
//                   onChange={(e) => setCurrentModel({ ...currentModel, yearTo: e.target.value ? parseInt(e.target.value) : undefined })}
//                   className="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white placeholder-gray-400 backdrop-blur-sm transition-all focus:border-blue-500/50 focus:bg-white/10 focus:outline-none"
//                   placeholder="Till date"
//                   min="2000"
//                   max={new Date().getFullYear() + 1}
//                 />
//               </div>

//               <div className="flex items-end">
//                 <Button
//                   type="button"
//                   onClick={addCompatibleModel}
//                   variant="primary"
//                   className="w-full"
//                 >
//                   <Plus className="h-4 w-4" />
//                   Add
//                 </Button>
//               </div>
//             </div>

//             {/* Added Models */}
//             {formData.compatibleModels.length > 0 && (
//               <div className="space-y-2">
//                 {formData.compatibleModels.map((model, index) => (
//                   <motion.div
//                     key={index}
//                     initial={{ opacity: 0, x: -20 }}
//                     animate={{ opacity: 1, x: 0 }}
//                     className="flex items-center justify-between rounded-lg border border-white/10 bg-white/5 p-3"
//                   >
//                     <span className="text-sm text-white">
//                       {model.modelName} ({model.yearFrom} - {model.yearTo || 'Present'})
//                       {model.variant && ` - ${model.variant}`}
//                     </span>
//                     <button
//                       type="button"
//                       onClick={() => removeCompatibleModel(index)}
//                       className="text-red-400 hover:text-red-300"
//                     >
//                       <X className="h-4 w-4" />
//                     </button>
//                   </motion.div>
//                 ))}
//               </div>
//             )}
//           </div>

//           {/* Product Images */}
//           <div>
//             <h2 className="mb-4 text-xl font-semibold text-white">Product Images</h2>

//             <div className="space-y-4">
//               <label className="flex cursor-pointer flex-col items-center justify-center rounded-xl border-2 border-dashed border-white/20 bg-white/5 px-6 py-12 transition-colors hover:border-blue-500/50 hover:bg-white/10">
//                 <Upload className="mb-3 h-12 w-12 text-gray-400" />
//                 <span className="text-sm font-medium text-white">
//                   Click to upload images
//                 </span>
//                 <span className="mt-1 text-xs text-gray-400">
//                   PNG, JPG up to 5MB (Max 5 images)
//                 </span>
//                 <input
//                   type="file"
//                   multiple
//                   accept="image/*"
//                   onChange={handleImageChange}
//                   className="hidden"
//                 />
//               </label>

//               {/* Image Previews */}
//               {imagePreviews.length > 0 && (
//                 <div className="grid gap-4 sm:grid-cols-3 md:grid-cols-5">
//                   {imagePreviews.map((preview, index) => (
//                     <motion.div
//                       key={index}
//                       initial={{ opacity: 0, scale: 0.8 }}
//                       animate={{ opacity: 1, scale: 1 }}
//                       className="group relative aspect-square overflow-hidden rounded-xl border border-white/10"
//                     >
//                       <img
//                         src={preview}
//                         alt={`Preview ${index + 1}`}
//                         className="h-full w-full object-cover"
//                       />
//                       <button
//                         type="button"
//                         onClick={() => removeImage(index)}
//                         className="absolute right-2 top-2 rounded-full bg-red-500 p-1 opacity-0 transition-opacity group-hover:opacity-100"
//                       >
//                         <X className="h-4 w-4 text-white" />
//                       </button>
//                     </motion.div>
//                   ))}
//                 </div>
//               )}
//             </div>
//           </div>

//           {/* Additional Details */}
//           <div>
//             <h2 className="mb-4 text-xl font-semibold text-white">Additional Details</h2>
//             <div className="grid gap-6 md:grid-cols-2">
//               <div>
//                 <label className="mb-2 block text-sm font-medium text-gray-300">
//                   Warranty Period
//                 </label>
//                 <input
//                   type="text"
//                   value={formData.warrantyPeriod}
//                   onChange={(e) => setFormData({ ...formData, warrantyPeriod: e.target.value })}
//                   className="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white backdrop-blur-sm transition-all focus:border-blue-500/50 focus:bg-white/10 focus:outline-none"
//                   placeholder="e.g., 1 Year"
//                 />
//               </div>

//               <div>
//                 <label className="mb-2 block text-sm font-medium text-gray-300">
//                   Manufacturer
//                 </label>
//                 <input
//                   type="text"
//                   value={formData.manufacturer}
//                   onChange={(e) => setFormData({ ...formData, manufacturer: e.target.value })}
//                   className="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white backdrop-blur-sm transition-all focus:border-blue-500/50 focus:bg-white/10 focus:outline-none"
//                   placeholder="e.g., Hyundai Mobis"
//                 />
//               </div>
//             </div>
//           </div>

//           {/* Submit Buttons */}
//           <div className="flex gap-4">
//             <Button
//               type="submit"
//               variant="primary"
//               size="lg"
//               isLoading={isLoading}
//               className="flex-1"
//             >
//               Create Product
//             </Button>
//             <Link href="/dashboard/products" className="flex-1">
//               <Button
//                 type="button"
//                 variant="secondary"
//                 size="lg"
//                 className="w-full"
//               >
//                 Cancel
//               </Button>
//             </Link>
//           </div>
//         </div>
//       </motion.form>
//     </div>
//   );
// }

"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { motion } from "framer-motion";
import {
  ArrowLeft,
  Upload,
  X,
  Plus,
  Trash2,
  Tag,
  Scale,
  Ruler,
  Zap,
  RotateCcw,
  BarChart3,
} from "lucide-react";
import Button from "@/components/ui/Button";
import { ProductService } from "@/lib/api";
import { toast } from "sonner";
import Link from "next/link";

// --- Types Definition ---
type ProductCategory =
  | "Engine"
  | "Brake"
  | "Electrical"
  | "Body"
  | "Accessories"
  | "Suspension"
  | "Transmission"
  | "Interior"
  | "Exterior"
  | "Service Parts";

interface CompatibleModel {
  modelName: string;
  yearFrom: number;
  yearTo?: number;
  variant?: string;
}

interface ProductFormData {
  name: string;
  partNumber: string;
  description: string;
  category: ProductCategory;
  subcategory: string;
  price: number;
  discountPrice?: number;
  stock: number;
  lowStockThreshold: number;
  warrantyPeriod: string;
  manufacturer: string;
  compatibleModels: CompatibleModel[];
  tags: string[];
  isActive: boolean;
  // ðŸ”¥ New Features
  flashSale: {
    isActive: boolean;
    salePrice?: number;
    startTime?: string;
    endTime?: string;
  };
  inventoryAnalytics: {
    reorderLevel: number;
    leadTimeDays: number;
    supplierEmail: string;
  };
  returnPolicy: {
    isReturnable: boolean;
    returnWindowDays: number;
    restockingFee: number;
  };
  shippingInfo: {
    weight: number;
    length: number;
    width: number;
    height: number;
  };
}

interface SpecificationItem {
  key: string;
  value: string;
}

const CATEGORIES: ProductCategory[] = [
  "Engine",
  "Brake",
  "Electrical",
  "Body",
  "Accessories",
  "Suspension",
  "Transmission",
  "Interior",
  "Exterior",
  "Service Parts",
];

const HYUNDAI_MODELS = [
  "i10",
  "i20",
  "Venue",
  "Verna",
  "Creta",
  "Alcazar",
  "Tucson",
  "Elantra",
  "Kona",
  "Ioniq 5",
  "Santro",
  "Grand i10",
  "Aura",
  "Exter",
];

export default function AddProductPage() {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);
  const [images, setImages] = useState<File[]>([]);
  const [imagePreviews, setImagePreviews] = useState<string[]>([]);
  const [tagInput, setTagInput] = useState("");

  // --- Main Form Data ---
  const [formData, setFormData] = useState<ProductFormData>({
    name: "",
    partNumber: "",
    description: "",
    category: "Engine",
    subcategory: "",
    price: 0,
    discountPrice: undefined,
    stock: 0,
    lowStockThreshold: 5,
    warrantyPeriod: "No Warranty",
    manufacturer: "Hyundai Mobis",
    compatibleModels: [],
    tags: [],
    isActive: true,
    // New Defaults
    flashSale: {
      isActive: false,
      salePrice: 0,
      startTime: "",
      endTime: "",
    },
    inventoryAnalytics: {
      reorderLevel: 10,
      leadTimeDays: 7,
      supplierEmail: "",
    },
    returnPolicy: {
      isReturnable: true,
      returnWindowDays: 7,
      restockingFee: 0,
    },
    shippingInfo: {
      weight: 0,
      length: 0,
      width: 0,
      height: 0,
    },
  });

  const [specifications, setSpecifications] = useState<SpecificationItem[]>([
    { key: "", value: "" },
  ]);

  const [currentModel, setCurrentModel] = useState<CompatibleModel>({
    modelName: "",
    yearFrom: new Date().getFullYear(),
    yearTo: undefined,
    variant: "",
  });

  // --- Handlers ---

  const handleImageChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(e.target.files || []);
    if (files.length + images.length > 5) {
      toast.error("Maximum 5 images allowed");
      return;
    }
    setImages([...images, ...files]);
    files.forEach((file) => {
      const reader = new FileReader();
      reader.onloadend = () =>
        setImagePreviews((prev) => [...prev, reader.result as string]);
      reader.readAsDataURL(file);
    });
  };

  const removeImage = (index: number) => {
    setImages(images.filter((_, i) => i !== index));
    setImagePreviews(imagePreviews.filter((_, i) => i !== index));
  };

  const addCompatibleModel = () => {
    if (!currentModel.modelName) {
      toast.error("Please select a model");
      return;
    }
    setFormData((prev) => ({
      ...prev,
      compatibleModels: [...prev.compatibleModels, currentModel],
    }));
    setCurrentModel({
      modelName: "",
      yearFrom: new Date().getFullYear(),
      yearTo: undefined,
      variant: "",
    });
  };

  const removeCompatibleModel = (index: number) => {
    setFormData((prev) => ({
      ...prev,
      compatibleModels: prev.compatibleModels.filter((_, i) => i !== index),
    }));
  };

  const handleSpecChange = (
    index: number,
    field: "key" | "value",
    value: string,
  ) => {
    const newSpecs = [...specifications];
    newSpecs[index][field] = value;
    setSpecifications(newSpecs);
  };

  const addSpecRow = () =>
    setSpecifications([...specifications, { key: "", value: "" }]);
  const removeSpecRow = (index: number) => {
    setSpecifications(specifications.filter((_, i) => i !== index));
  };

  const handleAddTag = (e: React.KeyboardEvent) => {
    if (e.key === "Enter" && tagInput.trim()) {
      e.preventDefault();
      if (!formData.tags.includes(tagInput.trim())) {
        setFormData((prev) => ({
          ...prev,
          tags: [...prev.tags, tagInput.trim()],
        }));
      }
      setTagInput("");
    }
  };

  const removeTag = (tagToRemove: string) => {
    setFormData((prev) => ({
      ...prev,
      tags: prev.tags.filter((tag) => tag !== tagToRemove),
    }));
  };

  // --- Submit Handler ---
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (images.length === 0) {
      toast.error("Please upload at least one image");
      return;
    }

    if (formData.compatibleModels.length === 0) {
      toast.error("Please add at least one compatible model");
      return;
    }

    setIsLoading(true);

    try {
      const data = new FormData();

      // Basic Fields
      data.append("name", formData.name);
      data.append("partNumber", formData.partNumber);
      data.append("description", formData.description);
      data.append("category", formData.category);
      if (formData.subcategory)
        data.append("subcategory", formData.subcategory);
      data.append("price", formData.price.toString());
      if (formData.discountPrice)
        data.append("discountPrice", formData.discountPrice.toString());
      data.append("stock", formData.stock.toString());
      data.append("lowStockThreshold", formData.lowStockThreshold.toString());
      data.append("warrantyPeriod", formData.warrantyPeriod);
      data.append("manufacturer", formData.manufacturer);
      data.append("isActive", formData.isActive.toString());

      // Complex Fields (JSON.stringify for Backend Parsing)
      data.append(
        "compatibleModels",
        JSON.stringify(formData.compatibleModels),
      );
      data.append("tags", JSON.stringify(formData.tags));
      data.append("flashSale", JSON.stringify(formData.flashSale));
      data.append(
        "inventoryAnalytics",
        JSON.stringify(formData.inventoryAnalytics),
      );
      data.append("returnPolicy", JSON.stringify(formData.returnPolicy));
      data.append("shippingInfo", JSON.stringify(formData.shippingInfo));

      // Specifications Map
      const specsObject = specifications.reduce(
        (acc, curr) => {
          if (curr.key.trim() && curr.value.trim()) {
            acc[curr.key.trim()] = curr.value.trim();
          }
          return acc;
        },
        {} as Record<string, string>,
      );
      data.append("specifications", JSON.stringify(specsObject));

      // Images
      images.forEach((image) => data.append("images", image));

      await ProductService.create(data);

      toast.success("Product created successfully!");
      router.push("/dashboard/products");
    } catch (error: any) {
      console.error("Create product error:", error);
      toast.error(error.response?.data?.message || "Failed to create product");
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="space-y-6 pb-20">
      {/* Header */}
      <motion.div
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        className="flex items-center gap-4"
      >
        <Link href="/dashboard/products">
          <motion.button
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.95 }}
            className="rounded-xl bg-white/5 p-2 backdrop-blur-sm transition-colors hover:bg-white/10"
          >
            <ArrowLeft className="h-5 w-5 text-white" />
          </motion.button>
        </Link>
        <div>
          <h1 className="text-3xl font-bold text-white">Add New Product</h1>
          <p className="mt-1 text-gray-400">Create a new spare part listing</p>
        </div>
      </motion.div>

      {/* Form */}
      <motion.form
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.1 }}
        onSubmit={handleSubmit}
        className="rounded-2xl border border-white/10 bg-white/[0.02] p-8 backdrop-blur-sm"
      >
        <div className="space-y-8">
          {/* 1. Basic Information */}
          <div>
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-xl font-semibold text-white">
                Basic Information
              </h2>
              {/* Active Toggle */}
              <div className="flex items-center gap-3 bg-white/5 px-4 py-2 rounded-lg border border-white/10">
                <span className="text-sm font-medium text-gray-300">
                  Status:
                </span>
                <label className="relative inline-flex items-center cursor-pointer">
                  <input
                    type="checkbox"
                    checked={formData.isActive}
                    onChange={(e) =>
                      setFormData({ ...formData, isActive: e.target.checked })
                    }
                    className="sr-only peer"
                  />
                  <div className="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                  <span className="ms-3 text-sm font-medium text-white">
                    {formData.isActive ? "Active" : "Inactive"}
                  </span>
                </label>
              </div>
            </div>

            <div className="grid gap-6 md:grid-cols-2">
              <div>
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Product Name *
                </label>
                <input
                  type="text"
                  required
                  value={formData.name}
                  onChange={(e) =>
                    setFormData({ ...formData, name: e.target.value })
                  }
                  className="form-input"
                  placeholder="e.g., Front Brake Pad Set"
                />
              </div>
              <div>
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Part Number *
                </label>
                <input
                  type="text"
                  required
                  value={formData.partNumber}
                  onChange={(e) =>
                    setFormData({
                      ...formData,
                      partNumber: e.target.value.toUpperCase(),
                    })
                  }
                  className="form-input"
                  placeholder="e.g., 58101-C9A70"
                />
              </div>
              <div className="md:col-span-2">
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Description *
                </label>
                <textarea
                  required
                  rows={4}
                  value={formData.description}
                  onChange={(e) =>
                    setFormData({ ...formData, description: e.target.value })
                  }
                  className="form-input"
                  placeholder="Detailed product description..."
                />
              </div>
              <div>
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Category *
                </label>
                <select
                  required
                  value={formData.category}
                  onChange={(e) =>
                    setFormData({
                      ...formData,
                      category: e.target.value as ProductCategory,
                    })
                  }
                  className="form-input"
                >
                  {CATEGORIES.map((cat) => (
                    <option
                      key={cat}
                      value={cat}
                      style={{ backgroundColor: "#1f2937", color: "white" }}
                    >
                      {cat}
                    </option>
                  ))}
                </select>
              </div>
              <div>
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Subcategory
                </label>
                <input
                  type="text"
                  value={formData.subcategory}
                  onChange={(e) =>
                    setFormData({ ...formData, subcategory: e.target.value })
                  }
                  className="form-input"
                  placeholder="e.g., Brake Pads"
                />
              </div>
            </div>
          </div>

          <div className="h-px bg-white/10" />

          {/* 2. Pricing & Stock */}
          <div>
            <h2 className="mb-4 text-xl font-semibold text-white">
              Pricing & Stock
            </h2>
            <div className="grid gap-6 md:grid-cols-4">
              <div>
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Price (â‚¹) *
                </label>
                <input
                  type="number"
                  required
                  min="0"
                  value={formData.price}
                  onChange={(e) =>
                    setFormData({
                      ...formData,
                      price: parseFloat(e.target.value),
                    })
                  }
                  className="form-input"
                />
              </div>
              <div>
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Discount Price (â‚¹)
                </label>
                <input
                  type="number"
                  min="0"
                  value={formData.discountPrice || ""}
                  onChange={(e) =>
                    setFormData({
                      ...formData,
                      discountPrice: e.target.value
                        ? parseFloat(e.target.value)
                        : undefined,
                    })
                  }
                  className="form-input"
                />
              </div>
              <div>
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Stock Quantity *
                </label>
                <input
                  type="number"
                  required
                  min="0"
                  value={formData.stock}
                  onChange={(e) =>
                    setFormData({
                      ...formData,
                      stock: parseInt(e.target.value),
                    })
                  }
                  className="form-input"
                />
              </div>
              <div>
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Low Stock Alert
                </label>
                <input
                  type="number"
                  min="0"
                  value={formData.lowStockThreshold}
                  onChange={(e) =>
                    setFormData({
                      ...formData,
                      lowStockThreshold: parseInt(e.target.value),
                    })
                  }
                  className="form-input"
                />
              </div>
            </div>
          </div>

          <div className="h-px bg-white/10" />

          {/* ðŸ”¥ 3. Flash Sale (New Feature) */}
          <div className="rounded-xl border border-yellow-500/20 bg-yellow-500/5 p-6">
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-2">
                <Zap className="h-5 w-5 text-yellow-400" />
                <h2 className="text-xl font-semibold text-white">Flash Sale</h2>
              </div>
              <label className="relative inline-flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  checked={formData.flashSale.isActive}
                  onChange={(e) =>
                    setFormData({
                      ...formData,
                      flashSale: {
                        ...formData.flashSale,
                        isActive: e.target.checked,
                      },
                    })
                  }
                  className="sr-only peer"
                />
                <div className="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:bg-yellow-600 after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
              </label>
            </div>

            {formData.flashSale.isActive && (
              <div className="grid gap-6 md:grid-cols-3 animate-in fade-in slide-in-from-top-2">
                <div>
                  <label className="mb-2 block text-sm font-medium text-gray-300">
                    Sale Price (â‚¹)
                  </label>
                  <input
                    type="number"
                    min="0"
                    value={formData.flashSale.salePrice}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        flashSale: {
                          ...formData.flashSale,
                          salePrice: parseFloat(e.target.value),
                        },
                      })
                    }
                    className="form-input border-yellow-500/30 focus:border-yellow-500"
                  />
                </div>
                <div>
                  <label className="mb-2 block text-sm font-medium text-gray-300">
                    Start Time
                  </label>
                  <input
                    type="datetime-local"
                    value={formData.flashSale.startTime}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        flashSale: {
                          ...formData.flashSale,
                          startTime: e.target.value,
                        },
                      })
                    }
                    className="form-input border-yellow-500/30 focus:border-yellow-500"
                  />
                </div>
                <div>
                  <label className="mb-2 block text-sm font-medium text-gray-300">
                    End Time
                  </label>
                  <input
                    type="datetime-local"
                    value={formData.flashSale.endTime}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        flashSale: {
                          ...formData.flashSale,
                          endTime: e.target.value,
                        },
                      })
                    }
                    className="form-input border-yellow-500/30 focus:border-yellow-500"
                  />
                </div>
              </div>
            )}
          </div>

          {/* 4. Physical Dimensions & Shipping */}
          <div>
            <div className="flex items-center gap-2 mb-4">
              <Scale className="h-5 w-5 text-blue-400" />
              <h2 className="text-xl font-semibold text-white">
                Shipping & Dimensions
              </h2>
            </div>
            <div className="grid gap-6 md:grid-cols-4">
              <div>
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Weight (kg)
                </label>
                <input
                  type="number"
                  step="0.01"
                  min="0"
                  value={formData.shippingInfo.weight}
                  onChange={(e) =>
                    setFormData({
                      ...formData,
                      shippingInfo: {
                        ...formData.shippingInfo,
                        weight: parseFloat(e.target.value),
                      },
                    })
                  }
                  className="form-input"
                  placeholder="0.00"
                />
              </div>
              <div className="md:col-span-3">
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Dimensions (L x W x H) in cm
                </label>
                <div className="flex gap-2">
                  <input
                    type="number"
                    placeholder="Length"
                    value={formData.shippingInfo.length}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        shippingInfo: {
                          ...formData.shippingInfo,
                          length: parseFloat(e.target.value),
                        },
                      })
                    }
                    className="form-input w-full"
                  />
                  <input
                    type="number"
                    placeholder="Width"
                    value={formData.shippingInfo.width}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        shippingInfo: {
                          ...formData.shippingInfo,
                          width: parseFloat(e.target.value),
                        },
                      })
                    }
                    className="form-input w-full"
                  />
                  <input
                    type="number"
                    placeholder="Height"
                    value={formData.shippingInfo.height}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        shippingInfo: {
                          ...formData.shippingInfo,
                          height: parseFloat(e.target.value),
                        },
                      })
                    }
                    className="form-input w-full"
                  />
                </div>
              </div>
            </div>
          </div>

          <div className="h-px bg-white/10" />

          {/* 5. Compatible Models */}
          <div>
            <h2 className="mb-4 text-xl font-semibold text-white">
              Compatible Models
            </h2>
            <div className="mb-4 grid gap-4 md:grid-cols-5 p-4 rounded-xl bg-white/5 border border-white/10">
              <div className="md:col-span-2">
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Model *
                </label>
                <select
                  value={currentModel.modelName}
                  onChange={(e) =>
                    setCurrentModel({
                      ...currentModel,
                      modelName: e.target.value,
                    })
                  }
                  className="form-input"
                >
                  <option value="">Select Model</option>
                  {HYUNDAI_MODELS.map((model) => (
                    <option
                      key={model}
                      value={model}
                      style={{ backgroundColor: "#1f2937", color: "white" }}
                    >
                      {model}
                    </option>
                  ))}
                </select>
              </div>
              <div>
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Year From *
                </label>
                <input
                  type="number"
                  value={currentModel.yearFrom}
                  onChange={(e) =>
                    setCurrentModel({
                      ...currentModel,
                      yearFrom: parseInt(e.target.value),
                    })
                  }
                  className="form-input"
                  min="2000"
                  max={new Date().getFullYear() + 1}
                />
              </div>
              <div>
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Year To
                </label>
                <input
                  type="number"
                  value={currentModel.yearTo || ""}
                  onChange={(e) =>
                    setCurrentModel({
                      ...currentModel,
                      yearTo: e.target.value
                        ? parseInt(e.target.value)
                        : undefined,
                    })
                  }
                  className="form-input"
                  placeholder="Till date"
                  min="2000"
                  max={new Date().getFullYear() + 1}
                />
              </div>
              <div className="flex items-end">
                <Button
                  type="button"
                  onClick={addCompatibleModel}
                  variant="primary"
                  className="w-full"
                >
                  <Plus className="h-4 w-4" /> Add
                </Button>
              </div>
            </div>
            {formData.compatibleModels.length > 0 && (
              <div className="grid gap-2 sm:grid-cols-2 md:grid-cols-3">
                {formData.compatibleModels.map((model, index) => (
                  <motion.div
                    key={index}
                    initial={{ opacity: 0, scale: 0.9 }}
                    animate={{ opacity: 1, scale: 1 }}
                    className="flex items-center justify-between rounded-lg border border-white/10 bg-blue-500/10 p-3"
                  >
                    <div className="text-sm">
                      <p className="font-semibold text-blue-200">
                        {model.modelName}
                      </p>
                      <p className="text-blue-300/70 text-xs">
                        {model.yearFrom} - {model.yearTo || "Present"}{" "}
                        {model.variant ? `(${model.variant})` : ""}
                      </p>
                    </div>
                    <button
                      type="button"
                      onClick={() => removeCompatibleModel(index)}
                      className="text-red-400 hover:text-red-300"
                    >
                      <X className="h-4 w-4" />
                    </button>
                  </motion.div>
                ))}
              </div>
            )}
          </div>

          <div className="h-px bg-white/10" />

          {/* 6. Specifications */}
          <div>
            <div className="flex items-center gap-2 mb-4">
              <Ruler className="h-5 w-5 text-purple-400" />
              <h2 className="text-xl font-semibold text-white">
                Specifications
              </h2>
            </div>
            <div className="space-y-3">
              {specifications.map((spec, index) => (
                <div key={index} className="flex gap-4">
                  <input
                    type="text"
                    placeholder="Key (e.g. Material)"
                    value={spec.key}
                    onChange={(e) =>
                      handleSpecChange(index, "key", e.target.value)
                    }
                    className="form-input flex-1"
                  />
                  <input
                    type="text"
                    placeholder="Value (e.g. Steel)"
                    value={spec.value}
                    onChange={(e) =>
                      handleSpecChange(index, "value", e.target.value)
                    }
                    className="form-input flex-1"
                  />
                  {index > 0 && (
                    <button
                      type="button"
                      onClick={() => removeSpecRow(index)}
                      className="p-3 rounded-xl bg-red-500/10 text-red-400 hover:bg-red-500/20"
                    >
                      <Trash2 className="h-5 w-5" />
                    </button>
                  )}
                </div>
              ))}
              <Button
                type="button"
                onClick={addSpecRow}
                variant="secondary"
                size="sm"
                className="mt-2"
              >
                <Plus className="h-4 w-4 mr-2" /> Add Specification
              </Button>
            </div>
          </div>

          {/* ðŸ”¥ 7. Inventory Analytics & Return Policy */}
          <div className="grid md:grid-cols-2 gap-8">
            {/* Inventory */}
            <div>
              <div className="flex items-center gap-2 mb-4">
                <BarChart3 className="h-5 w-5 text-green-400" />
                <h2 className="text-xl font-semibold text-white">
                  Inventory Analytics
                </h2>
              </div>
              <div className="space-y-4 rounded-xl bg-white/5 p-4 border border-white/10">
                <div>
                  <label className="mb-1 block text-sm text-gray-400">
                    Reorder Level
                  </label>
                  <input
                    type="number"
                    value={formData.inventoryAnalytics.reorderLevel}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        inventoryAnalytics: {
                          ...formData.inventoryAnalytics,
                          reorderLevel: parseInt(e.target.value),
                        },
                      })
                    }
                    className="form-input"
                  />
                </div>
                <div>
                  <label className="mb-1 block text-sm text-gray-400">
                    Lead Time (Days)
                  </label>
                  <input
                    type="number"
                    value={formData.inventoryAnalytics.leadTimeDays}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        inventoryAnalytics: {
                          ...formData.inventoryAnalytics,
                          leadTimeDays: parseInt(e.target.value),
                        },
                      })
                    }
                    className="form-input"
                  />
                </div>
                <div>
                  <label className="mb-1 block text-sm text-gray-400">
                    Supplier Email
                  </label>
                  <input
                    type="email"
                    value={formData.inventoryAnalytics.supplierEmail}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        inventoryAnalytics: {
                          ...formData.inventoryAnalytics,
                          supplierEmail: e.target.value,
                        },
                      })
                    }
                    className="form-input"
                    placeholder="supplier@example.com"
                  />
                </div>
              </div>
            </div>

            {/* Returns */}
            <div>
              <div className="flex items-center gap-2 mb-4">
                <RotateCcw className="h-5 w-5 text-orange-400" />
                <h2 className="text-xl font-semibold text-white">
                  Return Policy
                </h2>
              </div>
              <div className="space-y-4 rounded-xl bg-white/5 p-4 border border-white/10">
                <div className="flex items-center justify-between">
                  <label className="text-sm text-gray-400">
                    Is Returnable?
                  </label>
                  <input
                    type="checkbox"
                    checked={formData.returnPolicy.isReturnable}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        returnPolicy: {
                          ...formData.returnPolicy,
                          isReturnable: e.target.checked,
                        },
                      })
                    }
                    className="h-5 w-5 rounded border-gray-600 bg-gray-700 text-blue-600 focus:ring-blue-600"
                  />
                </div>
                {formData.returnPolicy.isReturnable && (
                  <>
                    <div>
                      <label className="mb-1 block text-sm text-gray-400">
                        Return Window (Days)
                      </label>
                      <input
                        type="number"
                        value={formData.returnPolicy.returnWindowDays}
                        onChange={(e) =>
                          setFormData({
                            ...formData,
                            returnPolicy: {
                              ...formData.returnPolicy,
                              returnWindowDays: parseInt(e.target.value),
                            },
                          })
                        }
                        className="form-input"
                      />
                    </div>
                    <div>
                      <label className="mb-1 block text-sm text-gray-400">
                        Restocking Fee (â‚¹)
                      </label>
                      <input
                        type="number"
                        value={formData.returnPolicy.restockingFee}
                        onChange={(e) =>
                          setFormData({
                            ...formData,
                            returnPolicy: {
                              ...formData.returnPolicy,
                              restockingFee: parseFloat(e.target.value),
                            },
                          })
                        }
                        className="form-input"
                      />
                    </div>
                  </>
                )}
              </div>
            </div>
          </div>

          <div className="h-px bg-white/10" />

          {/* 8. Other Details (Tags, etc.) */}
          <div className="grid gap-6 md:grid-cols-2">
            <div>
              <label className="mb-2 block text-sm font-medium text-gray-300">
                Warranty Period
              </label>
              <input
                type="text"
                value={formData.warrantyPeriod}
                onChange={(e) =>
                  setFormData({ ...formData, warrantyPeriod: e.target.value })
                }
                className="form-input"
                placeholder="e.g., 1 Year"
              />
            </div>
            <div>
              <label className="mb-2 block text-sm font-medium text-gray-300">
                Manufacturer
              </label>
              <input
                type="text"
                value={formData.manufacturer}
                onChange={(e) =>
                  setFormData({ ...formData, manufacturer: e.target.value })
                }
                className="form-input"
                placeholder="e.g., Hyundai Mobis"
              />
            </div>
          </div>

          <div>
            <label className="mb-2 flex items-center gap-2 text-sm font-medium text-gray-300">
              <Tag className="h-4 w-4" /> Product Tags
            </label>
            <input
              type="text"
              value={tagInput}
              onChange={(e) => setTagInput(e.target.value)}
              onKeyDown={handleAddTag}
              className="form-input"
              placeholder="Type a tag and press Enter (e.g., 'oem', 'fast-moving')"
            />
            <div className="mt-3 flex flex-wrap gap-2">
              {formData.tags.map((tag) => (
                <span
                  key={tag}
                  className="inline-flex items-center gap-1 rounded-full bg-blue-500/20 px-3 py-1 text-sm text-blue-200 border border-blue-500/30"
                >
                  {tag}
                  <button
                    type="button"
                    onClick={() => removeTag(tag)}
                    className="hover:text-white"
                  >
                    <X className="h-3 w-3" />
                  </button>
                </span>
              ))}
            </div>
          </div>

          <div className="h-px bg-white/10" />

          {/* 9. Images */}
          <div>
            <h2 className="mb-4 text-xl font-semibold text-white">
              Product Images
            </h2>
            <div className="space-y-4">
              <label className="flex cursor-pointer flex-col items-center justify-center rounded-xl border-2 border-dashed border-white/20 bg-white/5 px-6 py-12 transition-colors hover:border-blue-500/50 hover:bg-white/10">
                <Upload className="mb-3 h-12 w-12 text-gray-400" />
                <span className="text-sm font-medium text-white">
                  Click to upload images
                </span>
                <span className="mt-1 text-xs text-gray-400">
                  PNG, JPG up to 5MB (Max 5 images)
                </span>
                <input
                  type="file"
                  multiple
                  accept="image/*"
                  onChange={handleImageChange}
                  className="hidden"
                />
              </label>
              {imagePreviews.length > 0 && (
                <div className="grid gap-4 sm:grid-cols-3 md:grid-cols-5">
                  {imagePreviews.map((preview, index) => (
                    <motion.div
                      key={index}
                      initial={{ opacity: 0, scale: 0.8 }}
                      animate={{ opacity: 1, scale: 1 }}
                      className="group relative aspect-square overflow-hidden rounded-xl border border-white/10"
                    >
                      <img
                        src={preview}
                        alt={`Preview ${index + 1}`}
                        className="h-full w-full object-cover"
                      />
                      <button
                        type="button"
                        onClick={() => removeImage(index)}
                        className="absolute right-2 top-2 rounded-full bg-red-500 p-1 opacity-0 transition-opacity group-hover:opacity-100"
                      >
                        <X className="h-4 w-4 text-white" />
                      </button>
                    </motion.div>
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* Buttons */}
          <div className="flex gap-4 pt-4">
            <Button
              type="submit"
              variant="primary"
              size="lg"
              isLoading={isLoading}
              className="flex-1"
            >
              Create Product
            </Button>
            <Link href="/dashboard/products" className="flex-1">
              <Button
                type="button"
                variant="secondary"
                size="lg"
                className="w-full"
              >
                Cancel
              </Button>
            </Link>
          </div>
        </div>
      </motion.form>

      {/* Input Styles */}
      <style jsx global>{`
        .form-input {
          width: 100%;
          border-radius: 0.75rem;
          border-width: 1px;
          border-color: rgba(255, 255, 255, 0.1);
          background-color: rgba(255, 255, 255, 0.05);
          padding-left: 1rem;
          padding-right: 1rem;
          padding-top: 0.75rem;
          padding-bottom: 0.75rem;
          color: white;
          backdrop-filter: blur(4px);
          transition: all 150ms;
        }
        .form-input:focus {
          border-color: rgba(59, 130, 246, 0.5);
          background-color: rgba(255, 255, 255, 0.1);
          outline: 2px solid transparent;
        }
        .form-input::placeholder {
          color: #9ca3af;
        }
      `}</style>
    </div>
  );
}
</file>

<file path="app/dashboard/products/page.tsx">
// // 'use client';

// // import { useEffect, useState } from 'react';
// // import { motion } from 'framer-motion';
// // import {
// //   Package,
// //   Search,
// //   Plus,
// //   Edit,
// //   Trash2,
// //   Eye,
// //   RefreshCcw,
// // } from 'lucide-react';
// // import Button from '@/components/ui/Button';
// // import { TableSkeleton } from '@/components/ui/Skeleton';
// // import { ProductService } from '@/lib/api';
// // import { Product } from '@/types';
// // import { toast } from 'sonner';
// // import { formatCurrency, getStockStatusColor, cn } from '@/lib/utils';
// // import Image from 'next/image';
// // import Link from 'next/link'; // <--- Import this

// // export default function ProductsPage() {
// //   // âœ… FIX 1: Initialize with empty array
// //   const [products, setProducts] = useState<Product[]>([]);
// //   const [isLoading, setIsLoading] = useState(true);
// //   const [searchQuery, setSearchQuery] = useState('');
// //   const [selectedCategory, setSelectedCategory] = useState('All');

// //   useEffect(() => {
// //     fetchProducts();
// //   }, []);

// //   const fetchProducts = async () => {
// //     try {
// //       setIsLoading(true);
// //       const response = await ProductService.getAll();

// //       // Debugging: à°•à°¨à±à°¸à±‹à°²à± à°²à±‹ à°°à±†à°¸à±à°ªà°¾à°¨à±à°¸à± à°šà±†à°•à± à°šà±‡à°¯à°¡à°¾à°¨à°¿à°•à°¿
// //       console.log('ðŸ“¦ Products API Response:', response.data);

// //       // âœ… UPDATE: Based on your JSON structure { success: true, data: [ARRAY], ... }
// //       // Axios response body is in response.data
// //       // So products list is at response.data.data
// //       const incomingData = response.data.data || [];

// //       if (Array.isArray(incomingData)) {
// //         setProducts(incomingData);
// //       } else {
// //         console.error('Invalid products data format. Expected Array, got:', incomingData);
// //         setProducts([]); // Fallback to empty array
// //       }
// //     } catch (error: any) {
// //       console.error('Products fetch error:', error);
// //       toast.error('Failed to fetch products');
// //       setProducts([]);
// //     } finally {
// //       setIsLoading(false);
// //     }
// //   };

// //   const handleDeleteProduct = async (id: string) => {
// //     if (!confirm('Are you sure you want to delete this product?')) return;

// //     try {
// //       await ProductService.delete(id);
// //       toast.success('Product deleted successfully');
// //       fetchProducts(); // Refresh list
// //     } catch (error) {
// //       toast.error('Failed to delete product');
// //     }
// //   };

// //   // âœ… FIX 3: Safe Filtering Logic
// //   const safeProducts = Array.isArray(products) ? products : [];

// //   const filteredProducts = safeProducts.filter((product) => {
// //     const matchesSearch =
// //       (product.name || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
// //       (product.partNumber || '').toLowerCase().includes(searchQuery.toLowerCase());
// //     const matchesCategory =
// //       selectedCategory === 'All' || product.category === selectedCategory;
// //     return matchesSearch && matchesCategory;
// //   });

// //   // Calculate Categories safely
// //   const categories = ['All', ...new Set(safeProducts.map((p) => p.category).filter(Boolean))];

// //   if (isLoading) {
// //     return (
// //       <div className="space-y-6">
// //         <div className="flex items-center justify-between">
// //           <h1 className="text-3xl font-bold text-white">Products</h1>
// //         </div>
// //         <TableSkeleton />
// //       </div>
// //     );
// //   }

// //   return (
// //     <div className="space-y-6">
// //       {/* Header */}
// //       <motion.div
// //         initial={{ opacity: 0, y: -20 }}
// //         animate={{ opacity: 1, y: 0 }}
// //         transition={{ duration: 0.5 }}
// //         className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between"
// //       >
// //         <div>
// //           <h1 className="text-3xl font-bold text-white">Products</h1>
// //           <p className="mt-1 text-gray-400">
// //             Manage your spare parts inventory
// //           </p>
// //         </div>
// //         <div className="flex gap-2">
// //            <button
// //              onClick={fetchProducts}
// //              className="flex items-center gap-2 rounded-lg bg-white/5 px-4 py-2 text-sm font-medium text-white hover:bg-white/10"
// //            >
// //              <RefreshCcw className="h-4 w-4" />
// //              Refresh
// //            </button>
// //            <Link href="products/add">
// //              <Button variant="primary" size="md">
// //                <Plus className="h-4 w-4 mr-2" />
// //                Add Product
// //              </Button>
// //            </Link>
// //         </div>
// //       </motion.div>

// //       {/* Filters */}
// //       <motion.div
// //         initial={{ opacity: 0, y: 20 }}
// //         animate={{ opacity: 1, y: 0 }}
// //         transition={{ delay: 0.1, duration: 0.5 }}
// //         className="flex flex-wrap items-center gap-4"
// //       >
// //         {/* Search */}
// //         <div className="relative flex-1 min-w-[300px]">
// //           <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400" />
// //           <input
// //             type="text"
// //             placeholder="Search by name or part number..."
// //             value={searchQuery}
// //             onChange={(e) => setSearchQuery(e.target.value)}
// //             className="w-full rounded-xl border border-white/10 bg-white/5 py-2.5 pl-10 pr-4 text-sm text-white placeholder-gray-400 backdrop-blur-sm transition-all focus:border-blue-500/30 focus:bg-white/10 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
// //           />
// //         </div>

// //         {/* Category Filter */}
// //         <div className="flex items-center gap-2 overflow-x-auto rounded-xl border border-white/10 bg-white/5 p-1 backdrop-blur-sm scrollbar-hide">
// //           {categories.map((category) => (
// //             <motion.button
// //               key={category}
// //               whileHover={{ scale: 1.05 }}
// //               whileTap={{ scale: 0.95 }}
// //               onClick={() => setSelectedCategory(category)}
// //               className={cn(
// //                 'whitespace-nowrap rounded-lg px-4 py-2 text-sm font-medium transition-all',
// //                 selectedCategory === category
// //                   ? 'bg-blue-500 text-white shadow-lg shadow-blue-500/30'
// //                   : 'text-gray-400 hover:text-white'
// //               )}
// //             >
// //               {category}
// //             </motion.button>
// //           ))}
// //         </div>
// //       </motion.div>

// //       {/* Stats */}
// //       <motion.div
// //         initial={{ opacity: 0, y: 20 }}
// //         animate={{ opacity: 1, y: 0 }}
// //         transition={{ delay: 0.2, duration: 0.5 }}
// //         className="grid gap-4 sm:grid-cols-3"
// //       >
// //         <div className="rounded-xl border border-white/10 bg-white/5 p-4 backdrop-blur-sm">
// //           <p className="text-sm text-gray-400">Total Products</p>
// //           <p className="mt-1 text-2xl font-bold text-white">{safeProducts.length}</p>
// //         </div>
// //         <div className="rounded-xl border border-white/10 bg-white/5 p-4 backdrop-blur-sm">
// //           <p className="text-sm text-gray-400">Low Stock Items</p>
// //           <p className="mt-1 text-2xl font-bold text-yellow-400">
// //             {safeProducts.filter((p) => p.stockStatus === 'Low Stock').length}
// //           </p>
// //         </div>
// //         <div className="rounded-xl border border-white/10 bg-white/5 p-4 backdrop-blur-sm">
// //           <p className="text-sm text-gray-400">Out of Stock</p>
// //           <p className="mt-1 text-2xl font-bold text-red-400">
// //             {safeProducts.filter((p) => p.stockStatus === 'Out of Stock').length}
// //           </p>
// //         </div>
// //       </motion.div>

// //       {/* Products Table */}
// //       <motion.div
// //         initial={{ opacity: 0, y: 20 }}
// //         animate={{ opacity: 1, y: 0 }}
// //         transition={{ delay: 0.3, duration: 0.5 }}
// //         className="overflow-hidden rounded-2xl border border-white/10 bg-white/[0.02] backdrop-blur-sm"
// //       >
// //         <div className="overflow-x-auto">
// //           <table className="w-full">
// //             <thead>
// //               <tr className="border-b border-white/10 bg-white/5">
// //                 <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">
// //                   Product
// //                 </th>
// //                 <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">
// //                   Part Number
// //                 </th>
// //                 <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">
// //                   Category
// //                 </th>
// //                 <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">
// //                   Price
// //                 </th>
// //                 <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">
// //                   Stock
// //                 </th>
// //                 <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">
// //                   Actions
// //                 </th>
// //               </tr>
// //             </thead>
// //             <tbody className="divide-y divide-white/5">
// //               {filteredProducts.length === 0 ? (
// //                  <tr>
// //                   <td colSpan={6} className="px-6 py-12 text-center text-gray-400">
// //                     <Package className="h-12 w-12 mx-auto mb-3 text-gray-600" />
// //                     <p>No products found</p>
// //                   </td>
// //                 </tr>
// //               ) : (
// //                 filteredProducts.map((product, index) => (
// //                   <motion.tr
// //                     key={product._id}
// //                     initial={{ opacity: 0, x: -20 }}
// //                     animate={{ opacity: 1, x: 0 }}
// //                     transition={{ delay: 0.05 * index, duration: 0.3 }}
// //                     whileHover={{ backgroundColor: 'rgba(255, 255, 255, 0.02)' }}
// //                     className="transition-colors"
// //                   >
// //                     <td className="px-6 py-4">
// //                       <div className="flex items-center gap-3">
// //                         <div className="relative h-12 w-12 overflow-hidden rounded-lg bg-white/5 border border-white/10 flex-shrink-0">
// //                           {product.images && product.images[0] ? (
// //                             <Image
// //                               src={product.images[0].url}
// //                               alt={product.name}
// //                               fill
// //                               className="object-cover"
// //                             />
// //                           ) : (
// //                             <div className="flex h-full w-full items-center justify-center text-gray-500">
// //                               <Package className="h-6 w-6" />
// //                             </div>
// //                           )}
// //                         </div>
// //                         <div>
// //                           <p className="font-medium text-white">{product.name}</p>
// //                           <p className="text-xs text-gray-400">
// //                             {product.subcategory || product.category}
// //                           </p>
// //                         </div>
// //                       </div>
// //                     </td>
// //                     <td className="px-6 py-4">
// //                       <code className="rounded bg-white/5 px-2 py-1 text-xs text-cyan-400">
// //                         {product.partNumber}
// //                       </code>
// //                     </td>
// //                     <td className="px-6 py-4">
// //                       <span className="rounded-full bg-blue-500/10 px-3 py-1 text-xs font-medium text-blue-400">
// //                         {product.category}
// //                       </span>
// //                     </td>
// //                     <td className="px-6 py-4">
// //                       <div>
// //                         <p className="font-semibold text-white">
// //                           {formatCurrency(product.finalPrice || product.price)}
// //                         </p>
// //                         {product.discountPrice && product.discountPrice < product.price && (
// //                           <p className="text-xs text-gray-400 line-through">
// //                             {formatCurrency(product.price)}
// //                           </p>
// //                         )}
// //                       </div>
// //                     </td>
// //                     <td className="px-6 py-4">
// //                       <div className="flex items-center gap-2">
// //                         <span className="font-medium text-white">
// //                           {product.stock}
// //                         </span>
// //                         <span
// //                           className={cn(
// //                             'text-xs font-medium px-2 py-0.5 rounded-full',
// //                             product.stock > (product.lowStockThreshold || 5) ? 'bg-green-500/10 text-green-400' :
// //                             product.stock > 0 ? 'bg-yellow-500/10 text-yellow-400' :
// //                             'bg-red-500/10 text-red-400'
// //                           )}
// //                         >
// //                           {product.stockStatus || (product.stock > 0 ? 'In Stock' : 'Out of Stock')}
// //                         </span>
// //                       </div>
// //                     </td>
// //                     <td className="px-6 py-4">
// //                       <div className="flex items-center gap-2">
// //                         <motion.button
// //                           whileHover={{ scale: 1.1 }}
// //                           whileTap={{ scale: 0.9 }}
// //                           className="rounded-lg bg-blue-500/10 p-2 text-blue-400 transition-colors hover:bg-blue-500/20"
// //                           title="View Details"
// //                         >
// //                           <Eye className="h-4 w-4" />
// //                         </motion.button>
// //                         <motion.button
// //                           whileHover={{ scale: 1.1 }}
// //                           whileTap={{ scale: 0.9 }}
// //                           className="rounded-lg bg-yellow-500/10 p-2 text-yellow-400 transition-colors hover:bg-yellow-500/20"
// //                           title="Edit Product"
// //                         >
// //                           <Edit className="h-4 w-4" />
// //                         </motion.button>
// //                         <motion.button
// //                           whileHover={{ scale: 1.1 }}
// //                           whileTap={{ scale: 0.9 }}
// //                           onClick={() => handleDeleteProduct(product._id)}
// //                           className="rounded-lg bg-red-500/10 p-2 text-red-400 transition-colors hover:bg-red-500/20"
// //                           title="Delete Product"
// //                         >
// //                           <Trash2 className="h-4 w-4" />
// //                         </motion.button>
// //                       </div>
// //                     </td>
// //                   </motion.tr>
// //                 ))
// //               )}
// //             </tbody>
// //           </table>
// //         </div>
// //       </motion.div>
// //     </div>
// //   );
// // }

// // 'use client';

// // import { useEffect, useState } from 'react';
// // import { motion, AnimatePresence } from 'framer-motion'; // Import AnimatePresence
// // import {
// //   Package,
// //   Search,
// //   Plus,
// //   Edit,
// //   Trash2,
// //   Eye,
// //   RefreshCcw,
// //   Car,
// //   AlertTriangle, // Import Alert Icon
// //   X,
// // } from 'lucide-react';
// // import Button from '@/components/ui/Button';
// // import { TableSkeleton } from '@/components/ui/Skeleton';
// // import { ProductService } from '@/lib/api';
// // import { Product } from '@/types';
// // import { toast } from 'sonner';
// // import { formatCurrency, cn } from '@/lib/utils';
// // import Image from 'next/image';
// // import Link from 'next/link';

// // export default function ProductsPage() {
// //   const [products, setProducts] = useState<Product[]>([]);
// //   const [isLoading, setIsLoading] = useState(true);
// //   const [searchQuery, setSearchQuery] = useState('');
// //   const [selectedCategory, setSelectedCategory] = useState('All');

// //   // --- DELETE MODAL STATE ---
// //   const [deleteId, setDeleteId] = useState<string | null>(null);
// //   const [isDeleting, setIsDeleting] = useState(false);

// //   useEffect(() => {
// //     fetchProducts();
// //   }, []);

// //   const fetchProducts = async () => {
// //     try {
// //       setIsLoading(true);
// //       const response = await ProductService.getAll();
// //       const incomingData = response.data.data || [];

// //       if (Array.isArray(incomingData)) {
// //         setProducts(incomingData);
// //       } else {
// //         setProducts([]);
// //       }
// //     } catch (error: any) {
// //       console.error('Products fetch error:', error);
// //       toast.error('Failed to fetch products');
// //       setProducts([]);
// //     } finally {
// //       setIsLoading(false);
// //     }
// //   };

// //   // 1. Open Modal
// //   const openDeleteModal = (id: string) => {
// //     setDeleteId(id);
// //   };

// //   // 2. Close Modal
// //   const closeDeleteModal = () => {
// //     setDeleteId(null);
// //   };

// //   // 3. Execute Delete (API Call)
// //   const executeDelete = async () => {
// //     if (!deleteId) return;

// //     setIsDeleting(true);
// //     try {
// //       await ProductService.delete(deleteId);
// //       toast.success('Product deleted successfully');
// //       // Remove from UI
// //       setProducts(prev => prev.filter(p => p._id !== deleteId));
// //       closeDeleteModal();
// //     } catch (error: any) {
// //       console.error("Delete Error:", error);
// //       toast.error(error.response?.data?.message || 'Failed to delete product');
// //     } finally {
// //       setIsDeleting(false);
// //     }
// //   };

// //   const safeProducts = Array.isArray(products) ? products : [];

// //   const filteredProducts = safeProducts.filter((product) => {
// //     const matchesSearch =
// //       (product.name || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
// //       (product.partNumber || '').toLowerCase().includes(searchQuery.toLowerCase());
// //     const matchesCategory =
// //       selectedCategory === 'All' || product.category === selectedCategory;
// //     return matchesSearch && matchesCategory;
// //   });

// //   const categories = ['All', ...new Set(safeProducts.map((p) => p.category).filter(Boolean))];

// //   if (isLoading) {
// //     return (
// //       <div className="space-y-6">
// //         <div className="flex items-center justify-between">
// //           <h1 className="text-3xl font-bold text-white">Products</h1>
// //         </div>
// //         <TableSkeleton />
// //       </div>
// //     );
// //   }

// //   return (
// //     <div className="space-y-6 pb-20">
// //       {/* Header */}
// //       <motion.div
// //         initial={{ opacity: 0, y: -20 }}
// //         animate={{ opacity: 1, y: 0 }}
// //         transition={{ duration: 0.5 }}
// //         className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between"
// //       >
// //         <div>
// //           <h1 className="text-3xl font-bold text-white">Products</h1>
// //           <p className="mt-1 text-gray-400">
// //             Manage your spare parts inventory
// //           </p>
// //         </div>
// //         <div className="flex gap-2">
// //            <button
// //              onClick={fetchProducts}
// //              className="flex items-center gap-2 rounded-lg bg-white/5 px-4 py-2 text-sm font-medium text-white hover:bg-white/10 transition-colors"
// //            >
// //              <RefreshCcw className="h-4 w-4" />
// //              Refresh
// //            </button>
// //            <Link href="/dashboard/products/add">
// //              <Button variant="primary" size="md">
// //                <Plus className="h-4 w-4 mr-2" />
// //                Add Product
// //              </Button>
// //            </Link>
// //         </div>
// //       </motion.div>

// //       {/* Filters */}
// //       <motion.div
// //         initial={{ opacity: 0, y: 20 }}
// //         animate={{ opacity: 1, y: 0 }}
// //         transition={{ delay: 0.1, duration: 0.5 }}
// //         className="flex flex-wrap items-center gap-4"
// //       >
// //         <div className="relative flex-1 min-w-[300px]">
// //           <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400" />
// //           <input
// //             type="text"
// //             placeholder="Search by name or part number..."
// //             value={searchQuery}
// //             onChange={(e) => setSearchQuery(e.target.value)}
// //             className="w-full rounded-xl border border-white/10 bg-white/5 py-2.5 pl-10 pr-4 text-sm text-white placeholder-gray-400 backdrop-blur-sm transition-all focus:border-blue-500/30 focus:bg-white/10 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
// //           />
// //         </div>

// //         <div className="flex items-center gap-2 overflow-x-auto rounded-xl border border-white/10 bg-white/5 p-1 backdrop-blur-sm scrollbar-hide">
// //           {categories.map((category) => (
// //             <motion.button
// //               key={category}
// //               whileHover={{ scale: 1.05 }}
// //               whileTap={{ scale: 0.95 }}
// //               onClick={() => setSelectedCategory(category)}
// //               className={cn(
// //                 'whitespace-nowrap rounded-lg px-4 py-2 text-sm font-medium transition-all',
// //                 selectedCategory === category
// //                   ? 'bg-blue-500 text-white shadow-lg shadow-blue-500/30'
// //                   : 'text-gray-400 hover:text-white'
// //               )}
// //             >
// //               {category}
// //             </motion.button>
// //           ))}
// //         </div>
// //       </motion.div>

// //       {/* Products Table */}
// //       <motion.div
// //         initial={{ opacity: 0, y: 20 }}
// //         animate={{ opacity: 1, y: 0 }}
// //         transition={{ delay: 0.3, duration: 0.5 }}
// //         className="overflow-hidden rounded-2xl border border-white/10 bg-white/[0.02] backdrop-blur-sm"
// //       >
// //         <div className="overflow-x-auto">
// //           <table className="w-full">
// //             <thead>
// //               <tr className="border-b border-white/10 bg-white/5">
// //                 <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Product</th>
// //                 <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Category</th>
// //                 <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Models</th>
// //                 <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Price</th>
// //                 <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Stock</th>
// //                 <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Actions</th>
// //               </tr>
// //             </thead>
// //             <tbody className="divide-y divide-white/5">
// //               {filteredProducts.length === 0 ? (
// //                  <tr>
// //                   <td colSpan={6} className="px-6 py-12 text-center text-gray-400">
// //                     <Package className="h-12 w-12 mx-auto mb-3 text-gray-600" />
// //                     <p>No products found</p>
// //                   </td>
// //                 </tr>
// //               ) : (
// //                 filteredProducts.map((product, index) => (
// //                   <motion.tr
// //                     key={product._id}
// //                     initial={{ opacity: 0, x: -20 }}
// //                     animate={{ opacity: 1, x: 0 }}
// //                     transition={{ delay: 0.05 * index, duration: 0.3 }}
// //                     whileHover={{ backgroundColor: 'rgba(255, 255, 255, 0.02)' }}
// //                     className="transition-colors group"
// //                   >
// //                     {/* ... (Existing Columns: Product, Category, Models, Price, Stock) ... */}
// //                     <td className="px-6 py-4">
// //                       <div className="flex items-center gap-3">
// //                         <div className="relative h-12 w-12 overflow-hidden rounded-lg bg-white/5 border border-white/10 flex-shrink-0">
// //                           {product.images && product.images[0] ? (
// //                             <Image src={product.images[0].url} alt={product.name} fill className="object-cover transition-transform group-hover:scale-110" />
// //                           ) : (
// //                             <div className="flex h-full w-full items-center justify-center text-gray-500"><Package className="h-6 w-6" /></div>
// //                           )}
// //                         </div>
// //                         <div>
// //                           <p className="font-medium text-white line-clamp-1">{product.name}</p>
// //                           <code className="text-xs text-cyan-400 bg-cyan-400/10 px-1.5 py-0.5 rounded">{product.partNumber}</code>
// //                         </div>
// //                       </div>
// //                     </td>
// //                     <td className="px-6 py-4">
// //                       <span className="rounded-full bg-blue-500/10 px-3 py-1 text-xs font-medium text-blue-400">{product.category}</span>
// //                     </td>
// //                     <td className="px-6 py-4 max-w-[200px]">
// //                       <div className="flex flex-wrap gap-1">
// //                         {product.compatibleModels?.slice(0, 2).map((model, i) => (
// //                            <span key={i} className="inline-flex items-center gap-1 rounded bg-white/5 px-2 py-0.5 text-[10px] text-gray-300 border border-white/10">
// //                               <Car className="h-3 w-3 text-gray-500" />{model.modelName}
// //                            </span>
// //                         ))}
// //                         {product.compatibleModels?.length > 2 && <span className="text-[10px] text-gray-500 pl-1">+{product.compatibleModels.length - 2} more</span>}
// //                       </div>
// //                     </td>
// //                     <td className="px-6 py-4">
// //                         <p className="font-semibold text-white">{formatCurrency(product.finalPrice || product.price)}</p>
// //                     </td>
// //                     <td className="px-6 py-4">
// //                       <span className={cn('text-[10px] font-medium px-2 py-0.5 rounded-full border', product.stock > (product.lowStockThreshold || 5) ? 'bg-green-500/10 text-green-400 border-green-500/20' : 'bg-red-500/10 text-red-400 border-red-500/20')}>
// //                           {product.stockStatus || (product.stock > 0 ? 'In Stock' : 'Out of Stock')}
// //                       </span>
// //                     </td>

// //                     {/* ACTIONS COLUMN */}
// //                     <td className="px-6 py-4">
// //                       <div className="flex items-center gap-2">
// //                         <Link href={`/dashboard/products/${product._id}`}>
// //                             <motion.button whileHover={{ scale: 1.1 }} whileTap={{ scale: 0.9 }} className="rounded-lg bg-blue-500/10 p-2 text-blue-400 transition-colors hover:bg-blue-500/20" title="View Details"><Eye className="h-4 w-4" /></motion.button>
// //                         </Link>
// //                         <Link href={`/dashboard/products/edit/${product._id}`}>
// //                             <motion.button whileHover={{ scale: 1.1 }} whileTap={{ scale: 0.9 }} className="rounded-lg bg-yellow-500/10 p-2 text-yellow-400 transition-colors hover:bg-yellow-500/20" title="Edit Product"><Edit className="h-4 w-4" /></motion.button>
// //                         </Link>
// //                         {/* Trigger Delete Modal */}
// //                         <motion.button
// //                           whileHover={{ scale: 1.1 }}
// //                           whileTap={{ scale: 0.9 }}
// //                           onClick={() => openDeleteModal(product._id)}
// //                           className="rounded-lg bg-red-500/10 p-2 text-red-400 transition-colors hover:bg-red-500/20"
// //                           title="Delete Product"
// //                         >
// //                           <Trash2 className="h-4 w-4" />
// //                         </motion.button>
// //                       </div>
// //                     </td>
// //                   </motion.tr>
// //                 ))
// //               )}
// //             </tbody>
// //           </table>
// //         </div>
// //       </motion.div>

// //       {/* --- BEAUTIFUL DELETE CONFIRMATION MODAL --- */}
// //       <AnimatePresence>
// //         {deleteId && (
// //           <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
// //             {/* Backdrop with Blur */}
// //             <motion.div
// //               initial={{ opacity: 0 }}
// //               animate={{ opacity: 1 }}
// //               exit={{ opacity: 0 }}
// //               onClick={closeDeleteModal}
// //               className="absolute inset-0 bg-black/60 backdrop-blur-sm"
// //             />

// //             {/* Modal Content */}
// //             <motion.div
// //               initial={{ opacity: 0, scale: 0.95, y: 20 }}
// //               animate={{ opacity: 1, scale: 1, y: 0 }}
// //               exit={{ opacity: 0, scale: 0.95, y: 20 }}
// //               className="relative w-full max-w-md overflow-hidden rounded-2xl border border-white/10 bg-gray-900 p-6 shadow-2xl"
// //             >
// //               {/* Close Button */}
// //               <button
// //                 onClick={closeDeleteModal}
// //                 className="absolute right-4 top-4 text-gray-400 hover:text-white"
// //               >
// //                 <X className="h-5 w-5" />
// //               </button>

// //               <div className="flex flex-col items-center text-center">
// //                 {/* Warning Icon */}
// //                 <div className="mb-4 rounded-full bg-red-500/10 p-4">
// //                   <AlertTriangle className="h-8 w-8 text-red-500" />
// //                 </div>

// //                 <h3 className="mb-2 text-xl font-bold text-white">Delete Product?</h3>
// //                 <p className="mb-6 text-sm text-gray-400 leading-relaxed">
// //                   Are you sure you want to delete this product? <br/>
// //                   This action cannot be undone and will remove the item from inventory.
// //                 </p>

// //                 <div className="flex w-full gap-3">
// //                   <button
// //                     onClick={closeDeleteModal}
// //                     disabled={isDeleting}
// //                     className="flex-1 rounded-xl border border-white/10 bg-white/5 py-3 text-sm font-medium text-white transition-colors hover:bg-white/10 disabled:opacity-50"
// //                   >
// //                     Cancel
// //                   </button>
// //                   <button
// //                     onClick={executeDelete}
// //                     disabled={isDeleting}
// //                     className="flex-1 rounded-xl bg-red-500 py-3 text-sm font-medium text-white transition-colors hover:bg-red-600 disabled:opacity-50 flex justify-center items-center gap-2"
// //                   >
// //                      {isDeleting ? (
// //                        <>
// //                          <div className="h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent" />
// //                          <span>Deleting...</span>
// //                        </>
// //                      ) : (
// //                        <>
// //                          <Trash2 className="h-4 w-4" />
// //                          <span>Delete Forever</span>
// //                        </>
// //                      )}
// //                   </button>
// //                 </div>
// //               </div>
// //             </motion.div>
// //           </div>
// //         )}
// //       </AnimatePresence>
// //     </div>
// //   );
// // }

// // 'use client';

// // import { useEffect, useState } from 'react';
// // import { motion } from 'framer-motion';
// // import {
// //   Package,
// //   Search,
// //   Plus,
// //   Edit,
// //   Trash2,
// //   Eye,
// //   RefreshCcw,
// //   Car, // Added Car icon for models
// // } from 'lucide-react';
// // import Button from '@/components/ui/Button';
// // import { TableSkeleton } from '@/components/ui/Skeleton';
// // import { ProductService } from '@/lib/api';
// // import { Product } from '@/types';
// // import { toast } from 'sonner';
// // import { formatCurrency, cn } from '@/lib/utils';
// // import Image from 'next/image';
// // import Link from 'next/link';

// // export default function ProductsPage() {
// //   const [products, setProducts] = useState<Product[]>([]);
// //   const [isLoading, setIsLoading] = useState(true);
// //   const [searchQuery, setSearchQuery] = useState('');
// //   const [selectedCategory, setSelectedCategory] = useState('All');

// //   useEffect(() => {
// //     fetchProducts();
// //   }, []);

// //   const fetchProducts = async () => {
// //     try {
// //       setIsLoading(true);
// //       const response = await ProductService.getAll();
// //       const incomingData = response.data.data || [];

// //       if (Array.isArray(incomingData)) {
// //         setProducts(incomingData);
// //       } else {
// //         setProducts([]);
// //       }
// //     } catch (error: any) {
// //       console.error('Products fetch error:', error);
// //       toast.error('Failed to fetch products');
// //       setProducts([]);
// //     } finally {
// //       setIsLoading(false);
// //     }
// //   };

// //   const handleDeleteProduct = async (id: string) => {
// //     if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) return;

// //     try {
// //       await ProductService.delete(id);
// //       toast.success('Product deleted successfully');
// //       // Optimistic update or refetch
// //       setProducts(products.filter(p => p._id !== id));
// //     } catch (error: any) {
// //       console.error("Delete Error:", error);
// //       toast.error(error.response?.data?.message || 'Failed to delete product');
// //     }
// //   };

// //   // Safe Filtering Logic
// //   const safeProducts = Array.isArray(products) ? products : [];

// //   const filteredProducts = safeProducts.filter((product) => {
// //     const matchesSearch =
// //       (product.name || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
// //       (product.partNumber || '').toLowerCase().includes(searchQuery.toLowerCase());
// //     const matchesCategory =
// //       selectedCategory === 'All' || product.category === selectedCategory;
// //     return matchesSearch && matchesCategory;
// //   });

// //   const categories = ['All', ...new Set(safeProducts.map((p) => p.category).filter(Boolean))];

// //   if (isLoading) {
// //     return (
// //       <div className="space-y-6">
// //         <div className="flex items-center justify-between">
// //           <h1 className="text-3xl font-bold text-white">Products</h1>
// //         </div>
// //         <TableSkeleton />
// //       </div>
// //     );
// //   }

// //   return (
// //     <div className="space-y-6 pb-20">
// //       {/* Header */}
// //       <motion.div
// //         initial={{ opacity: 0, y: -20 }}
// //         animate={{ opacity: 1, y: 0 }}
// //         transition={{ duration: 0.5 }}
// //         className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between"
// //       >
// //         <div>
// //           <h1 className="text-3xl font-bold text-white">Products</h1>
// //           <p className="mt-1 text-gray-400">
// //             Manage your spare parts inventory
// //           </p>
// //         </div>
// //         <div className="flex gap-2">
// //            <button
// //              onClick={fetchProducts}
// //              className="flex items-center gap-2 rounded-lg bg-white/5 px-4 py-2 text-sm font-medium text-white hover:bg-white/10 transition-colors"
// //            >
// //              <RefreshCcw className="h-4 w-4" />
// //              Refresh
// //            </button>
// //            <Link href="/dashboard/products/add">
// //              <Button variant="primary" size="md">
// //                <Plus className="h-4 w-4 mr-2" />
// //                Add Product
// //              </Button>
// //            </Link>
// //         </div>
// //       </motion.div>

// //       {/* Filters */}
// //       <motion.div
// //         initial={{ opacity: 0, y: 20 }}
// //         animate={{ opacity: 1, y: 0 }}
// //         transition={{ delay: 0.1, duration: 0.5 }}
// //         className="flex flex-wrap items-center gap-4"
// //       >
// //         {/* Search */}
// //         <div className="relative flex-1 min-w-[300px]">
// //           <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400" />
// //           <input
// //             type="text"
// //             placeholder="Search by name, part number..."
// //             value={searchQuery}
// //             onChange={(e) => setSearchQuery(e.target.value)}
// //             className="w-full rounded-xl border border-white/10 bg-white/5 py-2.5 pl-10 pr-4 text-sm text-white placeholder-gray-400 backdrop-blur-sm transition-all focus:border-blue-500/30 focus:bg-white/10 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
// //           />
// //         </div>

// //         {/* Category Filter */}
// //         <div className="flex items-center gap-2 overflow-x-auto rounded-xl border border-white/10 bg-white/5 p-1 backdrop-blur-sm scrollbar-hide">
// //           {categories.map((category) => (
// //             <motion.button
// //               key={category}
// //               whileHover={{ scale: 1.05 }}
// //               whileTap={{ scale: 0.95 }}
// //               onClick={() => setSelectedCategory(category)}
// //               className={cn(
// //                 'whitespace-nowrap rounded-lg px-4 py-2 text-sm font-medium transition-all',
// //                 selectedCategory === category
// //                   ? 'bg-blue-500 text-white shadow-lg shadow-blue-500/30'
// //                   : 'text-gray-400 hover:text-white'
// //               )}
// //             >
// //               {category}
// //             </motion.button>
// //           ))}
// //         </div>
// //       </motion.div>

// //       {/* Stats Cards */}
// //       <motion.div
// //         initial={{ opacity: 0, y: 20 }}
// //         animate={{ opacity: 1, y: 0 }}
// //         transition={{ delay: 0.2, duration: 0.5 }}
// //         className="grid gap-4 sm:grid-cols-3"
// //       >
// //         <div className="rounded-xl border border-white/10 bg-white/5 p-4 backdrop-blur-sm">
// //           <p className="text-sm text-gray-400">Total Products</p>
// //           <p className="mt-1 text-2xl font-bold text-white">{safeProducts.length}</p>
// //         </div>
// //         <div className="rounded-xl border border-white/10 bg-white/5 p-4 backdrop-blur-sm">
// //           <p className="text-sm text-gray-400">Low Stock Items</p>
// //           <p className="mt-1 text-2xl font-bold text-yellow-400">
// //             {safeProducts.filter((p) => p.stockStatus === 'Low Stock').length}
// //           </p>
// //         </div>
// //         <div className="rounded-xl border border-white/10 bg-white/5 p-4 backdrop-blur-sm">
// //           <p className="text-sm text-gray-400">Out of Stock</p>
// //           <p className="mt-1 text-2xl font-bold text-red-400">
// //             {safeProducts.filter((p) => p.stockStatus === 'Out of Stock').length}
// //           </p>
// //         </div>
// //       </motion.div>

// //       {/* Products Table */}
// //       <motion.div
// //         initial={{ opacity: 0, y: 20 }}
// //         animate={{ opacity: 1, y: 0 }}
// //         transition={{ delay: 0.3, duration: 0.5 }}
// //         className="overflow-hidden rounded-2xl border border-white/10 bg-white/[0.02] backdrop-blur-sm"
// //       >
// //         <div className="overflow-x-auto">
// //           <table className="w-full">
// //             <thead>
// //               <tr className="border-b border-white/10 bg-white/5">
// //                 <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Product</th>
// //                 <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Category</th>
// //                 <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Models</th>
// //                 <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Price</th>
// //                 <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Stock</th>
// //                 <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Actions</th>
// //               </tr>
// //             </thead>
// //             <tbody className="divide-y divide-white/5">
// //               {filteredProducts.length === 0 ? (
// //                  <tr>
// //                   <td colSpan={6} className="px-6 py-12 text-center text-gray-400">
// //                     <Package className="h-12 w-12 mx-auto mb-3 text-gray-600" />
// //                     <p>No products found</p>
// //                   </td>
// //                 </tr>
// //               ) : (
// //                 filteredProducts.map((product, index) => (
// //                   <motion.tr
// //                     key={product._id}
// //                     initial={{ opacity: 0, x: -20 }}
// //                     animate={{ opacity: 1, x: 0 }}
// //                     transition={{ delay: 0.05 * index, duration: 0.3 }}
// //                     whileHover={{ backgroundColor: 'rgba(255, 255, 255, 0.02)' }}
// //                     className="transition-colors group"
// //                   >
// //                     <td className="px-6 py-4">
// //                       <div className="flex items-center gap-3">
// //                         <div className="relative h-12 w-12 overflow-hidden rounded-lg bg-white/5 border border-white/10 flex-shrink-0">
// //                           {product.images && product.images[0] ? (
// //                             <Image
// //                               src={product.images[0].url}
// //                               alt={product.name}
// //                               fill
// //                               className="object-cover transition-transform group-hover:scale-110"
// //                             />
// //                           ) : (
// //                             <div className="flex h-full w-full items-center justify-center text-gray-500">
// //                               <Package className="h-6 w-6" />
// //                             </div>
// //                           )}
// //                         </div>
// //                         <div>
// //                           <p className="font-medium text-white line-clamp-1">{product.name}</p>
// //                           <code className="text-xs text-cyan-400 bg-cyan-400/10 px-1.5 py-0.5 rounded">
// //                             {product.partNumber}
// //                           </code>
// //                         </div>
// //                       </div>
// //                     </td>

// //                     <td className="px-6 py-4">
// //                       <span className="rounded-full bg-blue-500/10 px-3 py-1 text-xs font-medium text-blue-400">
// //                         {product.category}
// //                       </span>
// //                       {product.subcategory && (
// //                         <p className="text-[10px] text-gray-500 mt-1 ml-2">{product.subcategory}</p>
// //                       )}
// //                     </td>

// //                     {/* NEW: Compatible Models Column */}
// //                     <td className="px-6 py-4 max-w-[200px]">
// //                       <div className="flex flex-wrap gap-1">
// //                         {product.compatibleModels?.slice(0, 3).map((model, i) => (
// //                            <span key={i} className="inline-flex items-center gap-1 rounded bg-white/5 px-2 py-0.5 text-[10px] text-gray-300 border border-white/10">
// //                               <Car className="h-3 w-3 text-gray-500" />
// //                               {model.modelName}
// //                            </span>
// //                         ))}
// //                         {product.compatibleModels?.length > 3 && (
// //                            <span className="text-[10px] text-gray-500 pl-1">
// //                              +{product.compatibleModels.length - 3} more
// //                            </span>
// //                         )}
// //                       </div>
// //                     </td>

// //                     <td className="px-6 py-4">
// //                       <div>
// //                         <p className="font-semibold text-white">
// //                           {formatCurrency(product.finalPrice || product.price)}
// //                         </p>
// //                         {product.discountPrice && product.discountPrice < product.price && (
// //                           <p className="text-xs text-gray-400 line-through">
// //                             {formatCurrency(product.price)}
// //                           </p>
// //                         )}
// //                       </div>
// //                     </td>

// //                     <td className="px-6 py-4">
// //                       <div className="flex items-center gap-2">
// //                         <span className="font-medium text-white">
// //                           {product.stock}
// //                         </span>
// //                         <span
// //                           className={cn(
// //                             'text-[10px] font-medium px-2 py-0.5 rounded-full border',
// //                             product.stockStatus === 'In Stock'
// //                                 ? 'bg-green-500/10 text-green-400 border-green-500/20'
// //                                 : product.stockStatus === 'Low Stock'
// //                                 ? 'bg-yellow-500/10 text-yellow-400 border-yellow-500/20'
// //                                 : 'bg-red-500/10 text-red-400 border-red-500/20'
// //                           )}
// //                         >
// //                           {product.stockStatus}
// //                         </span>
// //                       </div>
// //                     </td>

// //                     <td className="px-6 py-4">
// //                       <div className="flex items-center gap-2">
// //                         {/* VIEW ACTION */}
// //                         <Link href={`/dashboard/products/${product._id}`}>
// //                             <motion.button
// //                             whileHover={{ scale: 1.1 }}
// //                             whileTap={{ scale: 0.9 }}
// //                             className="rounded-lg bg-blue-500/10 p-2 text-blue-400 transition-colors hover:bg-blue-500/20"
// //                             title="View Details"
// //                             >
// //                             <Eye className="h-4 w-4" />
// //                             </motion.button>
// //                         </Link>

// //                         {/* EDIT ACTION */}
// //                         <Link href={`/dashboard/products/edit/${product._id}`}>
// //                             <motion.button
// //                             whileHover={{ scale: 1.1 }}
// //                             whileTap={{ scale: 0.9 }}
// //                             className="rounded-lg bg-yellow-500/10 p-2 text-yellow-400 transition-colors hover:bg-yellow-500/20"
// //                             title="Edit Product"
// //                             >
// //                             <Edit className="h-4 w-4" />
// //                             </motion.button>
// //                         </Link>

// //                         {/* DELETE ACTION */}
// //                         <motion.button
// //                           whileHover={{ scale: 1.1 }}
// //                           whileTap={{ scale: 0.9 }}
// //                           onClick={() => handleDeleteProduct(product._id)}
// //                           className="rounded-lg bg-red-500/10 p-2 text-red-400 transition-colors hover:bg-red-500/20"
// //                           title="Delete Product"
// //                         >
// //                           <Trash2 className="h-4 w-4" />
// //                         </motion.button>
// //                       </div>
// //                     </td>
// //                   </motion.tr>
// //                 ))
// //               )}
// //             </tbody>
// //           </table>
// //         </div>
// //       </motion.div>
// //     </div>
// //   );
// // }

// 'use client';

// import { useEffect, useState } from 'react';
// import { motion, AnimatePresence } from 'framer-motion';
// import {
//   Package,
//   Search,
//   Plus,
//   Edit,
//   Trash2,
//   Eye,
//   RefreshCcw,
//   Car,
//   AlertTriangle,
//   X,
//   Layers,
//   DollarSign,
//   AlertCircle
// } from 'lucide-react';
// import Button from '@/components/ui/Button';
// import { TableSkeleton } from '@/components/ui/Skeleton';
// import { ProductService } from '@/lib/api';
// import { Product } from '@/types';
// import { toast } from 'sonner';
// import { formatCurrency, cn } from '@/lib/utils';
// import Image from 'next/image';
// import Link from 'next/link';

// export default function ProductsPage() {
//   const [products, setProducts] = useState<Product[]>([]);
//   const [isLoading, setIsLoading] = useState(true);
//   const [searchQuery, setSearchQuery] = useState('');
//   const [selectedCategory, setSelectedCategory] = useState('All');

//   // --- DELETE MODAL STATE ---
//   const [deleteId, setDeleteId] = useState<string | null>(null);
//   const [isDeleting, setIsDeleting] = useState(false);

//   useEffect(() => {
//     fetchProducts();
//   }, []);

//   const fetchProducts = async () => {
//     try {
//       setIsLoading(true);
//       const response = await ProductService.getAll();
//       const incomingData = response.data.data || [];

//       if (Array.isArray(incomingData)) {
//         setProducts(incomingData);
//       } else {
//         setProducts([]);
//       }
//     } catch (error: any) {
//       console.error('Products fetch error:', error);
//       toast.error('Failed to fetch products');
//       setProducts([]);
//     } finally {
//       setIsLoading(false);
//     }
//   };

//   // 1. Open Modal
//   const openDeleteModal = (id: string) => {
//     setDeleteId(id);
//   };

//   // 2. Close Modal
//   const closeDeleteModal = () => {
//     setDeleteId(null);
//   };

//   // 3. Execute Delete (API Call)
//   const executeDelete = async () => {
//     if (!deleteId) return;

//     setIsDeleting(true);
//     try {
//       await ProductService.delete(deleteId);
//       toast.success('Product deleted successfully');
//       setProducts(prev => prev.filter(p => p._id !== deleteId));
//       closeDeleteModal();
//     } catch (error: any) {
//       console.error("Delete Error:", error);
//       toast.error(error.response?.data?.message || 'Failed to delete product');
//     } finally {
//       setIsDeleting(false);
//     }
//   };

//   const safeProducts = Array.isArray(products) ? products : [];

//   const filteredProducts = safeProducts.filter((product) => {
//     const matchesSearch =
//       (product.name || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
//       (product.partNumber || '').toLowerCase().includes(searchQuery.toLowerCase());
//     const matchesCategory =
//       selectedCategory === 'All' || product.category === selectedCategory;
//     return matchesSearch && matchesCategory;
//   });

//   const categories = ['All', ...new Set(safeProducts.map((p) => p.category).filter(Boolean))];

//   // Calculate Summary Stats
//   const totalProducts = safeProducts.length;
//   const lowStockCount = safeProducts.filter(p => p.stock <= (p.lowStockThreshold || 5)).length;
//   const outOfStockCount = safeProducts.filter(p => p.stock === 0).length;
//   const totalInventoryValue = safeProducts.reduce((sum, p) => sum + (p.price * p.stock), 0);

//   if (isLoading) {
//     return (
//       <div className="space-y-6">
//         <div className="flex items-center justify-between">
//           <h1 className="text-3xl font-bold text-white">Products</h1>
//         </div>
//         <TableSkeleton />
//       </div>
//     );
//   }

//   return (
//     <div className="space-y-6 pb-20">
//       {/* Header */}
//       <motion.div
//         initial={{ opacity: 0, y: -20 }}
//         animate={{ opacity: 1, y: 0 }}
//         transition={{ duration: 0.5 }}
//         className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between"
//       >
//         <div>
//           <h1 className="text-3xl font-bold text-white">Products</h1>
//           <p className="mt-1 text-gray-400">
//             Manage your spare parts inventory
//           </p>
//         </div>
//         <div className="flex gap-2">
//            <button
//              onClick={fetchProducts}
//              className="flex items-center gap-2 rounded-lg bg-white/5 px-4 py-2 text-sm font-medium text-white hover:bg-white/10 transition-colors"
//            >
//              <RefreshCcw className="h-4 w-4" />
//              Refresh
//            </button>
//            <Link href="/dashboard/products/add">
//              <Button variant="primary" size="md">
//                <Plus className="h-4 w-4 mr-2" />
//                Add Product
//              </Button>
//            </Link>
//         </div>
//       </motion.div>

//       {/* --- SUMMARY CARDS SECTION --- */}
//       <motion.div
//         initial={{ opacity: 0, y: 20 }}
//         animate={{ opacity: 1, y: 0 }}
//         transition={{ delay: 0.1, duration: 0.5 }}
//         className="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4"
//       >
//         <div className="rounded-xl border border-white/10 bg-white/5 backdrop-blur-sm p-4 transition-colors hover:bg-white/10">
//           <div className="flex items-center gap-4">
//             <div className="rounded-lg bg-blue-500/10 p-3 text-blue-400">
//               <Package className="h-6 w-6" />
//             </div>
//             <div>
//               <p className="text-sm font-medium text-gray-400">Total Products</p>
//               <p className="text-2xl font-bold text-white">{totalProducts}</p>
//             </div>
//           </div>
//         </div>

//         <div className="rounded-xl border border-white/10 bg-white/5 backdrop-blur-sm p-4 transition-colors hover:bg-white/10">
//           <div className="flex items-center gap-4">
//             <div className="rounded-lg bg-yellow-500/10 p-3 text-yellow-400">
//               <AlertTriangle className="h-6 w-6" />
//             </div>
//             <div>
//               <p className="text-sm font-medium text-gray-400">Low Stock</p>
//               <p className="text-2xl font-bold text-white">{lowStockCount}</p>
//             </div>
//           </div>
//         </div>

//         <div className="rounded-xl border border-white/10 bg-white/5 backdrop-blur-sm p-4 transition-colors hover:bg-white/10">
//           <div className="flex items-center gap-4">
//              <div className="rounded-lg bg-red-500/10 p-3 text-red-400">
//               <AlertCircle className="h-6 w-6" />
//             </div>
//             <div>
//               <p className="text-sm font-medium text-gray-400">Out of Stock</p>
//               <p className="text-2xl font-bold text-white">{outOfStockCount}</p>
//             </div>
//           </div>
//         </div>

//         <div className="rounded-xl border border-white/10 bg-white/5 backdrop-blur-sm p-4 transition-colors hover:bg-white/10">
//           <div className="flex items-center gap-4">
//             <div className="rounded-lg bg-green-500/10 p-3 text-green-400">
//               <DollarSign className="h-6 w-6" />
//             </div>
//             <div>
//               <p className="text-sm font-medium text-gray-400">Total Value</p>
//               <p className="text-2xl font-bold text-white">{formatCurrency(totalInventoryValue)}</p>
//             </div>
//           </div>
//         </div>
//       </motion.div>

//       {/* Filters */}
//       <motion.div
//         initial={{ opacity: 0, y: 20 }}
//         animate={{ opacity: 1, y: 0 }}
//         transition={{ delay: 0.2, duration: 0.5 }}
//         className="flex flex-wrap items-center gap-4"
//       >
//         <div className="relative flex-1 min-w-[300px]">
//           <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400" />
//           <input
//             type="text"
//             placeholder="Search by name or part number..."
//             value={searchQuery}
//             onChange={(e) => setSearchQuery(e.target.value)}
//             className="w-full rounded-xl border border-white/10 bg-white/5 py-2.5 pl-10 pr-4 text-sm text-white placeholder-gray-400 backdrop-blur-sm transition-all focus:border-blue-500/30 focus:bg-white/10 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
//           />
//         </div>

//         <div className="flex items-center gap-2 overflow-x-auto rounded-xl border border-white/10 bg-white/5 p-1 backdrop-blur-sm scrollbar-hide">
//           {categories.map((category) => (
//             <motion.button
//               key={category}
//               whileHover={{ scale: 1.05 }}
//               whileTap={{ scale: 0.95 }}
//               onClick={() => setSelectedCategory(category)}
//               className={cn(
//                 'whitespace-nowrap rounded-lg px-4 py-2 text-sm font-medium transition-all',
//                 selectedCategory === category
//                   ? 'bg-blue-500 text-white shadow-lg shadow-blue-500/30'
//                   : 'text-gray-400 hover:text-white'
//               )}
//             >
//               {category}
//             </motion.button>
//           ))}
//         </div>
//       </motion.div>

//       {/* Products Table */}
//       <motion.div
//         initial={{ opacity: 0, y: 20 }}
//         animate={{ opacity: 1, y: 0 }}
//         transition={{ delay: 0.3, duration: 0.5 }}
//         className="overflow-hidden rounded-2xl border border-white/10 bg-white/[0.02] backdrop-blur-sm"
//       >
//         <div className="overflow-x-auto">
//           <table className="w-full">
//             <thead>
//               <tr className="border-b border-white/10 bg-white/5">
//                 <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Product</th>
//                 <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Category</th>
//                 <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Models</th>
//                 <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Price</th>
//                 <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Stock</th>
//                 <th className="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Actions</th>
//               </tr>
//             </thead>
//             <tbody className="divide-y divide-white/5">
//               {filteredProducts.length === 0 ? (
//                  <tr>
//                   <td colSpan={6} className="px-6 py-12 text-center text-gray-400">
//                     <Package className="h-12 w-12 mx-auto mb-3 text-gray-600" />
//                     <p>No products found</p>
//                   </td>
//                 </tr>
//               ) : (
//                 filteredProducts.map((product, index) => (
//                   <motion.tr
//                     key={product._id}
//                     initial={{ opacity: 0, x: -20 }}
//                     animate={{ opacity: 1, x: 0 }}
//                     transition={{ delay: 0.05 * index, duration: 0.3 }}
//                     whileHover={{ backgroundColor: 'rgba(255, 255, 255, 0.02)' }}
//                     className="transition-colors group"
//                   >
//                     <td className="px-6 py-4">
//                       <div className="flex items-center gap-3">
//                         <div className="relative h-12 w-12 overflow-hidden rounded-lg bg-white/5 border border-white/10 flex-shrink-0">
//                           {product.images && product.images[0] ? (
//                             <Image src={product.images[0].url} alt={product.name} fill className="object-cover transition-transform group-hover:scale-110" />
//                           ) : (
//                             <div className="flex h-full w-full items-center justify-center text-gray-500"><Package className="h-6 w-6" /></div>
//                           )}
//                         </div>
//                         <div>
//                           <p className="font-medium text-white line-clamp-1">{product.name}</p>
//                           <code className="text-xs text-cyan-400 bg-cyan-400/10 px-1.5 py-0.5 rounded">{product.partNumber}</code>
//                         </div>
//                       </div>
//                     </td>
//                     <td className="px-6 py-4">
//                       <span className="rounded-full bg-blue-500/10 px-3 py-1 text-xs font-medium text-blue-400">{product.category}</span>
//                     </td>
//                     <td className="px-6 py-4 max-w-[200px]">
//                       <div className="flex flex-wrap gap-1">
//                         {product.compatibleModels?.slice(0, 2).map((model, i) => (
//                            <span key={i} className="inline-flex items-center gap-1 rounded bg-white/5 px-2 py-0.5 text-[10px] text-gray-300 border border-white/10">
//                               <Car className="h-3 w-3 text-gray-500" />{model.modelName}
//                            </span>
//                         ))}
//                         {product.compatibleModels?.length > 2 && <span className="text-[10px] text-gray-500 pl-1">+{product.compatibleModels.length - 2} more</span>}
//                       </div>
//                     </td>
//                     <td className="px-6 py-4">
//                         <p className="font-semibold text-white">{formatCurrency(product.finalPrice || product.price)}</p>
//                     </td>

//                     {/* --- UPDATED STOCK COLUMN --- */}
//                     <td className="px-6 py-4">
//                       <div className="flex flex-col gap-1.5">
//                         <span className="text-sm font-semibold text-white">{product.stock} Units</span>
//                         <span className={cn('text-[10px] w-fit font-medium px-2 py-0.5 rounded-full border',
//                           product.stock > (product.lowStockThreshold || 5)
//                             ? 'bg-green-500/10 text-green-400 border-green-500/20'
//                             : product.stock === 0
//                               ? 'bg-red-500/10 text-red-400 border-red-500/20'
//                               : 'bg-yellow-500/10 text-yellow-400 border-yellow-500/20'
//                         )}>
//                             {product.stockStatus || (product.stock > 0 ? 'In Stock' : 'Out of Stock')}
//                         </span>
//                       </div>
//                     </td>

//                     <td className="px-6 py-4">
//                       <div className="flex items-center gap-2">
//                         <Link href={`/dashboard/products/${product._id}`}>
//                             <motion.button whileHover={{ scale: 1.1 }} whileTap={{ scale: 0.9 }} className="rounded-lg bg-blue-500/10 p-2 text-blue-400 transition-colors hover:bg-blue-500/20" title="View Details"><Eye className="h-4 w-4" /></motion.button>
//                         </Link>
//                         <Link href={`/dashboard/products/edit/${product._id}`}>
//                             <motion.button whileHover={{ scale: 1.1 }} whileTap={{ scale: 0.9 }} className="rounded-lg bg-yellow-500/10 p-2 text-yellow-400 transition-colors hover:bg-yellow-500/20" title="Edit Product"><Edit className="h-4 w-4" /></motion.button>
//                         </Link>
//                         <motion.button
//                           whileHover={{ scale: 1.1 }}
//                           whileTap={{ scale: 0.9 }}
//                           onClick={() => openDeleteModal(product._id)}
//                           className="rounded-lg bg-red-500/10 p-2 text-red-400 transition-colors hover:bg-red-500/20"
//                           title="Delete Product"
//                         >
//                           <Trash2 className="h-4 w-4" />
//                         </motion.button>
//                       </div>
//                     </td>
//                   </motion.tr>
//                 ))
//               )}
//             </tbody>
//           </table>
//         </div>
//       </motion.div>

//       {/* --- DELETE CONFIRMATION MODAL --- */}
//       <AnimatePresence>
//         {deleteId && (
//           <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
//             <motion.div
//               initial={{ opacity: 0 }}
//               animate={{ opacity: 1 }}
//               exit={{ opacity: 0 }}
//               onClick={closeDeleteModal}
//               className="absolute inset-0 bg-black/60 backdrop-blur-sm"
//             />
//             <motion.div
//               initial={{ opacity: 0, scale: 0.95, y: 20 }}
//               animate={{ opacity: 1, scale: 1, y: 0 }}
//               exit={{ opacity: 0, scale: 0.95, y: 20 }}
//               className="relative w-full max-w-md overflow-hidden rounded-2xl border border-white/10 bg-gray-900 p-6 shadow-2xl"
//             >
//               <button onClick={closeDeleteModal} className="absolute right-4 top-4 text-gray-400 hover:text-white">
//                 <X className="h-5 w-5" />
//               </button>
//               <div className="flex flex-col items-center text-center">
//                 <div className="mb-4 rounded-full bg-red-500/10 p-4">
//                   <AlertTriangle className="h-8 w-8 text-red-500" />
//                 </div>
//                 <h3 className="mb-2 text-xl font-bold text-white">Delete Product?</h3>
//                 <p className="mb-6 text-sm text-gray-400 leading-relaxed">
//                   Are you sure you want to delete this product? <br/>
//                   This action cannot be undone and will remove the item from inventory.
//                 </p>
//                 <div className="flex w-full gap-3">
//                   <button
//                     onClick={closeDeleteModal}
//                     disabled={isDeleting}
//                     className="flex-1 rounded-xl border border-white/10 bg-white/5 py-3 text-sm font-medium text-white transition-colors hover:bg-white/10 disabled:opacity-50"
//                   >
//                     Cancel
//                   </button>
//                   <button
//                     onClick={executeDelete}
//                     disabled={isDeleting}
//                     className="flex-1 rounded-xl bg-red-500 py-3 text-sm font-medium text-white transition-colors hover:bg-red-600 disabled:opacity-50 flex justify-center items-center gap-2"
//                   >
//                      {isDeleting ? (
//                        <>
//                          <div className="h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent" />
//                          <span>Deleting...</span>
//                        </>
//                      ) : (
//                        <>
//                          <Trash2 className="h-4 w-4" />
//                          <span>Delete Forever</span>
//                        </>
//                      )}
//                   </button>
//                 </div>
//               </div>
//             </motion.div>
//           </div>
//         )}
//       </AnimatePresence>
//     </div>
//   );
// }

"use client";

import { useEffect, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import {
  Package,
  Search,
  Plus,
  Edit,
  Trash2,
  Eye,
  RefreshCcw,
  Car,
  AlertTriangle,
  X,
  DollarSign,
  AlertCircle,
} from "lucide-react";
import Button from "@/components/ui/Button";
import { TableSkeleton } from "@/components/ui/Skeleton";
import { ProductService } from "@/lib/api";
import { Product } from "@/types";
import { toast } from "sonner";
import { formatCurrency, cn } from "@/lib/utils";
import Image from "next/image";
import Link from "next/link";

export default function ProductsPage() {
  const [products, setProducts] = useState<Product[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState("");
  const [selectedCategory, setSelectedCategory] = useState("All");

  // --- DELETE MODAL STATE ---
  const [deleteId, setDeleteId] = useState<string | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);

  useEffect(() => {
    fetchProducts();
  }, []);

  const fetchProducts = async () => {
    try {
      setIsLoading(true);
      const response = await ProductService.getAll();
      const incomingData = response.data.data || [];

      if (Array.isArray(incomingData)) {
        setProducts(incomingData);
      } else {
        setProducts([]);
      }
    } catch (error: any) {
      console.error("Products fetch error:", error);
      toast.error("Failed to fetch products");
      setProducts([]);
    } finally {
      setIsLoading(false);
    }
  };

  // 1. Open Modal
  const openDeleteModal = (id: string) => {
    setDeleteId(id);
  };

  // 2. Close Modal
  const closeDeleteModal = () => {
    setDeleteId(null);
  };

  // 3. Execute Delete (API Call)
  const executeDelete = async () => {
    if (!deleteId) return;

    setIsDeleting(true);
    try {
      await ProductService.delete(deleteId);
      toast.success("Product deleted successfully");
      setProducts((prev) => prev.filter((p) => p._id !== deleteId));
      closeDeleteModal();
    } catch (error: any) {
      console.error("Delete Error:", error);
      toast.error(error.response?.data?.message || "Failed to delete product");
    } finally {
      setIsDeleting(false);
    }
  };

  const safeProducts = Array.isArray(products) ? products : [];

  const filteredProducts = safeProducts.filter((product) => {
    const matchesSearch =
      (product.name || "").toLowerCase().includes(searchQuery.toLowerCase()) ||
      (product.partNumber || "")
        .toLowerCase()
        .includes(searchQuery.toLowerCase());
    const matchesCategory =
      selectedCategory === "All" || product.category === selectedCategory;
    return matchesSearch && matchesCategory;
  });

  const categories = [
    "All",
    ...new Set(safeProducts.map((p) => p.category).filter(Boolean)),
  ];

  // Calculate Summary Stats
  const totalProducts = safeProducts.length;
  const lowStockCount = safeProducts.filter(
    (p) => p.stock <= (p.lowStockThreshold || 5),
  ).length;
  const outOfStockCount = safeProducts.filter((p) => p.stock === 0).length;
  const totalInventoryValue = safeProducts.reduce(
    (sum, p) => sum + p.price * p.stock,
    0,
  );

  if (isLoading) {
    return (
      <div className="space-y-6">
        <div className="flex items-center justify-between">
          <h1 className="text-3xl font-bold text-white">Products</h1>
        </div>
        <TableSkeleton />
      </div>
    );
  }

  return (
    <div className="space-y-6 pb-20 px-2 md:px-0">
      {" "}
      {/* Added small horizontal padding for mobile */}
      {/* Header */}
      <motion.div
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.5 }}
        className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between"
      >
        <div>
          <h1 className="text-2xl md:text-3xl font-bold text-white">
            Products
          </h1>{" "}
          {/* Responsive Font Size */}
          <p className="mt-1 text-sm md:text-base text-gray-400">
            Manage your spare parts inventory
          </p>
        </div>
        <div className="flex flex-wrap gap-2">
          {" "}
          {/* flex-wrap handles small screens */}
          <button
            onClick={fetchProducts}
            className="flex items-center gap-2 rounded-lg bg-white/5 px-4 py-2 text-sm font-medium text-white hover:bg-white/10 transition-colors"
          >
            <RefreshCcw className="h-4 w-4" />
            Refresh
          </button>
          <Link href="/dashboard/products/add">
            <Button variant="primary" size="md">
              <Plus className="h-4 w-4 mr-2" />
              Add Product
            </Button>
          </Link>
        </div>
      </motion.div>
      {/* --- SUMMARY CARDS SECTION --- */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.1, duration: 0.5 }}
        className="grid grid-cols-1 gap-3 sm:gap-4 sm:grid-cols-2 lg:grid-cols-4"
      >
        {/* Card 1 */}
        <div className="rounded-xl border border-white/10 bg-white/5 backdrop-blur-sm p-4 transition-colors hover:bg-white/10">
          <div className="flex items-center gap-4">
            <div className="rounded-lg bg-blue-500/10 p-3 text-blue-400">
              <Package className="h-6 w-6" />
            </div>
            <div>
              <p className="text-sm font-medium text-gray-400">
                Total Products
              </p>
              <p className="text-xl md:text-2xl font-bold text-white">
                {totalProducts}
              </p>
            </div>
          </div>
        </div>

        {/* Card 2 */}
        <div className="rounded-xl border border-white/10 bg-white/5 backdrop-blur-sm p-4 transition-colors hover:bg-white/10">
          <div className="flex items-center gap-4">
            <div className="rounded-lg bg-yellow-500/10 p-3 text-yellow-400">
              <AlertTriangle className="h-6 w-6" />
            </div>
            <div>
              <p className="text-sm font-medium text-gray-400">Low Stock</p>
              <p className="text-xl md:text-2xl font-bold text-white">
                {lowStockCount}
              </p>
            </div>
          </div>
        </div>

        {/* Card 3 */}
        <div className="rounded-xl border border-white/10 bg-white/5 backdrop-blur-sm p-4 transition-colors hover:bg-white/10">
          <div className="flex items-center gap-4">
            <div className="rounded-lg bg-red-500/10 p-3 text-red-400">
              <AlertCircle className="h-6 w-6" />
            </div>
            <div>
              <p className="text-sm font-medium text-gray-400">Out of Stock</p>
              <p className="text-xl md:text-2xl font-bold text-white">
                {outOfStockCount}
              </p>
            </div>
          </div>
        </div>

        {/* Card 4 */}
        <div className="rounded-xl border border-white/10 bg-white/5 backdrop-blur-sm p-4 transition-colors hover:bg-white/10">
          <div className="flex items-center gap-4">
            <div className="rounded-lg bg-green-500/10 p-3 text-green-400">
              <DollarSign className="h-6 w-6" />
            </div>
            <div>
              <p className="text-sm font-medium text-gray-400">Total Value</p>
              <p className="text-xl md:text-2xl font-bold text-white">
                {formatCurrency(totalInventoryValue)}
              </p>
            </div>
          </div>
        </div>
      </motion.div>
      {/* Filters */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.2, duration: 0.5 }}
        className="flex flex-col md:flex-row md:items-center gap-4" // Stack on mobile, row on desktop
      >
        {/* Search Input: Full width on mobile, auto on desktop */}
        <div className="relative w-full md:flex-1 md:min-w-[300px]">
          <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400" />
          <input
            type="text"
            placeholder="Search by name or part number..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            className="w-full rounded-xl border border-white/10 bg-white/5 py-2.5 pl-10 pr-4 text-sm text-white placeholder-gray-400 backdrop-blur-sm transition-all focus:border-blue-500/30 focus:bg-white/10 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
          />
        </div>

        {/* Category Filter */}
        <div className="flex items-center gap-2 overflow-x-auto rounded-xl border border-white/10 bg-white/5 p-1 backdrop-blur-sm scrollbar-hide w-full md:w-auto">
          {categories.map((category) => (
            <motion.button
              key={category}
              whileHover={{ scale: 1.05 }}
              whileTap={{ scale: 0.95 }}
              onClick={() => setSelectedCategory(category)}
              className={cn(
                "whitespace-nowrap rounded-lg px-4 py-2 text-sm font-medium transition-all flex-shrink-0",
                selectedCategory === category
                  ? "bg-blue-500 text-white shadow-lg shadow-blue-500/30"
                  : "text-gray-400 hover:text-white",
              )}
            >
              {category}
            </motion.button>
          ))}
        </div>
      </motion.div>
      {/* Products Table */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.3, duration: 0.5 }}
        className="overflow-hidden rounded-2xl border border-white/10 bg-white/[0.02] backdrop-blur-sm"
      >
        <div className="overflow-x-auto">
          <table className="w-full whitespace-nowrap">
            {" "}
            {/* whitespace-nowrap prevents broken layouts on mobile */}
            <thead>
              <tr className="border-b border-white/10 bg-white/5">
                {/* Responsive Padding: px-4 on mobile, px-6 on desktop */}
                <th className="px-4 md:px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">
                  Product
                </th>
                <th className="px-4 md:px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">
                  Category
                </th>
                <th className="px-4 md:px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">
                  Models
                </th>
                <th className="px-4 md:px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">
                  Price
                </th>
                <th className="px-4 md:px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">
                  Stock
                </th>
                <th className="px-4 md:px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody className="divide-y divide-white/5">
              {filteredProducts.length === 0 ? (
                <tr>
                  <td
                    colSpan={6}
                    className="px-6 py-12 text-center text-gray-400"
                  >
                    <Package className="h-12 w-12 mx-auto mb-3 text-gray-600" />
                    <p>No products found</p>
                  </td>
                </tr>
              ) : (
                filteredProducts.map((product, index) => (
                  <motion.tr
                    key={product._id}
                    initial={{ opacity: 0, x: -20 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: 0.05 * index, duration: 0.3 }}
                    whileHover={{
                      backgroundColor: "rgba(255, 255, 255, 0.02)",
                    }}
                    className="transition-colors group"
                  >
                    <td className="px-4 md:px-6 py-4">
                      <div className="flex items-center gap-3">
                        <div className="relative h-10 w-10 md:h-12 md:w-12 overflow-hidden rounded-lg bg-white/5 border border-white/10 flex-shrink-0">
                          {product.images && product.images[0] ? (
                            <Image
                              src={product.images[0].url}
                              alt={product.name}
                              fill
                              className="object-cover transition-transform group-hover:scale-110"
                            />
                          ) : (
                            <div className="flex h-full w-full items-center justify-center text-gray-500">
                              <Package className="h-5 w-5 md:h-6 md:w-6" />
                            </div>
                          )}
                        </div>
                        <div>
                          <p className="font-medium text-white line-clamp-1 text-sm md:text-base">
                            {product.name}
                          </p>
                          <code className="text-xs text-cyan-400 bg-cyan-400/10 px-1.5 py-0.5 rounded">
                            {product.partNumber}
                          </code>
                        </div>
                      </div>
                    </td>
                    <td className="px-4 md:px-6 py-4">
                      <span className="rounded-full bg-blue-500/10 px-3 py-1 text-xs font-medium text-blue-400">
                        {product.category}
                      </span>
                    </td>
                    <td className="px-4 md:px-6 py-4 max-w-[200px] whitespace-normal">
                      {" "}
                      {/* Allowed wrapping only for Models */}
                      <div className="flex flex-wrap gap-1">
                        {product.compatibleModels
                          ?.slice(0, 2)
                          .map((model, i) => (
                            <span
                              key={i}
                              className="inline-flex items-center gap-1 rounded bg-white/5 px-2 py-0.5 text-[10px] text-gray-300 border border-white/10"
                            >
                              <Car className="h-3 w-3 text-gray-500" />
                              {model.modelName}
                            </span>
                          ))}
                        {product.compatibleModels?.length > 2 && (
                          <span className="text-[10px] text-gray-500 pl-1">
                            +{product.compatibleModels.length - 2} more
                          </span>
                        )}
                      </div>
                    </td>
                    <td className="px-4 md:px-6 py-4">
                      <p className="font-semibold text-white text-sm md:text-base">
                        {formatCurrency(product.finalPrice || product.price)}
                      </p>
                    </td>

                    <td className="px-4 md:px-6 py-4">
                      <div className="flex flex-col gap-1.5">
                        <span className="text-sm font-semibold text-white">
                          {product.stock} Units
                        </span>
                        <span
                          className={cn(
                            "text-[10px] w-fit font-medium px-2 py-0.5 rounded-full border",
                            product.stock > (product.lowStockThreshold || 5)
                              ? "bg-green-500/10 text-green-400 border-green-500/20"
                              : product.stock === 0
                                ? "bg-red-500/10 text-red-400 border-red-500/20"
                                : "bg-yellow-500/10 text-yellow-400 border-yellow-500/20",
                          )}
                        >
                          {product.stockStatus ||
                            (product.stock > 0 ? "In Stock" : "Out of Stock")}
                        </span>
                      </div>
                    </td>

                    <td className="px-4 md:px-6 py-4">
                      <div className="flex items-center gap-2">
                        <Link href={`/dashboard/products/${product._id}`}>
                          <motion.button
                            whileHover={{ scale: 1.1 }}
                            whileTap={{ scale: 0.9 }}
                            className="rounded-lg bg-blue-500/10 p-2 text-blue-400 transition-colors hover:bg-blue-500/20"
                            title="View Details"
                          >
                            <Eye className="h-4 w-4" />
                          </motion.button>
                        </Link>
                        <Link href={`/dashboard/products/edit/${product._id}`}>
                          <motion.button
                            whileHover={{ scale: 1.1 }}
                            whileTap={{ scale: 0.9 }}
                            className="rounded-lg bg-yellow-500/10 p-2 text-yellow-400 transition-colors hover:bg-yellow-500/20"
                            title="Edit Product"
                          >
                            <Edit className="h-4 w-4" />
                          </motion.button>
                        </Link>
                        <motion.button
                          whileHover={{ scale: 1.1 }}
                          whileTap={{ scale: 0.9 }}
                          onClick={() => openDeleteModal(product._id)}
                          className="rounded-lg bg-red-500/10 p-2 text-red-400 transition-colors hover:bg-red-500/20"
                          title="Delete Product"
                        >
                          <Trash2 className="h-4 w-4" />
                        </motion.button>
                      </div>
                    </td>
                  </motion.tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </motion.div>
      {/* --- DELETE CONFIRMATION MODAL --- */}
      <AnimatePresence>
        {deleteId && (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              onClick={closeDeleteModal}
              className="absolute inset-0 bg-black/60 backdrop-blur-sm"
            />
            <motion.div
              initial={{ opacity: 0, scale: 0.95, y: 20 }}
              animate={{ opacity: 1, scale: 1, y: 0 }}
              exit={{ opacity: 0, scale: 0.95, y: 20 }}
              className="relative w-full max-w-md overflow-hidden rounded-2xl border border-white/10 bg-gray-900 p-6 shadow-2xl"
            >
              <button
                onClick={closeDeleteModal}
                className="absolute right-4 top-4 text-gray-400 hover:text-white"
              >
                <X className="h-5 w-5" />
              </button>
              <div className="flex flex-col items-center text-center">
                <div className="mb-4 rounded-full bg-red-500/10 p-4">
                  <AlertTriangle className="h-8 w-8 text-red-500" />
                </div>
                <h3 className="mb-2 text-xl font-bold text-white">
                  Delete Product?
                </h3>
                <p className="mb-6 text-sm text-gray-400 leading-relaxed">
                  Are you sure you want to delete this product? <br />
                  This action cannot be undone and will remove the item from
                  inventory.
                </p>
                <div className="flex w-full gap-3">
                  <button
                    onClick={closeDeleteModal}
                    disabled={isDeleting}
                    className="flex-1 rounded-xl border border-white/10 bg-white/5 py-3 text-sm font-medium text-white transition-colors hover:bg-white/10 disabled:opacity-50"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={executeDelete}
                    disabled={isDeleting}
                    className="flex-1 rounded-xl bg-red-500 py-3 text-sm font-medium text-white transition-colors hover:bg-red-600 disabled:opacity-50 flex justify-center items-center gap-2"
                  >
                    {isDeleting ? (
                      <>
                        <div className="h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent" />
                        <span>Deleting...</span>
                      </>
                    ) : (
                      <>
                        <Trash2 className="h-4 w-4" />
                        <span>Delete Forever</span>
                      </>
                    )}
                  </button>
                </div>
              </div>
            </motion.div>
          </div>
        )}
      </AnimatePresence>
    </div>
  );
}
</file>

<file path="app/dashboard/settings/page.tsx">
"use client";

import { useState, useEffect, useRef } from "react";
import { useRouter } from "next/navigation";
import { motion, AnimatePresence } from "framer-motion";
import {
  User,
  Lock,
  Save,
  Eye,
  EyeOff,
  Camera,
  Bell,
  Shield,
  LogOut,
  Mail,
  Smartphone,
  Loader2,
} from "lucide-react";
import Button from "@/components/ui/Button";
import { AdminAuthService } from "@/lib/api";
import { toast } from "sonner";

// --- Types ---
type TabType = "profile" | "security" | "notifications";

interface ProfileData {
  name: string;
  email: string;
  phone: string;
  bio: string;
  avatar?: string;
  role?: string;
}

interface NotificationSettings {
  emailAlerts: boolean;
  securityAlerts: boolean;
  marketingEmails: boolean;
}

export default function SettingsPage() {
  const router = useRouter();
  const [activeTab, setActiveTab] = useState<TabType>("profile");
  const [isLoading, setIsLoading] = useState(false);
  const [isPageLoading, setIsPageLoading] = useState(true);

  // Profile State
  const [profileData, setProfileData] = useState<ProfileData>({
    name: "",
    email: "",
    phone: "",
    bio: "",
    role: "", // Added role to state
  });

  // Avatar State
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
  const [avatarFile, setAvatarFile] = useState<File | null>(null);

  // Password State
  const [showCurrentPassword, setShowCurrentPassword] = useState(false);
  const [showNewPassword, setShowNewPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);
  const [passwordData, setPasswordData] = useState({
    currentPassword: "",
    newPassword: "",
    confirmPassword: "",
  });

  // Notifications State
  const [notifications, setNotifications] = useState<NotificationSettings>({
    emailAlerts: true,
    securityAlerts: true,
    marketingEmails: false,
  });

  // 1. Fetch Profile on Load
  useEffect(() => {
    const fetchProfile = async () => {
      try {
        const response = await AdminAuthService.getProfile();

        // âœ… FIX: Handling Nested API Response Structure
        // Axios gives 'response.data'. Your API has 'data.data' inside that.
        const rootData = response.data;

        // Checking if data is nested as { data: { data: { user... } } }
        const userProfile = rootData?.data?.data || rootData?.data || {};

        setProfileData({
          name: userProfile.name || "",
          email: userProfile.email || "",
          phone: userProfile.phone || "",
          bio: userProfile.bio || "",
          role: userProfile.role || "ADMIN",
        });

        // Update Avatar Preview
        if (userProfile.avatar) {
          setAvatarPreview(userProfile.avatar);
        }

        // Update Notifications State if exists
        if (userProfile.notifications) {
          setNotifications((prev) => ({
            ...prev,
            ...userProfile.notifications,
          }));
        }
      } catch (error: any) {
        console.error("Profile fetch error:", error);
        toast.error("Failed to load profile data");
      } finally {
        setIsPageLoading(false);
      }
    };

    fetchProfile();
  }, []);

  // 2. Handle Image Selection
  const handleImageChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      if (file.size > 5 * 1024 * 1024) {
        toast.error("Image size must be less than 5MB");
        return;
      }
      setAvatarFile(file);

      // Create local preview
      const reader = new FileReader();
      reader.onloadend = () => {
        setAvatarPreview(reader.result as string);
      };
      reader.readAsDataURL(file);
    }
  };

  // 3. Handle Profile Update (Multipart/FormData)
  // 3. Handle Profile Update (Updated Logic)
  const handleProfileUpdate = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);

    try {
      const formData = new FormData();
      formData.append("name", profileData.name);
      formData.append("phone", profileData.phone || "");
      formData.append("bio", profileData.bio || "");

      if (avatarFile) {
        formData.append("avatar", avatarFile);
      }

      const response = await AdminAuthService.updateProfile(formData);

      const responseRoot = response.data;
      // Data Path: response.data.data.admin
      const updatedAdmin = responseRoot?.data?.admin || responseRoot?.data;

      if (updatedAdmin) {
        // Update Form State
        setProfileData((prev) => ({
          ...prev,
          name: updatedAdmin.name,
          phone: updatedAdmin.phone,
          bio: updatedAdmin.bio,
          avatar: updatedAdmin.avatar,
          role: updatedAdmin.role,
        }));

        // âœ… FIX 2: Force Update Preview
        if (updatedAdmin.avatar) {
          // à°¬à±à°°à±Œà°œà°°à± à°•à±à°¯à°¾à°šà±€à°¨à°¿ à°•à±à°²à°¿à°¯à°°à± à°šà±‡à°¯à°¡à°¾à°¨à°¿à°•à°¿ à°šà°¿à°µà°°à°¨ à°Ÿà±ˆà°®à± à°¸à±à°Ÿà°¾à°‚à°ªà± à°¯à°¾à°¡à± à°šà±‡à°¸à±à°¤à±à°¨à±à°¨à°¾à°‚
          setAvatarPreview(`${updatedAdmin.avatar}?t=${new Date().getTime()}`);
        }

        // Update Notifications if changed
        if (updatedAdmin.notifications) {
          setNotifications(updatedAdmin.notifications);
        }
      }

      toast.success("Profile updated successfully!");
      setAvatarFile(null);

      // âœ… Optional: à°ªà±‡à°œà±€à°¨à°¿ à°°à±€à°«à±à°°à±†à°·à± à°šà±‡à°¸à±à°¤à±‡ à°ªà°°à±à°«à±†à°•à±à°Ÿà± à°—à°¾ à°•à±Šà°¤à±à°¤ à°¡à±‡à°Ÿà°¾ à°µà°¸à±à°¤à±à°‚à°¦à°¿ (à°•à°¾à°µà°¾à°²à°‚à°Ÿà±‡ à°…à°¨à±â€Œà°•à°¾à°®à±†à°‚à°Ÿà± à°šà±‡à°¯à°‚à°¡à°¿)
      // router.refresh();
    } catch (error: any) {
      console.error("Profile update error:", error);
      const errorMsg =
        error.response?.data?.message || "Failed to update profile";
      toast.error(errorMsg);
    } finally {
      setIsLoading(false);
    }
  };
  // 4. Handle Notification Update (JSON)
  const handleSaveNotifications = async () => {
    setIsLoading(true);
    try {
      await AdminAuthService.updateProfile({
        notifications: notifications,
      });
      toast.success("Notification preferences saved!");
    } catch (error: any) {
      console.error("Notification update error:", error);
      toast.error("Failed to save preferences");
    } finally {
      setIsLoading(false);
    }
  };

  // 5. Handle Password Change
  const handlePasswordChange = async (e: React.FormEvent) => {
    e.preventDefault();

    if (passwordData.newPassword !== passwordData.confirmPassword) {
      toast.error("New passwords do not match");
      return;
    }

    if (passwordData.newPassword.length < 6) {
      toast.error("Password must be at least 6 characters");
      return;
    }

    setIsLoading(true);
    try {
      await AdminAuthService.changePassword({
        currentPassword: passwordData.currentPassword,
        newPassword: passwordData.newPassword,
      });

      toast.success("Password changed! Please login again.");
      setPasswordData({
        currentPassword: "",
        newPassword: "",
        confirmPassword: "",
      });

      // Optional: Logout logic here
    } catch (error: any) {
      console.error("Password change error:", error);
      toast.error(error.response?.data?.message || "Failed to change password");
    } finally {
      setIsLoading(false);
    }
  };

  // 6. Logout All Devices
  const handleLogoutAllDevices = async () => {
    if (!confirm("Are you sure? You will be logged out of this device too."))
      return;

    try {
      await AdminAuthService.logoutAllDevices();
      toast.success("Logged out of all sessions");
      localStorage.removeItem("token");
      router.push("/login");
    } catch (error: any) {
      toast.error("Failed to logout other sessions");
    }
  };

  if (isPageLoading) {
    return (
      <div className="flex h-96 items-center justify-center">
        <Loader2 className="h-8 w-8 animate-spin text-blue-500" />
      </div>
    );
  }

  return (
    <div className="space-y-6 max-w-5xl mx-auto pb-20">
      {/* Header */}
      <motion.div
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.5 }}
      >
        <h1 className="text-3xl font-bold text-white">Settings</h1>
        <p className="mt-1 text-gray-400">
          Manage your profile, security, and notification preferences
        </p>
      </motion.div>

      <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
        {/* Sidebar Navigation */}
        <motion.div
          initial={{ opacity: 0, x: -20 }}
          animate={{ opacity: 1, x: 0 }}
          transition={{ delay: 0.1 }}
          className="lg:col-span-3 space-y-2"
        >
          <div className="rounded-xl border border-white/10 bg-white/5 p-2 backdrop-blur-sm sticky top-6">
            {[
              { id: "profile", icon: User, label: "My Profile" },
              { id: "security", icon: Shield, label: "Security" },
              { id: "notifications", icon: Bell, label: "Notifications" },
            ].map((tab) => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id as TabType)}
                className={`w-full flex items-center gap-3 rounded-lg px-4 py-3 text-sm font-medium transition-all ${
                  activeTab === tab.id
                    ? "bg-blue-500 text-white shadow-lg shadow-blue-500/20"
                    : "text-gray-400 hover:text-white hover:bg-white/5"
                }`}
              >
                <tab.icon className="h-4 w-4" />
                {tab.label}
              </button>
            ))}
          </div>
        </motion.div>

        {/* Main Content Area */}
        <div className="lg:col-span-9">
          <AnimatePresence mode="wait">
            {/* --- PROFILE TAB --- */}
            {activeTab === "profile" && (
              <motion.div
                key="profile"
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -10 }}
                transition={{ duration: 0.2 }}
                className="space-y-6"
              >
                {/* Profile Header & Avatar Upload */}
                <div className="rounded-2xl border border-white/10 bg-white/[0.02] p-6 backdrop-blur-sm relative overflow-hidden">
                  <div className="absolute top-0 left-0 w-full h-24 bg-gradient-to-r from-blue-600/20 to-purple-600/20" />
                  <div className="relative pt-8 flex flex-col sm:flex-row items-center sm:items-end gap-6">
                    <div className="relative group">
                      <div className="h-24 w-24 rounded-full border-4 border-[#0f1115] bg-gray-800 overflow-hidden relative">
                        {avatarPreview ? (
                          <img
                            src={avatarPreview}
                            alt="Profile"
                            className="h-full w-full object-cover"
                          />
                        ) : (
                          <div className="h-full w-full flex items-center justify-center bg-blue-500/20 text-blue-400 text-3xl font-bold">
                            {profileData.name?.charAt(0)?.toUpperCase() || "A"}
                          </div>
                        )}
                      </div>
                      <button
                        type="button"
                        onClick={() => fileInputRef.current?.click()}
                        className="absolute bottom-0 right-0 p-2 bg-blue-500 rounded-full text-white shadow-lg cursor-pointer hover:bg-blue-600 transition-colors z-10"
                      >
                        <Camera className="h-4 w-4" />
                      </button>
                      <input
                        type="file"
                        ref={fileInputRef}
                        className="hidden"
                        accept="image/*"
                        onChange={handleImageChange}
                      />
                    </div>
                    <div className="text-center sm:text-left flex-1 pb-2">
                      <h2 className="text-2xl font-bold text-white">
                        {profileData.name || "Loading..."}
                      </h2>
                      <div className="flex items-center justify-center sm:justify-start gap-3 mt-1 text-gray-400 text-sm">
                        <span className="flex items-center gap-1">
                          <Shield className="h-3 w-3 text-blue-400" />
                          {(profileData.role || "ADMIN").toUpperCase()}
                        </span>
                        <span>â€¢</span>
                        <span>{profileData.email}</span>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Profile Form */}
                <div className="rounded-2xl border border-white/10 bg-white/[0.02] p-8 backdrop-blur-sm">
                  <h3 className="mb-6 text-xl font-semibold text-white">
                    Profile Details
                  </h3>
                  <form onSubmit={handleProfileUpdate} className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div>
                        <label className="mb-2 block text-sm font-medium text-gray-300">
                          Full Name
                        </label>
                        <div className="relative">
                          <User className="absolute left-4 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-500" />
                          <input
                            type="text"
                            required
                            value={profileData.name}
                            onChange={(e) =>
                              setProfileData({
                                ...profileData,
                                name: e.target.value,
                              })
                            }
                            className="w-full rounded-xl border border-white/10 bg-white/5 pl-10 pr-4 py-3 text-white placeholder-gray-500 backdrop-blur-sm focus:border-blue-500/50 focus:bg-white/10 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
                          />
                        </div>
                      </div>

                      <div>
                        <label className="mb-2 block text-sm font-medium text-gray-300">
                          Email Address
                        </label>
                        <div className="relative">
                          <Mail className="absolute left-4 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-500" />
                          <input
                            type="email"
                            required
                            disabled
                            value={profileData.email}
                            className="w-full rounded-xl border border-white/10 bg-white/5 pl-10 pr-4 py-3 text-gray-400 cursor-not-allowed placeholder-gray-500"
                          />
                        </div>
                      </div>

                      <div>
                        <label className="mb-2 block text-sm font-medium text-gray-300">
                          Phone Number
                        </label>
                        <div className="relative">
                          <Smartphone className="absolute left-4 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-500" />
                          <input
                            type="tel"
                            value={profileData.phone}
                            onChange={(e) =>
                              setProfileData({
                                ...profileData,
                                phone: e.target.value,
                              })
                            }
                            className="w-full rounded-xl border border-white/10 bg-white/5 pl-10 pr-4 py-3 text-white placeholder-gray-500 backdrop-blur-sm focus:border-blue-500/50 focus:bg-white/10 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
                          />
                        </div>
                      </div>
                    </div>

                    <div>
                      <label className="mb-2 block text-sm font-medium text-gray-300">
                        Bio
                      </label>
                      <textarea
                        rows={3}
                        value={profileData.bio}
                        onChange={(e) =>
                          setProfileData({
                            ...profileData,
                            bio: e.target.value,
                          })
                        }
                        className="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white placeholder-gray-500 backdrop-blur-sm focus:border-blue-500/50 focus:bg-white/10 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
                        placeholder="Tell us a little about yourself..."
                      />
                    </div>

                    <div className="flex justify-end pt-4">
                      <Button
                        type="submit"
                        variant="primary"
                        size="lg"
                        isLoading={isLoading}
                      >
                        <Save className="h-4 w-4" />
                        Save Changes
                      </Button>
                    </div>
                  </form>
                </div>
              </motion.div>
            )}

            {/* --- SECURITY TAB --- */}
            {activeTab === "security" && (
              <motion.div
                key="security"
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -10 }}
                transition={{ duration: 0.2 }}
                className="space-y-6"
              >
                <div className="rounded-2xl border border-white/10 bg-white/[0.02] p-8 backdrop-blur-sm">
                  <h2 className="mb-6 text-xl font-semibold text-white">
                    Change Password
                  </h2>
                  <form onSubmit={handlePasswordChange} className="space-y-6">
                    <div>
                      <label className="mb-2 block text-sm font-medium text-gray-300">
                        Current Password
                      </label>
                      <div className="relative">
                        <input
                          type={showCurrentPassword ? "text" : "password"}
                          required
                          value={passwordData.currentPassword}
                          onChange={(e) =>
                            setPasswordData({
                              ...passwordData,
                              currentPassword: e.target.value,
                            })
                          }
                          className="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 pr-12 text-white placeholder-gray-400 focus:border-blue-500/50 focus:bg-white/10 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
                        />
                        <button
                          type="button"
                          onClick={() =>
                            setShowCurrentPassword(!showCurrentPassword)
                          }
                          className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white"
                        >
                          {showCurrentPassword ? (
                            <EyeOff className="h-5 w-5" />
                          ) : (
                            <Eye className="h-5 w-5" />
                          )}
                        </button>
                      </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div>
                        <label className="mb-2 block text-sm font-medium text-gray-300">
                          New Password
                        </label>
                        <div className="relative">
                          <input
                            type={showNewPassword ? "text" : "password"}
                            required
                            minLength={6}
                            value={passwordData.newPassword}
                            onChange={(e) =>
                              setPasswordData({
                                ...passwordData,
                                newPassword: e.target.value,
                              })
                            }
                            className="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 pr-12 text-white placeholder-gray-400 focus:border-blue-500/50 focus:bg-white/10 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
                          />
                          <button
                            type="button"
                            onClick={() => setShowNewPassword(!showNewPassword)}
                            className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white"
                          >
                            {showNewPassword ? (
                              <EyeOff className="h-5 w-5" />
                            ) : (
                              <Eye className="h-5 w-5" />
                            )}
                          </button>
                        </div>
                      </div>

                      <div>
                        <label className="mb-2 block text-sm font-medium text-gray-300">
                          Confirm Password
                        </label>
                        <div className="relative">
                          <input
                            type={showConfirmPassword ? "text" : "password"}
                            required
                            minLength={6}
                            value={passwordData.confirmPassword}
                            onChange={(e) =>
                              setPasswordData({
                                ...passwordData,
                                confirmPassword: e.target.value,
                              })
                            }
                            className="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 pr-12 text-white placeholder-gray-400 focus:border-blue-500/50 focus:bg-white/10 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
                          />
                          <button
                            type="button"
                            onClick={() =>
                              setShowConfirmPassword(!showConfirmPassword)
                            }
                            className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white"
                          >
                            {showConfirmPassword ? (
                              <EyeOff className="h-5 w-5" />
                            ) : (
                              <Eye className="h-5 w-5" />
                            )}
                          </button>
                        </div>
                      </div>
                    </div>

                    <div className="flex justify-end">
                      <Button
                        type="submit"
                        variant="primary"
                        size="lg"
                        isLoading={isLoading}
                      >
                        <Lock className="h-4 w-4" />
                        Change Password
                      </Button>
                    </div>
                  </form>
                </div>

                <div className="rounded-2xl border border-red-500/20 bg-red-500/5 p-8 backdrop-blur-sm">
                  <h3 className="text-lg font-semibold text-white mb-4">
                    Device Sessions
                  </h3>
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-gray-300 font-medium">
                        Log out of all devices
                      </p>
                      <p className="text-sm text-gray-500 mt-1">
                        This will terminate sessions on all other devices.
                      </p>
                    </div>
                    <Button
                      onClick={handleLogoutAllDevices}
                      variant="outline"
                      className="border-red-500/30 text-red-400 hover:bg-red-500/10 hover:text-red-300"
                    >
                      <LogOut className="h-4 w-4 mr-2" />
                      Log Out All
                    </Button>
                  </div>
                </div>
              </motion.div>
            )}

            {/* --- NOTIFICATIONS TAB --- */}
            {activeTab === "notifications" && (
              <motion.div
                key="notifications"
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -10 }}
                transition={{ duration: 0.2 }}
                className="rounded-2xl border border-white/10 bg-white/[0.02] p-8 backdrop-blur-sm"
              >
                <h2 className="mb-6 text-xl font-semibold text-white">
                  Notification Preferences
                </h2>
                <div className="space-y-6">
                  {Object.entries(notifications).map(([key, value]) => (
                    <div
                      key={key}
                      className="flex items-center justify-between py-4 border-b border-white/5 last:border-0"
                    >
                      <div>
                        <p className="font-medium text-white capitalize">
                          {key.replace(/([A-Z])/g, " $1").trim()}
                        </p>
                        <p className="text-sm text-gray-400 mt-1">
                          Receive notifications for{" "}
                          {key.replace(/([A-Z])/g, " $1").toLowerCase()}.
                        </p>
                      </div>
                      <button
                        onClick={() =>
                          setNotifications((prev) => ({
                            ...prev,
                            [key]: !value,
                          }))
                        }
                        className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                          value ? "bg-blue-500" : "bg-gray-700"
                        }`}
                      >
                        <span
                          className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                            value ? "translate-x-6" : "translate-x-1"
                          }`}
                        />
                      </button>
                    </div>
                  ))}
                </div>
                <div className="mt-8 flex justify-end">
                  <Button
                    onClick={handleSaveNotifications}
                    variant="primary"
                    isLoading={isLoading}
                  >
                    <Save className="h-4 w-4" />
                    Save Preferences
                  </Button>
                </div>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/globals.css">
@import url("https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap");

@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    --background: 240 10% 3.9%;
    --foreground: 0 0% 98%;
    --card: 240 6% 10%;
    --card-foreground: 0 0% 98%;
    --popover: 240 6% 10%;
    --popover-foreground: 0 0% 98%;
    --primary: 210 100% 50%;
    --primary-foreground: 0 0% 98%;
    --secondary: 240 4% 16%;
    --secondary-foreground: 0 0% 98%;
    --muted: 240 4% 16%;
    --muted-foreground: 240 5% 65%;
    --accent: 142 76% 36%;
    --accent-foreground: 0 0% 98%;
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 0 0% 98%;
    --border: 240 4% 16%;
    --input: 240 4% 16%;
    --ring: 210 100% 50%;
    --radius: 0.75rem;

    /* Custom Hyundai Colors */
    --hyundai-blue: 210 100% 50%;
    --hyundai-blue-light: 210 100% 60%;
    --hyundai-blue-dark: 210 100% 40%;
    --success: 142 76% 36%;
    --warning: 38 92% 50%;
    --danger: 0 84% 60%;
  }
}

@layer base {
  * {
    @apply border-border;
  }

  body {
    @apply bg-background text-foreground font-sans;
    font-family:
      "Sora",
      -apple-system,
      BlinkMacSystemFont,
      "Segoe UI",
      sans-serif;
    font-feature-settings: "cv11", "ss01";
  }

  h1,
  h2,
  h3,
  h4,
  h5,
  h6 {
    @apply font-semibold tracking-tight;
  }

  code,
  pre {
    font-family: "JetBrains Mono", monospace;
  }
}

@layer utilities {
  .animate-shimmer {
    background: linear-gradient(
      90deg,
      transparent 0%,
      rgba(255, 255, 255, 0.05) 50%,
      transparent 100%
    );
    background-size: 200% 100%;
    animation: shimmer 2s infinite;
  }

  .glass-effect {
    background: rgba(255, 255, 255, 0.03);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.05);
  }

  .glass-hover {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .glass-hover:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
  }

  .glow-effect {
    box-shadow:
      0 0 20px rgba(33, 150, 243, 0.3),
      0 0 40px rgba(33, 150, 243, 0.2),
      0 0 60px rgba(33, 150, 243, 0.1);
  }

  .text-gradient {
    background: linear-gradient(135deg, #2196f3 0%, #21cbf3 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .scrollbar-thin::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }

  .scrollbar-thin::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.02);
  }

  .scrollbar-thin::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
  }

  .scrollbar-thin::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.15);
  }
}

/* Custom selection */
::selection {
  background-color: rgba(33, 150, 243, 0.3);
  color: #ffffff;
}

/* Smooth scroll */
html {
  scroll-behavior: smooth;
}

/* Remove autofill background */
input:-webkit-autofill,
input:-webkit-autofill:hover,
input:-webkit-autofill:focus,
input:-webkit-autofill:active {
  -webkit-box-shadow: 0 0 0 30px rgb(24, 24, 27) inset !important;
  -webkit-text-fill-color: white !important;
}

.custom-scrollbar::-webkit-scrollbar {
  width: 6px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
  background-color: rgba(59, 130, 246, 0.6); /* Tailwind blue-500 */
  border-radius: 9999px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background-color: rgba(59, 130, 246, 0.9);
}

/* 1. Chrome, Edge, à°®à°°à°¿à°¯à± Safari à°¬à±à°°à±Œà°œà°°à±â€Œà°² à°•à±‹à°¸à°‚ */

/* à°¸à±à°•à±à°°à±‹à°²à± à°¬à°¾à°°à± à°µà±†à°¡à°²à±à°ªà± (Width) */
::-webkit-scrollbar {
  width: 12px; /* à°®à±€à°•à± à°•à°¾à°µà°¾à°²à±à°¸à°¿à°¨ à°¸à±ˆà°œà± à°‡à°•à±à°•à°¡ à°‡à°µà±à°µà°‚à°¡à°¿ */
}

/* à°¸à±à°•à±à°°à±‹à°²à± à°¬à°¾à°°à± à°µà±†à°¨à±à°• à°‰à°‚à°¡à±‡ à°¦à°¾à°°à°¿ (Track - Background) */
::-webkit-scrollbar-track {
  background: #f1f1f1; /* à°²à±‡à°¤ à°¬à±‚à°¡à°¿à°¦ à°°à°‚à°—à± */
}

/* à°®à°¨à°‚ à°œà°°à°¿à°ªà±‡ à°¬à°¾à°°à± (Thumb - Handle) */
::-webkit-scrollbar-thumb {
  background: #888; /* à°¬à±‚à°¡à°¿à°¦ à°°à°‚à°—à± */
  border-radius: 6px; /* à°¬à°¾à°°à± à°—à±à°‚à°¡à±à°°à°‚à°—à°¾ à°°à°¾à°µà°¡à°¾à°¨à°¿à°•à°¿ */
  border: 3px solid #f1f1f1; /* à°¬à°¾à°°à± à°šà±à°Ÿà±à°Ÿà±‚ à°•à±Šà°‚à°šà±†à°‚ à°–à°¾à°³à±€ à°°à°¾à°µà°¡à°¾à°¨à°¿à°•à°¿ */
}

/* à°®à±Œà°¸à± à°¸à±à°•à±à°°à±‹à°²à± à°¬à°¾à°°à± à°®à±€à°¦ à°ªà±†à°Ÿà±à°Ÿà°¿à°¨à°ªà±à°ªà±à°¡à± (Hover Effect) */
::-webkit-scrollbar-thumb:hover {
  background: #555; /* à°®à±à°¦à±à°°à± à°°à°‚à°—à± */
}

/* 2. Firefox à°¬à±à°°à±Œà°œà°°à± à°•à±‹à°¸à°‚ (Firefox à°µà±‡à°°à±‡ à°ªà°¦à±à°§à°¤à°¿à°¨à°¿ à°µà°¾à°¡à±à°¤à±à°‚à°¦à°¿) */
html {
  scrollbar-width: thin; /* 'auto' à°²à±‡à°¦à°¾ 'thin' */
  scrollbar-color: #888 #f1f1f1; /* thumb color | track color */
}
</file>

<file path="app/layout.tsx">
import type { Metadata } from "next";
import "./globals.css";
import { Toaster } from "@/components/ui/Toaster";

export const metadata: Metadata = {
  title: "Hyundai Spares - Admin Dashboard",
  description: "Modern admin dashboard for Hyundai spare parts e-commerce",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en" className="dark">
      <body className="antialiased">
        {children}
        <Toaster />
      </body>
    </html>
  );
}
</file>

<file path="app/login/page.tsx">
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { motion } from "framer-motion";
import { Lock, Mail, Eye, EyeOff } from "lucide-react";
import Button from "@/components/ui/Button";
import { AdminAuthService } from "@/lib/api";
import { toast } from "sonner";
import Cookies from "js-cookie";
export default function LoginPage() {
  const router = useRouter();
  const [showPassword, setShowPassword] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [formData, setFormData] = useState({
    email: "",
    password: "",
  });

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);

    try {
      const response = await AdminAuthService.login(formData);

      // Store token from response
      const token =
        response.data.data?.accessToken || response.data.accessToken;
      const adminId = response.data.data?.admin?.id || response.data.admin?.id;
      if (token) {
        localStorage.setItem("token", token);
        Cookies.set("accessToken", token, { expires: 1 });
        Cookies.set("admin", adminId, { expires: 1 });
      }

      toast.success("Login successful! Welcome to Hyundai Admin");
      router.push("/dashboard");
    } catch (error: any) {
      console.error("Login error:", error);
      toast.error(
        error.response?.data?.message ||
          "Login failed. Please check your credentials.",
      );
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="relative flex min-h-screen items-center justify-center overflow-hidden bg-gradient-to-br from-gray-950 via-gray-900 to-gray-950">
      {/* Animated Background */}
      <div className="absolute inset-0 overflow-hidden">
        <motion.div
          animate={{
            scale: [1, 1.2, 1],
            rotate: [0, 90, 0],
          }}
          transition={{
            duration: 20,
            repeat: Infinity,
            ease: "linear",
          }}
          className="absolute -top-1/2 -right-1/2 h-full w-full rounded-full bg-blue-500/10 blur-3xl"
        />
        <motion.div
          animate={{
            scale: [1, 1.1, 1],
            rotate: [0, -90, 0],
          }}
          transition={{
            duration: 25,
            repeat: Infinity,
            ease: "linear",
          }}
          className="absolute -bottom-1/2 -left-1/2 h-full w-full rounded-full bg-cyan-500/10 blur-3xl"
        />
      </div>

      {/* Login Card */}
      <motion.div
        initial={{ opacity: 0, y: 50, scale: 0.9 }}
        animate={{ opacity: 1, y: 0, scale: 1 }}
        transition={{ duration: 0.7, ease: [0.4, 0, 0.2, 1] }}
        className="relative z-10 w-full max-w-md"
      >
        <div className="glass-effect rounded-3xl border border-white/10 p-8 shadow-2xl">
          {/* Logo */}
          <motion.div
            initial={{ opacity: 0, y: -20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.2, duration: 0.5 }}
            className="mb-8 text-center"
          >
            <div className="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-2xl bg-gradient-to-br from-blue-500 to-cyan-500 shadow-lg shadow-blue-500/50">
              <svg
                className="h-8 w-8 text-white"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2.5}
                  d="M13 10V3L4 14h7v7l9-11h-7z"
                />
              </svg>
            </div>
            <h1 className="text-3xl font-bold text-white">Welcome Back</h1>
            <p className="mt-2 text-gray-400">
              Sign in to Varshini Hyundai Spares Admin
            </p>
          </motion.div>

          {/* Form */}
          <form onSubmit={handleSubmit} className="space-y-5">
            <motion.div
              initial={{ opacity: 0, x: -20 }}
              animate={{ opacity: 1, x: 0 }}
              transition={{ delay: 0.3, duration: 0.5 }}
            >
              <label className="mb-2 block text-sm font-medium text-gray-300">
                Email Address
              </label>
              <div className="relative">
                <Mail className="absolute left-4 top-1/2 h-5 w-5 -translate-y-1/2 text-gray-400" />
                <input
                  type="email"
                  required
                  value={formData.email}
                  onChange={(e) =>
                    setFormData({ ...formData, email: e.target.value })
                  }
                  className="w-full rounded-xl border border-white/10 bg-white/5 py-3 pl-12 pr-4 text-white placeholder-gray-400 backdrop-blur-sm transition-all focus:border-blue-500/50 focus:bg-white/10 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
                  placeholder="admin@hyundai.com"
                />
              </div>
            </motion.div>

            <motion.div
              initial={{ opacity: 0, x: -20 }}
              animate={{ opacity: 1, x: 0 }}
              transition={{ delay: 0.4, duration: 0.5 }}
            >
              <label className="mb-2 block text-sm font-medium text-gray-300">
                Password
              </label>
              <div className="relative">
                <Lock className="absolute left-4 top-1/2 h-5 w-5 -translate-y-1/2 text-gray-400" />
                <input
                  type={showPassword ? "text" : "password"}
                  required
                  value={formData.password}
                  onChange={(e) =>
                    setFormData({ ...formData, password: e.target.value })
                  }
                  className="w-full rounded-xl border border-white/10 bg-white/5 py-3 pl-12 pr-12 text-white placeholder-gray-400 backdrop-blur-sm transition-all focus:border-blue-500/50 focus:bg-white/10 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                />
                <button
                  type="button"
                  onClick={() => setShowPassword(!showPassword)}
                  className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 transition-colors hover:text-white"
                >
                  {showPassword ? (
                    <EyeOff className="h-5 w-5" />
                  ) : (
                    <Eye className="h-5 w-5" />
                  )}
                </button>
              </div>
            </motion.div>

            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.5, duration: 0.5 }}
            >
              <Button
                type="submit"
                variant="primary"
                size="lg"
                className="w-full"
                isLoading={isLoading}
              >
                Sign In
              </Button>
            </motion.div>
          </form>

          {/* Footer */}
          <motion.p
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ delay: 0.6, duration: 0.5 }}
            className="mt-6 text-center text-sm text-gray-400"
          >
            Hyundai Spares Â© 2025. All rights reserved.
          </motion.p>
        </div>
      </motion.div>
    </div>
  );
}
</file>

<file path="app/page.tsx">
import { redirect } from 'next/navigation';

export default function HomePage() {
  redirect('/login');
}
</file>

<file path="CHANGELOG.md">
# ðŸ”„ Changelog - Backend Integration Update

## Version 2.0 - Complete Backend Integration

### ðŸŽ¯ Major Updates Based on Official Backend Documentation

---

## 1. âœ… Complete API Service Refactor (`lib/api.ts`)

### What Changed
- **Completely rewrote** the API service layer to match your official backend documentation
- Organized into **5 main service groups**: AdminAuthService, ProductService, OrderService, PaymentService, DashboardService

### New Services

#### AdminAuthService
- âœ… `login()` - Admin authentication
- âœ… `refreshToken()` - Token refresh mechanism
- âœ… `getProfile()` - Get admin profile
- âœ… `updateProfile()` - Update admin details
- âœ… `changePassword()` - Change password
- âœ… `logout()` - Logout admin

#### ProductService  
- âœ… `getAll()` - Get products with filters (page, limit, category, search, sortBy)
- âœ… `getById()` - Get single product
- âœ… `getFeatured()` - Get featured products
- âœ… `getByCategory()` - Filter by category
- âœ… `create()` - Create product with images (FormData)
- âœ… `update()` - Update product with images (FormData)
- âœ… `updateStock()` - Update stock only
- âœ… `delete()` - Delete product (soft delete)
- âœ… `deleteImage()` - Remove product image
- âœ… `getLowStock()` - Get low stock products

#### OrderService
- âœ… `getAllOrders()` - Get all orders with filters (Admin)
- âœ… `getById()` - Get order details
- âœ… `updateStatus()` - Update order status (Placed â†’ Packed â†’ Shipped â†’ Delivered)
- âœ… `getInvoice()` - Download PDF invoice (Blob response)
- âœ… `cancelOrder()` - Cancel order with reason

#### PaymentService
- âœ… `getAllPayments()` - Get all payments (Admin)
- âœ… `getByOrderId()` - Get payment details
- âœ… `getPaymentMethods()` - Payment method statistics

#### DashboardService
- âœ… `getStats()` - Dashboard statistics
- âœ… `getMonthlyRevenue()` - Monthly revenue data (for charts)
- âœ… `getDailyRevenue()` - Daily revenue data
- âœ… `getRecentOrders()` - Latest orders
- âœ… `getLowStockProducts()` - Products below threshold
- âœ… `getTopSellingProducts()` - Best sellers
- âœ… `getSalesByCategory()` - Category-wise sales
- âœ… `getCustomerGrowth()` - Customer growth analytics

### Invoice Download Feature
Created helper function `downloadInvoice()` that:
- Fetches PDF as Blob
- Creates download link
- Auto-downloads with proper filename
- Cleans up resources

---

## 2. âœ… Real-time Socket.io Integration (`components/providers/SocketProvider.tsx`)

### What's New
Created a **Global Socket Context Provider** that handles all real-time features.

### Features Implemented

#### Server Events Listened
1. **`new_order`** (Admin Only)
   - ðŸ”” Animated toast notification
   - ðŸ”Š Sound effect plays
   - ðŸ“¦ Shows order number, amount, customer name
   - ðŸŽ¨ Shake animation to grab attention

2. **`order_status_updated`**
   - ðŸ“¦ Status change notification
   - ðŸŽ¨ Different icons per status (Package, Truck, CheckCircle)
   - ðŸŒˆ Color-coded by status
   - ðŸ”„ Auto-updates order list

3. **`payment_success`**
   - âœ… Payment confirmation toast
   - ðŸ’³ Shows payment amount
   - âœ¨ Rotating icon animation

4. **`payment_failed`**
   - âŒ Error notification
   - ðŸš¨ Alert styling

5. **`low_stock_alert`**
   - âš ï¸ Low stock warning
   - ðŸ“Š Shows remaining quantity
   - ðŸŽ¨ Yellow warning colors

#### Client Events Emitted
- âœ… `join_order_room(orderId)` - Join specific order room
- âœ… `leave_order_room(orderId)` - Leave order room

#### Authentication
- âœ… Sends JWT token in socket handshake
- âœ… Auto-reconnects if disconnected
- âœ… Shows connection status in UI

#### Notification Sound
- âœ… Plays subtle notification sound (base64 embedded)
- âœ… Volume controlled at 30%
- âœ… Graceful failure if audio blocked

---

## 3. âœ… Enhanced Dashboard Home (`app/dashboard/page.tsx`)

### New Features

#### Real API Integration
- âœ… Uses `DashboardService.getStats()` for statistics
- âœ… Uses `DashboardService.getMonthlyRevenue()` for revenue chart
- âœ… Uses `DashboardService.getRecentOrders()` for order list
- âœ… Uses `DashboardService.getTopSellingProducts()` for best sellers

#### Monthly Revenue Chart (Recharts)
- ðŸ“Š **AreaChart** with gradient fill
- ðŸ“ˆ 6-month revenue trend
- ðŸŽ¨ Green gradient matching Hyundai theme
- ðŸ’¡ Interactive tooltip with formatted values
- ðŸ“± Fully responsive

#### Recent Orders Widget
- ðŸ“‹ Shows last 5 orders
- ðŸ‘¤ Customer name and email
- ðŸ’° Order amount
- ðŸ·ï¸ Status badge with colors
- ðŸ”— "View All" link to orders page

#### Top Selling Products
- ðŸ† Displays top 5 products
- ðŸ”¢ Numbered rankings
- ðŸ“Š Total sales count
- ðŸ’µ Revenue per product
- ðŸŽ¨ Animated cards with hover effects

#### Enhanced Stats Cards
- âœ¨ All 4 cards now fetch real data
- ðŸ“ˆ Growth percentages shown
- ðŸŽ¯ Animated number counting from 0
- ðŸŽ¨ Smooth transitions

---

## 4. âœ… Complete Orders Management (`app/dashboard/orders/page.tsx`)

### NEW PAGE - Fully Functional

#### Order Status Flow
- âœ… **Placed** â†’ **Packed** â†’ **Shipped** â†’ **Delivered**
- âœ… **Cancelled** (separate flow)
- ðŸŽ¨ Each status has unique icon and color
- ðŸ”„ Dropdown to change status (inline)

#### Features

##### Filters & Search
- ðŸ” Search by order number, customer name, or email
- ðŸ·ï¸ Filter by status (All, Placed, Packed, Shipped, Delivered, Cancelled)
- ðŸ“Š Quick stats showing count per status

##### Order Table
- ðŸ“‹ Comprehensive order information
- ðŸ“„ Order number (code styling)
- ðŸ‘¤ Customer details
- ðŸ’° Amount with currency formatting
- ðŸ’³ Payment method & status
- ðŸ·ï¸ Order status with color coding
- ðŸ“… Order date

##### Actions
- ðŸ“¥ **Download Invoice** button (green)
  - Calls `OrderService.getInvoice()`
  - Downloads PDF with proper filename
  - Shows toast notifications
- ðŸ‘ï¸ **View Details** button (blue)
  - Opens order detail modal (ready for implementation)

##### Real-time Updates
- ðŸ”´ Live connection indicator
- ðŸ”„ Orders auto-update when status changes via Socket.io
- âœ… No page refresh needed

##### Status Management
- ðŸ“ Inline dropdown to update status
- ðŸŽ¯ Calls `OrderService.updateStatus()`
- âœ… Success notification
- ðŸ”„ Updates local state immediately
- ðŸ“¡ Broadcasts change via Socket.io

---

## 5. âœ… Updated Dashboard Layout (`app/dashboard/layout.tsx`)

### Changes
- âœ… Wrapped entire dashboard in `<SocketProvider>`
- âœ… Provides socket context to all child pages
- âœ… Handles global socket connection
- âœ… Manages all real-time event listeners

---

## 6. âœ… Updated Login Page (`app/login/page.tsx`)

### Changes
- âœ… Uses `AdminAuthService.login()` instead of generic auth
- âœ… Correctly extracts token from response
- âœ… Better error handling
- âœ… Updated success message

---

## 7. âœ… Updated Products Page (`app/dashboard/products/page.tsx`)

### Changes
- âœ… Uses `ProductService.getAll()` with proper response handling
- âœ… Handles nested response structure (`data.data.products`)
- âœ… Ready for pagination and filters

---

## 8. âœ… Removed Old Files

### Cleaned Up
- âŒ Deleted `lib/socket.ts` (replaced by SocketProvider)
- âœ… All socket logic now centralized in provider

---

## ðŸŽ¨ UI/UX Improvements

### Toast Notifications
- âœ¨ All toasts now use Framer Motion animations
- ðŸŽ¨ Custom styling per notification type
- ðŸŽµ Sound effects for important events
- â±ï¸ Auto-dismiss with configurable duration

### Live Status Indicator
- ðŸ”´ Shows "Live Updates On" when socket connected
- âš« Shows "Disconnected" when offline
- ðŸ’š Animated pulse effect

### Order Status Colors
```typescript
Placed    â†’ Blue
Packed    â†’ Purple
Shipped   â†’ Yellow/Orange
Delivered â†’ Green
Cancelled â†’ Red
```

---

## ðŸ“ Documentation Added

### New Files
1. **API_INTEGRATION_GUIDE.md** - Complete API documentation
   - All services explained
   - Socket.io events documented
   - Error handling guide
   - Testing instructions
   - Common issues & solutions

2. **SETUP_GUIDE.md** (Updated)
   - Environment variables
   - Quick start instructions
   - Feature checklist

---

## ðŸ”§ Technical Improvements

### Type Safety
- âœ… Proper TypeScript types for all API responses
- âœ… Type-safe socket event handlers
- âœ… Correct typing for order status updates

### Error Handling
- âœ… Try-catch blocks in all API calls
- âœ… User-friendly error messages
- âœ… Graceful fallbacks for development
- âœ… Console logging for debugging

### Performance
- âœ… Parallel API calls on dashboard (Promise.all)
- âœ… Efficient socket event listeners
- âœ… Cleanup functions to prevent memory leaks
- âœ… Optimized re-renders

---

## ðŸš€ What You Can Do Now

### Fully Working Features
1. âœ… Login with admin credentials
2. âœ… View real-time dashboard statistics
3. âœ… See monthly revenue chart (Recharts)
4. âœ… View recent orders list
5. âœ… See top selling products
6. âœ… Browse all products with filters
7. âœ… **Manage orders with full CRUD**
8. âœ… **Update order status (Placed â†’ Packed â†’ Shipped â†’ Delivered)**
9. âœ… **Download PDF invoices**
10. âœ… **Receive real-time order notifications**
11. âœ… **Get live status updates via Socket.io**
12. âœ… **Hear notification sounds**

### Ready for Implementation
- ðŸ“¦ Product CRUD (create/update/delete)
- ðŸ“Š Advanced analytics pages
- ðŸ‘¥ Customer management
- ðŸ·ï¸ Category management
- âš™ï¸ Settings page

---

## ðŸ”„ Migration Steps

If you're updating from the previous version:

1. **Backup your `.env.local`**
2. **Replace entire project** with new version
3. **Run `npm install`** (dependencies unchanged)
4. **Verify environment variables**:
   ```env
   NEXT_PUBLIC_API_URL=http://localhost:5000/api
   NEXT_PUBLIC_SOCKET_URL=http://localhost:5000
   ```
5. **Start backend** on port 5000
6. **Run `npm run dev`**
7. **Test login** with `admin@hyundaispares.com` / `Admin@12345`
8. **Check console** for socket connection: `âœ… Socket connected`
9. **Place test order** from your customer app to see real-time notification

---

## âœ… Testing Checklist

After updating, test these:

- [ ] Admin login works
- [ ] Dashboard statistics load
- [ ] Revenue chart displays
- [ ] Recent orders show
- [ ] Products page loads
- [ ] Orders page displays all orders
- [ ] Can filter orders by status
- [ ] Can search orders
- [ ] Can update order status
- [ ] Can download invoice (PDF)
- [ ] Socket.io connects (check console)
- [ ] Real-time notifications appear when order placed
- [ ] Notification sound plays
- [ ] Order status updates in real-time

---

## ðŸ› Known Issues & Future Enhancements

### For Future Updates
- [ ] Add order detail modal
- [ ] Implement product CRUD forms
- [ ] Add image upload for products
- [ ] Pagination for orders/products
- [ ] Advanced filtering options
- [ ] Export data to CSV/Excel
- [ ] Print invoice functionality
- [ ] Dark/Light mode toggle
- [ ] Multi-language support

---

## ðŸ“ž Support

If you encounter issues:

1. **Check browser console** for errors
2. **Verify backend is running** on port 5000
3. **Test API endpoints** with Postman
4. **Check Socket.io connection** in console
5. **Review API_INTEGRATION_GUIDE.md**

---

**Happy Coding! ðŸš€**

All features are now fully integrated with your official backend API!
</file>

<file path="components/AdminChatComponent.jsx">
"use client";

import { useEffect, useState, useRef, useMemo } from "react";
import { io, Socket } from "socket.io-client";
import Cookies from "js-cookie";
import { format } from "date-fns";
import { motion, AnimatePresence } from "framer-motion";
import {
  Activity,
  ShoppingCart,
  Smartphone,
  Monitor,
  MapPin,
  Battery,
  MessageCircle,
  Wifi,
  History,
  X,
  Send,
  User,
  Bell,
  MousePointer2,
  AlertTriangle,
  Clock,
  Radio,
  ShoppingBag,
  CreditCard,
  Zap,
  Package,
  ChevronRight,
  Sparkles,
} from "lucide-react";
import toast, { Toaster } from "react-hot-toast";

const SOCKET_URL = (
  process.env.NEXT_PUBLIC_API_URL || "http://localhost:5000"
).replace(/\/api\/?$/, "");

// ðŸ”Š Audio Objects
const notificationSound =
  typeof window !== "undefined"
    ? new Audio(
        "https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"
      )
    : null;

const cartSound =
  typeof window !== "undefined"
    ? new Audio(
        "https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"
      )
    : null;

export default function LiveMonitor() {
  const [logs, setLogs] = useState<any[]>([]);
  const [isConnected, setIsConnected] = useState(false);

  // ðŸ’¬ Chat Modal States
  const [isChatOpen, setIsChatOpen] = useState(false);
  const [targetUserId, setTargetUserId] = useState<string | null>(null);
  const [targetUserName, setTargetUserName] = useState<string>("");
  const [messageInput, setMessageInput] = useState("");

  // ðŸ”¥ Incoming Reply Popup State
  const [incomingReply, setIncomingReply] = useState<any | null>(null);

  const socketRef = useRef<Socket | null>(null);

  useEffect(() => {
    const token = Cookies.get("accessToken");

    socketRef.current = io(SOCKET_URL, {
      auth: { token },
      path: "/socket.io/",
      transports: ["websocket"],
      autoConnect: true,
    });

    socketRef.current.on("connect", () => {
      setIsConnected(true);
      socketRef.current?.emit("join_room", "admin");
    });

    socketRef.current.on("disconnect", () => setIsConnected(false));

    socketRef.current.on("new_live_activity", (data: any) => {
      if (data.action === "ADD_TO_CART" && cartSound) {
        try {
          cartSound.currentTime = 0;
          cartSound.play().catch(() => {});
        } catch (e) {}
      }
      setLogs((prev) => [data, ...prev].slice(0, 100));
    });

    socketRef.current.on("admin_receive_reply", (data: any) => {
      try {
        if (notificationSound) {
          notificationSound.currentTime = 0;
          notificationSound.play().catch(() => {});
        }
      } catch (e) {}
      setIncomingReply(data);
    });

    return () => {
      socketRef.current?.disconnect();
    };
  }, []);

  // =================================================================
  // ðŸ”¥ LOGIC: ACTIVE CART LIST + PRIORITY ACTIONS
  // =================================================================
  const activeUsers = useMemo(() => {
    const userGroups = new Map();

    logs.forEach((log) => {
      const key = log.userId || log.guestId || log.userName;
      if (!userGroups.has(key)) {
        userGroups.set(key, []);
      }
      userGroups.get(key).push(log);
    });

    const finalDisplayList: any[] = [];

    userGroups.forEach((userHistory, key) => {
      let logToShow = userHistory[0]; // Latest Log
      const latestMeta = userHistory[0].meta || {}; // Always use latest meta for Cart Data

      // Priority Logic for Action Badge (Status)
      const IMPORTANT_ACTIONS = ["ADD_TO_CART", "CHECKOUT_INIT", "BUY_NOW"];
      if (!IMPORTANT_ACTIONS.includes(logToShow.action)) {
        const recentImportantLog = userHistory
          .slice(0, 5)
          .find((l: any) => IMPORTANT_ACTIONS.includes(l.action));

        if (recentImportantLog) {
          logToShow = {
            ...recentImportantLog,
            timestamp: userHistory[0].timestamp, // Show current time
          };
        }
      }

      // Attach the LATEST meta (which contains the full cart list)
      logToShow = { 
        ...logToShow, 
        meta: latestMeta, 
        historyCount: userHistory.length 
      };
      
      finalDisplayList.push(logToShow);
    });

    return finalDisplayList;
  }, [logs]);

  const openChatModal = (userId: string, userName: string) => {
    if (!userId) {
      toast.error("Guest user - Cannot chat");
      return;
    }
    setTargetUserId(userId);
    setTargetUserName(userName);
    setIsChatOpen(true);
    setIncomingReply(null);
  };

  const handleSendMessage = () => {
    if (!messageInput.trim()) return;

    if (socketRef.current && targetUserId) {
      socketRef.current.emit("admin_send_message_trigger", {
        targetUserId: targetUserId,
        message: messageInput,
      });
      toast.success(`Message sent to ${targetUserName}!`);
      setMessageInput("");
      setIsChatOpen(false);
    }
  };

  return (
    <div className="min-h-screen bg-[#020617] text-gray-200 font-sans selection:bg-cyan-500/30 overflow-x-hidden relative">
      <Toaster position="top-right" />

      {/* ðŸŒŒ Background Ambience */}
      <div className="fixed inset-0 pointer-events-none">
        <div className="absolute top-[-10%] left-[-10%] w-[600px] h-[600px] bg-blue-600/10 rounded-full blur-[120px] animate-pulse"></div>
        <div className="absolute bottom-[-10%] right-[-10%] w-[600px] h-[600px] bg-purple-600/10 rounded-full blur-[120px] delay-1000"></div>
        <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 brightness-100 contrast-150 mix-blend-overlay"></div>
      </div>

      <header className="sticky top-0 z-40 bg-[#020617]/80 backdrop-blur-xl border-b border-white/5 px-6 py-4 shadow-2xl">
        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
          <div className="flex items-center gap-3">
            <div className="p-2.5 bg-gradient-to-br from-indigo-600 to-blue-600 rounded-xl shadow-lg shadow-indigo-500/20 border border-white/10">
              <Activity className="text-white w-6 h-6 animate-pulse" />
            </div>
            <div>
              <h1 className="text-xl font-black tracking-widest text-white">
                LIVE <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">MONITOR</span>
              </h1>
              <div className="flex items-center gap-2 mt-0.5">
                <span className={`w-1.5 h-1.5 rounded-full ${isConnected ? "bg-emerald-500 animate-ping" : "bg-red-500"}`}></span>
                <span className={`text-[10px] font-mono uppercase tracking-widest ${isConnected ? "text-emerald-500" : "text-red-500"}`}>
                  {isConnected ? "System Online" : "Reconnecting..."}
                </span>
              </div>
            </div>
          </div>
          <div className="flex items-center gap-3 bg-white/5 px-5 py-2 rounded-full border border-white/10 backdrop-blur-md shadow-inner">
            <Radio size={16} className={`text-cyan-400 ${activeUsers.length > 0 ? "animate-pulse" : ""}`} />
            <span className="text-sm font-bold text-gray-200">
              Active Sessions: <span className="text-cyan-400 text-lg mx-1">{activeUsers.length}</span>
            </span>
          </div>
        </div>
      </header>

      {/* ðŸ“¡ Activity Grid */}
      <main className="max-w-7xl mx-auto p-6 relative z-10">
        {activeUsers.length === 0 ? (
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="flex flex-col items-center justify-center h-[60vh] text-gray-500">
            <div className="w-24 h-24 bg-white/5 rounded-full flex items-center justify-center mb-6 animate-pulse border border-white/5">
              <Wifi size={48} className="text-indigo-500/50" />
            </div>
            <h2 className="text-2xl font-bold text-gray-400 mb-2">Radar Empty</h2>
            <p className="text-sm font-mono text-gray-600">Waiting for user activity...</p>
          </motion.div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            <AnimatePresence>
              {activeUsers.map((log) => {
                const meta = log.meta || {};
                const isTabActive = meta.isTabActive !== false;
                const isExitIntent = log.action === "EXIT_INTENT";
                const isAddToCart = log.action === "ADD_TO_CART";
                const isCheckout = log.action === "CHECKOUT_INIT";
                const uniqueKey = log.userId || log.guestId || log.userName;

                // Cart Logic
                const cartItems = meta.cart?.items || [];
                const cartTotal = meta.cart?.total || 0;

                return (
                  <motion.div
                    key={uniqueKey}
                    layout
                    initial={{ opacity: 0, scale: 0.9 }}
                    animate={{ opacity: 1, scale: 1 }}
                    exit={{ opacity: 0, scale: 0.9 }}
                    transition={{ duration: 0.4, type: "spring" }}
                    className={`group relative overflow-hidden rounded-[1.5rem] border backdrop-blur-xl transition-all duration-300
                      ${
                        isExitIntent ? "bg-red-950/30 border-red-500/50 shadow-[0_0_40px_-10px_rgba(239,68,68,0.4)]"
                        : isAddToCart ? "bg-emerald-950/40 border-emerald-500/50 shadow-[0_0_40px_-10px_rgba(16,185,129,0.3)] ring-1 ring-emerald-500/30"
                        : isCheckout ? "bg-purple-950/40 border-purple-500/50 shadow-[0_0_40px_-10px_rgba(168,85,247,0.3)]"
                        : isTabActive ? "bg-[#0F172A]/80 border-cyan-500/20 shadow-lg shadow-cyan-900/10 hover:border-cyan-500/50"
                        : "bg-[#0F172A]/40 border-white/5 opacity-60 grayscale"
                      }
                    `}
                  >
                    <div className={`absolute inset-x-0 top-0 h-[1px] bg-gradient-to-r from-transparent via-white/20 to-transparent opacity-50`}></div>

                    <div className="p-6 relative z-10">
                      {/* Top Row: User Info */}
                      <div className="flex justify-between items-start mb-4">
                        <div className="flex items-center gap-3">
                          <div className={`p-3 rounded-2xl border backdrop-blur-sm ${meta.device === "Mobile" ? "bg-purple-500/10 border-purple-500/30 text-purple-400" : "bg-blue-500/10 border-blue-500/30 text-blue-400"}`}>
                            {meta.device === "Mobile" ? <Smartphone size={20} /> : <Monitor size={20} />}
                          </div>
                          <div>
                            <h3 className="font-bold text-white text-base truncate max-w-[140px] flex items-center gap-2">
                              {log.userName}
                              {log.userId ? <div className="p-1 bg-cyan-500/10 rounded"><User size={10} className="text-cyan-400" /></div> : <span className="text-[9px] bg-white/10 px-1.5 py-0.5 rounded text-gray-400 border border-white/5">GUEST</span>}
                            </h3>
                            <div className="flex items-center gap-1.5 text-xs text-gray-400 mt-1">
                              <MapPin size={12} className="text-indigo-400" />
                              {meta.location || "Unknown"}
                            </div>
                          </div>
                        </div>

                        <div className={`px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider border flex items-center gap-1.5 shadow-inner
                          ${isExitIntent ? "bg-red-500/10 text-red-400 border-red-500/30"
                          : isAddToCart ? "bg-emerald-500/10 text-emerald-400 border-emerald-500/30"
                          : isTabActive ? "bg-cyan-500/10 text-cyan-400 border-cyan-500/30"
                          : "bg-gray-700/30 text-gray-500 border-gray-700"}`}
                        >
                          <span className={`w-1.5 h-1.5 rounded-full ${isExitIntent ? "bg-red-500 animate-ping" : isAddToCart ? "bg-emerald-500 animate-bounce" : isTabActive ? "bg-cyan-500 animate-pulse" : "bg-gray-500"}`}></span>
                          {isExitIntent ? "LEAVING" : isAddToCart ? "BUYING" : isTabActive ? "ONLINE" : "IDLE"}
                        </div>
                      </div>

                      {/* ðŸ”¥ðŸ”¥ðŸ”¥ FULL CART LIST VIEW (SCROLLABLE) ðŸ”¥ðŸ”¥ðŸ”¥ */}
                      {cartItems.length > 0 && (
                        <div className="mb-4 bg-[#020617]/60 border border-white/10 rounded-xl overflow-hidden shadow-inner">
                           <div className="bg-white/5 px-3 py-2 border-b border-white/5 flex justify-between items-center">
                              <span className="text-[10px] font-bold text-gray-400 uppercase tracking-widest flex items-center gap-1">
                                <ShoppingBag size={10} /> Active Cart ({cartItems.length})
                              </span>
                              <span className="text-xs font-bold text-emerald-400">Total: â‚¹{cartTotal.toLocaleString()}</span>
                           </div>
                           
                           {/* Scrollable List */}
                           <div className="max-h-[140px] overflow-y-auto p-2 space-y-1.5 custom-scrollbar">
                              {cartItems.map((item: any, idx: number) => (
                                <div key={idx} className="flex items-center gap-3 p-2 bg-white/5 rounded-lg hover:bg-white/10 transition-colors border border-white/5">
                                   {/* Product Image */}
                                   <div className="w-8 h-8 rounded bg-gray-800 flex-shrink-0 overflow-hidden">
                                      {item.image ? (
                                        <img src={item.image} alt="" className="w-full h-full object-cover" />
                                      ) : (
                                        <Package className="w-full h-full p-1.5 text-gray-500" />
                                      )}
                                   </div>
                                   {/* Details */}
                                   <div className="flex-1 min-w-0">
                                      <p className="text-xs font-bold text-gray-200 truncate">{item.name || "Product Name"}</p>
                                      <p className="text-[10px] text-gray-500">Qty: {item.qty || 1} â€¢ â‚¹{item.price}</p>
                                   </div>
                                </div>
                              ))}
                           </div>
                        </div>
                      )}

                      {/* Middle: Action Context Card */}
                      <div className="bg-[#020617]/50 rounded-2xl p-4 border border-white/5 mb-5 relative overflow-hidden">
                        <div className="flex items-center justify-between mb-3 relative z-10">
                          <span className={`text-xs font-black uppercase tracking-widest flex items-center gap-2 ${isExitIntent ? "text-red-400" : isAddToCart ? "text-emerald-400" : "text-cyan-400"}`}>
                            {isExitIntent ? <AlertTriangle size={14} /> : isAddToCart ? <ShoppingCart size={14} /> : <Zap size={14} />}
                            {log.action.replace("_", " ")}
                          </span>
                          <span className="text-[10px] text-gray-500 font-mono flex items-center gap-1">
                            <Clock size={10} />
                            {log.timestamp ? format(new Date(log.timestamp), "hh:mm:ss a") : "Now"}
                          </span>
                        </div>

                        <div className="relative z-10">
                          <p className="text-xs text-gray-400 font-mono truncate pl-2 border-l-2 border-white/10 opacity-80 mb-2">path: {log.path}</p>
                          {/* Event Specific Displays (Click/Add) */}
                          {log.action === "CLICK" && (
                            <div className="mt-2 bg-yellow-500/5 border border-yellow-500/20 px-3 py-2 rounded-lg flex items-center gap-2 text-yellow-200/80">
                              <MousePointer2 size={14} className="text-yellow-500" />
                              <span className="text-xs font-medium">Clicked: <span className="text-white font-bold">"{log.details?.element || "Item"}"</span></span>
                            </div>
                          )}
                        </div>
                      </div>

                      {/* Bottom Stats */}
                      <div className="flex items-center justify-between">
                        <div className="flex gap-2">
                          <div className="flex items-center gap-1.5 text-[10px] text-gray-500 bg-white/5 px-2.5 py-1 rounded-lg border border-white/5">
                            <History size={10} /> {log.historyCount} actions
                          </div>
                          {meta.battery && (
                            <div className="flex items-center gap-1.5 text-[10px] text-gray-500 bg-white/5 px-2.5 py-1 rounded-lg border border-white/5">
                              <Battery size={10} className={parseInt(meta.battery) < 20 ? "text-red-500" : "text-emerald-500"} /> {meta.battery}
                            </div>
                          )}
                        </div>
                        {log.userId && (
                          <button onClick={() => openChatModal(log.userId, log.userName)} className="p-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg transition-all active:scale-95 group/btn border-t border-white/20">
                            <MessageCircle size={16} />
                          </button>
                        )}
                      </div>
                    </div>
                  </motion.div>
                );
              })}
            </AnimatePresence>
          </div>
        )}
      </main>

      {/* ========================================================== */}
      {/* ðŸ”¥ MODERN BEAUTIFUL REPLY MODAL (ANIMATED) */}
      {/* ========================================================== */}
      <AnimatePresence>
        {incomingReply && (
          <div className="fixed inset-0 z-[10000] flex items-center justify-center p-4">
             {/* Backdrop */}
             <motion.div 
               initial={{ opacity: 0 }} 
               animate={{ opacity: 1 }} 
               exit={{ opacity: 0 }} 
               className="absolute inset-0 bg-black/60 backdrop-blur-sm"
               onClick={() => setIncomingReply(null)}
             />

             {/* Main Card */}
             <motion.div 
               initial={{ opacity: 0, scale: 0.9, y: 30 }} 
               animate={{ opacity: 1, scale: 1, y: 0 }} 
               exit={{ opacity: 0, scale: 0.9, y: 30 }}
               transition={{ type: "spring", bounce: 0.4, duration: 0.6 }}
               className="relative w-full max-w-md bg-[#0F172A] border border-white/10 rounded-3xl shadow-[0_0_60px_-15px_rgba(16,185,129,0.3)] overflow-hidden ring-1 ring-emerald-500/30"
             >
                {/* Decorative Top Glow */}
                <div className="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-emerald-500 via-teal-400 to-cyan-500 shadow-[0_0_20px_rgba(16,185,129,0.5)]"></div>

                <div className="p-8 relative">
                   {/* Icon & Header */}
                   <div className="flex items-center gap-4 mb-6">
                      <div className="relative">
                         <div className="absolute inset-0 bg-emerald-500 blur-xl opacity-40 rounded-full"></div>
                         <div className="bg-gradient-to-br from-emerald-500 to-teal-600 w-14 h-14 rounded-2xl flex items-center justify-center shadow-lg relative z-10 text-white border border-white/20">
                            <Sparkles size={28} />
                         </div>
                         <div className="absolute -bottom-1 -right-1 bg-[#0F172A] rounded-full p-1 border border-white/10 z-20">
                            <MessageCircle size={14} className="text-emerald-400" />
                         </div>
                      </div>
                      <div>
                         <h3 className="text-2xl font-black text-white leading-none tracking-tight">New Message</h3>
                         <div className="flex items-center gap-1.5 mt-2">
                            <span className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span>
                            <p className="text-emerald-400 text-sm font-bold">{incomingReply.userName} is replying</p>
                         </div>
                      </div>
                   </div>

                   {/* Message Content Area */}
                   <div className="bg-gradient-to-b from-white/5 to-transparent border border-white/10 rounded-2xl p-5 mb-8 relative">
                      <div className="absolute -left-[1px] top-4 bottom-4 w-1 bg-emerald-500/50 rounded-r-full"></div>
                      <p className="text-gray-200 text-lg leading-relaxed font-medium">"{incomingReply.message}"</p>
                      <p className="text-[10px] text-gray-500 mt-3 text-right uppercase tracking-widest font-mono">Just Now</p>
                   </div>

                   {/* Actions */}
                   <div className="flex gap-3">
                      <button 
                        onClick={() => setIncomingReply(null)} 
                        className="flex-1 py-3.5 bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white rounded-xl font-bold transition-all border border-white/5"
                      >
                        Dismiss
                      </button>
                      <button 
                        onClick={() => openChatModal(incomingReply.userId, incomingReply.userName)} 
                        className="flex-[1.5] py-3.5 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white font-bold rounded-xl shadow-lg shadow-emerald-900/50 hover:shadow-emerald-900/70 hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2 border-t border-white/20"
                      >
                        <Send size={18} /> Quick Reply
                      </button>
                   </div>
                </div>
             </motion.div>
          </div>
        )}
      </AnimatePresence>

      {/* ðŸ’¬ Admin Chat Modal (Keeping same logic) */}
      <AnimatePresence>
        {isChatOpen && (
          <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
            <motion.div initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0, scale: 0.95 }} className="bg-[#0F172A] border border-white/10 p-0 rounded-3xl w-full max-w-md shadow-2xl overflow-hidden">
               <div className="flex justify-between items-center p-6 border-b border-white/5 bg-white/5">
                  <h3 className="text-lg font-bold text-white">Reply to {targetUserName}</h3>
                  <button onClick={() => setIsChatOpen(false)} className="text-gray-400 hover:text-white"><X size={20} /></button>
               </div>
               <div className="p-6">
                  <textarea value={messageInput} onChange={(e) => setMessageInput(e.target.value)} placeholder="Type your message..." className="w-full h-32 bg-black/40 border border-white/10 rounded-xl p-4 text-white focus:ring-1 focus:ring-emerald-500 focus:outline-none" autoFocus />
               </div>
               <div className="p-6 pt-0 flex justify-end gap-3">
                  <button onClick={() => setIsChatOpen(false)} className="px-5 py-2.5 text-gray-400 hover:text-white rounded-xl hover:bg-white/5">Cancel</button>
                  <button onClick={handleSendMessage} disabled={!messageInput.trim()} className="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl shadow-lg flex items-center gap-2"><Send size={16} /> Send</button>
               </div>
            </motion.div>
          </div>
        )}
      </AnimatePresence>
    </div>
  );
}
</file>

<file path="components/ChatComponent.jsx">
"use client";

import { useState, useEffect, useRef } from "react";
import io from "socket.io-client";
import axios from "axios";
import {
  Send,
  Paperclip,
  X,
  Image as ImageIcon,
  Video,
  Loader2,
  Check,
  CheckCheck,
} from "lucide-react";

export default function ChatComponent({
  currentUserId,
  otherUserId,
  otherUserModel = "Admin",
  otherUserName = "User",
  token,
  apiUrl = "http://localhost:5000",
  isDarkMode, // ðŸ”¥ Parent à°¨à±à°‚à°¡à°¿ à°µà°¸à±à°¤à±à°‚à°¦à°¿
}) {
  const [socket, setSocket] = useState(null);
  const [messages, setMessages] = useState([]);
  const [inputText, setInputText] = useState("");
  const [otherUserTyping, setOtherUserTyping] = useState(false);
  const [selectedFile, setSelectedFile] = useState(null);
  const [uploading, setUploading] = useState(false);

  const messagesEndRef = useRef(null);
  const fileInputRef = useRef(null);
  const typingTimeoutRef = useRef(null);

  const roomId = [currentUserId, otherUserId].sort().join("_");

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages, otherUserTyping, selectedFile]);

  // --- SOCKET LOGIC ---
  useEffect(() => {
    if (!token || !currentUserId || !otherUserId) return;
    const socketUrl = apiUrl.replace("/api", "");
    const newSocket = io(socketUrl, {
      auth: { token },
      withCredentials: true,
      transports: ["websocket"],
    });
    setSocket(newSocket);

    newSocket.on("connect", () => {
      newSocket.emit("join_room", { roomId });
      fetchChatHistory();
    });

    newSocket.on("new_message", (data) => {
      if (data.roomId === roomId) {
        setMessages((prev) => {
          const exists = prev.some((msg) => msg._id === data.message._id);
          if (exists) return prev;
          return [...prev, data.message];
        });
        if (data.message.senderId !== currentUserId) {
          newSocket.emit("mark_read", { messageId: data.message._id, roomId });
        }
      }
    });

    newSocket.on("typing", (data) => {
      if (data.userId !== currentUserId && data.roomId === roomId)
        setOtherUserTyping(true);
    });

    newSocket.on("stop_typing", (data) => {
      if (data.userId !== currentUserId && data.roomId === roomId)
        setOtherUserTyping(false);
    });

    newSocket.on("message_read", (data) => {
      if (data.roomId === roomId) {
        setMessages((prev) =>
          prev.map((msg) =>
            msg._id === data.messageId ? { ...msg, isRead: true } : msg,
          ),
        );
      }
    });

    return () => {
      newSocket.off("new_message");
      newSocket.emit("leave_room", { roomId });
      newSocket.disconnect();
    };
  }, [currentUserId, otherUserId, token, roomId, apiUrl]);

  const fetchChatHistory = async () => {
    try {
      const res = await axios.get(`${apiUrl}/api/chat/history/${roomId}`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      if (res.data.success) {
        const historyData = res.data.data?.messages || [];
        setMessages(Array.isArray(historyData) ? historyData : []);
      }
    } catch (error) {
      setMessages([]);
    }
  };

  const uploadAndSendFile = async () => {
    if (!selectedFile) return;
    setUploading(true);
    const formData = new FormData();
    formData.append("file", selectedFile);
    try {
      const res = await axios.post(`${apiUrl}/api/chat/upload`, formData, {
        headers: {
          "Content-Type": "multipart/form-data",
          Authorization: `Bearer ${token}`,
        },
      });
      if (res.data.success) {
        const { fileUrl, fileType, fileName, fileSize } = res.data.data;
        socket?.emit("send_message", {
          roomId,
          receiverId: otherUserId,
          receiverModel: otherUserModel,
          text: inputText || "",
          messageType: fileType,
          fileUrl: fileUrl,
          fileName: fileName,
          fileSize: fileSize,
          tempId: Date.now(),
        });
        setSelectedFile(null);
        setInputText("");
      }
    } catch (error) {
      alert("File upload failed.");
    } finally {
      setUploading(false);
    }
  };

  const sendMessage = () => {
    if (selectedFile) {
      uploadAndSendFile();
      return;
    }
    if (!inputText.trim()) return;
    socket?.emit("send_message", {
      roomId,
      receiverId: otherUserId,
      receiverModel: otherUserModel,
      text: inputText,
      messageType: "text",
      tempId: Date.now(),
    });
    setInputText("");
    socket?.emit("stop_typing", { roomId });
  };

  const handleTyping = () => {
    socket?.emit("typing", { roomId });
    if (typingTimeoutRef.current) clearTimeout(typingTimeoutRef.current);
    typingTimeoutRef.current = setTimeout(() => {
      socket?.emit("stop_typing", { roomId });
    }, 2000);
  };

  const handleFileSelect = (e) => {
    if (e.target.files && e.target.files[0]) setSelectedFile(e.target.files[0]);
  };

  const handleKeyPress = (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  };

  const isMessageFromMe = (msg) => {
    const senderId = msg.senderId?._id || msg.senderId;
    return senderId === currentUserId;
  };

  const formatTime = (timestamp) => {
    return new Date(timestamp).toLocaleTimeString("en-US", {
      hour: "2-digit",
      minute: "2-digit",
      hour12: true,
    });
  };

  // ==============================
  // UI RENDER
  // ==============================
  return (
    <div
      className={`flex flex-col h-full relative transition-colors duration-300 ${isDarkMode ? "bg-slate-950" : "bg-white"}`}
    >
      {/* HEADER */}
      <div
        className={`h-[72px] flex items-center justify-between px-6 shrink-0 transition-colors duration-300 ${
          isDarkMode
            ? "bg-slate-900 border-b border-slate-800"
            : "bg-white border-b border-gray-100"
        }`}
      >
        <div className="flex items-center gap-4">
          <div
            className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm ${
              isDarkMode ? "bg-slate-700 text-white" : "bg-[#0f172a] text-white"
            }`}
          >
            {otherUserName.charAt(0).toUpperCase()}
          </div>
          <div>
            <h2
              className={`font-bold text-base ${isDarkMode ? "text-white" : "text-[#0f172a]"}`}
            >
              {otherUserName}
            </h2>
            <div className="flex items-center gap-1.5">
              <span className="w-2 h-2 rounded-full bg-green-500"></span>
              <p
                className={`text-xs ${isDarkMode ? "text-slate-400" : "text-gray-500"}`}
              >
                Active now
              </p>
            </div>
          </div>
        </div>
      </div>

      {/* MESSAGES */}
      <div
        className={`flex-1 overflow-y-auto p-6 space-y-4 ${isDarkMode ? "bg-slate-950" : "bg-white"}`}
      >
        {Array.isArray(messages) &&
          messages.map((msg, index) => {
            const isMe = isMessageFromMe(msg);
            return (
              <div
                key={msg._id || index}
                className={`flex w-full ${isMe ? "justify-end" : "justify-start"}`}
              >
                <div
                  className={`flex flex-col max-w-[70%] ${isMe ? "items-end" : "items-start"}`}
                >
                  <div
                    className={`px-5 py-3 text-[15px] leading-relaxed relative shadow-sm ${
                      isMe
                        ? "bg-[#0f172a] text-white rounded-2xl rounded-tr-sm"
                        : isDarkMode
                          ? "bg-slate-800 text-slate-100 rounded-2xl rounded-tl-sm"
                          : "bg-gray-100 text-gray-900 rounded-2xl rounded-tl-sm"
                    }`}
                  >
                    {(msg.messageType === "image" ||
                      msg.messageType === "video") &&
                      msg.fileUrl && (
                        <div className="mb-2 rounded-lg overflow-hidden">
                          {msg.messageType === "image" ? (
                            <img
                              src={msg.fileUrl}
                              alt="media"
                              className="max-w-full h-auto cursor-pointer"
                              onClick={() => window.open(msg.fileUrl, "_blank")}
                            />
                          ) : (
                            <video
                              src={msg.fileUrl}
                              controls
                              className="max-w-full h-auto"
                            />
                          )}
                        </div>
                      )}
                    {msg.text && (
                      <p className="whitespace-pre-wrap">{msg.text}</p>
                    )}
                  </div>
                  <div
                    className={`text-[11px] mt-1.5 font-medium flex items-center gap-1 ${isDarkMode ? "text-slate-500" : "text-gray-400"}`}
                  >
                    {formatTime(msg.createdAt)}
                    {isMe &&
                      (msg.isRead ? (
                        <CheckCheck className="w-3.5 h-3.5 text-blue-500" />
                      ) : (
                        <Check className="w-3.5 h-3.5" />
                      ))}
                  </div>
                </div>
              </div>
            );
          })}
        {otherUserTyping && (
          <div className="text-xs text-gray-400 ml-4">typing...</div>
        )}
        <div ref={messagesEndRef} />
      </div>

      {/* INPUT */}
      <div
        className={`p-6 shrink-0 ${isDarkMode ? "bg-slate-900" : "bg-white"}`}
      >
        {selectedFile && (
          <div
            className={`flex items-center gap-3 p-2 rounded-lg mb-2 border w-fit ${isDarkMode ? "bg-slate-800 border-slate-700" : "bg-gray-50 border-gray-200"}`}
          >
            <span
              className={`text-xs font-medium truncate max-w-[200px] ${isDarkMode ? "text-white" : "text-gray-600"}`}
            >
              {selectedFile.name}
            </span>
            <button
              onClick={() => setSelectedFile(null)}
              className="bg-gray-200 rounded-full p-1"
            >
              <X className="w-3 h-3" />
            </button>
          </div>
        )}
        <div className="flex items-center gap-3">
          <input
            type="file"
            ref={fileInputRef}
            onChange={handleFileSelect}
            className="hidden"
          />
          <button
            onClick={() => fileInputRef.current?.click()}
            className={`p-3 rounded-xl transition-colors ${isDarkMode ? "bg-slate-800 hover:bg-slate-700 text-slate-400" : "bg-gray-100 hover:bg-gray-200 text-gray-500"}`}
          >
            <Paperclip className="w-5 h-5" />
          </button>
          <div className="flex-1 relative">
            <input
              type="text"
              value={inputText}
              onChange={(e) => {
                setInputText(e.target.value);
                handleTyping();
              }}
              onKeyPress={handleKeyPress}
              placeholder="Type a message..."
              disabled={uploading}
              className={`w-full rounded-xl px-4 py-3 pr-12 focus:outline-none focus:ring-2 focus:ring-blue-500/20 border transition-all ${
                isDarkMode
                  ? "bg-slate-800 text-white placeholder-slate-500 border-slate-700 focus:bg-slate-800"
                  : "bg-gray-100 text-gray-900 placeholder-gray-500 border-transparent focus:bg-white focus:border-gray-200"
              }`}
            />
          </div>
          <button
            onClick={sendMessage}
            disabled={(!inputText.trim() && !selectedFile) || uploading}
            className={`p-3 rounded-xl shadow-md transition-all flex items-center justify-center ${(!inputText.trim() && !selectedFile) || uploading ? "bg-gray-200 text-gray-400 cursor-not-allowed" : "bg-[#0f172a] text-white hover:bg-[#1e293b] hover:scale-105"}`}
          >
            {uploading ? (
              <Loader2 className="w-5 h-5 animate-spin" />
            ) : (
              <Send className="w-5 h-5" />
            )}
          </button>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="components/dashboard/InventoryForecast.tsx">
"use client";
import { useEffect, useState } from "react";
import { DashboardService } from "@/lib/api";
import { AlertTriangle, RefreshCw } from "lucide-react";
import { toast } from "sonner";

export default function InventoryForecast() {
  const [products, setProducts] = useState<any[]>([]);
  const [loading, setLoading] = useState(false);

  const fetchForecast = async () => {
    try {
      const res = await DashboardService.getInventoryForecast();
      setProducts(res.data?.data || []);
    } catch (e) {
      console.error(e);
    }
  };

  const refreshAI = async () => {
    setLoading(true);
    try {
      await DashboardService.triggerAICalculation();
      toast.success("AI Analysis Updated!");
      fetchForecast(); // Refresh list
    } catch (e) {
      toast.error("Failed to update AI");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchForecast();
  }, []);

  return (
    <div className="rounded-2xl border border-white/10 bg-white/[0.02] p-6">
      <div className="flex justify-between items-center mb-4">
        <div>
          <h3 className="text-lg font-semibold text-white flex items-center gap-2">
            <AlertTriangle className="h-5 w-5 text-amber-500" /> AI Stock Alerts
          </h3>
          <p className="text-sm text-gray-400">Predicted to run out soon</p>
        </div>
        <button
          onClick={refreshAI}
          disabled={loading}
          className="p-2 bg-white/5 hover:bg-white/10 rounded-lg transition"
        >
          <RefreshCw
            className={`h-4 w-4 text-gray-400 ${loading ? "animate-spin" : ""}`}
          />
        </button>
      </div>

      <div className="space-y-3">
        {products.length === 0 ? (
          <p className="text-sm text-gray-500 text-center py-4">
            Inventory looks healthy! âœ…
          </p>
        ) : (
          products.map((p: any) => (
            <div
              key={p._id}
              className="flex items-center gap-3 p-3 bg-red-500/5 border border-red-500/10 rounded-xl"
            >
              <img
                src={p.images?.[0]?.url}
                className="h-10 w-10 rounded-md object-cover"
                alt=""
              />
              <div className="flex-1 min-w-0">
                <p className="text-sm font-medium text-white truncate">
                  {p.name}
                </p>
                <p className="text-xs text-gray-400">Stock: {p.stock} units</p>
              </div>
              <div className="text-right">
                <p className="text-lg font-bold text-red-400">
                  {p.inventoryAnalytics?.daysRemaining || 0}
                </p>
                <p className="text-[10px] text-red-300/70">Days Left</p>
              </div>
            </div>
          ))
        )}
      </div>
    </div>
  );
}
</file>

<file path="components/dashboard/SalesHeatmap.tsx">
"use client";

import { useEffect, useState } from "react";
import {
  MapContainer,
  TileLayer,
  CircleMarker,
  Popup,
  Tooltip,
} from "react-leaflet";
import "leaflet/dist/leaflet.css";
import { DashboardService } from "@/lib/api";
import { formatCurrency } from "@/lib/utils";

// --- City Coordinates ---
const CITY_COORDINATES: Record<string, [number, number]> = {
  /* ===================== INDIA â€“ EXISTING CITIES ===================== */
  Delhi: [28.7041, 77.1025],
  Mumbai: [19.076, 72.8777],
  Kolkata: [22.5726, 88.3639],
  Chennai: [13.0827, 80.2707],
  Bangalore: [12.9716, 77.5946],
  Ahmedabad: [23.0225, 72.5714],
  Pune: [18.5204, 73.8567],
  Jaipur: [26.9124, 75.7873],
  Chandigarh: [30.7333, 76.7794],
  Bhopal: [23.2599, 77.4126],
  Indore: [22.7196, 75.8577],
  Lucknow: [26.8467, 80.9462],
  Kanpur: [26.4499, 80.3319],
  Patna: [25.5941, 85.1376],
  Ranchi: [23.3441, 85.3096],
  Bhubaneswar: [20.2961, 85.8245],
  Raipur: [21.2514, 81.6296],
  Guwahati: [26.1445, 91.7362],
  Shillong: [25.5788, 91.8933],
  Imphal: [24.817, 93.9368],
  Aizawl: [23.7271, 92.7176],
  Agartala: [23.8315, 91.2868],
  Itanagar: [27.0844, 93.6053],
  Kohima: [25.6747, 94.11],
  Gangtok: [27.3389, 88.6065],
  Thiruvananthapuram: [8.5241, 76.9366],
  Kochi: [9.9312, 76.2673],
  Coimbatore: [11.0168, 76.9558],
  Madurai: [9.9252, 78.1198],
  Tiruchirappalli: [10.7905, 78.7047],
  Vellore: [12.9165, 79.1325],
  Salem: [11.6643, 78.146],
  Udaipur: [24.5854, 73.7125],
  Jodhpur: [26.2389, 73.0243],
  Amritsar: [31.634, 74.8723],
  Ludhiana: [30.9, 75.8573],
  Jalandhar: [31.326, 75.5762],
  Dehradun: [30.3165, 78.0322],
  Haridwar: [29.9457, 78.1642],
  Shimla: [31.1048, 77.1734],
  Srinagar: [34.0837, 74.7973],
  Jammu: [32.7266, 74.857],
  Leh: [34.1526, 77.5771],

  /* ===================== ANDHRA PRADESH â€“ ALL DISTRICTS ===================== */
  Visakhapatnam: [17.6868, 83.2185],
  Anakapalli: [17.69, 82.9988],
  "Alluri Sitharama Raju": [18.1149, 82.9946],
  Vizianagaram: [18.1067, 83.3956],
  Srikakulam: [18.2969, 83.8973],
  "Parvathipuram Manyam": [18.7833, 83.425],
  Kakinada: [16.989, 82.2475],
  "East Godavari": [16.9891, 81.784],
  "West Godavari": [16.7107, 81.0952],
  Eluru: [16.7107, 81.0952],
  NTR: [16.5062, 80.648],
  Krishna: [16.507, 80.646],
  Guntur: [16.3067, 80.4365],
  Bapatla: [15.9042, 80.4676],
  Palnadu: [16.2, 79.9],
  Prakasam: [15.5057, 80.0499],
  "SPSR Nellore": [14.4426, 79.9865],
  Kurnool: [15.8281, 78.0373],
  Nandyal: [15.4786, 78.4831],
  Anantapur: [14.6819, 77.6006],
  "Sri Sathya Sai": [14.165, 77.809],
  "YSR Kadapa": [14.4674, 78.8241],
  Annamayya: [14.0, 79.2],
  Tirupati: [13.6288, 79.4192],
  Chittoor: [13.2172, 79.1003],

  /* ===================== TELANGANA â€“ ALL DISTRICTS ===================== */
  Hyderabad: [17.385, 78.4867],
  "Medchal Malkajgiri": [17.536, 78.481],
  Rangareddy: [17.2403, 78.4294],
  Sangareddy: [17.6297, 78.09],
  Vikarabad: [17.3381, 77.9044],
  Medak: [18.0453, 78.2608],
  Siddipet: [18.1019, 78.852],
  Warangal: [17.9689, 79.5941],
  Hanamkonda: [18.0, 79.5667],
  Jangaon: [17.726, 79.1524],
  Mahabubabad: [17.5983, 80.002],
  "Jayashankar Bhupalpally": [18.41, 79.874],
  Mulugu: [18.189, 80.0169],
  Karimnagar: [18.4386, 79.1288],
  "Rajanna Sircilla": [18.3886, 78.8105],
  Peddapalli: [18.6136, 79.3744],
  Jagitial: [18.7947, 78.9166],
  Nizamabad: [18.6732, 78.1],
  Kamareddy: [18.32, 78.35],
  Adilabad: [19.6633, 78.5323],
  Mancherial: [18.87, 79.44],
  Nirmal: [19.0976, 78.3432],
  "Komaram Bheem": [19.0333, 79.5],
  Mahabubnagar: [16.7375, 77.9859],
  Narayanpet: [16.75, 77.5],
  Nagarkurnool: [16.4821, 78.3247],
  Wanaparthy: [16.357, 78.0623],
  Gadwal: [16.2335, 77.7956],
  Khammam: [17.2473, 80.1514],
  "Bhadradri Kothagudem": [17.5531, 80.6192],
  Suryapet: [17.1405, 79.6236],
  "Yadadri Bhuvanagiri": [17.5154, 78.888],
};

// --- Helper: Get Color based on Intensity ---
const getMarkerColor = (count: number) => {
  if (count >= 50) return { color: "#dc2626", fill: "#ef4444" }; // High (Deep Red)
  if (count >= 20) return { color: "#d97706", fill: "#f59e0b" }; // Medium (Orange)
  return { color: "#2563eb", fill: "#3b82f6" }; // Low (Blue)
};

export default function SalesHeatmap() {
  const [data, setData] = useState<any[]>([]);
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
    async function fetchData() {
      try {
        const res = await DashboardService.getHeatmapData();
        setData(res.data?.data || []);
      } catch (e) {
        console.error("Heatmap error", e);
      }
    }
    fetchData();
  }, []);

  if (!mounted)
    return (
      <div className="h-[400px] w-full bg-white/5 animate-pulse rounded-2xl" />
    );

  return (
    <div className="relative h-[400px] w-full rounded-2xl overflow-hidden border border-white/10 shadow-2xl">
      {/* Custom CSS for Popup Styling */}
      <style jsx global>{`
        .leaflet-popup-content-wrapper {
          background: rgba(255, 255, 255, 0.95) !important;
          backdrop-filter: blur(5px) !important;
          color: #1a1a1a !important;
          border-radius: 12px !important;
          box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3) !important;
          font-weight: 500;
        }
        .leaflet-popup-tip {
          background: rgba(255, 255, 255, 0.95) !important;
        }
        .leaflet-container {
          font-family: inherit;
          background: #aad3df; /* Ocean color fallback */
        }
      `}</style>

      <MapContainer
        center={[22.5937, 78.9629]} // Centered on India
        zoom={4}
        style={{ height: "100%", width: "100%", zIndex: 0 }}
        scrollWheelZoom={false}
        dragging={true}
        className="z-0"
      >
        {/* ðŸ”¥ COLORFUL MAP TILES (Standard OpenStreetMap) */}
        <TileLayer
          attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
          url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
        />

        {data.map((cityData, idx) => {
          const coords = CITY_COORDINATES[cityData.city];
          if (!coords) return null;

          const { color, fill } = getMarkerColor(cityData.count);
          // Scale radius: slightly bigger for better visibility on colorful map
          const radius = Math.min(Math.max(cityData.count * 1.5, 10), 35);

          return (
            <CircleMarker
              key={idx}
              center={coords}
              pathOptions={{
                color: "white", // White border to stand out on colorful map
                weight: 2,
                fillColor: fill,
                fillOpacity: 0.8,
              }}
              radius={radius}
            >
              <Popup>
                <div className="p-1 min-w-[120px] text-gray-900">
                  <h4 className="text-sm font-bold text-black mb-1 uppercase tracking-wider border-b border-gray-200 pb-1">
                    {cityData.city}
                  </h4>
                  <div className="flex justify-between text-xs text-gray-600 mb-1 mt-2">
                    <span>Orders:</span>
                    <span className="text-blue-600 font-mono font-bold text-sm">
                      {cityData.count}
                    </span>
                  </div>
                  <div className="flex justify-between text-xs text-gray-600">
                    <span>Revenue:</span>
                    <span className="text-green-600 font-mono font-bold text-sm">
                      {formatCurrency(cityData.revenue)}
                    </span>
                  </div>
                </div>
              </Popup>

              <Tooltip
                direction="top"
                offset={[0, -10]}
                opacity={1}
                className="bg-black text-white font-bold border-0 rounded px-2 py-1 text-xs shadow-lg"
              >
                {cityData.city}: {cityData.count}
              </Tooltip>
            </CircleMarker>
          );
        })}
      </MapContainer>

      {/* --- Legend Overlay (Dark Glass to contrast with bright map) --- */}
      <div className="absolute bottom-4 left-4 z-[400] bg-black/70 backdrop-blur-md border border-white/20 p-3 rounded-xl flex flex-col gap-2 shadow-xl">
        <span className="text-[10px] text-gray-200 uppercase font-bold tracking-wide">
          Sales Intensity
        </span>
        <div className="flex items-center gap-3 text-xs text-white font-medium">
          <div className="flex items-center gap-1">
            <span className="w-3 h-3 rounded-full bg-blue-500 border border-white"></span>{" "}
            Low
          </div>
          <div className="flex items-center gap-1">
            <span className="w-3 h-3 rounded-full bg-orange-500 border border-white"></span>{" "}
            Med
          </div>
          <div className="flex items-center gap-1">
            <span className="w-3 h-3 rounded-full bg-red-500 border border-white animate-pulse"></span>{" "}
            High
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="components/Header.tsx">
"use client";

import { motion, AnimatePresence } from "framer-motion";
import { Bell, Search, LogOut, AlertTriangle, Menu, X } from "lucide-react";
import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { toast } from "sonner";
import { AdminAuthService } from "@/lib/api";

// --- PROPS INTERFACE ---
// Sidebar à°¨à°¿ à°•à°‚à°Ÿà±à°°à±‹à°²à± à°šà±‡à°¯à°¡à°¾à°¨à°¿à°•à°¿ props à°¸à±à°µà±€à°•à°°à°¿à°¸à±à°¤à±à°¨à±à°¨à°¾à°‚
interface HeaderProps {
  isSidebarOpen: boolean;
  setSidebarOpen: (open: boolean) => void;
}

export default function Header({ isSidebarOpen, setSidebarOpen }: HeaderProps) {
  const router = useRouter();
  const [notificationCount, setNotificationCount] = useState(0);
  const [isLogoutOpen, setIsLogoutOpen] = useState(false);
  const [searchQuery, setSearchQuery] = useState("");

  // ... (Fetch Notifications Logic - Same as before)
  useEffect(() => {
    const fetchNotifications = async () => {
      try {
        setNotificationCount(5); // Mock Data
      } catch (error) {
        console.error("Failed to fetch notifications");
      }
    };
    fetchNotifications();
  }, []);

  // ... (Search Handler - Same as before)
  const handleSearch = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === "Enter" && searchQuery.trim()) {
      router.push(
        `/dashboard/products?search=${encodeURIComponent(searchQuery)}`,
      );
    }
  };

  // ... (Logout Logic - Same as before)
  const handleLogout = async () => {
    try {
      await AdminAuthService.logout();
      localStorage.removeItem("token");
      toast.success("Logged out successfully");
      router.push("/login");
    } catch (error) {
      console.error("Logout error", error);
      toast.error("Failed to logout");
    } finally {
      setIsLogoutOpen(false);
    }
  };

  return (
    <>
      <motion.header
        initial={{ y: -100, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ duration: 0.5, ease: [0.4, 0, 0.2, 1] }}
        // --- UPDATED HEADER CLASSES ---
        // flex-wrap: Allows items to wrap on smaller screens
        // h-auto py-3: Dynamic height and padding for mobile
        // lg:h-16 lg:py-0: Fixed height and no padding for desktop
        className="sticky right-0 top-0 z-30 flex h-auto w-full flex-wrap items-center justify-between border-b border-white/5 bg-black/40 px-4 py-3 backdrop-blur-xl transition-all duration-300 ease-in-out lg:h-16 lg:px-6 lg:py-0"
      >
        {/* --- MOBILE HAMBURGER BUTTON --- */}
        {/* lg:hidden: Only visible on mobile */}
        <div className="lg:hidden mr-4 order-1">
          <button
            onClick={() => setSidebarOpen(!isSidebarOpen)}
            className="p-2 rounded-xl bg-white/10 backdrop-blur-md border border-white/10 text-white shadow-lg active:scale-95 transition-all"
          >
            {isSidebarOpen ? <X size={20} /> : <Menu size={20} />}
          </button>
        </div>

        {/* --- RIGHT ACTIONS (Bell, Logout) --- */}
        {/* ml-auto: Pushes to the right */}
        {/* order-2: Appears after hamburger on mobile */}
        {/* lg:order-3: Appears last on desktop */}
        <div className="flex items-center gap-2 ml-auto lg:ml-4 order-2 lg:order-3">
          {/* Notifications */}
          <motion.button
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.95 }}
            className="relative rounded-xl bg-white/5 p-2.5 text-gray-400 backdrop-blur-sm transition-colors hover:bg-white/10 hover:text-white"
            onClick={() => toast.info("Notifications feature coming soon!")}
          >
            <Bell className="h-5 w-5" />
            {notificationCount > 0 && (
              <motion.span
                initial={{ scale: 0 }}
                animate={{ scale: 1 }}
                className="absolute right-1 top-1 flex h-4 w-4 items-center justify-center rounded-full bg-red-500 text-[10px] font-bold text-white"
              >
                {notificationCount}
              </motion.span>
            )}
          </motion.button>

          {/* Logout Button */}
          <motion.button
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.95 }}
            onClick={() => setIsLogoutOpen(true)}
            className="rounded-xl bg-white/5 p-2.5 text-gray-400 backdrop-blur-sm transition-colors hover:bg-red-500/10 hover:text-red-400"
          >
            <LogOut className="h-5 w-5" />
          </motion.button>
        </div>

        {/* --- SEARCH BAR --- */}
        {/* w-full mt-4: Full width and margin-top on mobile */}
        {/* order-3: Appears last (below everything) on mobile */}
        {/* lg:w-auto lg:mt-0 lg:order-2: Normal size and position on desktop */}
        <div className="w-full mt-4 lg:mt-0 lg:flex-1 lg:w-auto order-3 lg:order-2 flex justify-center lg:justify-start">
          <div className="relative w-full max-w-md">
            <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400" />
            <motion.input
              whileFocus={{ scale: 1.01 }}
              type="text"
              placeholder="Search..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              onKeyDown={handleSearch}
              className="w-full rounded-xl border border-white/5 bg-white/5 py-2.5 pl-10 pr-4 text-sm text-white placeholder-gray-400 backdrop-blur-sm transition-all focus:border-blue-500/30 focus:bg-white/10 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
            />
          </div>
        </div>
      </motion.header>

      {/* --- LOGOUT MODAL (No changes here) --- */}
      <AnimatePresence>
        {isLogoutOpen && (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              onClick={() => setIsLogoutOpen(false)}
              className="absolute inset-0 bg-black/60 backdrop-blur-sm"
            />
            <motion.div
              initial={{ opacity: 0, scale: 0.95, y: 20 }}
              animate={{ opacity: 1, scale: 1, y: 0 }}
              exit={{ opacity: 0, scale: 0.95, y: 20 }}
              className="relative w-full max-w-sm overflow-hidden rounded-2xl border border-white/10 bg-[#121212] p-6 shadow-2xl"
            >
              <div className="flex flex-col items-center text-center">
                <div className="mb-4 rounded-full bg-red-500/10 p-4">
                  <AlertTriangle className="h-8 w-8 text-red-500" />
                </div>
                <h3 className="mb-2 text-xl font-bold text-white">Log Out?</h3>
                <p className="mb-6 text-sm text-gray-400">
                  Are you sure you want to sign out?
                </p>
                <div className="flex w-full gap-3">
                  <button
                    onClick={() => setIsLogoutOpen(false)}
                    className="flex-1 rounded-xl border border-white/10 bg-white/5 py-2.5 text-sm font-medium text-white transition-colors hover:bg-white/10"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={handleLogout}
                    className="flex-1 rounded-xl bg-red-500 py-2.5 text-sm font-medium text-white transition-colors hover:bg-red-600"
                  >
                    Log Out
                  </button>
                </div>
              </div>
            </motion.div>
          </div>
        )}
      </AnimatePresence>
    </>
  );
}
</file>

<file path="components/PageTransition.tsx">
'use client';

import { motion, AnimatePresence } from 'framer-motion';
import { usePathname } from 'next/navigation';
import { ReactNode } from 'react';

interface PageTransitionProps {
  children: ReactNode;
}

const pageVariants = {
  initial: {
    opacity: 0,
    y: 20,
  },
  animate: {
    opacity: 1,
    y: 0,
  },
  exit: {
    opacity: 0,
    y: -20,
  },
};

const pageTransition = {
  type: 'tween',
  ease: [0.4, 0, 0.2, 1], // Custom cubic-bezier for smooth premium feel
  duration: 0.4,
};

export default function PageTransition({ children }: PageTransitionProps) {
  const pathname = usePathname();

  return (
    <AnimatePresence mode="wait">
      <motion.div
        key={pathname}
        initial="initial"
        animate="animate"
        exit="exit"
        variants={pageVariants}
        transition={pageTransition}
        className="w-full"
      >
        {children}
      </motion.div>
    </AnimatePresence>
  );
}
</file>

<file path="components/providers/SocketProvider.tsx">
'use client';

import React, { createContext, useContext, useEffect, useState, useCallback } from 'react';
import { io, Socket } from 'socket.io-client';
import { toast } from 'sonner';
import { motion } from 'framer-motion';
import { ShoppingCart, PackageCheck, TruckIcon, CreditCard, AlertTriangle } from 'lucide-react';

interface SocketContextType {
  socket: Socket | null;
  isConnected: boolean;
  joinOrderRoom: (orderId: string) => void;
  leaveOrderRoom: (orderId: string) => void;
}

const SocketContext = createContext<SocketContextType>({
  socket: null,
  isConnected: false,
  joinOrderRoom: () => {},
  leaveOrderRoom: () => {},
});

export const useSocket = () => useContext(SocketContext);

interface SocketProviderProps {
  children: React.ReactNode;
}

export function SocketProvider({ children }: SocketProviderProps) {
  const [socket, setSocket] = useState<Socket | null>(null);
  const [isConnected, setIsConnected] = useState(false);

  // Play notification sound
  const playNotificationSound = useCallback(() => {
    if (typeof window !== 'undefined') {
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZSA0PVanp8LNlHAU+ku3z0H0pBSh+zPLaizsIGGS57OihUBELTKXh8bllHAQ7ktXzzn8qBSh+zPLaizsIGGS57OihUBELTKXh8bllHAQ7ktXzzn8qBSh+zPLaizsIGGS57OihUBELTKXh8bllHAQ7ktXzzn8qBSh+zPLaizsIGGS57OihUBELTKXh8bllHAQ7ktXzzn8qBSh+zPLaizsIGGS57OihUBELTKXh8bllHAQ7ktXzzn8qBSh+zPLaizsIGGS57OihUBELTKXh8bllHAQ7ktXzzn8qBSh+zPLaizsIGGS57OihUBELTKXh8bllHAQ7ktXzzn8qBSh+zPLaizsIGGS57OihUBELTKXh8bllHAQ7ktXzzn8qBSh+zPLaizsIGGS57OihUBELTKXh8bllHAQ7ktXzzn8qBSh+zPLaizsIGGS57OihUBELTKXh8bllHAQ7ktXzzn8qBQ==');
      audio.volume = 0.3;
      audio.play().catch(err => console.log('Audio play failed:', err));
    }
  }, []);

  useEffect(() => {
    // Get token from localStorage
    const token = localStorage.getItem('token');
    
    if (!token) {
      console.log('No auth token found, skipping socket connection');
      return;
    }

    // Initialize socket connection with authentication
    const socketInstance = io(process.env.NEXT_PUBLIC_SOCKET_URL || 'http://localhost:5000', {
      auth: {
        token: token,
      },
      transports: ['websocket'],
      autoConnect: true,
    });

    // Connection events
    socketInstance.on('connect', () => {
      console.log('âœ… Socket connected:', socketInstance.id);
      setIsConnected(true);
    });

    socketInstance.on('disconnect', () => {
      console.log('âŒ Socket disconnected');
      setIsConnected(false);
    });

    socketInstance.on('connect_error', (error) => {
      console.error('Socket connection error:', error);
      setIsConnected(false);
    });

    // Server event: Connection success
    socketInstance.on('connected', (data) => {
      console.log('ðŸŽ‰ Connected to server:', data);
    });

    // Server event: New Order (Admin only)
    socketInstance.on('new_order', (orderData) => {
      console.log('ðŸ”” New order received:', orderData);
      playNotificationSound();
      
      toast(
        <motion.div
          initial={{ x: 50, opacity: 0 }}
          animate={{ x: 0, opacity: 1 }}
          className="flex items-center gap-3"
        >
          <motion.div
            animate={{ 
              rotate: [0, -10, 10, -10, 0],
              scale: [1, 1.1, 1],
            }}
            transition={{ duration: 0.5 }}
            className="flex h-12 w-12 items-center justify-center rounded-full bg-gradient-to-br from-green-500 to-emerald-500 shadow-lg"
          >
            <ShoppingCart className="h-6 w-6 text-white" />
          </motion.div>
          <div>
            <p className="font-bold text-white">ðŸŽ‰ New Order Received!</p>
            <p className="text-sm text-gray-300">
              Order #{orderData.orderNumber}
            </p>
            <p className="text-xs text-gray-400">
              Amount: â‚¹{orderData.totalAmount?.toLocaleString('en-IN')}
            </p>
          </div>
        </motion.div>,
        {
          duration: 6000,
          style: {
            background: 'linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.15) 100%)',
            border: '1px solid rgba(16, 185, 129, 0.3)',
          },
        }
      );
    });

    // Server event: Order Status Updated
    socketInstance.on('order_status_updated', (data) => {
      console.log('ðŸ“¦ Order status updated:', data);
      
      const statusIcons = {
        Placed: ShoppingCart,
        Packed: PackageCheck,
        Shipped: TruckIcon,
        Delivered: PackageCheck,
        Cancelled: AlertTriangle,
      };

      const statusColors = {
        Placed: 'from-blue-500 to-cyan-500',
        Packed: 'from-purple-500 to-pink-500',
        Shipped: 'from-yellow-500 to-orange-500',
        Delivered: 'from-green-500 to-emerald-500',
        Cancelled: 'from-red-500 to-rose-500',
      };

      const Icon = statusIcons[data.orderStatus as keyof typeof statusIcons] || PackageCheck;
      const colorClass = statusColors[data.orderStatus as keyof typeof statusColors] || 'from-blue-500 to-cyan-500';

      toast(
        <motion.div
          initial={{ x: 50, opacity: 0 }}
          animate={{ x: 0, opacity: 1 }}
          className="flex items-center gap-3"
        >
          <div className={`flex h-10 w-10 items-center justify-center rounded-full bg-gradient-to-br ${colorClass}`}>
            <Icon className="h-5 w-5 text-white" />
          </div>
          <div>
            <p className="font-semibold text-white">Order Status Updated</p>
            <p className="text-sm text-gray-300">
              Order #{data.orderNumber} â†’ {data.orderStatus}
            </p>
          </div>
        </motion.div>,
        {
          duration: 4000,
        }
      );
    });

    // Server event: Payment Success
    socketInstance.on('payment_success', (data) => {
      console.log('ðŸ’³ Payment successful:', data);
      
      toast(
        <motion.div
          initial={{ scale: 0.8, opacity: 0 }}
          animate={{ scale: 1, opacity: 1 }}
          className="flex items-center gap-3"
        >
          <motion.div
            animate={{ rotate: [0, 360] }}
            transition={{ duration: 0.6 }}
            className="flex h-10 w-10 items-center justify-center rounded-full bg-gradient-to-br from-green-500 to-emerald-500"
          >
            <CreditCard className="h-5 w-5 text-white" />
          </motion.div>
          <div>
            <p className="font-semibold text-white">âœ… Payment Successful</p>
            <p className="text-sm text-gray-300">
              Order #{data.orderNumber}
            </p>
            <p className="text-xs text-gray-400">
              Amount: â‚¹{data.amount?.toLocaleString('en-IN')}
            </p>
          </div>
        </motion.div>,
        {
          duration: 5000,
          style: {
            background: 'linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.15) 100%)',
            border: '1px solid rgba(16, 185, 129, 0.3)',
          },
        }
      );
    });

    // Server event: Payment Failed
    socketInstance.on('payment_failed', (data) => {
      console.log('âŒ Payment failed:', data);
      
      toast.error(
        <div>
          <p className="font-semibold">Payment Failed</p>
          <p className="text-sm">Order #{data.orderNumber}</p>
        </div>,
        {
          duration: 5000,
        }
      );
    });

    // Server event: Order Placed
    socketInstance.on('order_placed', (data) => {
      console.log('ðŸ“¦ Order placed:', data);
    });

    // Server event: Low Stock Alert (if implemented on backend)
    socketInstance.on('low_stock_alert', (data) => {
      console.log('âš ï¸ Low stock alert:', data);
      
      toast.warning(
        <motion.div
          initial={{ x: 50, opacity: 0 }}
          animate={{ x: 0, opacity: 1 }}
          className="flex items-center gap-3"
        >
          <div className="flex h-10 w-10 items-center justify-center rounded-full bg-yellow-500/20">
            <AlertTriangle className="h-5 w-5 text-yellow-400" />
          </div>
          <div>
            <p className="font-semibold text-white">âš ï¸ Low Stock Alert</p>
            <p className="text-sm text-gray-300">{data.productName}</p>
            <p className="text-xs text-gray-400">
              Only {data.stock} units remaining
            </p>
          </div>
        </motion.div>,
        {
          duration: 6000,
        }
      );
    });

    setSocket(socketInstance);

    return () => {
      socketInstance.disconnect();
    };
  }, [playNotificationSound]);

  // Join order room
  const joinOrderRoom = useCallback((orderId: string) => {
    if (socket && isConnected) {
      socket.emit('join_order_room', orderId);
      console.log(`ðŸ“¥ Joined order room: ${orderId}`);
    }
  }, [socket, isConnected]);

  // Leave order room
  const leaveOrderRoom = useCallback((orderId: string) => {
    if (socket && isConnected) {
      socket.emit('leave_order_room', orderId);
      console.log(`ðŸ“¤ Left order room: ${orderId}`);
    }
  }, [socket, isConnected]);

  const value = {
    socket,
    isConnected,
    joinOrderRoom,
    leaveOrderRoom,
  };

  return (
    <SocketContext.Provider value={value}>
      {children}
    </SocketContext.Provider>
  );
}
</file>

<file path="components/Sidebar.tsx">
// "use client";

// import Link from "next/link";
// import { usePathname, useRouter } from "next/navigation";
// import { useState, useEffect } from "react";
// import { motion, AnimatePresence } from "framer-motion"; // Added AnimatePresence
// import {
//   LayoutDashboard,
//   Package,
//   ShoppingCart,
//   Users,
//   Settings,
//   BarChart3,
//   Tag,
//   LogOut,
//   AlertTriangle,
//   Mail,
// } from "lucide-react";
// import { cn } from "@/lib/utils";
// import { AdminAuthService } from "@/lib/api";

// interface AdminProfile {
//   name: string;
//   email: string;
//   avatar?: string;
// }

// const navItems = [
//   { label: "Dashboard", href: "/dashboard", icon: LayoutDashboard },
//   { label: "Products", href: "/dashboard/products", icon: Package },
//   { label: "Orders", href: "/dashboard/orders", icon: ShoppingCart },
//   { label: "Customers", href: "/dashboard/customers", icon: Users },
//   { label: "Messages", href: "/dashboard/chat", icon: Mail },
//   { label: "Analytics", href: "/dashboard/analytics", icon: BarChart3 },
//   { label: "Categories", href: "/dashboard/categories", icon: Tag },
//   { label: "Settings", href: "/dashboard/settings", icon: Settings },
// ];

// export default function Sidebar() {
//   const pathname = usePathname();
//   const router = useRouter();
//   const [admin, setAdmin] = useState<AdminProfile | null>(null);

//   // New States for Logout Modal
//   const [showLogoutModal, setShowLogoutModal] = useState(false);
//   const [isLoggingOut, setIsLoggingOut] = useState(false);

//   useEffect(() => {
//     const fetchAdminData = async () => {
//       try {
//         const response = await AdminAuthService.getProfile();
//         const rootResponse = response.data;
//         const userData = rootResponse.data.data || rootResponse.data;
//         setAdmin(userData);
//       } catch (error) {
//         console.error("Failed to load admin profile", error);
//       }
//     };
//     fetchAdminData();
//   }, []);

//   // 1. Triggered when the small Logout icon is clicked
//   const handleLogoutClick = () => {
//     setShowLogoutModal(true);
//   };

//   // 2. Triggered when "Yes, Logout" is clicked in the modal
//   const confirmLogout = async () => {
//     setIsLoggingOut(true);
//     try {
//       await AdminAuthService.logout();
//       router.push("/admin/login");
//     } catch (error) {
//       console.error("Logout failed", error);
//       setIsLoggingOut(false);
//       setShowLogoutModal(false);
//     }
//   };

//   return (
//     <>
//       <motion.aside
//         initial={{ x: -300, opacity: 0 }}
//         animate={{ x: 0, opacity: 1 }}
//         transition={{ duration: 0.5, ease: [0.4, 0, 0.2, 1] }}
//         className="fixed left-0 top-0 z-40 h-screen w-64 border-r border-white/5 bg-black/40 backdrop-blur-xl"
//       >
//         <div className="flex h-full flex-col">
//           {/* Logo */}
//           <motion.div
//             initial={{ opacity: 0, y: -20 }}
//             animate={{ opacity: 1, y: 0 }}
//             transition={{ delay: 0.2, duration: 0.5 }}
//             className="flex h-16 items-center gap-3 border-b border-white/5 px-6"
//           >
//             <div className="flex h-10 w-10 items-center justify-center rounded-xl bg-gradient-to-br from-blue-500 to-cyan-500 shadow-lg shadow-blue-500/30">
//               <svg
//                 className="h-6 w-6 text-white"
//                 fill="none"
//                 viewBox="0 0 24 24"
//                 stroke="currentColor"
//               >
//                 <path
//                   strokeLinecap="round"
//                   strokeLinejoin="round"
//                   strokeWidth={2.5}
//                   d="M13 10V3L4 14h7v7l9-11h-7z"
//                 />
//               </svg>
//             </div>
//             <div>
//               <h1 className="text-lg font-bold text-white">Varshini Hyundai</h1>
//               <p className="text-xs text-gray-400">Spares Admin</p>
//             </div>
//           </motion.div>

//           {/* Navigation */}
//           <nav className="flex-1 space-y-1 overflow-y-auto p-4 scrollbar-thin">
//             {navItems.map((item, index) => {
//               const isActive = pathname === item.href;
//               const Icon = item.icon;
//               return (
//                 <motion.div
//                   key={item.href}
//                   initial={{ opacity: 0, x: -20 }}
//                   animate={{ opacity: 1, x: 0 }}
//                   transition={{ delay: 0.1 * index, duration: 0.3 }}
//                 >
//                   <Link href={item.href}>
//                     <motion.div
//                       whileHover={{ scale: 1.02, x: 4 }}
//                       whileTap={{ scale: 0.98 }}
//                       className={cn(
//                         "group relative flex items-center gap-3 rounded-xl px-4 py-3 text-sm font-medium transition-all duration-200",
//                         isActive
//                           ? "bg-gradient-to-r from-blue-500/20 to-cyan-500/20 text-white shadow-lg shadow-blue-500/10"
//                           : "text-gray-400 hover:bg-white/5 hover:text-white",
//                       )}
//                     >
//                       {isActive && (
//                         <motion.div
//                           layoutId="activeTab"
//                           className="absolute inset-0 rounded-xl border border-blue-500/30 bg-gradient-to-r from-blue-500/10 to-cyan-500/10"
//                           transition={{
//                             type: "spring",
//                             bounce: 0.2,
//                             duration: 0.6,
//                           }}
//                         />
//                       )}
//                       <Icon className="relative z-10 h-5 w-5" />
//                       <span className="relative z-10">{item.label}</span>
//                     </motion.div>
//                   </Link>
//                 </motion.div>
//               );
//             })}
//           </nav>

//           {/* User Section */}
//           <motion.div
//             initial={{ opacity: 0, y: 20 }}
//             animate={{ opacity: 1, y: 0 }}
//             transition={{ delay: 0.5 }}
//             className="border-t border-white/5 p-4"
//           >
//             <div className="flex items-center gap-3 rounded-xl bg-white/5 p-3 backdrop-blur-sm group">
//               {admin?.avatar ? (
//                 <img
//                   src={admin.avatar}
//                   alt={admin.name}
//                   className="h-10 w-10 rounded-full object-cover border border-white/10"
//                 />
//               ) : (
//                 <div className="flex h-10 w-10 items-center justify-center rounded-full bg-gradient-to-br from-blue-500 to-cyan-500 text-sm font-bold text-white shadow-lg">
//                   {admin?.name ? admin.name.charAt(0).toUpperCase() : "A"}
//                 </div>
//               )}

//               <div className="flex-1 min-w-0">
//                 <p className="truncate text-sm font-medium text-white">
//                   {admin?.name || "Loading..."}
//                 </p>
//                 <p
//                   className="truncate text-xs text-gray-400"
//                   title={admin?.email}
//                 >
//                   {admin?.email || "Please wait..."}
//                 </p>
//               </div>

//               {/* Logout Button (Triggers Modal) */}
//               <button
//                 onClick={handleLogoutClick}
//                 className="rounded-lg p-1.5 text-gray-400 hover:bg-white/10 hover:text-red-400 transition-colors"
//                 title="Logout"
//               >
//                 <LogOut className="h-4 w-4" />
//               </button>
//             </div>
//           </motion.div>
//         </div>
//       </motion.aside>

//       {/* --- LOGOUT CONFIRMATION MODAL --- */}
//       <AnimatePresence>
//         {showLogoutModal && (
//           <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
//             {/* Backdrop */}
//             <motion.div
//               initial={{ opacity: 0 }}
//               animate={{ opacity: 1 }}
//               exit={{ opacity: 0 }}
//               onClick={() => setShowLogoutModal(false)}
//               className="absolute inset-0 bg-black/60 backdrop-blur-sm"
//             />

//             {/* Modal Content */}
//             <motion.div
//               initial={{ opacity: 0, scale: 0.95, y: 20 }}
//               animate={{ opacity: 1, scale: 1, y: 0 }}
//               exit={{ opacity: 0, scale: 0.95, y: 20 }}
//               className="relative w-full max-w-sm overflow-hidden rounded-2xl border border-white/10 bg-gray-900 p-6 shadow-2xl"
//             >
//               <div className="flex flex-col items-center text-center">
//                 <div className="mb-4 rounded-full bg-red-500/10 p-3">
//                   <AlertTriangle className="h-8 w-8 text-red-500" />
//                 </div>
//                 <h3 className="mb-2 text-xl font-bold text-white">
//                   Confirm Logout
//                 </h3>
//                 <p className="mb-6 text-sm text-gray-400">
//                   Are you sure you want to log out of your admin account?
//                 </p>

//                 <div className="flex w-full gap-3">
//                   <button
//                     onClick={() => setShowLogoutModal(false)}
//                     disabled={isLoggingOut}
//                     className="flex-1 rounded-xl border border-white/10 bg-white/5 py-2.5 text-sm font-medium text-white transition-colors hover:bg-white/10 disabled:opacity-50"
//                   >
//                     Cancel
//                   </button>
//                   <button
//                     onClick={confirmLogout}
//                     disabled={isLoggingOut}
//                     className="flex-1 rounded-xl bg-red-500 py-2.5 text-sm font-medium text-white transition-colors hover:bg-red-600 disabled:opacity-50 flex justify-center items-center gap-2"
//                   >
//                     {isLoggingOut ? (
//                       <>
//                         <div className="h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent" />
//                         <span>Logging out...</span>
//                       </>
//                     ) : (
//                       "Yes, Logout"
//                     )}
//                   </button>
//                 </div>
//               </div>
//             </motion.div>
//           </div>
//         )}
//       </AnimatePresence>
//     </>
//   );
// }

"use client";

import Link from "next/link";
import { usePathname, useRouter } from "next/navigation";
import { useState, useEffect } from "react";
import { motion, AnimatePresence } from "framer-motion";
import {
  LayoutDashboard,
  Package,
  ShoppingCart,
  Users,
  Settings,
  BarChart3,
  Tag,
  LogOut,
  AlertTriangle,
  Mail,
  X,
  Activity,
  GalleryHorizontal, // Close icon for mobile
} from "lucide-react";
import { cn } from "@/lib/utils";
import { AdminAuthService } from "@/lib/api";

interface AdminProfile {
  name: string;
  email: string;
  avatar?: string;
}

// --- PROPS FOR RESPONSIVENESS ---
interface SidebarProps {
  isOpen?: boolean; // à°®à±Šà°¬à±ˆà°²à±â€Œà°²à±‹ à°“à°ªà±†à°¨à± à°‰à°‚à°¦à°¾ à°²à±‡à°¦à°¾?
  setSidebarOpen?: (open: boolean) => void; // à°•à±à°²à±‹à°œà± à°šà±‡à°¯à°¡à°¾à°¨à°¿à°•à°¿ à°«à°‚à°•à±à°·à°¨à±
}

const navItems = [
  { label: "Dashboard", href: "/dashboard", icon: LayoutDashboard },
  { label: "Products", href: "/dashboard/products", icon: Package },
  { label: "Orders", href: "/dashboard/orders", icon: ShoppingCart },
  { label: "Customers", href: "/dashboard/customers", icon: Users },
  { label: "Messages", href: "/dashboard/chat", icon: Mail },
  { label: "Analytics", href: "/dashboard/analytics", icon: BarChart3 },
  { label: "Categories", href: "/dashboard/categories", icon: Tag },
  { label: "Carousel", href: "/dashboard/carousel", icon: GalleryHorizontal },
  {
    label: "Abandoned Carts",
    href: "/dashboard/abandoned-carts",
    icon: ShoppingCart,
  },
  { label: "ðŸ‘€ Live Monitor", href: "/dashboard/monitor", icon: Activity },
  { label: "Settings", href: "/dashboard/settings", icon: Settings },
];

export default function Sidebar({
  isOpen = false,
  setSidebarOpen,
}: SidebarProps) {
  const pathname = usePathname();
  const router = useRouter();
  const [admin, setAdmin] = useState<AdminProfile | null>(null);

  const [showLogoutModal, setShowLogoutModal] = useState(false);
  const [isLoggingOut, setIsLoggingOut] = useState(false);

  useEffect(() => {
    const fetchAdminData = async () => {
      try {
        const response = await AdminAuthService.getProfile();
        // Handle inconsistent API structures
        const rootResponse = response.data;
        const userData =
          rootResponse.data?.data || rootResponse.data || rootResponse;
        setAdmin(userData);
      } catch (error) {
        console.error("Failed to load admin profile", error);
      }
    };
    fetchAdminData();
  }, []);

  const handleLogoutClick = () => {
    setShowLogoutModal(true);
  };

  const confirmLogout = async () => {
    setIsLoggingOut(true);
    try {
      await AdminAuthService.logout();
      router.push("/login"); // Updated path to typical login route
    } catch (error) {
      console.error("Logout failed", error);
      setIsLoggingOut(false);
      setShowLogoutModal(false);
    }
  };

  return (
    <>
      {/* --- MOBILE BACKDROP OVERLAY --- */}
      {/* à°‡à°¦à°¿ à°•à±‡à°µà°²à°‚ à°®à±Šà°¬à±ˆà°²à±â€Œà°²à±‹ à°¸à±ˆà°¡à±â€Œà°¬à°¾à°°à± à°“à°ªà±†à°¨à± à°…à°¯à°¿à°¨à°ªà±à°ªà±à°¡à± à°®à°¾à°¤à±à°°à°®à±‡ à°•à°¨à°¿à°ªà°¿à°¸à±à°¤à±à°‚à°¦à°¿ */}
      {isOpen && (
        <div
          onClick={() => setSidebarOpen && setSidebarOpen(false)}
          className="fixed inset-0 z-40 bg-black/60 backdrop-blur-sm lg:hidden"
        />
      )}

      {/* --- SIDEBAR CONTAINER --- */}
      <aside
        className={cn(
          "fixed top-0 left-0 z-50 h-screen w-64 border-r border-white/10 bg-[#0a0a0a]/90 backdrop-blur-xl transition-transform duration-300 ease-in-out",
          // Desktop: Always visible (translate-x-0)
          // Mobile: Based on isOpen prop
          isOpen ? "translate-x-0" : "-translate-x-full lg:translate-x-0",
        )}
      >
        <div className="flex h-full flex-col">
          {/* --- STYLISH LOGO SECTION --- */}
          <div className="relative flex h-20 items-center justify-between border-b border-white/5 px-6">
            <div className="flex items-center gap-3">
              {/* Animated/Glowing Logo Icon */}
              <div className="relative flex h-10 w-10 items-center justify-center rounded-xl bg-gradient-to-br from-blue-600 to-cyan-500 shadow-lg shadow-blue-500/20">
                <div className="absolute inset-0 rounded-xl bg-blue-400 blur opacity-20"></div>
                <svg
                  className="relative h-6 w-6 text-white"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2.5}
                    d="M13 10V3L4 14h7v7l9-11h-7z"
                  />
                </svg>
              </div>

              {/* Stylish Text */}
              <div>
                <h1 className="text-xl font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-white via-blue-100 to-gray-400">
                  Varshini
                </h1>
                <p className="text-[10px] font-bold uppercase tracking-widest text-blue-400">
                  Hyundai Spares
                </p>
              </div>
            </div>

            {/* Mobile Close Button (Visible inside sidebar on mobile only) */}
            <button
              onClick={() => setSidebarOpen && setSidebarOpen(false)}
              className="lg:hidden text-gray-400 hover:text-white"
            >
              <X size={20} />
            </button>
          </div>

          {/* --- NAVIGATION --- */}
          <nav className="flex-1 space-y-1 overflow-y-auto p-4 scrollbar-thin scrollbar-thumb-white/10 scrollbar-track-transparent">
            {navItems.map((item) => {
              const isActive = pathname === item.href;
              const Icon = item.icon;
              return (
                <Link key={item.href} href={item.href}>
                  <div
                    className={cn(
                      "group relative flex items-center gap-3 rounded-xl px-4 py-3.5 text-sm font-medium transition-all duration-300",
                      isActive
                        ? "bg-white/10 text-white shadow-inner"
                        : "text-gray-400 hover:bg-white/5 hover:text-white",
                    )}
                  >
                    {isActive && (
                      <motion.div
                        layoutId="activeTab"
                        className="absolute inset-0 rounded-xl border border-blue-500/30 bg-gradient-to-r from-blue-600/10 to-cyan-500/10"
                        transition={{
                          type: "spring",
                          bounce: 0.2,
                          duration: 0.6,
                        }}
                      />
                    )}
                    <Icon
                      className={cn(
                        "relative z-10 h-5 w-5 transition-colors",
                        isActive
                          ? "text-blue-400"
                          : "text-gray-500 group-hover:text-gray-300",
                      )}
                    />
                    <span className="relative z-10">{item.label}</span>

                    {/* Active Indicator Dot */}
                    {isActive && (
                      <div className="absolute right-3 h-1.5 w-1.5 rounded-full bg-blue-400 shadow-[0_0_8px_rgba(96,165,250,0.8)]" />
                    )}
                  </div>
                </Link>
              );
            })}
          </nav>

          {/* --- USER PROFILE FOOTER --- */}
          <div className="border-t border-white/5 p-4 bg-black/20">
            <div className="flex items-center gap-3 rounded-xl bg-white/5 p-3 backdrop-blur-sm border border-white/5 hover:border-white/10 transition-colors group">
              {admin?.avatar ? (
                <img
                  src={admin.avatar}
                  alt={admin.name}
                  className="h-10 w-10 rounded-full object-cover border-2 border-white/10"
                />
              ) : (
                <div className="flex h-10 w-10 items-center justify-center rounded-full bg-gradient-to-br from-gray-700 to-gray-600 text-sm font-bold text-white shadow-lg">
                  {admin?.name ? admin.name.charAt(0).toUpperCase() : "A"}
                </div>
              )}

              <div className="flex-1 min-w-0">
                <p className="truncate text-sm font-semibold text-white group-hover:text-blue-200 transition-colors">
                  {admin?.name || "Admin User"}
                </p>
                <p
                  className="truncate text-xs text-gray-500"
                  title={admin?.email}
                >
                  {admin?.email || "Loading..."}
                </p>
              </div>

              <button
                onClick={handleLogoutClick}
                className="rounded-lg p-2 text-gray-400 hover:bg-red-500/10 hover:text-red-400 transition-all active:scale-95"
                title="Logout"
              >
                <LogOut className="h-4 w-4" />
              </button>
            </div>
          </div>
        </div>
      </aside>

      {/* --- LOGOUT MODAL --- */}
      <AnimatePresence>
        {showLogoutModal && (
          <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              onClick={() => setShowLogoutModal(false)}
              className="absolute inset-0 bg-black/80 backdrop-blur-md"
            />
            <motion.div
              initial={{ opacity: 0, scale: 0.9, y: 20 }}
              animate={{ opacity: 1, scale: 1, y: 0 }}
              exit={{ opacity: 0, scale: 0.9, y: 20 }}
              className="relative w-full max-w-sm overflow-hidden rounded-2xl border border-white/10 bg-[#121212] p-6 shadow-2xl"
            >
              <div className="flex flex-col items-center text-center">
                <div className="mb-4 rounded-full bg-red-500/10 p-4 border border-red-500/20">
                  <AlertTriangle className="h-8 w-8 text-red-500" />
                </div>
                <h3 className="mb-2 text-xl font-bold text-white">Sign Out?</h3>
                <p className="mb-6 text-sm text-gray-400">
                  Are you sure you want to end your current session?
                </p>
                <div className="flex w-full gap-3">
                  <button
                    onClick={() => setShowLogoutModal(false)}
                    disabled={isLoggingOut}
                    className="flex-1 rounded-xl border border-white/10 bg-white/5 py-2.5 text-sm font-medium text-white hover:bg-white/10 transition-colors"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={confirmLogout}
                    disabled={isLoggingOut}
                    className="flex-1 rounded-xl bg-red-600 py-2.5 text-sm font-medium text-white hover:bg-red-700 transition-colors flex justify-center gap-2"
                  >
                    {isLoggingOut ? "Processing..." : "Logout"}
                  </button>
                </div>
              </div>
            </motion.div>
          </div>
        )}
      </AnimatePresence>
    </>
  );
}
</file>

<file path="components/StatsCard.tsx">
"use client";

import { motion, useMotionValue, useTransform, animate } from "framer-motion";
import { useEffect, useState } from "react";
import { LucideIcon } from "lucide-react";
import { cn } from "@/lib/utils";

interface StatsCardProps {
  title: string;
  value: number;
  prefix?: string;
  suffix?: string;
  icon: LucideIcon;
  iconColor: string;
  iconBg: string;
  trend?: {
    value: number;
    isPositive: boolean;
  };
  delay?: number;
  description?: string;
}

export default function StatsCard({
  title,
  value,
  prefix = "",
  suffix = "",
  icon: Icon,
  iconColor,
  iconBg,
  trend,
  delay = 0,
}: StatsCardProps) {
  const [isVisible, setIsVisible] = useState(false);
  const count = useMotionValue(0);
  const rounded = useTransform(count, (latest) => Math.round(latest));
  const [displayValue, setDisplayValue] = useState("0");

  useEffect(() => {
    setIsVisible(true);
  }, []);

  useEffect(() => {
    if (isVisible) {
      const controls = animate(count, value, {
        duration: 2,
        delay,
        ease: "easeOut",
      });

      return controls.stop;
    }
  }, [isVisible, value, count, delay]);

  useEffect(() => {
    return rounded.on("change", (latest) => {
      setDisplayValue(latest.toLocaleString("en-IN"));
    });
  }, [rounded]);

  return (
    <motion.div
      initial={{ opacity: 0, y: 20, scale: 0.95 }}
      animate={{ opacity: 1, y: 0, scale: 1 }}
      transition={{ duration: 0.5, delay, ease: [0.4, 0, 0.2, 1] }}
      whileHover={{ y: -4, scale: 1.02 }}
      className="group relative overflow-hidden rounded-2xl border border-white/5 bg-gradient-to-br from-white/[0.03] to-white/[0.01] p-6 backdrop-blur-sm transition-all duration-300 hover:border-white/10 hover:shadow-2xl"
    >
      {/* Glow effect on hover */}
      <motion.div
        className="absolute inset-0 opacity-0 transition-opacity duration-300 group-hover:opacity-100"
        style={{
          background: `radial-gradient(circle at 50% 0%, ${iconColor}15, transparent 70%)`,
        }}
      />

      <div className="relative z-10">
        <div className="flex items-start justify-between">
          <div>
            <p className="text-sm font-medium text-gray-400">{title}</p>
            <motion.div
              className="mt-2 flex items-baseline gap-2"
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ delay: delay + 0.2 }}
            >
              <h3 className="text-3xl font-bold text-white">
                {prefix}
                {displayValue}
                {suffix}
              </h3>
              {trend && (
                <motion.span
                  initial={{ opacity: 0, x: -10 }}
                  animate={{ opacity: 1, x: 0 }}
                  transition={{ delay: delay + 0.4 }}
                  className={cn(
                    "flex items-center gap-1 text-sm font-medium",
                    trend.isPositive ? "text-green-400" : "text-red-400",
                  )}
                >
                  <svg
                    className={cn("h-4 w-4", !trend.isPositive && "rotate-180")}
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={2}
                      d="M5 10l7-7m0 0l7 7m-7-7v18"
                    />
                  </svg>
                  {Math.abs(trend.value)}%
                </motion.span>
              )}
            </motion.div>
          </div>

          <motion.div
            initial={{ scale: 0, rotate: -180 }}
            animate={{ scale: 1, rotate: 0 }}
            transition={{
              delay: delay + 0.3,
              type: "spring",
              stiffness: 200,
              damping: 10,
            }}
            className={cn("rounded-xl p-3", iconBg)}
          >
            <Icon className={cn("h-6 w-6", iconColor)} />
          </motion.div>
        </div>

        {/* Bottom accent line */}
        <motion.div
          initial={{ scaleX: 0 }}
          animate={{ scaleX: 1 }}
          transition={{ delay: delay + 0.5, duration: 0.6 }}
          className={cn(
            "mt-4 h-1 rounded-full",
            iconColor.replace("text-", "bg-"),
          )}
          style={{ transformOrigin: "left" }}
        />
      </div>

      {/* Decorative corner accent */}
      <div className="absolute -right-12 -top-12 h-24 w-24 rounded-full bg-gradient-to-br from-white/5 to-transparent opacity-0 blur-2xl transition-opacity duration-300 group-hover:opacity-100" />
    </motion.div>
  );
}
</file>

<file path="components/ui/Button.tsx">
"use client";

import { motion, HTMLMotionProps } from "framer-motion";
import { cn } from "@/lib/utils";
import { ReactNode } from "react";

// âœ… FIX 1: ButtonHTMLAttributes à°¬à°¦à±à°²à± HTMLMotionProps à°µà°¾à°¡à°¾à°²à°¿.
// à°‡à°¦à°¿ Framer Motion à°Ÿà±ˆà°ªà± à°Žà°°à±à°°à°°à±à°¸à± à°¨à°¿ à°«à°¿à°•à±à°¸à± à°šà±‡à°¸à±à°¤à±à°‚à°¦à°¿.
interface ButtonProps extends Omit<HTMLMotionProps<"button">, "ref"> {
  // âœ… FIX 2: 'outline' à°¨à°¿ variant à°²à±‹ à°¯à°¾à°¡à± à°šà±‡à°¸à°¾à°®à±
  variant?: "primary" | "secondary" | "danger" | "ghost" | "outline";
  size?: "sm" | "md" | "lg";
  children: ReactNode;
  isLoading?: boolean;
}

export default function Button({
  variant = "primary",
  size = "md",
  children,
  isLoading = false,
  className,
  disabled,
  ...props
}: ButtonProps) {
  const baseStyles =
    "rounded-xl font-medium transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2";

  const variants = {
    primary:
      "bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50",
    secondary: "bg-white/5 text-white border border-white/10 hover:bg-white/10",
    danger:
      "bg-red-500/20 text-red-400 border border-red-500/30 hover:bg-red-500/30",
    ghost: "text-gray-400 hover:text-white hover:bg-white/5",
    // âœ… FIX 3: Outline à°¸à±à°Ÿà±ˆà°²à±à°¸à± à°¡à°¿à°«à±ˆà°¨à± à°šà±‡à°¸à°¾à°®à±
    outline:
      "bg-transparent border border-white/20 text-white hover:bg-white/5",
  };

  const sizes = {
    sm: "px-3 py-1.5 text-xs",
    md: "px-4 py-2.5 text-sm",
    lg: "px-6 py-3 text-base",
  };

  return (
    <motion.button
      // Loading à°²à±‡à°¦à°¾ Disabled à°‰à°¨à±à°¨à°ªà±à°ªà±à°¡à± à°¯à°¾à°¨à°¿à°®à±‡à°·à°¨à± à°†à°ªà±‡à°¸à±à°¤à±à°¨à±à°¨à°¾à°‚
      whileHover={{ scale: disabled || isLoading ? 1 : 1.02 }}
      whileTap={{ scale: disabled || isLoading ? 1 : 0.98 }}
      className={cn(baseStyles, variants[variant], sizes[size], className)}
      disabled={disabled || isLoading}
      {...props}
    >
      {isLoading ? (
        <>
          <motion.div
            animate={{ rotate: 360 }}
            transition={{ repeat: Infinity, duration: 1, ease: "linear" }}
            className="h-4 w-4 rounded-full border-2 border-white/30 border-t-white"
          />
          <span>Loading...</span>
        </>
      ) : (
        children
      )}
    </motion.button>
  );
}
</file>

<file path="components/ui/Skeleton.tsx">
'use client';

import { cn } from '@/lib/utils';

interface SkeletonProps {
  className?: string;
}

export function Skeleton({ className }: SkeletonProps) {
  return (
    <div
      className={cn(
        'relative overflow-hidden rounded-lg bg-white/5',
        className
      )}
    >
      <div className="absolute inset-0 -translate-x-full animate-shimmer bg-gradient-to-r from-transparent via-white/5 to-transparent" />
    </div>
  );
}

export function TableSkeleton({ rows = 5 }: { rows?: number }) {
  return (
    <div className="space-y-3">
      {/* Header */}
      <div className="flex gap-4">
        <Skeleton className="h-10 w-1/4" />
        <Skeleton className="h-10 w-1/4" />
        <Skeleton className="h-10 w-1/4" />
        <Skeleton className="h-10 w-1/4" />
      </div>
      
      {/* Rows */}
      {Array.from({ length: rows }).map((_, i) => (
        <div key={i} className="flex gap-4">
          <Skeleton className="h-16 w-1/4" />
          <Skeleton className="h-16 w-1/4" />
          <Skeleton className="h-16 w-1/4" />
          <Skeleton className="h-16 w-1/4" />
        </div>
      ))}
    </div>
  );
}

export function CardSkeleton() {
  return (
    <div className="rounded-2xl border border-white/5 bg-white/5 p-6 backdrop-blur-sm">
      <div className="flex items-start justify-between">
        <div className="space-y-2">
          <Skeleton className="h-4 w-24" />
          <Skeleton className="h-8 w-32" />
        </div>
        <Skeleton className="h-12 w-12 rounded-xl" />
      </div>
      <div className="mt-4">
        <Skeleton className="h-3 w-40" />
      </div>
    </div>
  );
}

export function StatsSkeleton() {
  return (
    <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-4">
      {Array.from({ length: 4 }).map((_, i) => (
        <CardSkeleton key={i} />
      ))}
    </div>
  );
}
</file>

<file path="components/ui/Toaster.tsx">
'use client';

import { Toaster as Sonner } from 'sonner';

export function Toaster() {
  return (
    <Sonner
      position="top-right"
      toastOptions={{
        style: {
          background: 'rgba(24, 24, 27, 0.95)',
          border: '1px solid rgba(255, 255, 255, 0.1)',
          color: '#fff',
          backdropFilter: 'blur(12px)',
        },
        className: 'glass-effect',
      }}
      closeButton
    />
  );
}
</file>

<file path="lib/api.ts">
import axios, { AxiosResponse } from "axios";

const api = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_URL || "http://localhost:5000/api",
  withCredentials: true,
  headers: {
    "Content-Type": "application/json",
  },
});

// Request interceptor for adding auth token
api.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem("token");
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => {
    return Promise.reject(error);
  },
);

// Response interceptor for handling errors
api.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      if (typeof window !== "undefined") {
        localStorage.removeItem("token");
        window.location.href = "/login";
      }
    }
    return Promise.reject(error);
  },
);

export default api;

// ============================================================================
// ADMIN AUTHENTICATION SERVICE
// ============================================================================
export const AdminAuthService = {
  login: (credentials: { email: string; password: string }) =>
    api.post("/admin/auth/login", credentials),

  refreshToken: () => api.post("/admin/auth/refresh-token"),

  getProfile: () => api.get("/admin/auth/profile"),

  updateProfile: (data: any) => {
    return api.put("/admin/auth/profile", data, {
      headers: {
        "Content-Type": "multipart/form-data", // à°‡à°¦à°¿ à°ªà°¾à°¤ JSON à°¹à±†à°¡à°°à± à°¨à°¿ à°“à°µà°°à±â€Œà°°à±ˆà°¡à± à°šà±‡à°¸à±à°¤à±à°‚à°¦à°¿
      },
    });
  },

  changePassword: (data: { currentPassword: string; newPassword: string }) =>
    api.put("/admin/auth/change-password", data),

  logout: () => api.post("/admin/auth/logout"),

  // 1. Logout from all devices (Fixes the error in Settings page)
  logoutAllDevices: () => api.post("/admin/auth/logout-all"),

  // 2. Forgot Password (Optional - for future use)
  forgotPassword: (email: string) =>
    api.post("/admin/auth/forgot-password", { email }),

  // 3. Reset Password (Optional - for future use)
  resetPassword: (data: { token: string; newPassword: string }) =>
    api.post("/admin/auth/reset-password", data),
};

// ============================================================================
// PRODUCT SERVICE
// ============================================================================
export const ProductService = {
  // Get all products with filters
  // getAll: (params?: {
  //   page?: number;
  //   limit?: number;
  //   category?: string;
  //   search?: string;
  //   sortBy?: string;
  //   order?: "asc" | "desc";
  // }) => api.get("/products", { params }),

  getAll: () => api.get("/products"),

  // Get single product
  getById: (id: string) => api.get(`/products/${id}`),

  // Get featured products
  getFeatured: () => api.get("/products/featured"),

  // Get products by category
  getByCategory: (category: string) =>
    api.get(`/products/category/${category}`),

  // Create new product (Admin)
  create: (data: FormData) =>
    api.post("/products", data, {
      headers: { "Content-Type": "multipart/form-data" },
    }),

  // Update product (Admin)
  update: (id: string, data: FormData) =>
    api.put(`/products/${id}`, data, {
      headers: { "Content-Type": "multipart/form-data" },
    }),

  // Update stock only (Admin)
  updateStock: (id: string, stock: number) =>
    api.patch(`/products/${id}/stock`, { stock }),

  // Delete product (Admin)
  delete: (id: string) => api.delete(`/products/${id}`),

  // Delete product image (Admin)
  deleteImage: (productId: string, imageId: string) =>
    api.delete(`/products/${productId}/images/${imageId}`),

  // Get low stock products (Admin)
  getLowStock: () => api.get("/products/low-stock"),
};

// ============================================================================
// ORDER SERVICE
// ============================================================================
export const OrderService = {
  // Get all orders (Admin)
  getAllOrders: (params?: {
    page?: number;
    limit?: number;
    status?: string;
    sortBy?: string;
    order?: "asc" | "desc";
  }) => api.get("/orders/admin/all", { params }),

  // Get single order
  getById: (id: string) => api.get(`/orders/${id}`),

  // Update order status (Admin)
  updateStatus: (
    id: string,
    data: {
      orderStatus: "Placed" | "Packed" | "Shipped" | "Delivered" | "Cancelled";
      note?: string;
    },
  ) => api.put(`/orders/${id}/status`, data),

  // Download invoice (Blob response)
  getInvoice: async (orderId: string): Promise<Blob> => {
    const response = await api.get(`/orders/${orderId}/invoice`, {
      responseType: "blob",
    });
    return response.data;
  },

  // Cancel order
  cancelOrder: (id: string, reason?: string) =>
    api.put(`/orders/${id}/cancel`, { cancellationReason: reason }),
};

// ============================================================================
// PAYMENT SERVICE
// ============================================================================
export const PaymentService = {
  // Get all payments (Admin)
  getAllPayments: (params?: {
    page?: number;
    limit?: number;
    status?: string;
  }) => api.get("/payments/admin/all", { params }),

  // Get payment details
  getByOrderId: (orderId: string) => api.get(`/payments/${orderId}`),

  // Get payment method statistics (Admin)
  getPaymentMethods: () => api.get("/dashboard/payments/methods"),
};

// ============================================================================
// DASHBOARD SERVICE
// ============================================================================
// export const DashboardService = {
//   // Existing methods (Optional, kept for compatibility)
//   getStats: () => api.get("/dashboard/stats"),
//   getMonthlyRevenue: (params?: { year?: number }) =>
//     api.get("/dashboard/revenue/monthly", { params }),
//   getDailyRevenue: (params?: { month?: number; year?: number }) =>
//     api.get("/dashboard/revenue/daily", { params }),
//   getRecentOrders: (limit?: number) =>
//     api.get("/dashboard/orders/recent", { params: { limit } }),
//   getLowStockProducts: () => api.get("/dashboard/products/low-stock"),
//   getTopSellingProducts: (limit?: number) =>
//     api.get("/dashboard/products/top-selling", { params: { limit } }),

//   // âœ… NEW METHODS FOR ANALYTICS PAGE
//   getAdvancedAnalytics: (params?: { startDate?: string; endDate?: string }) =>
//     api.get("/dashboard/advanced-analytics", { params }),

//   getInventoryHealth: () => api.get("/dashboard/inventory-health"),

//   getCustomerGrowth: (params?: { startDate?: string; endDate?: string }) =>
//     api.get("/dashboard/customers/growth", { params }),

//   getSalesByCategory: (params?: { startDate?: string; endDate?: string }) =>
//     api.get("/dashboard/sales/by-category", { params }),

//   getExportData: (params?: { startDate?: string; endDate?: string }) =>
//     api.get("/dashboard/export-data", { params }),
// };

export const DashboardService = {
  // 1. Basic Stats (Used in Main Dashboard)
  getStats: () => api.get("/dashboard/stats"),

  getMonthlyRevenue: (params?: { year?: number }) =>
    api.get("/dashboard/revenue/monthly", { params }),

  getDailyRevenue: (params?: { month?: number; year?: number }) =>
    api.get("/dashboard/revenue/daily", { params }),

  getRecentOrders: (limit?: number) =>
    api.get("/dashboard/orders/recent", { params: { limit } }),

  getLowStockProducts: () => api.get("/dashboard/products/low-stock"),

  getTopSellingProducts: (limit?: number) =>
    api.get("/dashboard/products/top-selling", { params: { limit } }),

  // âœ… Fix: Added Missing Method (Used in Main Dashboard)
  getPaymentMethodStats: () => api.get("/dashboard/payments/methods"),

  // 2. Advanced Analytics (Used in Analytics Page)
  getSalesByCategory: (params?: { startDate?: string; endDate?: string }) =>
    api.get("/dashboard/sales/by-category", { params }),

  getCustomerGrowth: (params?: { startDate?: string; endDate?: string }) =>
    api.get("/dashboard/customers/growth", { params }),

  getAdvancedAnalytics: (params?: { startDate?: string; endDate?: string }) =>
    api.get("/dashboard/advanced-analytics", { params }),

  getInventoryHealth: () => api.get("/dashboard/inventory-health"),

  getExportData: (params?: { startDate?: string; endDate?: string }) =>
    api.get("/dashboard/export-data", { params }),
  getHeatmapData: () => api.get("/analytics/heatmap"),

  getInventoryForecast: () => api.get("/analytics/inventory-forecast"),

  triggerAICalculation: () => api.post("/analytics/calculate-inventory"),
};

// ============================================================================
// HELPER FUNCTION FOR INVOICE DOWNLOAD
// ============================================================================
export const downloadInvoice = async (orderId: string, orderNumber: string) => {
  try {
    const blob = await OrderService.getInvoice(orderId);
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `Invoice_${orderNumber}.pdf`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
  } catch (error) {
    console.error("Failed to download invoice:", error);
    throw error;
  }
};

export const ChatService = {
  // à°…à°¡à±à°®à°¿à°¨à± à°¤à±‹ à°šà°¾à°Ÿà± à°šà±‡à°¸à°¿à°¨ à°¯à±‚à°œà°°à±à°² à°²à°¿à°¸à±à°Ÿà±
  getChatUsers: () => api.get("/admin/auth/chat-users"),

  // à°’à°• à°°à±‚à°®à± à°¯à±Šà°•à±à°• à°®à±†à°¸à±‡à°œà± à°¹à°¿à°¸à±à°Ÿà°°à±€
  getMessages: (roomId: string, page = 1) =>
    api.get(`/chat/history/${roomId}`, { params: { page } }),

  // à°«à±ˆà°²à± à°…à°ªà±â€Œà°²à±‹à°¡à± (Image/Video)
  uploadFile: (formData: FormData) =>
    api.post("/chat/upload", formData, {
      headers: { "Content-Type": "multipart/form-data" },
    }),

  // à°®à±†à°¸à±‡à°œà±â€Œà°²à°¨à± à°šà°¦à°¿à°µà°¿à°¨à°Ÿà±à°²à± à°®à°¾à°°à±à°šà°¡à°‚
  markAsRead: (roomId: string) => api.put(`/chat/read/${roomId}`),
  getChatRooms: () => api.get("/chat/rooms"),
};

export const CartService = {
  // 1. Get List
  getAbandonedCarts: () => api.get("/cart/admin/abandoned"),

  // 2. Send Email Trigger
  sendRecoveryEmail: (cartId: string) =>
    api.post(`/cart/admin/send-recovery/${cartId}`),
};
</file>

<file path="lib/utils.ts">
import { type ClassValue, clsx } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

export function formatCurrency(amount: number): string {
  return new Intl.NumberFormat('en-IN', {
    style: 'currency',
    currency: 'INR',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(amount)
}

export function formatDate(date: string | Date): string {
  return new Intl.DateTimeFormat('en-IN', {
    day: '2-digit',
    month: 'short',
    year: 'numeric',
  }).format(new Date(date))
}

export function formatDateTime(date: string | Date): string {
  return new Intl.DateTimeFormat('en-IN', {
    day: '2-digit',
    month: 'short',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  }).format(new Date(date))
}

export function getStockStatusColor(status: string): string {
  switch (status) {
    case 'In Stock':
      return 'text-green-500'
    case 'Low Stock':
      return 'text-yellow-500'
    case 'Out of Stock':
      return 'text-red-500'
    default:
      return 'text-gray-500'
  }
}

export function getOrderStatusColor(status: string): string {
  switch (status) {
    case 'Placed':
      return 'bg-blue-500/10 text-blue-400 border-blue-500/20'
    case 'Confirmed':
      return 'bg-cyan-500/10 text-cyan-400 border-cyan-500/20'
    case 'Packed':
      return 'bg-purple-500/10 text-purple-400 border-purple-500/20'
    case 'Shipped':
      return 'bg-yellow-500/10 text-yellow-400 border-yellow-500/20'
    case 'Delivered':
      return 'bg-green-500/10 text-green-400 border-green-500/20'
    case 'Cancelled':
      return 'bg-red-500/10 text-red-400 border-red-500/20'
    default:
      return 'bg-gray-500/10 text-gray-400 border-gray-500/20'
  }
}

export function truncate(str: string, length: number): string {
  return str.length > length ? str.substring(0, length) + '...' : str
}

// src/lib/utils.ts

// ... à°®à±€ à°‡à°¤à°° à°•à±‹à°¡à± ...

export const downloadCSV = (data: any[], filename: string) => {
  if (!data || data.length === 0) {
    alert("No data to export!");
    return;
  }

  // 1. Headers (Keys) à°¤à±€à°¯à°¡à°‚
  const headers = Object.keys(data[0]);
  
  // 2. CSV Content à°¤à°¯à°¾à°°à± à°šà±‡à°¯à°¡à°‚
  const csvContent = [
    headers.join(','), // Header Row
    ...data.map(row => 
      headers.map(fieldName => {
        const value = row[fieldName];
        // FIX: 0 à°‰à°¨à±à°¨à°ªà±à°ªà±à°¡à± à°…à°¦à°¿ à°–à°¾à°³à±€ à°•à°¾à°•à±‚à°¡à°¦à±. undefined/null à°‰à°‚à°Ÿà±‡à°¨à±‡ à°–à°¾à°³à±€ à°°à°¾à°µà°¾à°²à°¿.
        const safeValue = (value !== null && value !== undefined) ? value : '';
        // à°¡à±‡à°Ÿà°¾à°²à±‹ à°•à°¾à°®à°¾ (,) à°‰à°‚à°Ÿà±‡ à°¸à°®à°¸à±à°¯ à°°à°¾à°•à±à°‚à°¡à°¾ Quotes (" ") à°µà°¾à°¡à°¾à°²à°¿
        return JSON.stringify(safeValue);
      }).join(',')
    )
  ].join('\n');

  // 3. Blob à°•à±à°°à°¿à°¯à±‡à°Ÿà± à°šà±‡à°¸à°¿ à°¡à±Œà°¨à±â€Œà°²à±‹à°¡à± à°šà±‡à°¯à°¡à°‚
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  if (link.download !== undefined) {
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `${filename}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
};
</file>

<file path="next.config.js">
/** @type {import('next').NextConfig} */
const nextConfig = {
  images: {
    // à°ªà°¾à°¤ à°ªà°¦à±à°§à°¤à°¿ (domains) à°¬à°¦à±à°²à± remotePatterns à°µà°¾à°¡à°Ÿà°‚ à°®à°‚à°šà°¿à°¦à°¿
    remotePatterns: [
      {
        protocol: "https",
        hostname: "res.cloudinary.com", // à°®à±€ Cloudinary Images à°•à±‹à°¸à°‚
      },
      {
        protocol: "https",
        hostname: "example.com", // à°®à±€ à°¡à°®à±à°®à±€ à°¡à±‡à°Ÿà°¾à°²à±‹ à°‰à°¨à±à°¨ à°²à°¿à°‚à°•à±à°¸à± à°•à±‹à°¸à°‚
      },
      {
        protocol: "https",
        hostname: "placehold.co", // à°¡à°®à±à°®à±€ à°‡à°®à±‡à°œà±†à°¸à± à°•à±‹à°¸à°‚ (Optional)
      },
      {
        protocol: "https",
        hostname: "images.unsplash.com", // Unsplash à°‡à°®à±‡à°œà±†à°¸à± à°•à±‹à°¸à°‚ (Optional)
      },
      {
        protocol: "https",
        hostname: "upload.wikimedia.org", // ðŸ‘ˆ IDI ADD CHEYANDI
      },
    ],
  },
};

module.exports = nextConfig;
</file>

<file path="package.json">
{
  "name": "hyundai-admin-dashboard",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "axios": "^1.7.9",
    "clsx": "^2.1.1",
    "date-fns": "^4.1.0",
    "emoji-picker-react": "^4.17.3",
    "framer-motion": "^11.11.17",
    "google-auth-library": "^10.5.0",
    "js-cookie": "^3.0.5",
    "leaflet": "^1.9.4",
    "lucide-react": "^0.263.1",
    "next": "^14.2.18",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-hook-form": "^7.71.1",
    "react-hot-toast": "^2.6.0",
    "react-leaflet": "^4.2.1",
    "react-swipeable": "^7.0.2",
    "recharts": "^2.15.0",
    "socket.io-client": "^4.8.1",
    "sonner": "^1.7.1",
    "tailwind-merge": "^2.6.0",
    "wavesurfer.js": "^7.12.1"
  },
  "devDependencies": {
    "@types/js-cookie": "^3.0.6",
    "@types/leaflet": "^1.9.21",
    "@types/node": "^22.10.2",
    "@types/react": "^18.3.18",
    "@types/react-dom": "^18.3.5",
    "autoprefixer": "^10.4.20",
    "eslint": "^8.57.1",
    "eslint-config-next": "^14.2.18",
    "postcss": "^8.4.49",
    "tailwindcss": "^3.4.17",
    "typescript": "^5.7.2"
  }
}
</file>

<file path="postcss.config.js">
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
</file>

<file path="README.md">
# ðŸš— Hyundai Spares E-commerce - Premium Admin Dashboard

A modern, production-ready admin dashboard built with Next.js 14, featuring smooth animations powered by Framer Motion, real-time updates via Socket.io, and seamless integration with your Node.js backend.

## âœ¨ Features

### ðŸŽ¨ Premium Design & Animations
- **Smooth Page Transitions**: Fade-out and slide-up effects between pages
- **Animated Statistics Cards**: Numbers count up from 0 with smooth easing
- **Micro-interactions**: Button hover/tap effects with scale animations
- **Skeleton Loaders**: Shimmer effect loading states (no boring spinners!)
- **Glass-morphism UI**: Modern backdrop blur effects throughout
- **Real-time Toast Notifications**: Animated slide-in with shake effect for new orders

### ðŸ”§ Tech Stack
- **Framework**: Next.js 14 (App Router)
- **Language**: TypeScript
- **Styling**: Tailwind CSS
- **Animations**: Framer Motion
- **UI Components**: Custom components with premium design
- **API Client**: Axios with interceptors
- **Real-time**: Socket.io Client
- **Notifications**: Sonner (toast notifications)
- **Charts**: Recharts (for revenue analytics)

### ðŸ“± Pages & Features

#### 1. **Login Page** (`/login`)
- âœ¨ Smooth form entry animations
- ðŸ‘ï¸ Password visibility toggle
- ðŸŒˆ Gradient backgrounds with animated orbs
- ðŸ”’ JWT-based authentication
- ðŸ’Ž Glass-morphism card design

#### 2. **Dashboard Home** (`/dashboard`)
- ðŸ“Š **4 Animated Statistics Cards**
  - Total Revenue (with growth %)
  - Total Orders (with trend)
  - Total Products
  - Total Customers
- ðŸ“ˆ **Monthly Revenue Chart** (Recharts AreaChart)
  - Last 6 months performance
  - Interactive tooltips
  - Gradient fill effects
- ðŸ“‹ **Recent Orders Widget**
  - Latest 5 orders
  - Customer details
  - Order status badges
  - Quick access to view all
- ðŸ† **Top 5 Selling Products**
  - Ranked display
  - Sales count and revenue
  - Animated cards
- âš ï¸ **Alert Widgets**
  - Low stock products alert
  - Pending orders count
- ðŸŽ¯ **Quick Action Buttons**

#### 3. **Orders Management** (`/dashboard/orders`) â­ NEW
- ðŸ“‹ **Complete Order Table**
  - Order number, customer, amount, payment, status, date
  - Inline status updates with dropdown
  - Color-coded status badges
- ðŸ”„ **Order Status Flow**
  - Placed â†’ Packed â†’ Shipped â†’ Delivered
  - Separate Cancelled flow
  - Status icons (Package, Truck, CheckCircle, etc.)
- ðŸ” **Advanced Filtering**
  - Search by order number, customer name, email
  - Filter by status (All, Placed, Packed, Shipped, Delivered, Cancelled)
  - Quick status counts
- ðŸ“¥ **Invoice Download**
  - One-click PDF invoice download
  - Proper filename generation
  - Toast notifications for success/error
- ðŸ”´ **Live Updates**
  - Real-time connection indicator
  - Auto-updates when status changes via Socket.io
  - No page refresh needed!
- ðŸ“Š **Status Statistics**

#### 4. **Products Table** (`/dashboard/products`)
- ðŸ“¦ Animated table rows with hover effects
- ðŸ” Search by name or part number
- ðŸ·ï¸ Category filtering
- ðŸ“Š Stock status indicators with color coding
- ðŸ–¼ï¸ Product images and details
- âš¡ CRUD action buttons (View, Edit, Delete)

### ðŸ”” Real-Time Features (Socket.io)

#### Server Events Handled:
1. **`new_order`** (Admin Only)
   - ðŸ”Š Sound notification plays
   - âœ¨ Animated toast with shake effect
   - ðŸ“¦ Shows order number and amount
   - ðŸŽ¨ Green gradient styling

2. **`order_status_updated`**
   - ðŸ”„ Automatically updates order list
   - ðŸ“¦ Status-specific icons and colors
   - ðŸ”” Toast notification
   - ðŸ’« Smooth animations

3. **`payment_success`**
   - âœ… Success notification
   - ðŸ’³ Payment amount displayed
   - âœ¨ Rotating icon animation

4. **`payment_failed`**
   - âŒ Error notification
   - ðŸš¨ Alert styling

5. **`low_stock_alert`**
   - âš ï¸ Warning toast
   - ðŸ“Š Remaining stock count

### ðŸ”Œ Backend Integration

Complete API service with 5 main modules:
- **AdminAuthService** - Authentication & profile management
- **ProductService** - Complete CRUD with image upload
- **OrderService** - Order management & invoice download
- **PaymentService** - Payment tracking & analytics
- **DashboardService** - Statistics & analytics data

## ðŸš€ Getting Started

### Prerequisites
- Node.js 18+ installed
- Your Hyundai backend running on `http://localhost:5000`
- MongoDB running and connected

### Installation

1. **Install Dependencies**
```bash
npm install
```

2. **Configure Environment**
Edit `.env.local`:
```env
NEXT_PUBLIC_API_URL=http://localhost:5000/api
NEXT_PUBLIC_SOCKET_URL=http://localhost:5000
```

3. **Run Development Server**
```bash
npm run dev
```

4. **Open Browser**
Navigate to `http://localhost:3000`

### Default Admin Credentials
```
Email: admin@hyundaispares.com
Password: Admin@12345
```

## ðŸ“ Project Structure

```
hyundai-admin/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”œâ”€â”€ layout.tsx              # Dashboard layout with Socket Provider
â”‚   â”‚   â”œâ”€â”€ page.tsx                # Dashboard home with stats & charts
â”‚   â”‚   â”œâ”€â”€ products/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx           # Products management
â”‚   â”‚   â””â”€â”€ orders/
â”‚   â”‚       â””â”€â”€ page.tsx           # Orders management â­ NEW
â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â””â”€â”€ page.tsx                # Admin login page
â”‚   â”œâ”€â”€ layout.tsx                  # Root layout
â”‚   â”œâ”€â”€ globals.css                 # Global styles & animations
â”‚   â””â”€â”€ page.tsx                    # Root redirect
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ providers/
â”‚   â”‚   â””â”€â”€ SocketProvider.tsx     # Socket.io context provider â­ NEW
â”‚   â”œâ”€â”€ ui/
â”‚   â”‚   â”œâ”€â”€ Button.tsx             # Animated button component
â”‚   â”‚   â”œâ”€â”€ Skeleton.tsx           # Shimmer skeleton loaders
â”‚   â”‚   â””â”€â”€ Toaster.tsx            # Toast notification provider
â”‚   â”œâ”€â”€ Sidebar.tsx                # Navigation sidebar
â”‚   â”œâ”€â”€ Header.tsx                 # Top header with search
â”‚   â”œâ”€â”€ PageTransition.tsx         # Page transition wrapper
â”‚   â””â”€â”€ StatsCard.tsx              # Animated stats card
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ api.ts                     # Complete API service â­ UPDATED
â”‚   â””â”€â”€ utils.ts                   # Utility functions
â”œâ”€â”€ types/
â”‚   â””â”€â”€ index.ts                   # TypeScript definitions
â””â”€â”€ [config files]
```

## ðŸŽ¯ Key Animation Highlights

#### Page Transitions
```typescript
initial: { opacity: 0, y: 20 }
animate: { opacity: 1, y: 0 }
exit: { opacity: 0, y: -20 }
```

#### Number Counter Animation
```typescript
const count = useMotionValue(0);
animate(count, value, { duration: 2, ease: 'easeOut' });
```

#### Shimmer Loading
```css
.animate-shimmer {
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
  animation: shimmer 2s infinite;
}
```

## ðŸ” Authentication Flow

1. User enters credentials on `/login`
2. POST request to `/api/admin/auth/login`
3. JWT token stored in localStorage
4. Token sent in `Authorization` header for all requests
5. Socket.io authenticated with same token
6. Automatic redirect to login on 401 responses

## ðŸ”Œ Backend Requirements

### Required API Endpoints
```
POST   /api/admin/auth/login
GET    /api/dashboard/stats
GET    /api/dashboard/revenue/monthly
GET    /api/dashboard/orders/recent
GET    /api/dashboard/products/top-selling
GET    /api/orders/admin/all
GET    /api/orders/:id
GET    /api/orders/:id/invoice          # Returns PDF blob
PUT    /api/orders/:id/status
GET    /api/products
```

### Required Socket.io Events (Server â†’ Client)
```javascript
socket.on('new_order', (orderData) => {})
socket.on('order_status_updated', (data) => {})
socket.on('payment_success', (data) => {})
socket.on('payment_failed', (data) => {})
socket.on('low_stock_alert', (data) => {})
```

## ðŸ§ª Testing Checklist

After setup, verify:
- [ ] Admin login works
- [ ] Dashboard loads with real data
- [ ] Revenue chart displays correctly
- [ ] Recent orders appear
- [ ] Products page loads
- [ ] **Orders page displays all orders**
- [ ] **Can update order status**
- [ ] **Can download invoice (PDF)**
- [ ] Socket.io connects (check console for `âœ… Socket connected`)
- [ ] **Real-time notifications work**
- [ ] **Notification sound plays**
- [ ] **Orders update in real-time**

## ðŸ› Troubleshooting

### API Connection Issues
- âœ… Verify backend is running on port 5000
- âœ… Check CORS settings on backend
- âœ… Confirm API_URL in `.env.local`

### Socket.io Not Connecting
- âœ… Ensure Socket.io server is initialized on backend
- âœ… Check SOCKET_URL matches backend
- âœ… Verify JWT token is valid
- âœ… Check browser console for: `âœ… Socket connected`

### Invoice Download Not Working
- âœ… Verify backend endpoint returns PDF blob
- âœ… Check `Content-Type: application/pdf` header
- âœ… Test endpoint with Postman first

## ðŸ“š Additional Documentation

- **CHANGELOG.md** - Complete version history and updates
- **API_INTEGRATION_GUIDE.md** - Comprehensive API reference
- **SETUP_GUIDE.md** - Quick start and setup instructions

## ðŸŽ¯ Roadmap

### Completed âœ…
- [x] Admin authentication
- [x] Dashboard with real-time stats
- [x] Revenue analytics chart
- [x] Products management (view)
- [x] **Complete orders management**
- [x] **Order status updates**
- [x] **Invoice downloads**
- [x] **Real-time notifications**
- [x] **Socket.io integration**

### Coming Soon ðŸš§
- [ ] Product CRUD (create/edit forms)
- [ ] Customer management
- [ ] Advanced analytics pages
- [ ] Category management
- [ ] Settings page

## ðŸ“¦ Build for Production

```bash
# Build optimized production bundle
npm run build

# Start production server
npm start
```

## ðŸ“„ License

Proprietary - Hyundai Spares E-commerce Platform

## ðŸ™ Credits

- **Design Inspiration**: Modern SaaS dashboards
- **Animations**: Framer Motion library
- **Icons**: Lucide React
- **Fonts**: Google Fonts (Sora, JetBrains Mono)
- **Charts**: Recharts library

---

**Built with â¤ï¸ for Hyundai Spares E-commerce**

*Premium animations â€¢ Real-time updates â€¢ Production-ready code*

**Version 2.0** - Complete Backend Integration
</file>

<file path="SETUP_GUIDE.md">
# ðŸš€ Quick Setup Guide - Hyundai Admin Dashboard

## Installation Steps

### 1. Navigate to Project Directory
```bash
cd hyundai-admin
```

### 2. Install Dependencies
```bash
npm install
```

This will install all required packages including:
- Next.js 14
- React 18
- Framer Motion (for animations)
- Socket.io Client (for real-time updates)
- Axios (for API calls)
- Tailwind CSS (for styling)
- TypeScript

### 3. Configure Environment Variables
The `.env.local` file is already created. Update if needed:
```env
NEXT_PUBLIC_API_URL=http://localhost:5000/api
NEXT_PUBLIC_SOCKET_URL=http://localhost:5000
```

### 4. Start Development Server
```bash
npm run dev
```

The dashboard will be available at `http://localhost:3000`

### 5. Default Login Route
- Navigate to `http://localhost:3000` (automatically redirects to `/login`)
- Enter your admin credentials from your backend

## ðŸ“‹ Available Routes

- `/` - Redirects to login
- `/login` - Admin login page
- `/dashboard` - Dashboard home (requires auth)
- `/dashboard/products` - Products management page
- `/dashboard/orders` - Orders page (structure ready)
- `/dashboard/customers` - Customers page (structure ready)
- `/dashboard/analytics` - Analytics page (structure ready)
- `/dashboard/categories` - Categories page (structure ready)
- `/dashboard/settings` - Settings page (structure ready)

## ðŸŽ¨ Key Features Implemented

### âœ… Login Page
- Smooth form animations
- Password visibility toggle
- Animated background orbs
- Glass-morphism design
- Error handling with toast notifications

### âœ… Dashboard Home
- 4 animated stats cards with number counting
- Revenue, Orders, Products, Customers metrics
- Low stock alerts section
- Pending orders widget
- Quick action buttons
- Real-time data from API

### âœ… Products Page
- Fully functional products table
- Search by name/part number
- Category filtering
- Stock status indicators
- Product images
- CRUD action buttons
- Smooth hover animations on rows

### âœ… Layout Components
- **Sidebar**: Animated navigation with active state
- **Header**: Search bar and notification bell
- **Page Transitions**: Fade out/slide up between routes
- **Real-time Notifications**: Socket.io integration for new orders

## ðŸ”§ Backend Requirements

Your backend should provide these endpoints:

### Authentication
```
POST /api/auth/login
Body: { email: string, password: string }
Response: { token: string, user: object }
```

### Dashboard Stats
```
GET /api/dashboard/stats
Response: {
  totalRevenue: number,
  totalOrders: number,
  totalProducts: number,
  totalCustomers: number,
  revenueGrowth: number,
  ordersGrowth: number,
  lowStockProducts: number,
  pendingOrders: number
}
```

### Products
```
GET /api/products
Response: { products: Product[] }
```

### Socket.io Event
```javascript
// Your backend should emit this when a new order is created
io.emit('newOrder', orderData);
```

## ðŸŽ¯ Next Steps

1. âœ… Install dependencies
2. âœ… Start development server
3. ðŸ”„ Connect to your backend (ensure it's running on port 5000)
4. ðŸ”„ Test login functionality
5. ðŸ”„ Verify Socket.io connection
6. ðŸ”„ Add remaining pages (Orders, Customers, etc.)
7. ðŸ”„ Customize colors/branding if needed
8. ðŸ”„ Add form validation for product creation
9. ðŸ”„ Implement product edit/delete functionality
10. ðŸ”„ Build for production

## ðŸ› Common Issues

**Issue**: Can't connect to API
- **Solution**: Ensure backend is running on `http://localhost:5000`
- Check CORS is enabled on backend

**Issue**: Socket.io not working
- **Solution**: Verify Socket.io server is initialized on backend
- Check console for connection errors

**Issue**: Page shows "Failed to fetch"
- **Solution**: API endpoints might be different, check backend routes
- Verify authentication token is being sent

## ðŸ“¦ Production Build

When ready to deploy:
```bash
npm run build
npm start
```

## ðŸŽ¨ Customization

All animation timings and colors can be customized in:
- `app/globals.css` - Color palette and CSS animations
- `tailwind.config.js` - Tailwind theme
- `components/PageTransition.tsx` - Page transition settings
- Individual component files for specific animations

---

**Enjoy your premium admin dashboard! ðŸš€**
</file>

<file path="tailwind.config.js">
/** @type {import('tailwindcss').Config} */
module.exports = {
  darkMode: ["class"],
  content: [
    './pages/**/*.{ts,tsx}',
    './components/**/*.{ts,tsx}',
    './app/**/*.{ts,tsx}',
    './src/**/*.{ts,tsx}',
  ],
  theme: {
    container: {
      center: true,
      padding: "2rem",
      screens: {
        "2xl": "1400px",
      },
    },
    extend: {
      colors: {
        border: "hsl(var(--border))",
        input: "hsl(var(--input))",
        ring: "hsl(var(--ring))",
        background: "hsl(var(--background))",
        foreground: "hsl(var(--foreground))",
        primary: {
          DEFAULT: "hsl(var(--primary))",
          foreground: "hsl(var(--primary-foreground))",
        },
        secondary: {
          DEFAULT: "hsl(var(--secondary))",
          foreground: "hsl(var(--secondary-foreground))",
        },
        destructive: {
          DEFAULT: "hsl(var(--destructive))",
          foreground: "hsl(var(--destructive-foreground))",
        },
        muted: {
          DEFAULT: "hsl(var(--muted))",
          foreground: "hsl(var(--muted-foreground))",
        },
        accent: {
          DEFAULT: "hsl(var(--accent))",
          foreground: "hsl(var(--accent-foreground))",
        },
        popover: {
          DEFAULT: "hsl(var(--popover))",
          foreground: "hsl(var(--popover-foreground))",
        },
        card: {
          DEFAULT: "hsl(var(--card))",
          foreground: "hsl(var(--card-foreground))",
        },
      },
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
      keyframes: {
        "accordion-down": {
          from: { height: 0 },
          to: { height: "var(--radix-accordion-content-height)" },
        },
        "accordion-up": {
          from: { height: "var(--radix-accordion-content-height)" },
          to: { height: 0 },
        },
        shimmer: {
          "0%": { transform: "translateX(-100%)" },
          "100%": { transform: "translateX(100%)" },
        },
      },
      animation: {
        "accordion-down": "accordion-down 0.2s ease-out",
        "accordion-up": "accordion-up 0.2s ease-out",
        shimmer: "shimmer 2s infinite",
      },
    },
  },
  plugins: [],
}
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
</file>

<file path="types/index.ts">
// ============================================================================
// USER & ADMIN TYPES
// ============================================================================

export interface User {
  _id: string;
  name: string;
  email: string;
  phone: string;
  role: 'customer' | 'admin';
  isEmailVerified: boolean;
  addresses: Address[];
  createdAt: string;
  updatedAt: string;
}

export interface Address {
  _id: string;
  street: string;
  city: string;
  state: string;
  pincode: string;
  phone: string;
  isDefault: boolean;
}

export interface Admin {
  _id: string;
  name: string;
  email: string;
  role: 'admin';
  createdAt: string;
  updatedAt: string;
}

// ============================================================================
// PRODUCT TYPES
// ============================================================================

export interface Product {
  _id: string;
  name: string;
  partNumber: string;
  sanitizedPartNumber: string;
  description: string;
  category: ProductCategory;
  subcategory?: string;
  compatibleModels: CompatibleModel[];
  price: number;
  discountPrice?: number;
  stock: number;
  stockStatus: 'In Stock' | 'Low Stock' | 'Out of Stock';
  lowStockThreshold: number;
  images: ProductImage[];
  specifications?: Record<string, string>;
  warrantyPeriod: string;
  manufacturer: string;
  isActive: boolean;
  isDeleted: boolean;
  tags: string[];
  weight?: number;
  dimensions?: {
    length: number;
    width: number;
    height: number;
    unit: string;
  };
  averageRating: number;
  totalReviews: number;
  totalSales: number;
  finalPrice: number;
  createdAt: string;
  updatedAt: string;
}

export type ProductCategory = 
  | 'Engine' 
  | 'Brake' 
  | 'Electrical' 
  | 'Body' 
  | 'Accessories' 
  | 'Suspension' 
  | 'Transmission' 
  | 'Interior' 
  | 'Exterior' 
  | 'Service Parts';

export interface CompatibleModel {
  modelName: string;
  yearFrom: number;
  yearTo?: number;
  variant?: string;
}

export interface ProductImage {
  url: string;
  publicId: string;
  _id?: string;
}

export interface ProductFormData {
  name: string;
  partNumber: string;
  description: string;
  category: ProductCategory;
  subcategory?: string;
  compatibleModels: CompatibleModel[];
  price: number;
  discountPrice?: number;
  stock: number;
  lowStockThreshold?: number;
  warrantyPeriod?: string;
  manufacturer?: string;
  tags?: string[];
  weight?: number;
  specifications?: Record<string, string>;
}

// ============================================================================
// ORDER TYPES
// ============================================================================

export interface Order {
  _id: string;
  orderNumber: string;
  user: User | string;
  items: OrderItem[];
  shippingAddress: ShippingAddress;
  subtotal: number;
  tax: number;
  taxPercentage: number;
  shippingCharges: number;
  totalAmount: number;
  paymentMethod: 'COD' | 'Razorpay';
  paymentStatus: 'Pending' | 'Completed' | 'Failed' | 'Refunded';
  paymentDetails?: PaymentDetails;
  orderStatus: OrderStatus;
  statusHistory: StatusHistory[];
  trackingNumber?: string;
  courierPartner?: string;
  estimatedDelivery?: string;
  deliveredAt?: string;
  cancelledAt?: string;
  cancellationReason?: string;
  invoicePath?: string;
  invoiceNumber?: string;
  notes?: string;
  createdAt: string;
  updatedAt: string;
}

export type OrderStatus = 'Placed' | 'Confirmed' | 'Packed' | 'Shipped' | 'Delivered' | 'Cancelled';

export interface OrderItem {
  product: string | Product;
  name: string;
  partNumber: string;
  quantity: number;
  price: number;
  subtotal: number;
  image?: string;
}

export interface ShippingAddress {
  street: string;
  city: string;
  state: string;
  pincode: string;
  phone: string;
}

export interface PaymentDetails {
  razorpayOrderId?: string;
  razorpayPaymentId?: string;
  razorpaySignature?: string;
  paidAt?: string;
}

export interface StatusHistory {
  status: string;
  timestamp: string;
  note?: string;
}

// ============================================================================
// PAYMENT TYPES
// ============================================================================

export interface Payment {
  _id: string;
  order: string | Order;
  user: string | User;
  amount: number;
  currency: string;
  paymentMethod: 'COD' | 'Razorpay';
  paymentStatus: 'Pending' | 'Completed' | 'Failed' | 'Refunded';
  razorpayOrderId?: string;
  razorpayPaymentId?: string;
  razorpaySignature?: string;
  failureReason?: string;
  createdAt: string;
  updatedAt: string;
}

// ============================================================================
// DASHBOARD & ANALYTICS TYPES
// ============================================================================

export interface DashboardStats {
  totalRevenue: number;
  totalOrders: number;
  totalProducts: number;
  totalCustomers: number;
  revenueGrowth: number;
  ordersGrowth: number;
  lowStockProducts: number;
  pendingOrders: number;
}

export interface RevenueData {
  month: string;
  year?: number;
  revenue: number;
  orders: number;
  date?: string;
}

export interface TopProduct {
  _id: string;
  name: string;
  partNumber: string;
  totalSales: number;
  revenue: number;
  stock: number;
  images: ProductImage[];
  category?: string;
}

export interface CategorySales {
  _id: string;
  category: string;
  totalSales: number;
  revenue: number;
  productCount: number;
}

export interface CustomerGrowth {
  month: string;
  year: number;
  newCustomers: number;
  totalCustomers: number;
}

export interface PaymentMethodStats {
  method: 'COD' | 'Razorpay';
  count: number;
  totalAmount: number;
  percentage: number;
}

// ============================================================================
// API RESPONSE TYPES
// ============================================================================

export interface ApiResponse<T = any> {
  success: boolean;
  message?: string;
  data?: T;
  error?: string;
  errors?: Record<string, string[]>;
}

export interface PaginatedResponse<T> {
  success: boolean;
  data: T[];
  pagination: {
    page: number;
    limit: number;
    total: number;
    pages: number;
  };
}

// ============================================================================
// FILTER & QUERY TYPES
// ============================================================================

export interface ProductFilters {
  page?: number;
  limit?: number;
  category?: string;
  search?: string;
  sortBy?: string;
  order?: 'asc' | 'desc';
  minPrice?: number;
  maxPrice?: number;
  inStock?: boolean;
}

export interface OrderFilters {
  page?: number;
  limit?: number;
  status?: OrderStatus;
  paymentStatus?: string;
  sortBy?: string;
  order?: 'asc' | 'desc';
  dateFrom?: string;
  dateTo?: string;
}

// ============================================================================
// FORM TYPES
// ============================================================================

export interface LoginCredentials {
  email: string;
  password: string;
}

export interface PasswordChangeData {
  currentPassword: string;
  newPassword: string;
  confirmPassword?: string;
}

export interface ProfileUpdateData {
  name: string;
  email: string;
  phone?: string;
}

// ============================================================================
// NOTIFICATION TYPES
// ============================================================================

export interface Notification {
  _id: string;
  user: string;
  type: 'order' | 'payment' | 'stock' | 'system';
  title: string;
  message: string;
  isRead: boolean;
  link?: string;
  createdAt: string;
}

// ============================================================================
// CART TYPES (for reference)
// ============================================================================

export interface CartItem {
  product: string | Product;
  quantity: number;
  price: number;
  subtotal: number;
}

export interface Cart {
  _id: string;
  user: string;
  items: CartItem[];
  subtotal: number;
  tax: number;
  shippingCharges: number;
  total: number;
  createdAt: string;
  updatedAt: string;
}
</file>

<file path="app/dashboard/page.tsx">
// "use client";

// import { useEffect, useState } from "react";
// import { motion } from "framer-motion";
// import {
//   DollarSign,
//   ShoppingCart,
//   Package,
//   TrendingUp,
//   AlertCircle,
//   ArrowRight,
//   Activity,
//   Clock,
//   Download,
//   RefreshCw,
// } from "lucide-react";
// import StatsCard from "@/components/StatsCard";
// import { StatsSkeleton, Skeleton } from "@/components/ui/Skeleton";
// import { DashboardService } from "@/lib/api";
// import { toast } from "sonner";
// import {
//   XAxis,
//   YAxis,
//   CartesianGrid,
//   Tooltip,
//   ResponsiveContainer,
//   AreaChart,
//   Area,
//   PieChart,
//   Pie,
//   Cell,
//   Legend,
//   BarChart,
//   Bar,
//   LineChart,
//   Line,
// } from "recharts";
// import { formatCurrency, getOrderStatusColor, downloadCSV } from "@/lib/utils";
// import Link from "next/link";

// // --- Types ---
// interface DashboardStats {
//   totalOrders: number;
//   totalRevenue: number;
//   totalCustomers: number;
//   pendingOrders: number;
//   lowStockCount: number;
//   todayOrders: number;
//   todayRevenue: number;
//   ordersByStatus: Array<{ _id: string; count: number }>;
// }

// // Chart Colors
// const COLORS = [
//   "#3b82f6",
//   "#10b981",
//   "#f59e0b",
//   "#ec4899",
//   "#8b5cf6",
//   "#06b6d4",
// ];
// const STATUS_COLORS: Record<string, string> = {
//   Placed: "#3b82f6",
//   Confirmed: "#8b5cf6",
//   Packed: "#f59e0b",
//   Shipped: "#f97316",
//   Delivered: "#10b981",
//   Cancelled: "#ef4444",
// };

// export default function DashboardPage() {
//   // --- State ---
//   const [stats, setStats] = useState<DashboardStats | null>(null);
//   const [monthlyRevenue, setMonthlyRevenue] = useState<any[]>([]);
//   const [dailyRevenue, setDailyRevenue] = useState<any[]>([]);
//   const [recentOrders, setRecentOrders] = useState<any[]>([]);
//   const [topProducts, setTopProducts] = useState<any[]>([]);
//   const [categorySales, setCategorySales] = useState<any[]>([]);
//   const [customerGrowth, setCustomerGrowth] = useState<any[]>([]);

//   const [isLoading, setIsLoading] = useState(true);

//   useEffect(() => {
//     fetchDashboardData();
//   }, []);

//   const fetchDashboardData = async () => {
//     try {
//       setIsLoading(true);

//       const [
//         statsRes,
//         monthlyRevRes,
//         dailyRevRes,
//         ordersRes,
//         productsRes,
//         categoryRes,
//         growthRes,
//       ] = await Promise.all([
//         DashboardService.getStats(),
//         DashboardService.getMonthlyRevenue(),
//         DashboardService.getDailyRevenue(),
//         DashboardService.getRecentOrders(5),
//         DashboardService.getTopSellingProducts(5),
//         DashboardService.getSalesByCategory(),
//         DashboardService.getCustomerGrowth(),
//       ]);

//       // --- Data Extraction (With Safe Checks) ---

//       // 1. Stats
//       const statsData =
//         statsRes.data?.data?.stats || statsRes.data?.stats || {};
//       setStats(statsData);
//       console.log("Orders By Status:", statsData);

//       // 2. Monthly Revenue
//       const mRevData =
//         monthlyRevRes.data?.data?.data || monthlyRevRes.data?.data || [];
//       setMonthlyRevenue(Array.isArray(mRevData) ? mRevData : []);

//       // 3. Daily Revenue
//       const dRevData =
//         dailyRevRes.data?.data?.data || dailyRevRes.data?.data || [];
//       setDailyRevenue(Array.isArray(dRevData) ? dRevData : []);

//       // 4. Recent Orders
//       const rOrders =
//         ordersRes.data?.data?.orders || ordersRes.data?.orders || [];
//       setRecentOrders(Array.isArray(rOrders) ? rOrders : []);

//       // 5. Top Products
//       const tProds =
//         productsRes.data?.data?.products || productsRes.data?.products || [];
//       setTopProducts(Array.isArray(tProds) ? tProds : []);

//       // 6. Category Sales
//       const cSales =
//         categoryRes.data?.data?.data || categoryRes.data?.data || [];
//       setCategorySales(Array.isArray(cSales) ? cSales : []);

//       // 7. Customer Growth
//       const growthData =
//         growthRes.data?.data?.data || growthRes.data?.data || [];
//       if (Array.isArray(growthData)) {
//         const formattedGrowth = growthData.map((item: any) => {
//           const year = item._id?.year || new Date().getFullYear();
//           const month = (item._id?.month || 1) - 1;
//           const date = new Date(year, month);
//           return {
//             name: date.toLocaleString("default", {
//               month: "short",
//               year: "2-digit",
//             }),
//             count: item.newCustomers || 0,
//           };
//         });
//         setCustomerGrowth(formattedGrowth);
//       }
//     } catch (error: any) {
//       console.error("Dashboard data fetch error:", error);
//       toast.error("Failed to load dashboard data");
//     } finally {
//       setIsLoading(false);
//     }
//   };

//   const handleExport = () => {
//     if (monthlyRevenue.length === 0) {
//       toast.error("No revenue data available to export");
//       return;
//     }

//     const reportData = monthlyRevenue.map((item) => ({
//       Month: item.monthName,
//       Total_Orders: item.orders || 0,
//       Total_Revenue: `â‚¹${(item.revenue || 0).toLocaleString("en-IN")}`,
//       Generated_Date: new Date().toLocaleDateString("en-IN"),
//     }));

//     const fileName = `Revenue_Report_${new Date().toISOString().split("T")[0]}`;
//     downloadCSV(reportData, fileName);

//     toast.success("Report downloaded successfully!");
//   };

//   if (isLoading) {
//     return (
//       <div className="space-y-6">
//         <div className="flex justify-between">
//           <h1 className="text-3xl font-bold text-white">Dashboard</h1>
//         </div>
//         <StatsSkeleton />
//         <div className="grid gap-6 lg:grid-cols-2">
//           <Skeleton className="h-80" />
//           <Skeleton className="h-80" />
//         </div>
//       </div>
//     );
//   }

//   return (
//     <div className="space-y-6 pb-10">
//       {/* Header */}
//       <motion.div
//         initial={{ opacity: 0, y: -20 }}
//         animate={{ opacity: 1, y: 0 }}
//         className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4"
//       >
//         <div>
//           <h1 className="text-3xl font-bold text-white">Dashboard</h1>
//           <p className="mt-1 text-gray-400">
//             Overview of your store performance
//           </p>
//         </div>

//         <div className="flex gap-3">
//           <button
//             onClick={handleExport}
//             className="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-xl text-sm font-medium transition-colors shadow-lg shadow-green-900/20"
//           >
//             <Download className="h-4 w-4" />
//             Export Report
//           </button>

//           <button
//             onClick={fetchDashboardData}
//             disabled={isLoading}
//             className="flex items-center gap-2 px-4 py-2 bg-white/5 hover:bg-white/10 text-white rounded-xl text-sm font-medium transition-colors border border-white/10"
//           >
//             <RefreshCw
//               className={`h-4 w-4 ${isLoading ? "animate-spin" : ""}`}
//             />
//             Refresh
//           </button>
//         </div>
//       </motion.div>

//       {/* 1. Key Stats Cards */}
//       <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-4">
//         <StatsCard
//           title="Total Revenue"
//           value={stats?.totalRevenue || 0}
//           prefix="â‚¹"
//           icon={DollarSign}
//           iconColor="text-green-400"
//           iconBg="bg-green-500/10"
//           description={`+${formatCurrency(stats?.todayRevenue || 0)} today`}
//           delay={0}
//         />
//         <StatsCard
//           title="Total Orders"
//           value={stats?.totalOrders || 0}
//           icon={ShoppingCart}
//           iconColor="text-blue-400"
//           iconBg="bg-blue-500/10"
//           description={`+${stats?.todayOrders || 0} new today`}
//           delay={0.1}
//         />
//         <StatsCard
//           title="Pending Orders"
//           value={stats?.pendingOrders || 0}
//           icon={Clock}
//           iconColor="text-orange-400"
//           iconBg="bg-orange-500/10"
//           description="Requires attention"
//           delay={0.2}
//         />
//         <StatsCard
//           title="Low Stock"
//           value={stats?.lowStockCount || 0}
//           icon={AlertCircle}
//           iconColor="text-red-400"
//           iconBg="bg-red-500/10"
//           description="Products need restock"
//           delay={0.3}
//         />
//       </div>

//       {/* 2. Charts Row */}
//       <div className="grid gap-6 lg:grid-cols-2">
//         {/* Monthly Revenue */}
//         <motion.div
//           initial={{ opacity: 0, x: -20 }}
//           animate={{ opacity: 1, x: 0 }}
//           className="rounded-2xl border border-white/10 bg-white/[0.02] p-6"
//         >
//           <div className="mb-6 flex items-center justify-between">
//             <div>
//               <h3 className="text-lg font-semibold text-white">
//                 Monthly Revenue
//               </h3>
//               <p className="text-sm text-gray-400">Performance over the year</p>
//             </div>
//             <div className="p-2 bg-green-500/10 rounded-lg">
//               <TrendingUp className="h-5 w-5 text-green-400" />
//             </div>
//           </div>
//           <div className="h-[300px] w-full">
//             <ResponsiveContainer width="100%" height="100%">
//               <AreaChart data={monthlyRevenue}>
//                 <defs>
//                   <linearGradient id="colorRevenue" x1="0" y1="0" x2="0" y2="1">
//                     <stop offset="5%" stopColor="#10b981" stopOpacity={0.3} />
//                     <stop offset="95%" stopColor="#10b981" stopOpacity={0} />
//                   </linearGradient>
//                 </defs>
//                 <CartesianGrid
//                   strokeDasharray="3 3"
//                   stroke="rgba(255,255,255,0.1)"
//                 />
//                 <XAxis
//                   dataKey="monthName"
//                   stroke="#9ca3af"
//                   style={{ fontSize: "12px" }}
//                 />
//                 <YAxis
//                   stroke="#9ca3af"
//                   style={{ fontSize: "12px" }}
//                   tickFormatter={(val) => `â‚¹${(val / 1000).toFixed(0)}k`}
//                 />
//                 <Tooltip
//                   contentStyle={{
//                     backgroundColor: "#171717",
//                     border: "1px solid #333",
//                     borderRadius: "8px",
//                     color: "#fff",
//                   }}
//                   formatter={(val: any) => [formatCurrency(val), "Revenue"]}
//                 />
//                 <Area
//                   type="monotone"
//                   dataKey="revenue"
//                   stroke="#10b981"
//                   fill="url(#colorRevenue)"
//                   strokeWidth={2}
//                 />
//               </AreaChart>
//             </ResponsiveContainer>
//           </div>
//         </motion.div>

//         {/* Daily Sales Trend */}
//         <motion.div
//           initial={{ opacity: 0, x: 20 }}
//           animate={{ opacity: 1, x: 0 }}
//           className="rounded-2xl border border-white/10 bg-white/[0.02] p-6"
//         >
//           <div className="mb-6 flex items-center justify-between">
//             <div>
//               <h3 className="text-lg font-semibold text-white">
//                 Daily Sales Trend
//               </h3>
//               <p className="text-sm text-gray-400">Last 30 days performance</p>
//             </div>
//             <div className="p-2 bg-blue-500/10 rounded-lg">
//               <Activity className="h-5 w-5 text-blue-400" />
//             </div>
//           </div>
//           <div className="h-[300px] w-full">
//             {dailyRevenue.length > 0 ? (
//               <ResponsiveContainer width="100%" height="100%">
//                 <LineChart data={dailyRevenue}>
//                   <CartesianGrid
//                     strokeDasharray="3 3"
//                     stroke="rgba(255,255,255,0.1)"
//                   />
//                   <XAxis
//                     dataKey="_id"
//                     stroke="#9ca3af"
//                     style={{ fontSize: "12px" }}
//                     tickFormatter={(val) => (val ? val.substring(5) : "")}
//                   />
//                   <YAxis stroke="#9ca3af" style={{ fontSize: "12px" }} />
//                   <Tooltip
//                     contentStyle={{
//                       backgroundColor: "#171717",
//                       border: "1px solid #333",
//                       borderRadius: "8px",
//                     }}
//                     formatter={(val: any) => [formatCurrency(val), "Revenue"]}
//                   />
//                   <Line
//                     type="monotone"
//                     dataKey="revenue"
//                     stroke="#3b82f6"
//                     strokeWidth={2}
//                     dot={false}
//                   />
//                 </LineChart>
//               </ResponsiveContainer>
//             ) : (
//               <div className="flex h-full items-center justify-center text-gray-500">
//                 No sales in the last 30 days
//               </div>
//             )}
//           </div>
//         </motion.div>
//       </div>

//       {/* 3. Breakdown Charts */}
//       <div className="grid gap-6 lg:grid-cols-3">
//         {/* Order Status */}
//         <motion.div
//           initial={{ opacity: 0, y: 20 }}
//           animate={{ opacity: 1, y: 0 }}
//           className="rounded-2xl border border-white/10 bg-white/[0.02] p-6"
//         >
//           <h3 className="text-lg font-semibold text-white mb-4">
//             Order Status
//           </h3>
//           <div className="h-[250px] w-full">
//             {stats?.ordersByStatus && stats.ordersByStatus.length > 0 ? (
//               <ResponsiveContainer width="100%" height="100%">
//                 <PieChart>
//                   <Pie
//                     data={stats.ordersByStatus}
//                     dataKey="count"
//                     nameKey="_id"
//                     cx="50%"
//                     cy="50%"
//                     innerRadius={60}
//                     outerRadius={80}
//                     paddingAngle={5}
//                   >
//                     {stats.ordersByStatus.map((entry, index) => (
//                       <Cell
//                         key={`cell-${index}`}
//                         fill={STATUS_COLORS[entry._id] || "#9ca3af"}
//                         stroke="rgba(0,0,0,0)"
//                       />
//                     ))}
//                   </Pie>
//                   <Tooltip
//                     contentStyle={{
//                       backgroundColor: "#171717",
//                       border: "1px solid #333",
//                     }}
//                   />
//                   <Legend
//                     layout="horizontal"
//                     verticalAlign="bottom"
//                     align="center"
//                     wrapperStyle={{ fontSize: "12px", paddingTop: "10px" }}
//                   />
//                 </PieChart>
//               </ResponsiveContainer>
//             ) : (
//               <div className="flex h-full items-center justify-center text-gray-500">
//                 No orders yet
//               </div>
//             )}
//           </div>
//         </motion.div>

//         {/* Sales By Category */}
//         <motion.div
//           initial={{ opacity: 0, y: 20 }}
//           animate={{ opacity: 1, y: 0 }}
//           className="rounded-2xl border border-white/10 bg-white/[0.02] p-6"
//         >
//           <h3 className="text-lg font-semibold text-white mb-4">
//             Sales by Category
//           </h3>
//           <div className="h-[250px] w-full">
//             {categorySales.length > 0 ? (
//               <ResponsiveContainer width="100%" height="100%">
//                 <PieChart>
//                   <Pie
//                     data={categorySales}
//                     dataKey="totalRevenue"
//                     nameKey="_id"
//                     cx="50%"
//                     cy="50%"
//                     outerRadius={80}
//                   >
//                     {categorySales.map((entry, index) => (
//                       <Cell
//                         key={`cell-${index}`}
//                         fill={COLORS[index % COLORS.length]}
//                         stroke="rgba(0,0,0,0)"
//                       />
//                     ))}
//                   </Pie>
//                   <Tooltip
//                     contentStyle={{
//                       backgroundColor: "#171717",
//                       border: "1px solid #333",
//                     }}
//                     formatter={(val: any) => formatCurrency(val)}
//                   />
//                   <Legend
//                     layout="horizontal"
//                     verticalAlign="bottom"
//                     align="center"
//                     wrapperStyle={{ fontSize: "12px", paddingTop: "10px" }}
//                   />
//                 </PieChart>
//               </ResponsiveContainer>
//             ) : (
//               <div className="flex h-full items-center justify-center text-gray-500">
//                 No sales yet
//               </div>
//             )}
//           </div>
//         </motion.div>

//         {/* Customer Growth */}
//         <motion.div
//           initial={{ opacity: 0, y: 20 }}
//           animate={{ opacity: 1, y: 0 }}
//           className="rounded-2xl border border-white/10 bg-white/[0.02] p-6"
//         >
//           <h3 className="text-lg font-semibold text-white mb-4">
//             New Customers
//           </h3>
//           <div className="h-[250px] w-full">
//             {customerGrowth.length > 0 ? (
//               <ResponsiveContainer width="100%" height="100%">
//                 <BarChart data={customerGrowth}>
//                   <CartesianGrid
//                     strokeDasharray="3 3"
//                     stroke="rgba(255,255,255,0.1)"
//                     vertical={false}
//                   />
//                   <XAxis
//                     dataKey="name"
//                     stroke="#9ca3af"
//                     style={{ fontSize: "10px" }}
//                   />
//                   <Tooltip
//                     cursor={{ fill: "rgba(255,255,255,0.05)" }}
//                     contentStyle={{
//                       backgroundColor: "#171717",
//                       border: "1px solid #333",
//                     }}
//                   />
//                   <Bar dataKey="count" fill="#8b5cf6" radius={[4, 4, 0, 0]} />
//                 </BarChart>
//               </ResponsiveContainer>
//             ) : (
//               <div className="flex h-full items-center justify-center text-gray-500">
//                 No customers yet
//               </div>
//             )}
//           </div>
//         </motion.div>
//       </div>

//       {/* 4. Recent Orders & Top Products */}
//       <div className="grid gap-6 lg:grid-cols-3">
//         {/* Recent Orders */}
//         <motion.div
//           initial={{ opacity: 0, x: -20 }}
//           animate={{ opacity: 1, x: 0 }}
//           className="lg:col-span-2 rounded-2xl border border-white/10 bg-white/[0.02] p-6"
//         >
//           <div className="mb-4 flex justify-between items-center">
//             <h3 className="text-lg font-semibold text-white">Recent Orders</h3>
//             <Link
//               href="/dashboard/orders"
//               className="text-sm text-blue-400 hover:underline flex items-center gap-1"
//             >
//               View All <ArrowRight className="h-4 w-4" />
//             </Link>
//           </div>
//           <div className="space-y-3">
//             {recentOrders.length > 0 ? (
//               recentOrders.map((order) => (
//                 <div
//                   key={order._id}
//                   className="flex justify-between items-center p-3 rounded-lg border border-white/5 bg-white/[0.02] hover:bg-white/[0.05] transition-colors"
//                 >
//                   <div className="flex items-center gap-4">
//                     <div className="hidden sm:block p-2 rounded-full bg-white/5">
//                       <Package className="h-5 w-5 text-gray-400" />
//                     </div>
//                     <div>
//                       <p className="text-sm font-medium text-white">
//                         {order.orderNumber}
//                       </p>
//                       <p className="text-xs text-gray-400">
//                         {order.user?.name || "Guest User"}
//                       </p>
//                     </div>
//                   </div>
//                   <div className="text-right">
//                     <p className="text-sm font-semibold text-white">
//                       {formatCurrency(order.totalAmount)}
//                     </p>
//                     <span
//                       className={`text-xs px-2 py-0.5 rounded-full ${getOrderStatusColor(order.orderStatus)}`}
//                     >
//                       {order.orderStatus}
//                     </span>
//                   </div>
//                 </div>
//               ))
//             ) : (
//               <p className="text-gray-500 text-center py-4">No recent orders</p>
//             )}
//           </div>
//         </motion.div>

//         {/* Top Selling Products */}
//         <motion.div
//           initial={{ opacity: 0, x: 20 }}
//           animate={{ opacity: 1, x: 0 }}
//           className="rounded-2xl border border-white/10 bg-white/[0.02] p-6"
//         >
//           <h3 className="mb-4 text-lg font-semibold text-white">Top Selling</h3>
//           <div className="space-y-4">
//             {topProducts.length > 0 ? (
//               topProducts.map((product, index) => (
//                 <div key={product._id} className="flex items-center gap-4">
//                   <div
//                     className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm
//                     ${
//                       index === 0
//                         ? "bg-yellow-500/20 text-yellow-400"
//                         : index === 1
//                           ? "bg-gray-400/20 text-gray-300"
//                           : index === 2
//                             ? "bg-orange-500/20 text-orange-400"
//                             : "bg-white/10 text-gray-400"
//                     }`}
//                   >
//                     #{index + 1}
//                   </div>
//                   <div className="flex-1 min-w-0">
//                     <p className="text-sm font-medium text-white truncate">
//                       {product.name}
//                     </p>
//                     <p className="text-xs text-gray-400">
//                       {product.totalSales} units sold
//                     </p>
//                   </div>
//                 </div>
//               ))
//             ) : (
//               <p className="text-gray-500 text-center">No sales data yet.</p>
//             )}
//           </div>
//         </motion.div>
//       </div>
//     </div>
//   );
// }

"use client";

import { useEffect, useState, useMemo } from "react";
import { motion } from "framer-motion";
import {
  DollarSign,
  ShoppingCart,
  TrendingUp,
  AlertCircle,
  ArrowRight,
  Download,
  RefreshCw,
  Calendar,
  Plus,
  Package,
  Target,
} from "lucide-react";
import StatsCard from "@/components/StatsCard";
import { StatsSkeleton, Skeleton } from "@/components/ui/Skeleton";
import { DashboardService } from "@/lib/api";
import { toast } from "sonner";
import {
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  AreaChart,
  Area,
  Cell,
  PieChart,
  Pie,
} from "recharts";
import { formatCurrency, getOrderStatusColor, downloadCSV } from "@/lib/utils";
import Link from "next/link";
import dynamic from "next/dynamic";

// ðŸ”¥ IMPORT NEW COMPONENTS
const SalesHeatmap = dynamic(
  () => import("@/components/dashboard/SalesHeatmap"),
  {
    ssr: false,
  },
);

const InventoryForecast = dynamic(
  () => import("@/components/dashboard/InventoryForecast"),
  {
    ssr: false,
  },
);

// --- Styled Components / Utilities ---
const glassCard =
  "rounded-2xl border border-white/5 bg-white/[0.03] backdrop-blur-md shadow-xl p-6 hover:bg-white/[0.05] transition-all duration-300";
const actionBtn =
  "flex flex-col items-center justify-center gap-2 p-4 rounded-xl border border-white/10 bg-white/5 hover:bg-blue-500/20 hover:border-blue-500/50 hover:text-blue-400 transition-all cursor-pointer group h-full";

export default function DashboardPage() {
  // --- State ---
  const [stats, setStats] = useState<any>(null);
  const [monthlyRevenue, setMonthlyRevenue] = useState<any[]>([]);
  const [recentOrders, setRecentOrders] = useState<any[]>([]);
  const [topProducts, setTopProducts] = useState<any[]>([]);

  // UI States
  const [isLoading, setIsLoading] = useState(true);
  const [dateRange, setDateRange] = useState("30days");
  const [hasMounted, setHasMounted] = useState(false);

  // Mock Target (Backend integration later)
  const MONTHLY_TARGET = 50000;

  useEffect(() => {
    setHasMounted(true);
    fetchDashboardData();
  }, [dateRange]);

  const fetchDashboardData = async () => {
    try {
      setIsLoading(true);
      const [statsRes, monthlyRevRes, ordersRes, productsRes] =
        await Promise.all([
          DashboardService.getStats(),
          DashboardService.getMonthlyRevenue(),
          DashboardService.getRecentOrders(5),
          DashboardService.getTopSellingProducts(4),
        ]);

      setStats(statsRes.data?.data?.stats || statsRes.data?.stats || {});
      setMonthlyRevenue(
        Array.isArray(monthlyRevRes.data?.data?.data)
          ? monthlyRevRes.data?.data?.data
          : [],
      );
      setRecentOrders(
        Array.isArray(ordersRes.data?.data?.orders)
          ? ordersRes.data?.data?.orders
          : [],
      );
      setTopProducts(
        Array.isArray(productsRes.data?.data?.products)
          ? productsRes.data?.data?.products
          : [],
      );
    } catch (error: any) {
      console.error("Dashboard data fetch error:", error);
      toast.error("Failed to load dashboard data");
    } finally {
      setIsLoading(false);
    }
  };

  // Calculations
  const avgOrderValue = useMemo(() => {
    if (!stats?.totalRevenue || !stats?.totalOrders) return 0;
    return Math.round(stats.totalRevenue / stats.totalOrders);
  }, [stats]);

  const targetProgress = useMemo(() => {
    if (!stats?.totalRevenue) return 0;
    const progress = (stats.totalRevenue / MONTHLY_TARGET) * 100;
    return Math.min(progress, 100);
  }, [stats]);

  // Handle Export
  const handleExport = () => {
    if (monthlyRevenue.length === 0) {
      toast.error("No data to export");
      return;
    }
    const reportData = monthlyRevenue.map((item) => ({
      Month: item.monthName,
      Orders: item.orders || 0,
      Revenue: `â‚¹${(item.revenue || 0).toLocaleString("en-IN")}`,
    }));
    downloadCSV(
      reportData,
      `Dashboard_Report_${new Date().toISOString().split("T")[0]}`,
    );
    toast.success("Report downloaded!");
  };

  if (isLoading) {
    return (
      <div className="space-y-6">
        <StatsSkeleton />
        <div className="grid gap-6 lg:grid-cols-3">
          <Skeleton className="lg:col-span-2 h-80 rounded-2xl" />
          <Skeleton className="h-80 rounded-2xl" />
        </div>
      </div>
    );
  }

  if (!hasMounted) {
    return <StatsSkeleton />;
  }

  return (
    <div className="space-y-6 pb-10">
      {/* --- HEADER --- */}
      <motion.div
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4"
      >
        <div>
          <h1 className="text-3xl font-bold text-white tracking-tight">
            Dashboard
          </h1>
          <p className="mt-1 text-gray-400 text-sm">
            Overview of your store's performance today.
          </p>
        </div>

        <div className="flex flex-wrap gap-3">
          <div className="relative group">
            <Calendar className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400 group-hover:text-white transition-colors" />
            <select
              value={dateRange}
              onChange={(e) => setDateRange(e.target.value)}
              className="pl-10 pr-8 py-2 bg-white/5 border border-white/10 rounded-xl text-sm text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 appearance-none cursor-pointer hover:bg-white/10 transition-all"
            >
              <option value="7days" className="bg-gray-900">
                Last 7 Days
              </option>
              <option value="30days" className="bg-gray-900">
                Last 30 Days
              </option>
              <option value="month" className="bg-gray-900">
                This Month
              </option>
            </select>
          </div>

          <button
            onClick={handleExport}
            className="flex items-center gap-2 px-4 py-2 bg-blue-600/80 hover:bg-blue-600 text-white rounded-xl text-sm font-medium transition-all shadow-lg shadow-blue-900/20 backdrop-blur-sm"
          >
            <Download className="h-4 w-4" /> Report
          </button>

          <button
            onClick={fetchDashboardData}
            className="p-2 bg-white/5 hover:bg-white/10 text-white rounded-xl border border-white/10 transition-all"
          >
            <RefreshCw
              className={`h-4 w-4 ${isLoading ? "animate-spin" : ""}`}
            />
          </button>
        </div>
      </motion.div>

      {/* --- 1. KPI SECTION --- */}
      <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-4">
        <StatsCard
          title="Total Revenue"
          value={stats?.totalRevenue || 0}
          prefix="â‚¹"
          icon={DollarSign}
          iconColor="text-emerald-400"
          iconBg="bg-emerald-500/10"
          description={`+${formatCurrency(stats?.todayRevenue || 0)} today`}
          delay={0}
        />
        <StatsCard
          title="Total Orders"
          value={stats?.totalOrders || 0}
          icon={ShoppingCart}
          iconColor="text-blue-400"
          iconBg="bg-blue-500/10"
          description={`+${stats?.todayOrders || 0} today`}
          delay={0.1}
        />
        <StatsCard
          title="Avg Order Value"
          value={avgOrderValue}
          prefix="â‚¹"
          icon={TrendingUp}
          iconColor="text-purple-400"
          iconBg="bg-purple-500/10"
          description="Per transaction"
          delay={0.2}
        />
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.3 }}
          className={`${glassCard} border-l-4 ${
            stats?.pendingOrders > 0
              ? "border-l-amber-500"
              : "border-l-gray-600"
          }`}
        >
          <div className="flex justify-between items-start">
            <div>
              <p className="text-sm font-medium text-gray-400">
                Pending Actions
              </p>
              <h3 className="text-2xl font-bold text-white mt-1">
                {stats?.pendingOrders || 0}
              </h3>
              <p className="text-xs text-amber-400 mt-1">Orders need packing</p>
            </div>
            <div className="p-2 bg-amber-500/10 rounded-lg">
              <AlertCircle className="h-5 w-5 text-amber-400" />
            </div>
          </div>
        </motion.div>
      </div>

      {/* --- 2. MAIN CONTENT: Revenue & Forecast --- */}
      <div className="grid gap-6 lg:grid-cols-3 min-h-[400px]">
        {/* Left: Revenue Chart (2 Cols) */}
        <motion.div
          initial={{ opacity: 0, x: -20 }}
          animate={{ opacity: 1, x: 0 }}
          className={`${glassCard} lg:col-span-2 flex flex-col`}
        >
          <div className="mb-6 flex items-center justify-between">
            <div>
              <h3 className="text-lg font-semibold text-white">
                Revenue Trends
              </h3>
              <p className="text-sm text-gray-400">Performance over time</p>
            </div>
            <div className="px-3 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 text-xs font-medium flex items-center gap-1">
              <TrendingUp className="h-3 w-3" /> +12.5% vs last period
            </div>
          </div>
          <div className="flex-1 min-h-[300px] w-full">
            <ResponsiveContainer width="100%" height="100%">
              <AreaChart data={monthlyRevenue}>
                <defs>
                  <linearGradient id="colorRevenue" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="5%" stopColor="#10b981" stopOpacity={0.3} />
                    <stop offset="95%" stopColor="#10b981" stopOpacity={0} />
                  </linearGradient>
                </defs>
                <CartesianGrid
                  strokeDasharray="3 3"
                  stroke="rgba(255,255,255,0.05)"
                  vertical={false}
                />
                <XAxis
                  dataKey="monthName"
                  stroke="#6b7280"
                  style={{ fontSize: "12px" }}
                  axisLine={false}
                  tickLine={false}
                  dy={10}
                />
                <YAxis
                  stroke="#6b7280"
                  style={{ fontSize: "12px" }}
                  axisLine={false}
                  tickLine={false}
                  tickFormatter={(val) => `â‚¹${val / 1000}k`}
                />
                <Tooltip
                  contentStyle={{
                    backgroundColor: "#0f0f11",
                    borderColor: "#333",
                    borderRadius: "12px",
                    color: "#fff",
                  }}
                  formatter={(val: any) => [formatCurrency(val), "Revenue"]}
                />
                <Area
                  type="monotone"
                  dataKey="revenue"
                  stroke="#10b981"
                  strokeWidth={3}
                  fill="url(#colorRevenue)"
                  animationDuration={1500}
                />
              </AreaChart>
            </ResponsiveContainer>
          </div>
        </motion.div>

        {/* Right: Targets & AI Forecast (1 Col) */}
        <div className="flex flex-col gap-6">
          {/* Sales Target Widget */}
          <motion.div
            initial={{ opacity: 0, x: 20 }}
            animate={{ opacity: 1, x: 0 }}
            className={glassCard}
          >
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-base font-semibold text-white flex items-center gap-2">
                <Target className="h-4 w-4 text-blue-400" /> Monthly Target
              </h3>
              <span className="text-xs text-gray-400">
                Goal: {formatCurrency(MONTHLY_TARGET)}
              </span>
            </div>

            <div className="relative h-32 flex items-center justify-center">
              <PieChart width={120} height={120}>
                <Pie
                  data={[
                    { value: targetProgress },
                    { value: 100 - targetProgress },
                  ]}
                  cx="50%"
                  cy="50%"
                  innerRadius={45}
                  outerRadius={55}
                  startAngle={90}
                  endAngle={-270}
                  dataKey="value"
                  stroke="none"
                >
                  <Cell fill="#3b82f6" />
                  <Cell fill="rgba(255,255,255,0.1)" />
                </Pie>
              </PieChart>
              <div className="absolute flex flex-col items-center">
                <span className="text-2xl font-bold text-white">
                  {Math.round(targetProgress)}%
                </span>
              </div>
            </div>
            <p className="text-center text-sm text-gray-400 mt-2">
              {formatCurrency(MONTHLY_TARGET - (stats?.totalRevenue || 0))} more
              to reach goal
            </p>
          </motion.div>

          {/* ðŸ”¥ NEW: Inventory Forecast Widget (Replaced Trending) */}
          <motion.div
            initial={{ opacity: 0, x: 20 }}
            animate={{ opacity: 1, x: 0 }}
            transition={{ delay: 0.1 }}
            className="flex-1"
          >
            <InventoryForecast />
          </motion.div>
        </div>
      </div>

      {/* --- 3. HEATMAP & ACTIONS --- */}
      <div className="grid gap-6 lg:grid-cols-3">
        {/* Left: Heatmap (2 Cols) */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="lg:col-span-2"
        >
          <div className="mb-4">
            <h3 className="text-lg font-bold text-white">
              Live Sales Activity
            </h3>
            <p className="text-sm text-gray-400">
              Real-time order locations & density
            </p>
          </div>
          <SalesHeatmap />
        </motion.div>

        {/* Right: Quick Actions (1 Col) */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="grid grid-cols-2 gap-4 h-full content-start pt-14"
        >
          <Link href="/dashboard/products/add" className={actionBtn}>
            <div className="h-10 w-10 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400 group-hover:bg-blue-500 group-hover:text-white transition-colors">
              <Plus className="h-6 w-6" />
            </div>
            <span className="text-sm font-medium text-white">Add Product</span>
          </Link>
          <Link href="/dashboard/orders" className={actionBtn}>
            <div className="h-10 w-10 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-400 group-hover:bg-purple-500 group-hover:text-white transition-colors">
              <Package className="h-6 w-6" />
            </div>
            <span className="text-sm font-medium text-white">Orders</span>
          </Link>
          <div className={actionBtn}>
            <div className="h-10 w-10 rounded-full bg-orange-500/20 flex items-center justify-center text-orange-400 group-hover:bg-orange-500 group-hover:text-white transition-colors">
              <AlertCircle className="h-6 w-6" />
            </div>
            <span className="text-sm font-medium text-white">Alerts</span>
          </div>
          <div className={actionBtn}>
            <div className="h-10 w-10 rounded-full bg-green-500/20 flex items-center justify-center text-green-400 group-hover:bg-green-500 group-hover:text-white transition-colors">
              <DollarSign className="h-6 w-6" />
            </div>
            <span className="text-sm font-medium text-white">Finances</span>
          </div>
        </motion.div>
      </div>

      {/* --- 4. RECENT ORDERS TABLE --- */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        className={`${glassCard}`}
      >
        <div className="mb-6 flex justify-between items-center">
          <h3 className="text-lg font-semibold text-white">
            Recent Transactions
          </h3>
          <Link
            href="/dashboard/orders"
            className="text-xs text-blue-400 hover:text-blue-300 font-medium flex items-center gap-1"
          >
            View All <ArrowRight className="h-3 w-3" />
          </Link>
        </div>
        <div className="overflow-x-auto">
          <table className="w-full text-left border-collapse">
            <thead className="bg-white/5 text-gray-400 text-xs uppercase font-semibold">
              <tr>
                <th className="px-4 py-3 rounded-l-lg">Order ID</th>
                <th className="px-4 py-3">Customer</th>
                <th className="px-4 py-3">Amount</th>
                <th className="px-4 py-3">Status</th>
                <th className="px-4 py-3 rounded-r-lg text-right">Date</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-white/5 text-sm text-gray-300">
              {recentOrders.length > 0 ? (
                recentOrders.map((order) => (
                  <tr
                    key={order._id}
                    className="hover:bg-white/5 transition group cursor-pointer"
                  >
                    <td className="px-4 py-4 text-white font-medium group-hover:text-blue-400 transition-colors">
                      {order.orderNumber}
                    </td>
                    <td className="px-4 py-4">{order.user?.name || "Guest"}</td>
                    <td className="px-4 py-4 font-mono text-gray-200">
                      {formatCurrency(order.totalAmount)}
                    </td>
                    <td className="px-4 py-4">
                      <span
                        className={`px-2.5 py-1 rounded-full text-[10px] font-semibold border ${getOrderStatusColor(order.orderStatus)} border-opacity-20`}
                      >
                        {order.orderStatus}
                      </span>
                    </td>
                    <td className="px-4 py-4 text-gray-500 text-right">
                      {new Date(order.createdAt).toLocaleDateString()}
                    </td>
                  </tr>
                ))
              ) : (
                <tr>
                  <td colSpan={5} className="text-center py-8 text-gray-500">
                    No recent orders found
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </motion.div>
    </div>
  );
}
</file>

<file path="app/dashboard/products/edit/[id]/page.tsx">
// "use client";

// import { useState, useEffect } from "react";
// import { useRouter, useParams } from "next/navigation";
// import { motion, AnimatePresence } from "framer-motion";
// import {
//   ArrowLeft,
//   Upload,
//   X,
//   Plus,
//   Trash2,
//   Tag,
//   Scale,
//   Ruler,
//   Save,
//   Loader2,
// } from "lucide-react";
// import Button from "@/components/ui/Button";
// import { ProductService } from "@/lib/api";
// import { toast } from "sonner";
// import { ProductCategory, CompatibleModel, Product } from "@/types";
// import Link from "next/link";
// import Image from "next/image";

// // --- Interfaces (Same as Add Page) ---
// interface ProductFormData {
//   name: string;
//   partNumber: string;
//   description: string;
//   category: ProductCategory;
//   subcategory: string;
//   price: number;
//   discountPrice?: number;
//   stock: number;
//   lowStockThreshold: number;
//   warrantyPeriod: string;
//   manufacturer: string;
//   compatibleModels: CompatibleModel[];
//   tags: string[];
//   weight?: number;
//   isActive: boolean;
// }

// interface Dimensions {
//   length: string;
//   width: string;
//   height: string;
//   unit: string;
// }

// interface SpecificationItem {
//   key: string;
//   value: string;
// }

// const CATEGORIES: ProductCategory[] = [
//   "Engine",
//   "Brake",
//   "Electrical",
//   "Body",
//   "Accessories",
//   "Suspension",
//   "Transmission",
//   "Interior",
//   "Exterior",
//   "Service Parts",
// ];

// const HYUNDAI_MODELS = [
//   "i10",
//   "i20",
//   "Venue",
//   "Verna",
//   "Creta",
//   "Alcazar",
//   "Tucson",
//   "Elantra",
//   "Kona",
//   "Ioniq 5",
//   "Santro",
//   "Grand i10",
//   "Aura",
//   "Exter",
// ];

// export default function EditProductPage() {
//   const router = useRouter();
//   const { id } = useParams();

//   const [isFetching, setIsFetching] = useState(true);
//   const [isSaving, setIsSaving] = useState(false);

//   // Existing Images (URLs)
//   const [existingImages, setExistingImages] = useState<
//     { url: string; publicId: string; _id?: string }[]
//   >([]);
//   // New Images to Upload (Files)
//   const [newImages, setNewImages] = useState<File[]>([]);
//   const [newImagePreviews, setNewImagePreviews] = useState<string[]>([]);

//   const [tagInput, setTagInput] = useState("");

//   // Form State
//   const [formData, setFormData] = useState<ProductFormData>({
//     name: "",
//     partNumber: "",
//     description: "",
//     category: "Engine",
//     subcategory: "",
//     price: 0,
//     stock: 0,
//     lowStockThreshold: 5,
//     warrantyPeriod: "",
//     manufacturer: "",
//     compatibleModels: [],
//     tags: [],
//     weight: undefined,
//     isActive: true,
//   });

//   const [dimensions, setDimensions] = useState<Dimensions>({
//     length: "",
//     width: "",
//     height: "",
//     unit: "cm",
//   });

//   const [specifications, setSpecifications] = useState<SpecificationItem[]>([]);

//   const [currentModel, setCurrentModel] = useState<CompatibleModel>({
//     modelName: "",
//     yearFrom: new Date().getFullYear(),
//     yearTo: undefined,
//     variant: "",
//   });

//   // --- 1. Fetch Product Data ---
//   useEffect(() => {
//     if (id) {
//       fetchProductData();
//     }
//   }, [id]);

//   const fetchProductData = async () => {
//     try {
//       const response = await ProductService.getById(id as string);
//       const product: Product = response.data.data.product || response.data;

//       // Populate Form
//       setFormData({
//         name: product.name,
//         partNumber: product.partNumber,
//         description: product.description,
//         category: product.category as ProductCategory,
//         subcategory: product.subcategory || "",
//         price: product.price,
//         discountPrice: product.discountPrice,
//         stock: product.stock,
//         lowStockThreshold: product.lowStockThreshold || 5,
//         warrantyPeriod: product.warrantyPeriod || "",
//         manufacturer: product.manufacturer || "",
//         compatibleModels: product.compatibleModels || [],
//         tags: product.tags || [],
//         weight: product.weight,
//         isActive: product.isActive,
//       });

//       // Populate Images
//       if (product.images) {
//         setExistingImages(product.images);
//       }

//       // Populate Dimensions
//       if (product.dimensions) {
//         setDimensions({
//           length: product.dimensions.length?.toString() || "",
//           width: product.dimensions.width?.toString() || "",
//           height: product.dimensions.height?.toString() || "",
//           unit: product.dimensions.unit || "cm",
//         });
//       }

//       // Populate Specifications (Convert Map/Object to Array)
//       if (product.specifications) {
//         const specsArray = Object.entries(product.specifications).map(
//           ([key, value]) => ({
//             key,
//             value: value as string,
//           }),
//         );
//         setSpecifications(specsArray);
//       } else {
//         setSpecifications([{ key: "", value: "" }]);
//       }
//     } catch (error) {
//       console.error("Fetch error:", error);
//       toast.error("Failed to load product details");
//       router.push("/dashboard/products");
//     } finally {
//       setIsFetching(false);
//     }
//   };

//   // --- 2. Handlers ---

//   const handleNewImageChange = (e: React.ChangeEvent<HTMLInputElement>) => {
//     const files = Array.from(e.target.files || []);
//     const totalImages = existingImages.length + newImages.length + files.length;

//     if (totalImages > 5) {
//       toast.error("Maximum 5 images allowed in total");
//       return;
//     }

//     setNewImages([...newImages, ...files]);
//     files.forEach((file) => {
//       const reader = new FileReader();
//       reader.onloadend = () =>
//         setNewImagePreviews((prev) => [...prev, reader.result as string]);
//       reader.readAsDataURL(file);
//     });
//   };

//   // 1. à°…à°¸à°²à± à°¡à°¿à°²à±€à°Ÿà± à°šà±‡à°¸à±‡ à°²à°¾à°œà°¿à°•à± (Helper Function)
//   const executeImageDeletion = async (index: number, imageId: string) => {
//     // Show loading toast
//     const loadingToast = toast.loading("Deleting image...");

//     try {
//       // API Call
//       await ProductService.deleteImage(id as string, imageId);

//       // Update UI State (Remove from list)
//       setExistingImages((prev) => prev.filter((_, i) => i !== index));

//       // Success Message
//       toast.dismiss(loadingToast);
//       toast.success("Image deleted successfully");
//     } catch (error: any) {
//       console.error("Error deleting image:", error);
//       toast.dismiss(loadingToast);
//       toast.error(error.response?.data?.message || "Failed to delete image");
//     }
//   };

//   // 2. à°®à±†à°¯à°¿à°¨à± à°«à°‚à°•à±à°·à°¨à± (Triggered on Click)
//   const removeExistingImage = (index: number) => {
//     const imageToDelete = existingImages[index];

//     // Validation
//     if (!id) {
//       toast.error("Product ID missing");
//       return;
//     }

//     if (!imageToDelete?._id) {
//       console.warn("Image ID missing, removing locally only");
//       setExistingImages((prev) => prev.filter((_, i) => i !== index));
//       return;
//     }

//     // âœ¨ STYLISH CONFIRMATION TOAST
//     toast("Are you sure?", {
//       description: "This action cannot be undone.",
//       action: {
//         label: "Delete",
//         onClick: () => executeImageDeletion(index, imageToDelete._id!), // Call the helper function
//       },
//       cancel: {
//         label: "Cancel",
//         onClick: () => console.log("Deletion cancelled"), // Optional
//       },
//       duration: 5000, // 5 seconds display time
//       // Optional: Custom Style for Dark Theme look
//       style: {
//         background: "#1f2937",
//         color: "#fff",
//         border: "1px solid #374151",
//       },
//     });
//   };

//   const removeNewImage = (index: number) => {
//     setNewImages((prev) => prev.filter((_, i) => i !== index));
//     setNewImagePreviews((prev) => prev.filter((_, i) => i !== index));
//   };

//   // Compatible Models Logic
//   const addCompatibleModel = () => {
//     if (!currentModel.modelName) {
//       toast.error("Please select a model");
//       return;
//     }
//     setFormData((prev) => ({
//       ...prev,
//       compatibleModels: [...prev.compatibleModels, currentModel],
//     }));
//     setCurrentModel({
//       modelName: "",
//       yearFrom: new Date().getFullYear(),
//       yearTo: undefined,
//       variant: "",
//     });
//   };

//   const removeCompatibleModel = (index: number) => {
//     setFormData((prev) => ({
//       ...prev,
//       compatibleModels: prev.compatibleModels.filter((_, i) => i !== index),
//     }));
//   };

//   // Specifications Logic
//   const handleSpecChange = (
//     index: number,
//     field: "key" | "value",
//     value: string,
//   ) => {
//     const newSpecs = [...specifications];
//     newSpecs[index][field] = value;
//     setSpecifications(newSpecs);
//   };

//   const addSpecRow = () =>
//     setSpecifications([...specifications, { key: "", value: "" }]);
//   const removeSpecRow = (index: number) =>
//     setSpecifications(specifications.filter((_, i) => i !== index));

//   // Tags Logic
//   const handleAddTag = (e: React.KeyboardEvent) => {
//     if (e.key === "Enter" && tagInput.trim()) {
//       e.preventDefault();
//       if (!formData.tags.includes(tagInput.trim())) {
//         setFormData((prev) => ({
//           ...prev,
//           tags: [...prev.tags, tagInput.trim()],
//         }));
//       }
//       setTagInput("");
//     }
//   };
//   const removeTag = (tag: string) =>
//     setFormData((prev) => ({
//       ...prev,
//       tags: prev.tags.filter((t) => t !== tag),
//     }));

//   // --- 3. Submit Handler (Update) ---
//   const handleSubmit = async (e: React.FormEvent) => {
//     e.preventDefault();
//     setIsSaving(true);

//     try {
//       const data = new FormData();

//       // Basic Fields
//       data.append("name", formData.name);
//       data.append("partNumber", formData.partNumber);
//       data.append("description", formData.description);
//       data.append("category", formData.category);
//       if (formData.subcategory)
//         data.append("subcategory", formData.subcategory);
//       data.append("price", formData.price.toString());
//       if (formData.discountPrice)
//         data.append("discountPrice", formData.discountPrice.toString());
//       data.append("stock", formData.stock.toString());
//       data.append("lowStockThreshold", formData.lowStockThreshold.toString());
//       data.append("warrantyPeriod", formData.warrantyPeriod);
//       data.append("manufacturer", formData.manufacturer);
//       data.append("isActive", formData.isActive.toString());

//       if (formData.weight) data.append("weight", formData.weight.toString());

//       // Dimensions
//       const dims = {
//         length: parseFloat(dimensions.length) || 0,
//         width: parseFloat(dimensions.width) || 0,
//         height: parseFloat(dimensions.height) || 0,
//         unit: dimensions.unit,
//       };
//       data.append("dimensions", JSON.stringify(dims));

//       // Arrays & Objects
//       data.append(
//         "compatibleModels",
//         JSON.stringify(formData.compatibleModels),
//       );
//       data.append("tags", JSON.stringify(formData.tags));

//       const specsObject = specifications.reduce(
//         (acc, curr) => {
//           if (curr.key.trim() && curr.value.trim())
//             acc[curr.key.trim()] = curr.value.trim();
//           return acc;
//         },
//         {} as Record<string, string>,
//       );
//       data.append("specifications", JSON.stringify(specsObject));

//       // Handle Images
//       // 1. Keep Existing Images (Pass as JSON string of publicIds or full objects)
//       // Backend should handle "if existingImages provided, keep them"
//       data.append("existingImages", JSON.stringify(existingImages));

//       // 2. Add New Images
//       newImages.forEach((image) => {
//         data.append("images", image); // Note: Backend key might differ, usually 'images' or specific key
//       });

//       // NOTE: Ensure your Backend Update Controller handles `existingImages` (to preserve)
//       // and `req.files` (to add new ones).

//       await ProductService.update(id as string, data);

//       toast.success("Product updated successfully!");
//       router.push("/dashboard/products");
//     } catch (error: any) {
//       console.error("Update error:", error);
//       toast.error(error.response?.data?.message || "Failed to update product");
//     } finally {
//       setIsSaving(false);
//     }
//   };

//   if (isFetching) {
//     return (
//       <div className="flex h-[80vh] items-center justify-center">
//         <Loader2 className="h-10 w-10 animate-spin text-blue-500" />
//       </div>
//     );
//   }

//   return (
//     <div className="space-y-6 pb-20">
//       {/* Header */}
//       <motion.div
//         initial={{ opacity: 0, y: -20 }}
//         animate={{ opacity: 1, y: 0 }}
//         className="flex items-center justify-between"
//       >
//         <div className="flex items-center gap-4">
//           <Link href="/dashboard/products">
//             <button className="rounded-xl bg-white/5 p-2 transition-colors hover:bg-white/10">
//               <ArrowLeft className="h-5 w-5 text-white" />
//             </button>
//           </Link>
//           <div>
//             <h1 className="text-3xl font-bold text-white">Edit Product</h1>
//             <p className="mt-1 text-gray-400">
//               Update product details and stock
//             </p>
//           </div>
//         </div>
//       </motion.div>

//       {/* Form */}
//       <motion.form
//         initial={{ opacity: 0, y: 20 }}
//         animate={{ opacity: 1, y: 0 }}
//         transition={{ delay: 0.1 }}
//         onSubmit={handleSubmit}
//         className="rounded-2xl border border-white/10 bg-white/[0.02] p-8 backdrop-blur-sm"
//       >
//         <div className="space-y-8">
//           {/* 1. Basic Information */}
//           <div>
//             <div className="flex justify-between items-center mb-4">
//               <h2 className="text-xl font-semibold text-white">
//                 Basic Information
//               </h2>
//               {/* Active Toggle */}
//               <label className="relative inline-flex items-center cursor-pointer">
//                 <input
//                   type="checkbox"
//                   checked={formData.isActive}
//                   onChange={(e) =>
//                     setFormData({ ...formData, isActive: e.target.checked })
//                   }
//                   className="sr-only peer"
//                 />
//                 <div className="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
//                 <span className="ms-3 text-sm font-medium text-white">
//                   {formData.isActive ? "Active Listing" : "Draft / Inactive"}
//                 </span>
//               </label>
//             </div>

//             <div className="grid gap-6 md:grid-cols-2">
//               <div>
//                 <label className="mb-2 block text-sm font-medium text-gray-300">
//                   Product Name *
//                 </label>
//                 <input
//                   type="text"
//                   required
//                   value={formData.name}
//                   onChange={(e) =>
//                     setFormData({ ...formData, name: e.target.value })
//                   }
//                   className="form-input"
//                 />
//               </div>

//               <div>
//                 <label className="mb-2 block text-sm font-medium text-gray-300">
//                   Part Number *
//                 </label>
//                 <input
//                   type="text"
//                   required
//                   value={formData.partNumber}
//                   onChange={(e) =>
//                     setFormData({
//                       ...formData,
//                       partNumber: e.target.value.toUpperCase(),
//                     })
//                   }
//                   className="form-input"
//                 />
//               </div>

//               <div className="md:col-span-2">
//                 <label className="mb-2 block text-sm font-medium text-gray-300">
//                   Description *
//                 </label>
//                 <textarea
//                   required
//                   rows={4}
//                   value={formData.description}
//                   onChange={(e) =>
//                     setFormData({ ...formData, description: e.target.value })
//                   }
//                   className="form-input"
//                 />
//               </div>

//               <div>
//                 <label className="mb-2 block text-sm font-medium text-gray-300">
//                   Category *
//                 </label>
//                 <select
//                   required
//                   value={formData.category}
//                   onChange={(e) =>
//                     setFormData({
//                       ...formData,
//                       category: e.target.value as ProductCategory,
//                     })
//                   }
//                   className="form-input"
//                 >
//                   {CATEGORIES.map((cat) => (
//                     <option key={cat} value={cat}>
//                       {cat}
//                     </option>
//                   ))}
//                 </select>
//               </div>

//               <div>
//                 <label className="mb-2 block text-sm font-medium text-gray-300">
//                   Subcategory
//                 </label>
//                 <input
//                   type="text"
//                   value={formData.subcategory}
//                   onChange={(e) =>
//                     setFormData({ ...formData, subcategory: e.target.value })
//                   }
//                   className="form-input"
//                 />
//               </div>
//             </div>
//           </div>

//           <div className="h-px bg-white/10" />

//           {/* 2. Pricing & Stock */}
//           <div>
//             <h2 className="mb-4 text-xl font-semibold text-white">
//               Pricing & Stock
//             </h2>
//             <div className="grid gap-6 md:grid-cols-4">
//               <div>
//                 <label className="mb-2 block text-sm font-medium text-gray-300">
//                   Price (â‚¹) *
//                 </label>
//                 <input
//                   type="number"
//                   required
//                   min="0"
//                   value={formData.price}
//                   onChange={(e) =>
//                     setFormData({
//                       ...formData,
//                       price: parseFloat(e.target.value),
//                     })
//                   }
//                   className="form-input"
//                 />
//               </div>

//               <div>
//                 <label className="mb-2 block text-sm font-medium text-gray-300">
//                   Discount Price (â‚¹)
//                 </label>
//                 <input
//                   type="number"
//                   min="0"
//                   value={formData.discountPrice || ""}
//                   onChange={(e) =>
//                     setFormData({
//                       ...formData,
//                       discountPrice: e.target.value
//                         ? parseFloat(e.target.value)
//                         : undefined,
//                     })
//                   }
//                   className="form-input"
//                 />
//               </div>

//               <div>
//                 <label className="mb-2 block text-sm font-medium text-gray-300">
//                   Stock Quantity *
//                 </label>
//                 <input
//                   type="number"
//                   required
//                   min="0"
//                   value={formData.stock}
//                   onChange={(e) =>
//                     setFormData({
//                       ...formData,
//                       stock: parseInt(e.target.value),
//                     })
//                   }
//                   className="form-input"
//                 />
//               </div>

//               <div>
//                 <label className="mb-2 block text-sm font-medium text-gray-300">
//                   Low Stock Alert
//                 </label>
//                 <input
//                   type="number"
//                   min="0"
//                   value={formData.lowStockThreshold}
//                   onChange={(e) =>
//                     setFormData({
//                       ...formData,
//                       lowStockThreshold: parseInt(e.target.value),
//                     })
//                   }
//                   className="form-input"
//                 />
//               </div>
//             </div>
//           </div>

//           <div className="h-px bg-white/10" />

//           {/* 3. Physical & Specifications */}
//           <div>
//             <h2 className="mb-4 text-xl font-semibold text-white">
//               Technical Details
//             </h2>
//             <div className="grid gap-6 md:grid-cols-2">
//               {/* Dimensions */}
//               <div>
//                 <div className="flex items-center gap-2 mb-2">
//                   <Ruler className="h-4 w-4 text-purple-400" />
//                   <span className="text-sm font-medium text-gray-300">
//                     Dimensions (L x W x H)
//                   </span>
//                 </div>
//                 <div className="flex gap-2">
//                   <input
//                     type="number"
//                     placeholder="L"
//                     value={dimensions.length}
//                     onChange={(e) =>
//                       setDimensions({ ...dimensions, length: e.target.value })
//                     }
//                     className="form-input w-full"
//                   />
//                   <input
//                     type="number"
//                     placeholder="W"
//                     value={dimensions.width}
//                     onChange={(e) =>
//                       setDimensions({ ...dimensions, width: e.target.value })
//                     }
//                     className="form-input w-full"
//                   />
//                   <input
//                     type="number"
//                     placeholder="H"
//                     value={dimensions.height}
//                     onChange={(e) =>
//                       setDimensions({ ...dimensions, height: e.target.value })
//                     }
//                     className="form-input w-full"
//                   />
//                   <select
//                     value={dimensions.unit}
//                     onChange={(e) =>
//                       setDimensions({ ...dimensions, unit: e.target.value })
//                     }
//                     className="form-input w-24"
//                   >
//                     <option value="cm">cm</option>
//                     <option value="mm">mm</option>
//                   </select>
//                 </div>
//               </div>

//               {/* Weight */}
//               <div>
//                 <div className="flex items-center gap-2 mb-2">
//                   <Scale className="h-4 w-4 text-blue-400" />
//                   <span className="text-sm font-medium text-gray-300">
//                     Weight (kg)
//                   </span>
//                 </div>
//                 <input
//                   type="number"
//                   step="0.01"
//                   value={formData.weight || ""}
//                   onChange={(e) =>
//                     setFormData({
//                       ...formData,
//                       weight: e.target.value
//                         ? parseFloat(e.target.value)
//                         : undefined,
//                     })
//                   }
//                   className="form-input"
//                   placeholder="0.00"
//                 />
//               </div>
//             </div>

//             {/* Dynamic Specs */}
//             <div className="mt-6">
//               <label className="mb-2 block text-sm font-medium text-gray-300">
//                 Specifications
//               </label>
//               <div className="space-y-3">
//                 {specifications.map((spec, index) => (
//                   <div key={index} className="flex gap-4">
//                     <input
//                       type="text"
//                       placeholder="Key"
//                       value={spec.key}
//                       onChange={(e) =>
//                         handleSpecChange(index, "key", e.target.value)
//                       }
//                       className="form-input flex-1"
//                     />
//                     <input
//                       type="text"
//                       placeholder="Value"
//                       value={spec.value}
//                       onChange={(e) =>
//                         handleSpecChange(index, "value", e.target.value)
//                       }
//                       className="form-input flex-1"
//                     />
//                     <button
//                       type="button"
//                       onClick={() => removeSpecRow(index)}
//                       className="p-3 rounded-xl bg-red-500/10 text-red-400"
//                     >
//                       <Trash2 className="h-5 w-5" />
//                     </button>
//                   </div>
//                 ))}
//                 <Button
//                   type="button"
//                   onClick={addSpecRow}
//                   variant="secondary"
//                   size="sm"
//                 >
//                   <Plus className="h-4 w-4 mr-2" /> Add Specification
//                 </Button>
//               </div>
//             </div>
//           </div>

//           <div className="h-px bg-white/10" />

//           {/* 4. Compatible Models */}
//           <div>
//             <h2 className="mb-4 text-xl font-semibold text-white">
//               Compatible Models
//             </h2>

//             {/* Add Model Form */}
//             <div className="mb-4 grid gap-4 md:grid-cols-5 p-4 rounded-xl bg-white/5 border border-white/10">
//               <div className="md:col-span-2">
//                 <select
//                   value={currentModel.modelName}
//                   onChange={(e) =>
//                     setCurrentModel({
//                       ...currentModel,
//                       modelName: e.target.value,
//                     })
//                   }
//                   className="form-input"
//                 >
//                   <option value="">Select Model</option>
//                   {HYUNDAI_MODELS.map((model) => (
//                     <option key={model} value={model}>
//                       {model}
//                     </option>
//                   ))}
//                 </select>
//               </div>
//               <input
//                 type="number"
//                 placeholder="From Year"
//                 value={currentModel.yearFrom}
//                 onChange={(e) =>
//                   setCurrentModel({
//                     ...currentModel,
//                     yearFrom: parseInt(e.target.value),
//                   })
//                 }
//                 className="form-input"
//               />
//               <input
//                 type="number"
//                 placeholder="To Year"
//                 value={currentModel.yearTo || ""}
//                 onChange={(e) =>
//                   setCurrentModel({
//                     ...currentModel,
//                     yearTo: e.target.value
//                       ? parseInt(e.target.value)
//                       : undefined,
//                   })
//                 }
//                 className="form-input"
//               />
//               <Button
//                 type="button"
//                 onClick={addCompatibleModel}
//                 variant="primary"
//               >
//                 <Plus className="h-4 w-4" /> Add
//               </Button>
//             </div>

//             {/* List */}
//             <div className="grid gap-2 sm:grid-cols-2 md:grid-cols-3">
//               {formData.compatibleModels.map((model, index) => (
//                 <div
//                   key={index}
//                   className="flex items-center justify-between rounded-lg border border-white/10 bg-blue-500/10 p-3"
//                 >
//                   <div className="text-sm">
//                     <p className="font-semibold text-blue-200">
//                       {model.modelName}
//                     </p>
//                     <p className="text-blue-300/70 text-xs">
//                       {model.yearFrom} - {model.yearTo || "Present"}
//                     </p>
//                   </div>
//                   <button
//                     type="button"
//                     onClick={() => removeCompatibleModel(index)}
//                     className="text-red-400 hover:text-red-300"
//                   >
//                     <X className="h-4 w-4" />
//                   </button>
//                 </div>
//               ))}
//             </div>
//           </div>

//           <div className="h-px bg-white/10" />

//           {/* 5. Images */}
//           <div>
//             <h2 className="mb-4 text-xl font-semibold text-white">Images</h2>
//             <div className="space-y-4">
//               {/* Existing Images */}
//               {existingImages.length > 0 && (
//                 <div className="mb-4">
//                   <p className="mb-2 text-sm text-gray-400">Current Images</p>
//                   <div className="grid gap-4 sm:grid-cols-3 md:grid-cols-5">
//                     {existingImages.map((img, index) => (
//                       <div
//                         key={index}
//                         className="group relative aspect-square overflow-hidden rounded-xl border border-white/10"
//                       >
//                         <Image
//                           src={img.url}
//                           alt="product"
//                           fill
//                           className="object-cover"
//                         />
//                         <button
//                           type="button"
//                           onClick={() => removeExistingImage(index)}
//                           className="absolute right-2 top-2 rounded-full bg-red-500 p-1 opacity-0 group-hover:opacity-100 transition-opacity"
//                         >
//                           <Trash2 className="h-4 w-4 text-white" />
//                         </button>
//                       </div>
//                     ))}
//                   </div>
//                 </div>
//               )}

//               {/* Upload New */}
//               <label className="flex cursor-pointer flex-col items-center justify-center rounded-xl border-2 border-dashed border-white/20 bg-white/5 px-6 py-8 hover:bg-white/10">
//                 <Upload className="mb-2 h-8 w-8 text-gray-400" />
//                 <span className="text-sm font-medium text-white">
//                   Add New Images
//                 </span>
//                 <input
//                   type="file"
//                   multiple
//                   accept="image/*"
//                   onChange={handleNewImageChange}
//                   className="hidden"
//                 />
//               </label>

//               {/* New Previews */}
//               {newImagePreviews.length > 0 && (
//                 <div className="grid gap-4 sm:grid-cols-3 md:grid-cols-5 mt-4">
//                   {newImagePreviews.map((preview, index) => (
//                     <div
//                       key={index}
//                       className="relative aspect-square overflow-hidden rounded-xl border border-green-500/30"
//                     >
//                       <Image
//                         src={preview}
//                         alt="new"
//                         fill
//                         className="object-cover opacity-80"
//                       />
//                       <div className="absolute inset-0 flex items-center justify-center bg-black/20 text-xs font-bold text-white">
//                         NEW
//                       </div>
//                       <button
//                         type="button"
//                         onClick={() => removeNewImage(index)}
//                         className="absolute right-2 top-2 rounded-full bg-red-500 p-1"
//                       >
//                         <X className="h-4 w-4 text-white" />
//                       </button>
//                     </div>
//                   ))}
//                 </div>
//               )}
//             </div>
//           </div>

//           {/* 6. Footer Actions */}
//           <div className="flex gap-4 pt-4 border-t border-white/10">
//             <Button
//               type="submit"
//               variant="primary"
//               size="lg"
//               isLoading={isSaving}
//               className="flex-1"
//             >
//               <Save className="h-4 w-4 mr-2" /> Update Product
//             </Button>
//             <Link href="/dashboard/products" className="flex-1">
//               <Button
//                 type="button"
//                 variant="secondary"
//                 size="lg"
//                 className="w-full"
//               >
//                 Cancel
//               </Button>
//             </Link>
//           </div>
//         </div>
//       </motion.form>

//       {/* Styles */}
//       <style jsx global>{`
//         .form-input {
//           width: 100%;
//           border-radius: 0.75rem;
//           border-width: 1px;
//           border-color: rgba(255, 255, 255, 0.1);
//           background-color: rgba(255, 255, 255, 0.05);
//           padding: 0.75rem 1rem;
//           color: white;
//           outline: none;
//           transition: all 0.2s;
//         }
//         .form-input:focus {
//           border-color: rgba(59, 130, 246, 0.5);
//           background-color: rgba(255, 255, 255, 0.1);
//         }
//       `}</style>
//     </div>
//   );
// }

"use client";
import { useState, useEffect } from "react";
import { useRouter, useParams } from "next/navigation";
import { motion } from "framer-motion";
import {
  ArrowLeft,
  Upload,
  X,
  Plus,
  Trash2,
  Tag,
  Scale,
  Ruler,
  Save,
  Loader2,
  Zap,
  RotateCcw,
  BarChart3,
} from "lucide-react";
import Button from "@/components/ui/Button";
import { ProductService } from "@/lib/api";
import { toast } from "sonner";
import Link from "next/link";
import Image from "next/image";

// --- Types Definition ---
type ProductCategory =
  | "Engine"
  | "Brake"
  | "Electrical"
  | "Body"
  | "Accessories"
  | "Suspension"
  | "Transmission"
  | "Interior"
  | "Exterior"
  | "Service Parts";

interface CompatibleModel {
  modelName: string;
  yearFrom: number;
  yearTo?: number;
  variant?: string;
}

interface ProductFormData {
  name: string;
  partNumber: string;
  description: string;
  category: ProductCategory;
  subcategory: string;
  price: number;
  discountPrice?: number;
  stock: number;
  lowStockThreshold: number;
  warrantyPeriod: string;
  manufacturer: string;
  compatibleModels: CompatibleModel[];
  tags: string[];
  isActive: boolean;
  // ðŸ”¥ New Fields
  flashSale: {
    isActive: boolean;
    salePrice?: number;
    startTime?: string;
    endTime?: string;
  };
  inventoryAnalytics: {
    reorderLevel: number;
    leadTimeDays: number;
    supplierEmail: string;
  };
  returnPolicy: {
    isReturnable: boolean;
    returnWindowDays: number;
    restockingFee: number;
  };
  shippingInfo: {
    weight: number;
    length: number;
    width: number;
    height: number;
  };
}

interface SpecificationItem {
  key: string;
  value: string;
}

const CATEGORIES: ProductCategory[] = [
  "Engine",
  "Brake",
  "Electrical",
  "Body",
  "Accessories",
  "Suspension",
  "Transmission",
  "Interior",
  "Exterior",
  "Service Parts",
];

const HYUNDAI_MODELS = [
  "i10",
  "i20",
  "Venue",
  "Verna",
  "Creta",
  "Alcazar",
  "Tucson",
  "Elantra",
  "Kona",
  "Ioniq 5",
  "Santro",
  "Grand i10",
  "Aura",
  "Exter",
];

// Helper: Format Date for Input (YYYY-MM-DDTHH:mm)
// Helper: Format Date correctly for datetime-local input (Local Time)
const formatDateForInput = (dateString?: string) => {
  if (!dateString) return "";
  const date = new Date(dateString);

  // Get local date parts to match user's timezone
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, "0");
  const day = String(date.getDate()).padStart(2, "0");
  const hours = String(date.getHours()).padStart(2, "0");
  const minutes = String(date.getMinutes()).padStart(2, "0");

  // Return format: YYYY-MM-DDTHH:mm
  return `${year}-${month}-${day}T${hours}:${minutes}`;
};

export default function EditProductPage() {
  const router = useRouter();
  const { id } = useParams();

  const [isFetching, setIsFetching] = useState(true);
  const [isSaving, setIsSaving] = useState(false);

  // Images State
  const [existingImages, setExistingImages] = useState<
    { url: string; publicId: string; _id?: string }[]
  >([]);
  const [newImages, setNewImages] = useState<File[]>([]);
  const [newImagePreviews, setNewImagePreviews] = useState<string[]>([]);

  const [tagInput, setTagInput] = useState("");

  // Form State
  const [formData, setFormData] = useState<ProductFormData>({
    name: "",
    partNumber: "",
    description: "",
    category: "Engine",
    subcategory: "",
    price: 0,
    discountPrice: undefined,
    stock: 0,
    lowStockThreshold: 5,
    warrantyPeriod: "",
    manufacturer: "",
    compatibleModels: [],
    tags: [],
    isActive: true,
    flashSale: { isActive: false, salePrice: 0, startTime: "", endTime: "" },
    inventoryAnalytics: {
      reorderLevel: 10,
      leadTimeDays: 7,
      supplierEmail: "",
    },
    returnPolicy: { isReturnable: true, returnWindowDays: 7, restockingFee: 0 },
    shippingInfo: { weight: 0, length: 0, width: 0, height: 0 },
  });

  const [specifications, setSpecifications] = useState<SpecificationItem[]>([
    { key: "", value: "" },
  ]);
  const [currentModel, setCurrentModel] = useState<CompatibleModel>({
    modelName: "",
    yearFrom: new Date().getFullYear(),
    yearTo: undefined,
    variant: "",
  });

  // --- 1. Fetch Product Data ---
  useEffect(() => {
    if (id) {
      fetchProductData();
    }
  }, [id]);

  const fetchProductData = async () => {
    try {
      const response = await ProductService.getById(id as string);
      // Adjust based on your API response structure (e.g., response.data.data.product or response.data.product)
      const product =
        response.data.data?.product || response.data.product || response.data;

      // Map API Data to State
      setFormData({
        name: product.name,
        partNumber: product.partNumber,
        description: product.description,
        category: product.category as ProductCategory,
        subcategory: product.subcategory || "",
        price: product.price,
        discountPrice: product.discountPrice,
        stock: product.stock,
        lowStockThreshold: product.lowStockThreshold || 5,
        warrantyPeriod: product.warrantyPeriod || "",
        manufacturer: product.manufacturer || "",
        compatibleModels: product.compatibleModels || [],
        tags: product.tags || [],
        isActive: product.isActive,
        // Map Nested Objects (with fallbacks)
        flashSale: {
          isActive: product.flashSale?.isActive || false,
          salePrice: product.flashSale?.salePrice || 0,
          startTime: formatDateForInput(product.flashSale?.startTime),
          endTime: formatDateForInput(product.flashSale?.endTime),
        },
        inventoryAnalytics: product.inventoryAnalytics || {
          reorderLevel: 10,
          leadTimeDays: 7,
          supplierEmail: "",
        },
        returnPolicy: product.returnPolicy || {
          isReturnable: true,
          returnWindowDays: 7,
          restockingFee: 0,
        },
        shippingInfo: product.shippingInfo || {
          weight: 0,
          length: 0,
          width: 0,
          height: 0,
        },
      });

      // Images
      if (product.images) setExistingImages(product.images);

      // Specifications (Object to Array)
      if (product.specifications) {
        const specsArray = Object.entries(product.specifications).map(
          ([key, value]) => ({
            key,
            value: value as string,
          }),
        );
        setSpecifications(
          specsArray.length > 0 ? specsArray : [{ key: "", value: "" }],
        );
      }
    } catch (error) {
      console.error("Fetch error:", error);
      toast.error("Failed to load product details");
      router.push("/dashboard/products");
    } finally {
      setIsFetching(false);
    }
  };

  // --- 2. Handlers ---

  const handleNewImageChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(e.target.files || []);
    if (existingImages.length + newImages.length + files.length > 5) {
      toast.error("Maximum 5 images allowed total");
      return;
    }
    setNewImages([...newImages, ...files]);
    files.forEach((file) => {
      const reader = new FileReader();
      reader.onloadend = () =>
        setNewImagePreviews((prev) => [...prev, reader.result as string]);
      reader.readAsDataURL(file);
    });
  };

  const removeNewImage = (index: number) => {
    setNewImages((prev) => prev.filter((_, i) => i !== index));
    setNewImagePreviews((prev) => prev.filter((_, i) => i !== index));
  };

  // Delete Existing Image via API
  const removeExistingImage = (index: number) => {
    const imageToDelete = existingImages[index];
    if (!imageToDelete?._id) return;

    toast("Are you sure?", {
      description: "This will permanently delete the image.",
      action: {
        label: "Delete",
        onClick: async () => {
          const loadingToast = toast.loading("Deleting image...");
          try {
            await ProductService.deleteImage(id as string, imageToDelete._id!);
            setExistingImages((prev) => prev.filter((_, i) => i !== index));
            toast.dismiss(loadingToast);
            toast.success("Image deleted");
          } catch (error: any) {
            toast.dismiss(loadingToast);
            toast.error("Failed to delete image");
          }
        },
      },
      cancel: {
        label: "Cancel",
        onClick: () => {
          console.log("Toast cancelled");
        },
      },
    });
  };

  // ... (Reused Logic: Compatible Models, Specs, Tags) ...
  const addCompatibleModel = () => {
    if (!currentModel.modelName) return toast.error("Select a model");
    setFormData((p) => ({
      ...p,
      compatibleModels: [...p.compatibleModels, currentModel],
    }));
    setCurrentModel({
      modelName: "",
      yearFrom: new Date().getFullYear(),
      yearTo: undefined,
      variant: "",
    });
  };
  const removeCompatibleModel = (i: number) => {
    setFormData((p) => ({
      ...p,
      compatibleModels: p.compatibleModels.filter((_, idx) => idx !== i),
    }));
  };
  const handleSpecChange = (i: number, f: "key" | "value", v: string) => {
    const s = [...specifications];
    s[i][f] = v;
    setSpecifications(s);
  };
  const addSpecRow = () =>
    setSpecifications([...specifications, { key: "", value: "" }]);
  const removeSpecRow = (i: number) =>
    setSpecifications(specifications.filter((_, idx) => idx !== i));
  const handleAddTag = (e: React.KeyboardEvent) => {
    if (e.key === "Enter" && tagInput.trim()) {
      e.preventDefault();
      if (!formData.tags.includes(tagInput.trim()))
        setFormData((p) => ({ ...p, tags: [...p.tags, tagInput.trim()] }));
      setTagInput("");
    }
  };
  const removeTag = (t: string) =>
    setFormData((p) => ({ ...p, tags: p.tags.filter((tag) => tag !== t) }));

  // --- 3. Submit Handler (Update) ---
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSaving(true);

    try {
      const data = new FormData();

      // Basic Fields
      data.append("name", formData.name);
      data.append("partNumber", formData.partNumber);
      data.append("description", formData.description);
      data.append("category", formData.category);
      if (formData.subcategory)
        data.append("subcategory", formData.subcategory);
      data.append("price", formData.price.toString());
      if (formData.discountPrice)
        data.append("discountPrice", formData.discountPrice.toString());
      data.append("stock", formData.stock.toString());
      data.append("lowStockThreshold", formData.lowStockThreshold.toString());
      data.append("warrantyPeriod", formData.warrantyPeriod);
      data.append("manufacturer", formData.manufacturer);
      data.append("isActive", formData.isActive.toString());

      // Complex Fields (JSON.stringify)
      data.append(
        "compatibleModels",
        JSON.stringify(formData.compatibleModels),
      );
      data.append("tags", JSON.stringify(formData.tags));
      data.append("flashSale", JSON.stringify(formData.flashSale));
      data.append(
        "inventoryAnalytics",
        JSON.stringify(formData.inventoryAnalytics),
      );
      data.append("returnPolicy", JSON.stringify(formData.returnPolicy));
      data.append("shippingInfo", JSON.stringify(formData.shippingInfo));

      // Specifications Map
      const specsObject = specifications.reduce(
        (acc, curr) => {
          if (curr.key.trim() && curr.value.trim())
            acc[curr.key.trim()] = curr.value.trim();
          return acc;
        },
        {} as Record<string, string>,
      );
      data.append("specifications", JSON.stringify(specsObject));

      // New Images Only (Backend appends these to existing)
      newImages.forEach((image) => data.append("images", image));

      await ProductService.update(id as string, data);

      toast.success("Product updated successfully!");
      router.push("/dashboard/products");
    } catch (error: any) {
      console.error("Update error:", error);
      toast.error(error.response?.data?.message || "Failed to update product");
    } finally {
      setIsSaving(false);
    }
  };

  if (isFetching) {
    return (
      <div className="flex h-[80vh] items-center justify-center">
        <Loader2 className="h-10 w-10 animate-spin text-blue-500" />
      </div>
    );
  }

  return (
    <div className="space-y-6 pb-20">
      {/* Header */}
      <motion.div
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        className="flex items-center gap-4"
      >
        <Link href="/dashboard/products">
          <button className="rounded-xl bg-white/5 p-2 transition-colors hover:bg-white/10">
            <ArrowLeft className="h-5 w-5 text-white" />
          </button>
        </Link>
        <div>
          <h1 className="text-3xl font-bold text-white">Edit Product</h1>
          <p className="mt-1 text-gray-400">
            Update product details and configuration
          </p>
        </div>
      </motion.div>

      {/* Form */}
      <motion.form
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.1 }}
        onSubmit={handleSubmit}
        className="rounded-2xl border border-white/10 bg-white/[0.02] p-8 backdrop-blur-sm"
      >
        <div className="space-y-8">
          {/* 1. Basic Information */}
          <div>
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-xl font-semibold text-white">
                Basic Information
              </h2>
              <label className="relative inline-flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  checked={formData.isActive}
                  onChange={(e) =>
                    setFormData({ ...formData, isActive: e.target.checked })
                  }
                  className="sr-only peer"
                />
                <div className="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:bg-blue-600 after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                <span className="ms-3 text-sm font-medium text-white">
                  {formData.isActive ? "Active Listing" : "Draft"}
                </span>
              </label>
            </div>

            <div className="grid gap-6 md:grid-cols-2">
              <div>
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Product Name
                </label>
                <input
                  type="text"
                  required
                  value={formData.name}
                  onChange={(e) =>
                    setFormData({ ...formData, name: e.target.value })
                  }
                  className="form-input"
                />
              </div>
              <div>
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Part Number
                </label>
                <input
                  type="text"
                  required
                  value={formData.partNumber}
                  onChange={(e) =>
                    setFormData({
                      ...formData,
                      partNumber: e.target.value.toUpperCase(),
                    })
                  }
                  className="form-input"
                />
              </div>
              <div className="md:col-span-2">
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Description
                </label>
                <textarea
                  required
                  rows={4}
                  value={formData.description}
                  onChange={(e) =>
                    setFormData({ ...formData, description: e.target.value })
                  }
                  className="form-input"
                />
              </div>
              <div>
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Category
                </label>
                <select
                  required
                  value={formData.category}
                  onChange={(e) =>
                    setFormData({
                      ...formData,
                      category: e.target.value as ProductCategory,
                    })
                  }
                  className="form-input"
                >
                  {CATEGORIES.map((cat) => (
                    <option
                      key={cat}
                      value={cat}
                      style={{ backgroundColor: "#1f2937", color: "white" }}
                    >
                      {cat}
                    </option>
                  ))}
                </select>
              </div>
              <div>
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Subcategory
                </label>
                <input
                  type="text"
                  value={formData.subcategory}
                  onChange={(e) =>
                    setFormData({ ...formData, subcategory: e.target.value })
                  }
                  className="form-input"
                />
              </div>
            </div>
          </div>

          <div className="h-px bg-white/10" />

          {/* 2. Pricing & Stock */}
          <div>
            <h2 className="mb-4 text-xl font-semibold text-white">
              Pricing & Stock
            </h2>
            <div className="grid gap-6 md:grid-cols-4">
              <div>
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Price (â‚¹)
                </label>
                <input
                  type="number"
                  required
                  min="0"
                  value={formData.price}
                  onChange={(e) =>
                    setFormData({
                      ...formData,
                      price: parseFloat(e.target.value),
                    })
                  }
                  className="form-input"
                />
              </div>
              <div>
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Discount Price (â‚¹)
                </label>
                <input
                  type="number"
                  min="0"
                  value={formData.discountPrice || ""}
                  onChange={(e) =>
                    setFormData({
                      ...formData,
                      discountPrice: e.target.value
                        ? parseFloat(e.target.value)
                        : undefined,
                    })
                  }
                  className="form-input"
                />
              </div>
              <div>
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Stock Quantity
                </label>
                <input
                  type="number"
                  required
                  min="0"
                  value={formData.stock}
                  onChange={(e) =>
                    setFormData({
                      ...formData,
                      stock: parseInt(e.target.value),
                    })
                  }
                  className="form-input"
                />
              </div>
              <div>
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Low Stock Alert
                </label>
                <input
                  type="number"
                  min="0"
                  value={formData.lowStockThreshold}
                  onChange={(e) =>
                    setFormData({
                      ...formData,
                      lowStockThreshold: parseInt(e.target.value),
                    })
                  }
                  className="form-input"
                />
              </div>
            </div>
          </div>

          <div className="h-px bg-white/10" />

          {/* ðŸ”¥ 3. Flash Sale */}
          <div className="rounded-xl border border-yellow-500/20 bg-yellow-500/5 p-6">
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-2">
                <Zap className="h-5 w-5 text-yellow-400" />
                <h2 className="text-xl font-semibold text-white">Flash Sale</h2>
              </div>
              <label className="relative inline-flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  checked={formData.flashSale.isActive}
                  onChange={(e) =>
                    setFormData({
                      ...formData,
                      flashSale: {
                        ...formData.flashSale,
                        isActive: e.target.checked,
                      },
                    })
                  }
                  className="sr-only peer"
                />
                <div className="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:bg-yellow-600 after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
              </label>
            </div>
            {formData.flashSale.isActive && (
              <div className="grid gap-6 md:grid-cols-3">
                <div>
                  <label className="mb-2 block text-sm font-medium text-gray-300">
                    Sale Price (â‚¹)
                  </label>
                  <input
                    type="number"
                    min="0"
                    value={formData.flashSale.salePrice}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        flashSale: {
                          ...formData.flashSale,
                          salePrice: parseFloat(e.target.value),
                        },
                      })
                    }
                    className="form-input border-yellow-500/30 focus:border-yellow-500"
                  />
                </div>
                <div>
                  <label className="mb-2 block text-sm font-medium text-gray-300">
                    Start Time
                  </label>
                  <input
                    type="datetime-local"
                    value={formData.flashSale.startTime}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        flashSale: {
                          ...formData.flashSale,
                          startTime: e.target.value,
                        },
                      })
                    }
                    className="form-input border-yellow-500/30 focus:border-yellow-500"
                  />
                </div>
                <div>
                  <label className="mb-2 block text-sm font-medium text-gray-300">
                    End Time
                  </label>
                  <input
                    type="datetime-local"
                    value={formData.flashSale.endTime}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        flashSale: {
                          ...formData.flashSale,
                          endTime: e.target.value,
                        },
                      })
                    }
                    className="form-input border-yellow-500/30 focus:border-yellow-500"
                  />
                </div>
              </div>
            )}
          </div>

          {/* 4. Shipping Info */}
          <div>
            <div className="flex items-center gap-2 mb-4">
              <Scale className="h-5 w-5 text-blue-400" />
              <h2 className="text-xl font-semibold text-white">
                Shipping & Dimensions
              </h2>
            </div>
            <div className="grid gap-6 md:grid-cols-4">
              <div>
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Weight (kg)
                </label>
                <input
                  type="number"
                  step="0.01"
                  min="0"
                  value={formData.shippingInfo.weight}
                  onChange={(e) =>
                    setFormData({
                      ...formData,
                      shippingInfo: {
                        ...formData.shippingInfo,
                        weight: parseFloat(e.target.value),
                      },
                    })
                  }
                  className="form-input"
                />
              </div>
              <div className="md:col-span-3">
                <label className="mb-2 block text-sm font-medium text-gray-300">
                  Dimensions (L x W x H) in cm
                </label>
                <div className="flex gap-2">
                  <input
                    type="number"
                    placeholder="L"
                    value={formData.shippingInfo.length}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        shippingInfo: {
                          ...formData.shippingInfo,
                          length: parseFloat(e.target.value),
                        },
                      })
                    }
                    className="form-input w-full"
                  />
                  <input
                    type="number"
                    placeholder="W"
                    value={formData.shippingInfo.width}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        shippingInfo: {
                          ...formData.shippingInfo,
                          width: parseFloat(e.target.value),
                        },
                      })
                    }
                    className="form-input w-full"
                  />
                  <input
                    type="number"
                    placeholder="H"
                    value={formData.shippingInfo.height}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        shippingInfo: {
                          ...formData.shippingInfo,
                          height: parseFloat(e.target.value),
                        },
                      })
                    }
                    className="form-input w-full"
                  />
                </div>
              </div>
            </div>
          </div>

          <div className="h-px bg-white/10" />

          {/* 5. Compatible Models & Specs (Same UI as Add Page) */}
          <div>
            <h2 className="mb-4 text-xl font-semibold text-white">
              Compatible Models
            </h2>
            <div className="mb-4 grid gap-4 md:grid-cols-5 p-4 rounded-xl bg-white/5 border border-white/10">
              <div className="md:col-span-2">
                <select
                  value={currentModel.modelName}
                  onChange={(e) =>
                    setCurrentModel({
                      ...currentModel,
                      modelName: e.target.value,
                    })
                  }
                  className="form-input"
                >
                  <option value="">Select Model</option>
                  {HYUNDAI_MODELS.map((model) => (
                    <option
                      key={model}
                      value={model}
                      style={{ backgroundColor: "#1f2937", color: "white" }}
                    >
                      {model}
                    </option>
                  ))}
                </select>
              </div>
              <input
                type="number"
                placeholder="From"
                value={currentModel.yearFrom}
                onChange={(e) =>
                  setCurrentModel({
                    ...currentModel,
                    yearFrom: parseInt(e.target.value),
                  })
                }
                className="form-input"
              />
              <input
                type="number"
                placeholder="To"
                value={currentModel.yearTo || ""}
                onChange={(e) =>
                  setCurrentModel({
                    ...currentModel,
                    yearTo: e.target.value
                      ? parseInt(e.target.value)
                      : undefined,
                  })
                }
                className="form-input"
              />
              <div className="flex items-end">
                <Button
                  type="button"
                  onClick={addCompatibleModel}
                  variant="primary"
                >
                  <Plus className="h-4 w-4" /> Add
                </Button>
              </div>
            </div>
            {formData.compatibleModels.length > 0 && (
              <div className="grid gap-2 sm:grid-cols-2 md:grid-cols-3">
                {formData.compatibleModels.map((model, index) => (
                  <div
                    key={index}
                    className="flex items-center justify-between rounded-lg border border-white/10 bg-blue-500/10 p-3"
                  >
                    <div className="text-sm">
                      <p className="font-semibold text-blue-200">
                        {model.modelName}
                      </p>
                      <p className="text-blue-300/70 text-xs">
                        {model.yearFrom} - {model.yearTo || "Present"}
                      </p>
                    </div>
                    <button
                      type="button"
                      onClick={() => removeCompatibleModel(index)}
                      className="text-red-400 hover:text-red-300"
                    >
                      <X className="h-4 w-4" />
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* 6. Specifications (Dynamic) */}
          <div>
            <h2 className="mb-4 text-xl font-semibold text-white">
              Specifications
            </h2>
            <div className="space-y-3">
              {specifications.map((spec, index) => (
                <div key={index} className="flex gap-4">
                  <input
                    type="text"
                    placeholder="Key"
                    value={spec.key}
                    onChange={(e) =>
                      handleSpecChange(index, "key", e.target.value)
                    }
                    className="form-input flex-1"
                  />
                  <input
                    type="text"
                    placeholder="Value"
                    value={spec.value}
                    onChange={(e) =>
                      handleSpecChange(index, "value", e.target.value)
                    }
                    className="form-input flex-1"
                  />
                  {index > 0 && (
                    <button
                      type="button"
                      onClick={() => removeSpecRow(index)}
                      className="p-3 rounded-xl bg-red-500/10 text-red-400"
                    >
                      <Trash2 className="h-5 w-5" />
                    </button>
                  )}
                </div>
              ))}
              <Button
                type="button"
                onClick={addSpecRow}
                variant="secondary"
                size="sm"
                className="mt-2"
              >
                <Plus className="h-4 w-4 mr-2" /> Add
              </Button>
            </div>
          </div>

          {/* 7. Inventory & Returns */}
          <div className="grid md:grid-cols-2 gap-8">
            <div>
              <h2 className="text-xl font-semibold text-white mb-4">
                Inventory Analytics
              </h2>
              <div className="space-y-4 rounded-xl bg-white/5 p-4 border border-white/10">
                <input
                  type="number"
                  placeholder="Reorder Level"
                  value={formData.inventoryAnalytics.reorderLevel}
                  onChange={(e) =>
                    setFormData({
                      ...formData,
                      inventoryAnalytics: {
                        ...formData.inventoryAnalytics,
                        reorderLevel: parseInt(e.target.value),
                      },
                    })
                  }
                  className="form-input"
                />
                <input
                  type="number"
                  placeholder="Lead Time (Days)"
                  value={formData.inventoryAnalytics.leadTimeDays}
                  onChange={(e) =>
                    setFormData({
                      ...formData,
                      inventoryAnalytics: {
                        ...formData.inventoryAnalytics,
                        leadTimeDays: parseInt(e.target.value),
                      },
                    })
                  }
                  className="form-input"
                />
                <input
                  type="email"
                  placeholder="Supplier Email"
                  value={formData.inventoryAnalytics.supplierEmail}
                  onChange={(e) =>
                    setFormData({
                      ...formData,
                      inventoryAnalytics: {
                        ...formData.inventoryAnalytics,
                        supplierEmail: e.target.value,
                      },
                    })
                  }
                  className="form-input"
                />
              </div>
            </div>
            <div>
              <h2 className="text-xl font-semibold text-white mb-4">
                Return Policy
              </h2>
              <div className="space-y-4 rounded-xl bg-white/5 p-4 border border-white/10">
                <div className="flex justify-between">
                  <label className="text-sm text-gray-400">
                    Is Returnable?
                  </label>
                  <input
                    type="checkbox"
                    checked={formData.returnPolicy.isReturnable}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        returnPolicy: {
                          ...formData.returnPolicy,
                          isReturnable: e.target.checked,
                        },
                      })
                    }
                    className="h-5 w-5"
                  />
                </div>
                {formData.returnPolicy.isReturnable && (
                  <>
                    <input
                      type="number"
                      placeholder="Return Window (Days)"
                      value={formData.returnPolicy.returnWindowDays}
                      onChange={(e) =>
                        setFormData({
                          ...formData,
                          returnPolicy: {
                            ...formData.returnPolicy,
                            returnWindowDays: parseInt(e.target.value),
                          },
                        })
                      }
                      className="form-input"
                    />
                    <input
                      type="number"
                      placeholder="Restocking Fee (â‚¹)"
                      value={formData.returnPolicy.restockingFee}
                      onChange={(e) =>
                        setFormData({
                          ...formData,
                          returnPolicy: {
                            ...formData.returnPolicy,
                            restockingFee: parseFloat(e.target.value),
                          },
                        })
                      }
                      className="form-input"
                    />
                  </>
                )}
              </div>
            </div>
          </div>

          <div className="h-px bg-white/10" />

          {/* 8. Other Details & Tags */}
          <div className="grid gap-6 md:grid-cols-2">
            <input
              type="text"
              placeholder="Warranty Period"
              value={formData.warrantyPeriod}
              onChange={(e) =>
                setFormData({ ...formData, warrantyPeriod: e.target.value })
              }
              className="form-input"
            />
            <input
              type="text"
              placeholder="Manufacturer"
              value={formData.manufacturer}
              onChange={(e) =>
                setFormData({ ...formData, manufacturer: e.target.value })
              }
              className="form-input"
            />
          </div>
          <div>
            <label className="mb-2 flex items-center gap-2 text-sm font-medium text-gray-300">
              <Tag className="h-4 w-4" /> Tags
            </label>
            <input
              type="text"
              value={tagInput}
              onChange={(e) => setTagInput(e.target.value)}
              onKeyDown={handleAddTag}
              className="form-input"
              placeholder="Type tag & Enter"
            />
            <div className="mt-3 flex flex-wrap gap-2">
              {formData.tags.map((tag) => (
                <span
                  key={tag}
                  className="inline-flex items-center gap-1 rounded-full bg-blue-500/20 px-3 py-1 text-sm text-blue-200 border border-blue-500/30"
                >
                  {tag}{" "}
                  <button
                    type="button"
                    onClick={() => removeTag(tag)}
                    className="hover:text-white"
                  >
                    <X className="h-3 w-3" />
                  </button>
                </span>
              ))}
            </div>
          </div>

          <div className="h-px bg-white/10" />

          {/* 9. Images (Edit Mode) */}
          <div>
            <h2 className="mb-4 text-xl font-semibold text-white">Images</h2>
            <div className="space-y-4">
              {existingImages.length > 0 && (
                <div className="grid gap-4 sm:grid-cols-3 md:grid-cols-5">
                  {existingImages.map((img, index) => (
                    <div
                      key={index}
                      className="group relative aspect-square overflow-hidden rounded-xl border border-white/10"
                    >
                      <Image
                        src={img.url}
                        alt="product"
                        fill
                        className="object-cover"
                      />
                      <button
                        type="button"
                        onClick={() => removeExistingImage(index)}
                        className="absolute right-2 top-2 rounded-full bg-red-500 p-1 opacity-0 group-hover:opacity-100 transition-opacity"
                      >
                        <Trash2 className="h-4 w-4 text-white" />
                      </button>
                    </div>
                  ))}
                </div>
              )}
              <label className="flex cursor-pointer flex-col items-center justify-center rounded-xl border-2 border-dashed border-white/20 bg-white/5 px-6 py-8 hover:bg-white/10">
                <Upload className="mb-2 h-8 w-8 text-gray-400" />
                <span className="text-sm font-medium text-white">
                  Upload New Images
                </span>
                <input
                  type="file"
                  multiple
                  accept="image/*"
                  onChange={handleNewImageChange}
                  className="hidden"
                />
              </label>
              {newImagePreviews.length > 0 && (
                <div className="grid gap-4 sm:grid-cols-3 md:grid-cols-5 mt-4">
                  {newImagePreviews.map((preview, index) => (
                    <div
                      key={index}
                      className="relative aspect-square overflow-hidden rounded-xl border border-green-500/30"
                    >
                      <Image
                        src={preview}
                        alt="new"
                        fill
                        className="object-cover opacity-80"
                      />
                      <div className="absolute inset-0 flex items-center justify-center bg-black/20 text-xs font-bold text-white">
                        NEW
                      </div>
                      <button
                        type="button"
                        onClick={() => removeNewImage(index)}
                        className="absolute right-2 top-2 rounded-full bg-red-500 p-1"
                      >
                        <X className="h-4 w-4 text-white" />
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* Submit */}
          <div className="flex gap-4 pt-4 border-t border-white/10">
            <Button
              type="submit"
              variant="primary"
              size="lg"
              isLoading={isSaving}
              className="flex-1"
            >
              <Save className="h-4 w-4 mr-2" /> Save Changes
            </Button>
            <Link href="/dashboard/products" className="flex-1">
              <Button
                type="button"
                variant="secondary"
                size="lg"
                className="w-full"
              >
                Cancel
              </Button>
            </Link>
          </div>
        </div>
      </motion.form>

      {/* Styles */}
      <style jsx global>{`
        .form-input {
          width: 100%;
          border-radius: 0.75rem;
          border-width: 1px;
          border-color: rgba(255, 255, 255, 0.1);
          background-color: rgba(255, 255, 255, 0.05);
          padding: 0.75rem 1rem;
          color: white;
          outline: none;
          transition: all 0.2s;
        }
        .form-input:focus {
          border-color: rgba(59, 130, 246, 0.5);
          background-color: rgba(255, 255, 255, 0.1);
        }
      `}</style>
    </div>
  );
}
</file>

</files>
